---
title: "ComplexHeatmap - Genes - ImmuneGO"
output: html_notebook
---

# Colors
Defina as cores de cada elemento da tabela das anotações das colunas e/ou linhas.

```{r}
#Vaccines
ann_colors = list(
  vaccine = c(
  "BBIBP" = "#76c893",
  "ZF2001" = "#b5e48c",
  "BNT" = "#56cfe1",
  "MO" = "#72ddf7",
  "ChAd" = "#5e60ce",
  "I" = "grey95",
  "H" = "grey95"),
  dose = c(
    "0" = "grey95",
    "1" = "#bbdefb",
    "2" = "#1e88e5",
    "3" = "#0d47a1"),
  day = c(
    "0" = "white",
    "1" = "#e3f2fd",
    "2" = "#ade8f4",
    "3" = "#90e0ef",
    "4" = "#6CD5EA",
    "5" = "#48cae4",
    "6" = "#00b4d8",
    "7" = "#0096c7",
    "10" = "#0087BF",
    "11" = "#0087BF",
    "14" = "#0077b6",
    "26" = "#015BA0",
    "28" = "#023e8a",
    "51" = "#03045e"),
  week = c("1" = "#e3f2fd",
           "2" = "#6CD5EA",
           "3" = "#0087BF",
           "4" = "#015BA0", 
           "7" = "#03045e"),
  type = c('IN'= "#76c893", #1st Gen  vaccines
           'VV' = "#5e60ce", #3rd Gen vaccines
           'RNA' = "#56cfe1",
           'SU' = "#b5e48c",
           'I'= "#f72585",
           "H" = "grey95"), #Infection
  regimen = c('HO' = "grey90",
              'HE' = "#8d99ae",
              "V-I-V" = "#36248f",
              "V-I" = "#D7B0EE",
              "I-V-I" = "#7400b8",
              "I-I" = "#5390d9",
              "I" = "#64dfdf",
              "H" = "grey95"),
  infection = c("0" = "#64dfdf",
                "1" = "#f72585",
                "2" = "#a4161a"),
  variant = c("None" = "grey95",
              "Beta" = "#72efdd",
              "Omicron" = "#5e60ce"),
  severity = c("H" = "grey95",
               "S" = "#0d47a1",
               "MO" = "#1e88e5",
               "MI" = "#bbdefb",
               "NA" = "grey95"),
  sex = c("Male" = "#64dfdf",
          "Female" = "#5e60ce",
          "M/F" = "#D7B0EE"),
  disease_vac = c("I" = "#5e60ce",
                  "V" = "#64dfdf"))


#Definir cores do gráfico
# Defina os valores mínimos e máximos para o espectro de cores
min(matrix_data_ordered_rows)
max(matrix_data_ordered_rows)


#Definir cores do gráfico
# Defina os valores mínimos e máximos para o espectro de cores
min(matrix_data_ordered)
max(matrix_data_ordered)

valores_minimos <- -2  # Substitua pelo valor mínimo desejado
valores_maximos <- 2   # Substitua pelo valor máximo desejado

```





## ImmuneGO

1. Criar matrizes

Importar e padronizar tabelas

```{r}
############## Arquivos necessários

# Informações sobre os processos/Gene sets
ImmuneGO = `ImmuneGO_Annotated_GO_14-3-24_2` %>% 
  select(process:immune_tissue, set_size) %>% 
  distinct()

# Genes por gene sets
immunego_genes = `ImmuneGO_Annotated_Genes_14-3-24` %>%
  filter(go_term == "Manual") %>% 
  select(process,genes)

# Anotações das amostras/condições (Vacinas)
ann_vaccines = ann_vaccines_19_1_24

# Dados 
data.immunego = all_degs_p_05_vac_infected_19_12_23 %>% 
  select(condition:padj)

############## Processar dados

# Selecionar subprocessos para visualizar. Ao selecionar todos os genes de todos os processos, o heatmap ficará enorme e difícil de visualizar. Por isso, aqui, eu dividi em subprocessos com menos genes. Crie uma tabela-mãe com anotações para cada gene de cada condição analisada. Cada gene pode fazer parte de um ou mais processos/gene sets.

#Tabela-mãe
Immune_GO_genes_All = data.immunego %>% 
  merge(immunego_genes, by = "genes", all.x = F, all.y=F) %>% 
  merge(ann_vaccines, by = "condition", all.y=F) %>% 
  clean_names()

###### Gene sets

# Sistema inato
# Immune_GO_genes_Innate = Immune_GO_genes_All %>%
#  filter(process == "INNATE IMMUNE SYSTEM")
# Immune_GO_genes_Adaptive = Immune_GO_genes_All %>%
#  filter(process == "ADAPTIVE IMMUNE SYSTEM")
Immune_GO_genes_Inflammation = Immune_GO_genes_All %>%
  filter(process == "INFLAMMATION")
Immune_GO_genes_ARPP = Immune_GO_genes_All %>%
  filter(process == "ARPP")
Immune_GO_genes_IFN = Immune_GO_genes_All %>%
  filter(process == "ANTIVIRAL AND INTERFERON")
Immune_GO_genes_Neutrophil = Immune_GO_genes_All %>%
  filter(process == "NEUTROPHIL")
Immune_GO_genes_Eosinophil = Immune_GO_genes_All %>%
  filter(process == "EOSINOPHIL")
Immune_GO_genes_Complement = Immune_GO_genes_All %>%
  filter(process == "COMPLEMENT IMMUNE SYSTEM")
Immune_GO_genes_Monocytes = Immune_GO_genes_All %>%
  filter(process == "MONOCYTES")
Immune_GO_genes_DC = Immune_GO_genes_All %>%
  filter(process == "DENDRITIC CELLS")
Immune_GO_genes_Macro = Immune_GO_genes_All %>%
  filter(process == "MACROPHAGES")
Immune_GO_genes_NK = Immune_GO_genes_All %>%
  filter(process == "NK CELL")
Immune_GO_genes_Mast = Immune_GO_genes_All %>%
  filter(process == "MAST CELL") %>%
  distinct()

# Sistema adaptativo
Immune_GO_genes_Cellular = Immune_GO_genes_All %>%
  filter(process == "CELLULAR ADAPTIVE IMMUNE SYSTEM")
Immune_GO_genes_Humoral = Immune_GO_genes_All %>%
  filter(process == "HUMORAL ADAPTIVE IMMUNE SYSTEM")
Immune_GO_genes_Tcells = Immune_GO_genes_All %>%
  filter(process == "T CELLS")
Immune_GO_genes_Bcells = Immune_GO_genes_All %>%
  filter(process == "B CELLS")
Immune_GO_genes_Ig = Immune_GO_genes_All %>%
  filter(process == "IMMUNOGLOBULIN MEDIATED IMMUNE RESPONSE") %>%
  distinct()
```

Os heatmaps gerados variam em dimensão em função do número de linhas (no caso, genes) e condições. Some 20 cm a mais na dimensão da imagem.


Tamanhos:
1. Cellular adaptive immune system: width = unit(30, "cm"), height = unit(70, "cm") 
2. Humoral adaptive immune system: width = unit(30, "cm"), height = unit(30, "cm")
3. T cells: width = unit(30, "cm"), height = unit(50, "cm")
4. B cells: width = unit(30, "cm"), height = unit(50, "cm")
5. Ig mediated: width = unit(30, "cm"), height = unit(10, "cm")
6. Inflammation: width = unit(30, "cm"), height = unit(10, "cm")
7. ARPP: width = unit(30, "cm"), height = unit(3
0, "cm") 
8. IFN: width = unit(30, "cm"), height = unit(50, "cm")
9. DC: width = unit(30, "cm"), height = unit(20, "cm")
10. Macrophages: width = unit(30, "cm"), height = unit(20, "cm")
11. Neutrophils:  width = unit(30, "cm"), height = unit(40, "cm") # 70 genes
12. Eosinophils:  width = unit(30, "cm"), height = unit(10, "cm") # 30 genes
13. Complement:  width = unit(30, "cm"), height = unit(10, "cm") # 30 genes
14. Monocytes:  width = unit(30, "cm"), height = unit(10, "cm") # 30 genes
15. Mast cells: width = unit(30, "cm"), height = unit(10, "cm") # 27 genes




### Inflammation
```{r}
####### Input
#Troque pelo geneset de interesse

heatmap_data = Immune_GO_genes_Inflammation
file = "Immune_GO_genes_Inflammation"

########## Processar dados e criar matriz

#Excluir linhas com Target ou Source == NA
heatmap_data_l2fc= heatmap_data %>% 
  filter(condition != "NA", 
         process != "NA") %>% 
  select(genes, condition, log2fold_change)

# Converter para wide table
matrix_data <- dcast(heatmap_data_l2fc, 
                         genes ~ condition, 
                         value.var = "log2fold_change", 
                         fun.aggregate = mean) %>% 
  column_to_rownames('genes') %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0)

#Arredondar valores para facilitar visualização
matrix_data_ready =  matrix_data %>% 
  round(2)

# Verificar se todas as vacinas da anotação estão na matriz e unir as tabelas
ann_vaccines_complex = heatmap_data %>% 
  select(condition) %>% 
  distinct() %>% 
  inner_join(ann_vaccines %>% select(condition, disease_vac, type, week), by = "condition")

# Unir tabela de anotações
ann_vaccines_heatmap = matrix_data %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  merge(ann_vaccines_complex, by = "condition", all.x = TRUE) %>% 
  arrange(condition) %>% 
  column_to_rownames(var= "condition") 

# Ordenar colunas da matriz para a mesma ordem das linhas da tabela de anotações
matrix_data_ordered = matrix_data %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  merge(ann_vaccines_complex, by.y = "condition", all.x=TRUE) %>% 
  arrange(condition) %>% #Trocar a variável pela qual deseja ordenar (Vaccine, Day, Condition, etc.)
  select(!c(disease_vac, type, week)) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>% #Converter em numéricos
  replace(is.na(.), 0) %>% 
  as.matrix() 

#Verificar se as linhas sao iguais
dim(matrix_data_ordered) #Usar se for ordenar por colunas
dim(ann_vaccines_heatmap) #Anotações sobre as colunas


#Criar heatmap annotation
ha = HeatmapAnnotation(df = ann_vaccines_heatmap, 
                       col = ann_colors, 
                       annotation_name_side = "left")


col_fun <- colorRamp2(c(-2, -1, 0, 1, 2), c("#5AFFE9", "#9bc1bc", "black", "#ed6a5a", "#F11A02"))


#Parameters
mat = matrix_data_ordered
width_image = 40
height_image = 20
width = unit(30, "cm")
height = unit(10, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 3)


#Plotar e salvar imagem
fileimageheatmap_ungrouped= paste0(file, sep ="_", "Ungrouped_Complexheatmap.png")

png(file = fileimageheatmap_ungrouped, width=width_image, height=height_image,units="cm",res=800)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = ha,
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "L2FC", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = gpar(fontsize = 10),
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = gpar(fontsize = 7),
                        row_split = NULL, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        #column_split = 2, #Split group clusters
                        #column_km = 2,
                        column_gap = unit(8, "mm"),
                        show_column_dend = TRUE,
                        show_row_dend = TRUE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = unit(30, "cm"), 
                        height = unit(10, "cm")
)

draw(heatmap_plot_all, annotation_legend_side = "right", heatmap_legend_side = "right")

dev.off()
```
