---
title: "Random forest"
author: "Wasim Syed"
date: "2024-03-20"
output: html_document
---

https://juliasilge.com/blog/sf-trees-random-tuning/
# Libraries
```{r}
# install.packages("randomForest")
# install.packages("caret")
# install.packages("rpart")
# install.packages("rpart.plot")
# install.packages("tidymodels")
# install.packages("reticulate")
# install.packages("themis")
# install.packages("ranger")

tidymodels_prefer()
library(randomForest)
library(unbalanced)
library(ranger)
library(caret)
library(reticulate)
library(tidymodels)
library(themis)
library(tidyverse)
library(rpart)
library(rpart.plot)
library(here)
library(ggrepel)
```


#Tidymodels
```{r}
# Input data ----
filename = "ImmuneGO_Genes"
outcomevar = "type_age_sex_day_dose"
df = all_matrices_normalized_counts
ann_vaccines_samples = ann_vaccines_samples

#Select only important genes
PC1_2 = PC_1_2_cos2

# Prepare data ------

df_input <- df %>%
  rownames_to_column("genes") %>%
  inner_join(PC1_2 %>% select(genes) %>% distinct(), by = "genes") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("sample") %>%
  inner_join(ann_vaccines_samples %>% select(sample,type, day, age, sex, dose), by = "sample") %>%
  select(sample, type, everything()) %>%
  column_to_rownames("sample") %>%
  mutate_if(is.character, factor)

glimpse(df_input)

# Split data
set.seed(123)  
split <- initial_split(df_input, prop = 0.7, strata = "type")
trees_train <- training(split)
trees_test <- testing(split)

# Create recipe
tree_rec <- recipe(type ~ ., data = trees_train) %>%
  step_dummy(all_nominal(), -all_outcomes()) %>%
  step_upsample(type) #Upsample unbalanced data

tree_prep <- prep(tree_rec)

juiced <- juice(trtree_prep)

# Set random forest hyper parameters
tune_spec <- rand_forest(
  mtry = tune(),
  trees = 2000,
  min_n = tune()
) %>%
  set_mode("classification") %>% 
  set_engine("ranger")

# Create workflow
tune_wf <- workflow() %>%
  add_recipe(tree_rec) %>%
  add_model(tune_spec)

#Cross validation
set.seed(234)
trees_folds <- vfold_cv(trees_train)

# Parallel computing 
doParallel::registerDoParallel()

set.seed(345)
tune_res <- tune_grid(
  tune_wf,
  resamples = trees_folds,
  grid = 20
)

# Assess data ----
# AUC
metrics_tuneres = tune_res %>%
  collect_metrics() %>%
  filter(.metric == "roc_auc") %>%
  select(mean, min_n, mtry) %>%
  pivot_longer(min_n:mtry,
    values_to = "value",
    names_to = "parameter"
  ) %>%
  ggplot(aes(value, mean, color = parameter)) +
  geom_line() +
  geom_point(show.legend = FALSE) +
  geom_text_repel(aes(label = value))+
  facet_wrap(~parameter, scales = "free_x") +
  labs(x = NULL, y = "AUC")

ggsave(metrics_tuneres, file = paste0(outcomevar, "_tidymodels_tune_res.png"), width = 10, height = 6)

# Tune hyperparameters ----
rf_grid <- grid_regular(
  mtry(range = c(86,100)),
  min_n(range = c(7,11)),
  levels = 5
)

set.seed(456)
regular_res <- tune_grid(
  tune_wf,
  resamples = trees_folds,
  grid = rf_grid
)

# Assess performance -----

regular_res %>%
  collect_metrics() %>% 
  write.csv(file = paste("metrics_finalmodel_", outcomevar, today(), ".csv"), row.names = F)

ggsave(regular_res %>%
  collect_metrics() %>%
  filter(.metric == "roc_auc") %>%
  mutate(min_n = factor(min_n)) %>%
  ggplot(aes(mtry, mean, color = min_n)) +
  geom_line(alpha = 0.5, size = 1.5) +
  geom_point() +
  labs(y = "AUC"), file = paste("roc_auc_", outcomevar, today(), ".png"), width = 10, height = 6)

# Select best model -----
best_auc <- select_best(regular_res, metric = "roc_auc")
final_rf <- finalize_model(
  tune_spec,
  best_auc
)
```


```{r}
library(vip)

final = final_rf %>%
  set_engine("ranger", importance = "permutation") %>%
  fit(type ~ .,
    data = juice(tree_prep)
  ) %>% 
  vip()

final

final %>% ggsave(file = paste0("vipgenes_tidymodels_", outcomevar, today(), ".png"))

genes_rf = final$data
genes_rf
genes_rf %>% write.csv(file = paste0("vipgenes_tidymodels_", outcomevar, today(), ".csv"), row.names = F)
```


```{r}
# Train final model with tuned hyperparameters
final_wf <- workflow() %>%
  add_recipe(tree_rec) %>%
  add_model(final_rf)

final_res <- final_wf %>%
  last_fit(split)

final_res %>%
  collect_metrics() %>% 
write.csv(file = paste0("rf_metrics", outcomevar, today(), ".csv"), row.names = F)

final_res %>%
  collect_predictions() %>%
  mutate(correct = case_when(
    type == .pred_class ~ "Correct",
    TRUE ~ "Incorrect"
  )) %>%
  bind_cols(trees_test)
```

### Heatmaps

#### Gene counts per sample
```{r}
# Heatmap with gene counts per sample 
all_matrices_normalized_counts

# Matrix
counts_imps = genes_rf %>% 
  select(genes = Variable) %>% 
  inner_join(all_matrices_normalized_counts %>% rownames_to_column("genes"), by = "genes") %>%
  pivot_longer(cols =-genes, names_to = "sample", values_to = 'counts') %>% 
  inner_join(ann_vaccines_samples, by = "sample") %>% 
  select(condition, samples = sample, counts, genes) %>% 
  pivot_wider(names_from = c("condition", "samples"), values_from = 'counts') %>% 
  column_to_rownames("genes") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0)

#Annotations
colors_col = genes_rf %>% 
  select(genes = Variable, Importance) %>% 
  inner_join(all_matrices_normalized_counts %>% rownames_to_column("genes") %>% pivot_longer(cols = -genes, names_to = "sample", values_to = "counts"), by = "genes") %>%
  left_join(ann_vaccines_samples, by = "sample") %>%
  left_join(covid_others_colors %>% select(condition, color), by = "condition") %>% 
  select(sample, color) %>% 
  distinct() %>% 
  .$color

colors_row <- genes_rf %>% 
  select(genes = Variable, importance = Importance) %>% 
  inner_join(all_matrices_normalized_counts %>% rownames_to_column("genes") %>% pivot_longer(cols = -genes, names_to = "sample", values_to = "counts"), by = "genes") %>%
  select(genes, importance) %>%
  distinct() %>% 
  mutate(imp_color = circlize::colorRamp2(c(min(importance), max(importance)), c("white", "red"))(importance)) %>% 
  .$imp_color

head(counts_imps)
dim(counts_imps)
length(colors_col)
length(colors_row)


#Plot
png(paste0("randomforest_heatmap_conditions_counts_tidymodels_", outcomevar, today(), ".png"), units="in", width=10, height=10, res=300)
heatmap(counts_imps, 
        col = hcl.colors(100, palette = "reds", rev = T),
        ColSideColors = colors_col, 
        RowSideColors = colors_row, 
        scale = "row",
        margins = c(10, 10))
dev.off()

```

#### Gene L2FC per condition
```{r}
ImmuneGO_Annotated_Genes_all = ImmuneGO_Annotated_Genes_28_2_24 %>% 
  filter(!process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE"))

ImmuneGO_Genes = all_degs_p_05_vac_infected_19_12_23 %>% 
  select(-"...1", -"...12") %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% 
               select(genes, process) %>% 
               distinct() %>% 
               select(genes),
               by = "genes") %>% 
  distinct()

# Matrix
l2fc_imps = genes_rf %>% 
  select(genes = Variable, importance = Importance) %>% 
  inner_join(ImmuneGO_Genes, by = "genes") %>%
  select(genes, condition, log2fold_change) %>% 
  pivot_wider(names_from = condition, values_from = log2fold_change) %>% 
  column_to_rownames("genes") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0)

#Annotations
colors_col = genes_rf %>% 
  select(genes = Variable, importance = Importance) %>% 
  inner_join(ImmuneGO_Genes, by = "genes") %>%
  inner_join(covid_others_colors %>% select(condition, color), by = "condition") %>% 
  select(condition,color) %>% 
  distinct() %>% 
  .$color

colors_row <- genes_rf %>% 
  select(genes = Variable, importance = Importance) %>% 
  inner_join(ImmuneGO_Genes, by = "genes") %>%
  select(genes, condition, log2fold_change, importance) %>% 
  pivot_wider(names_from = condition, values_from = log2fold_change) %>% 
  mutate(imp_color = circlize::colorRamp2(c(min(importance), max(importance)), c("white", "red"))(importance)) %>% 
  .$imp_color

#Plot
png(paste0("randomforest_heatmap_conditions_l2fc", outcomevar, today(), ".png"), units="in", width=10, height=10, res=300)
heatmap(l2fc_imps,
        col = hcl.colors(100, palette = "reds", rev = T),
        ColSideColors = colors_col, 
        RowSideColors = colors_row, 
        scale = "row",
        margins = c(10, 10))
dev.off()
```


```{r}
####### INPUT
data_2 = covid_other_immune_genes_50_mostshared_all
filename_2 = paste0("mmune_GO_genes_All_50", "_VAX_COVID")

######## Matrix
matrix = data_2 %>% 
  select(genes, condition, regulation_numeric) %>%
  pivot_wider(names_from = "condition", 
              values_from = "regulation_numeric", 
              values_fn = mean) %>% 
  replace(is.na(.), 0) %>%
  arrange(genes) %>% 
  column_to_rownames(var="genes") %>% 
  as.matrix()

######## Annotations
ann_vaccines_covid_other_2 = data_2 %>% 
  inner_join(ann_vaccines_covid_other, by = "condition") %>% 
  select(condition, covid_other, microbe_type, disease_vac, type, week) %>% 
  distinct()

#Columns
ann_cols_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  inner_join(ann_vaccines_covid_other_2, by = "condition") %>% 
  distinct() %>% 
  arrange(condition) %>% 
  column_to_rownames("condition")

matrix_data = matrix %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  inner_join(ann_cols_heatmap %>% rownames_to_column("condition"), by = "condition") %>% 
  select(!c(covid_other:week)) %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>%
  as.matrix() 

#Rows Immune ----
ann_rows_immune = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  left_join(ImmuneGO_Annotated_Genes %>% filter(go_term == "Manual"), by = "genes") %>%
  select(genes, process) %>%
  distinct() %>%
  group_by(genes) %>%
  arrange(genes, factor(process, levels = c("INNATE IMMUNE SYSTEM", "ADAPTIVE IMMUNE SYSTEM")), .by_group = TRUE) %>%
  mutate(i_process = row_number()) %>%
  pivot_wider(., names_from = "i_process", values_from = "process") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("index") %>%
  mutate(index = as.numeric(index)) %>%
  arrange(desc(index)) %>%
  column_to_rownames("index") %>%
  t() %>%
  as.data.frame() %>%
  replace(is.na(.), ".") %>% 
  mutate(`1` = if_else(`1` == ".", "INNATE IMMUNE SYSTEM", `1`))


# Rows Not immune -----
ann_rows_notimmune = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  left_join(ann_genes %>%
               select(process = term, genes = symbol, annotation) %>%
               filter(annotation == "Major process",
                      process != "Immune system"), by = "genes") %>%
  select(genes, process) %>%
  distinct() %>%
  group_by(genes) %>%
  mutate(i_process = row_number()) %>%
  pivot_wider(., names_from = "i_process", values_from = "process") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("index") %>%
  arrange(desc(index)) %>%
  column_to_rownames("index") %>%
  t() %>%
  as.data.frame() %>%
  replace(is.na(.), ".")


#Verificar dimensões do dataset
dim(matrix)
dim(matrix_data)
dim(ann_cols_heatmap)
dim(ann_rows_notimmune)
dim(ann_rows_immune)



################# Immune 
#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "right")

row_ha = row_ha = HeatmapAnnotation(df = ann_rows_immune,
                       col = col_process_immune,
                       which= "row",
                       show_annotation_name = F,
                       show_legend = F)

# Values colors
col_fun <- colorRamp2(c(-1, 0, 1), c("#9bc1bc", "white", "#ed6a5a"))

file = filename_2
mat = matrix_data
width_image = 50
height_image = 50
width = unit(30, "cm")
height = unit(30, "cm")
column_names_gp = gpar(fontsize = 12)
row_names_gp = gpar(fontsize = 8)
rect_gp = gpar(col = "gray80", lwd = 0.5)

fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = fileimageheatmap_grouped, 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                       left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        col = col_fun, #color
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "white",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(0, "cm"),
                        row_split = NULL,
                        column_split = 2,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(8, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height)

heatmap_plot = draw(heatmap_plot, 
     annotation_legend_side = "left", 
     heatmap_legend_side = "left")

heatmap_plot

dev.off()

```








#Train and test data
## Define custom parameters
```{r}
# Define parameters ----
set.seed(420)
customRF <- list(type = "Classification",
                   library = "randomForest",
                   loop = NULL)
  
customRF$parameters <- data.frame(parameter = c("mtry", "ntree"),
                                    class = rep("numeric", 2),
                                    label = c("mtry", "ntree"))
  
customRF$grid <- function(x, y, len = NULL, search = "grid") {}

customRF$fit <- function(x, y, wts, param, lev, last, weights, classProbs) {
    randomForest(x, y,
                 mtry = param$mtry,
                 ntree=param$ntree)
  }
  
customRF$predict <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
    predict(modelFit, newdata)
customRF$prob <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
    predict(modelFit, newdata, type = "prob")
customRF$sort <- function(x) x[order(x[,1]),]
customRF$levels <- function(x) x$classes
```


```{r}
# Input data ----
filename = "ImmuneGO_Genes"
df_input = all_matrices_normalized_counts
ann_vaccines_samples = ann_vaccines_samples

#Select only important genes
PC1_2 = PC_1_2_cos2

#Data manipulation
df_random_forest = df_input %>% 
  rownames_to_column("genes") %>% 
  inner_join(PC1_2 %>% select(genes) %>% distinct(), by = "genes") %>% 
  column_to_rownames("genes") %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column("sample") %>% 
  inner_join(ann_vaccines_samples %>% select(sample, disease_vac), by = "sample") %>% 
  select(sample, disease_vac, everything()) %>% 
  column_to_rownames("sample") %>% 
  filter(disease_vac != "H", 
         disease_vac != "Healthy")  %>% 
  rename_with(~ gsub("-", "", .)) %>%
  mutate(disease_vac = if_else(disease_vac == "V", 0, 1))

# Stats
tabyl(df_random_forest$disease_vac)

# Allocate train and test data
sample(1:nrow(df_random_forest), 387) -> train_all # Sample ~70% of total data
df_random_forest[ train_all,] -> all_train # Allocate the 70% to train data
df_random_forest[-train_all,] -> all_test # Allocate the remaining to test data

#Check stats
table(all_train_upsample$disease_vac)
table(all_test$disease_vac)

# Control parameters -----
#Sample control by bootstraping
ctrl = trainControl(method = 'cv', 
                    number = 20, 
                    allowParallel = T)

grid = expand.grid(.mtry = c(1:15), 
                   .ntree = c(500,
                              1500,
                              2000,
                              2500))
# Train -----
rfFit = train(factor(disease_vac) ~ .,
              method = customRF,
              tuneGrid = grid,
              trControl = ctrl,
              metric = 'Accuracy',
              data = all_train)
# Check results
png(file = "randomforest_ntree_mtry_train_plot.png", width = 20, height = 10, units = "cm", res = 320)
plot(rfFit) 
dev.off()

summary(rfFit)

```


```{r}
# Weight factors
vector_RF <- if_else(all_train$disease_vac == 'I', 330, 57)

# Random forest
rf_aab_Pd = randomForest(factor(disease_vac) ~ .,
                         data = all_train, 
                         importance = T,
                         mtry = 7,
                         ntree = 1000,
                         type = 'class',
                         keep.inbag = TRUE
                         #weights = vector_RF
                         )
                         
print(rf_aab_Pd)


# Importance -----
importance(rf_aab_Pd, type = 2, scale= F)

t = importance(rf_aab_Pd, type = 2) %>%  
  as.data.frame() %>% 
  rownames_to_column("var")

imps <- data.frame(var = t$var, imps = t$MeanDecreaseGini/max(t$MeanDecreaseGini)) %>%
  filter(imps > 0.6)
```


```{r}
# Plotting ----

# Importance scores
png("random_with_symp1.png", units="in", width=6, height=6, res=300)
color = ifelse(imps$imps < 0.6, '< 0.6', 
               ifelse(imps$imps > 0.7, '0.6-0.7', '> 0.7'))
imps |>
  ggplot(aes(imps, x = reorder(var, imps))) +
  coord_flip() +
  geom_point(aes(size = imps, fill = color), colour = "black", shape = 21) +
  labs(x = "Predictors", y = "Importance scores") +
  theme_bw(18)+
  scale_fill_manual(values = c('gray', 'red', 'royalblue'))
dev.off()

# OOB error
oob.err.data = data.frame(Trees = rep(1:nrow(rf_aab_Pd$err.rate), 3),
                          Type = rep(c("OOB","0","1"), each = nrow(rf_aab_Pd$err.rate)),
                          Error = c(rf_aab_Pd$err.rate[,"OOB"],rf_aab_Pd$err.rate[,"0"],rf_aab_Pd$err.rate[,"1"]))



png("error_rate11.png", units="in", width=5, height=4, res=300)
ggplot(data = oob.err.data, aes(x = Trees, y= Error)) +
  geom_line(aes(color = Type)) +
  theme_bw(18) +
  ylim(0,1) +
  scale_color_manual(values = c('gray','orange', 'black'))
dev.off()

# decision tree
fit.tree_score = rpart(disease_vac ~ .,
                       data = all_train,
                       method = "class",
                       cp=0.0008,
                       minsplit = 60)
# Decision tree 
png("decision_tree.png", units="in", width=4, height=3, res=300)
rpart.plot(fit.tree_score, box.palette = "Blues") # plot decision tree 
dev.off()

# ROC curve
roc_data = data.frame()
target_variables = colnames(RF_data[2:554])
pred_rf = predict(rf_aab_Pd, all_test, type = 'prob')
pred_rf_df = pred_rf_aab %>% 
  as.data.frame() %>% 
  rownames_to_column("sample")

```


# Heatmap with counts



# Heatmap with L2FC 
```{r}

all_matrices_normalized_counts

# Matrix
l2fc_imps = imps %>% 
  select(genes = var, importance = imps) %>% 
  inner_join(all_matrices_normalized_counts %>% rownames_to_column("genes"), by = "genes") %>%
  select(genes, condition) %>% 
 pivot_wider(names_from = condition, values_from = log2fold_change) %>% 
  column_to_rownames("genes") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0)

#Annotations
colors_col = imps %>% 
  select(genes = var, importance = imps) %>% 
  inner_join(ImmuneGO_Genes, by = "genes") %>%
  inner_join(covid_others_colors %>% select(condition, color), by = "condition") %>% 
  select(condition,color) %>% 
  distinct() %>% 
  .$color

colors_row <- imps %>% 
  select(genes = var, importance = imps) %>% 
  inner_join(ImmuneGO_Genes, by = "genes") %>%
  select(genes, condition, log2fold_change, importance) %>% 
  pivot_wider(names_from = condition, values_from = log2fold_change) %>% 
  mutate(imp_color = circlize::colorRamp2(c(min(importance), max(importance)), c("white", "red"))(importance)) %>% 
  .$imp_color

#Plot
png("randomforest_heatmap_conditions_l2fc.png", units="in", width=10, height=10, res=300)
heatmap(l2fc_imps, ColSideColors = colors, RowSideColors = colors_row, scale = "none",  margins = c(10, 10))
dev.off()

```




# Heatmap with L2FC 
```{r}

ImmuneGO_Annotated_Genes_all = ImmuneGO_Annotated_Genes_28_2_24 %>% 
  filter(!process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE"))

ImmuneGO_Genes = all_degs_p_05_vac_infected_19_12_23 %>% 
  select(-"...1", -"...12") %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% 
               select(genes, process) %>% 
               distinct() %>% 
               select(genes),
               by = "genes") %>% 
  distinct()

# Matrix
l2fc_imps = imps %>% 
  select(genes = var, importance = imps) %>% 
  inner_join(ImmuneGO_Genes, by = "genes") %>%
  select(genes, condition, log2fold_change) %>% 
 pivot_wider(names_from = condition, values_from = log2fold_change) %>% 
  column_to_rownames("genes") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0)

#Annotations
colors_col = imps %>% 
  select(genes = var, importance = imps) %>% 
  inner_join(ImmuneGO_Genes, by = "genes") %>%
  inner_join(covid_others_colors %>% select(condition, color), by = "condition") %>% 
  select(condition,color) %>% 
  distinct() %>% 
  .$color

colors_row <- imps %>% 
  select(genes = var, importance = imps) %>% 
  inner_join(ImmuneGO_Genes, by = "genes") %>%
  select(genes, condition, log2fold_change, importance) %>% 
  pivot_wider(names_from = condition, values_from = log2fold_change) %>% 
  mutate(imp_color = circlize::colorRamp2(c(min(importance), max(importance)), c("white", "red"))(importance)) %>% 
  .$imp_color

#Plot
png("randomforest_heatmap_conditions_l2fc.png", units="in", width=10, height=10, res=300)
heatmap(l2fc_imps, ColSideColors = colors, RowSideColors = colors_row, scale = "none",  margins = c(10, 10))
dev.off()

```

