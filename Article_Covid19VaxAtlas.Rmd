---
title: "Covid-19 Vaccination Atlas: A systems vaccinology analysis"
author: "Wasim Aluísio Prates-Syed"
date: "2024-06-20"
output: 
  html_document: 
    toc: TRUE
    toc_depth: 4
    code_folding: hide
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval=FALSE, cache = TRUE)
```

# Covid-19 Vaccination Atlas: A systems vaccinology analysis

# Article information

**Authors:** Wasim Aluísio Prates-Syed1,2, Dennyson Leandro Mathias da
Fonseca3, Shahab Zaki Pour3, Aline Lira1,2, Nelson Cortes1, 2, Jaqueline
Dinis Queiroz Silva 1,5, Larissa Vuitika¹, Evellyn Carvalho1,4, Tania
Geraldine Churascari Vinces4, Gerhard Wunderlich4, Ricardo
Durães-Carvalho6, Lorena C. S. Chaves7, Niels O. S. Câmara1, Ester
Cerdeira SABINO8,9, José E. Krieger10, Otávio Cabral-Marques1,3,5,11,∙,
Gustavo Cabral-Miranda1,2,5,8 \*, ∙

**Emails:** [wasim.syed\@usp.br](mailto:wasim.syed@usp.br){.email},
[dennyson\@usp.br](mailto:dennyson@usp.br){.email},
[shahab.178\@gmail.com](mailto:shahab.178@gmail.com){.email},
[cv.tania\@usp.br](mailto:cv.tania@usp.br){.email},
[aline.llira\@usp.br](mailto:aline.llira@usp.br){.email},
[nelson.cortes\@usp.br](mailto:nelson.cortes@usp.br){.email},
[jaquelinedinis\@gmail.com](mailto:jaquelinedinis@gmail.com){.email},
[evelyn.carvalho\@unesp.br](mailto:evelyn.carvalho@unesp.br){.email},
[vuitika\@usp.br](mailto:vuitika@usp.br){.email},
[lorenacschaves\@gmail.com](mailto:lorenacschaves@gmail.com){.email},
[gwunder\@usp.br](mailto:gwunder@usp.br){.email},
[rdcarval\@gmail.com](mailto:rdcarval@gmail.com){.email},
[niels\@icb.usp.br](mailto:niels@icb.usp.br){.email},
[sabinoec\@usp.br](mailto:sabinoec@usp.br){.email},
[j.krieger\@hc.fm.usp.br](mailto:j.krieger@hc.fm.usp.br){.email},
[otavio.cmarques\@usp.br](mailto:otavio.cmarques@usp.br){.email},
[gcabral.miranda\@usp.br](mailto:gcabral.miranda@usp.br){.email}

**Institutions:** 1. Department of Immunology, Institute of Biomedical
Sciences (ICB), University of São Paulo (USP), São Paulo, Brazil. 2. The
Interunits Graduate Program in Biotechnology of the University of São
Paulo, the Butantan Institute and the Technological Research Institute
of the State of São Paulo, Brazil. 3. Interunit Postgraduate Program on
Bioinformatics, Institute of Mathematics and Statistics (IME),
University of Sao Paulo (USP), Sao Paulo, Brazil. 4. Department of
Parasitology, Institute of Biomedical Sciences (ICB), University of São
Paulo (USP), São Paulo, Brazil. 5. The Graduate Program in
Pathophysiology and Toxicology, Department of Clinical and Toxicological
Analyses, School of Pharmaceutical Sciences, University of São Paulo,
São Paulo, Brazil. 6. São Paulo School of Medicine, Department of
Microbiology, Immunology and Parasitology, Federal University of São
Paulo (UNIFESP), São Paulo, SP, Brazil. 7. Department of Microbiology
and Immunology, School of Medicine, Emory University, Atlanta, Georgia,
United States. 8. Institute of Tropical Medicine, Faculty of Medicine of
the University of São Paulo, Brazil 9. Department of Infectious and
Parasitic Diseases, Faculty of Medicine, University of São Paulo, São
Paulo, Brazil 10. Heart Institute, Clinical Hospital, Faculty of
Medicine, University of São Paulo, Brazil; Laboratory of Genetics and
Molecular Cardiology, Clinical Hospital, Faculty of Medicine, University
of São Paulo, Brazil. 11. Department of Medicine, Division of Molecular
Medicine, University of São Paulo School of Medicine, São Paulo, Brazil.

# Abstract:

The rapid development of COVID-19 vaccines has played a crucial role in
mitigating its public health impact. However, a gene-level understanding
of immune system dynamics during vaccination is crucial for
comprehending the various vaccination scenarios, including infection. In
this study, we conducted an integrative analysis of immunological
transcriptomic profiles to delineate the impact of COVID-19 vaccination
on immune responses. Our analysis comprised 681 bulk RNAseq samples from
343 participants, including healthy individuals vaccinated with
different types of COVID-19 vaccines (inactivated virus, protein
subunit, viral-vectored, and mRNA), along with infected patients with or
without prior vaccination history. We identified distinct and
overlapping immune-related genes and pathways associated with COVID-19
vaccination and infection, considering time and regimen. Furthermore, we
expanded our analysis to include datasets from vaccines targeting other
pathogens, such as influenza, smallpox, and yellow fever. Additionally,
we introduce VaxGO, a novel tool for exploring immunological processes
and comparing them across different vaccines. Our work will contribute
to advancing our understanding of the immunological mechanisms
underlying Covid-19 vaccination and inform future developments in
vaccine design and personalized medicine. **Keywords:** transcriptomics,
vaccines, COVID-19, SARS-CoV-2.

Read the recent version here:
(<https://www.medrxiv.org/content/10.1101/2024.05.22.24307755v3>)

# Codes for analyses and figures

# 1. Preparing

## 1.1. Packages

```{r message=FALSE, warning=FALSE, cache = TRUE}
# install.packages("randomForest")
# install.packages("caret")
# install.packages("rpart")
# install.packages("rpart.plot")
# install.packages("tidymodels")
# install.packages("reticulate")
# install.packages("themis")
# install.packages("ranger")
# install.packages("workflowsets")
# install.packages("glmnet")
# install.packages("kknn")
# install.packages("nnet")
# install.packages("tictoc")
# install.packages("ggExtra")
# install.packages("remotes")
# remotes::install_github("omnideconv/immunedeconv")
# BiocManager::install("multtest")
# install.packages("metap")
# install.packages("weights")

library(weights)
library(metap)
library(randomForest)
library(ranger)
library(caret)
library(reticulate)
library(themis)
library(rpart)
library(rpart.plot)
library(here)
library(ggrepel)
library(ComplexHeatmap)
library(janitor)
library(ggsci)
library(vip)
library(circlize)
library(workflowsets)
library(glmnet)
library(kknn)
library(nnet)
library(tictoc)
library(ggthemes)
library(readr)
library(qvalue)
library(explore)
library(GEOquery)
library(Matrix)
library(RColorBrewer)
library(celldex)
library(biomaRt)
library(org.Hs.eg.db)
library(plotly)
library(DESeq2)
library(msigdbr)
library(clusterProfiler)
library(EnhancedVolcano)
library(ggbeeswarm)
library(corrr)
library(ggcorrplot)
library(FactoMineR)
library(factoextra)
library(esquisse)
library(corto)
library(circlize)
library(ComplexHeatmap)
library(scales)
library(ggstatsplot)
library(patchwork)
library(vegan)
library(BH)
library(chorddiag)
library(tidyverse)
library(tidymodels)
library(purrr)
library(immunedeconv)
tidymodels_prefer()
```

## 1.2. Standardize figures

```{r cache = TRUE, message=FALSE, warning=FALSE}
### VAX SIG DB ----
ann_vaxsig_colors = list(
  type = c("VLP" = "#7E6148FF",
           "LA" =  "#E64B35FF",
           "CONJ" = "#F39B7FFF", 
           'IN'= "#00A087FF", #1st Gen  vaccines
           'VV' = "#3C5488FF", #3rd Gen vaccines
           'RNA' = "#4DBBD5FF",
           'SU' = "#8491B4FF",
           'I'= "#DC0000FF",
           "H" = "grey95"),
  Platform = c("VLP" = "#7E6148FF",
           "LA" =  "#E64B35FF",
           "CONJ" = "#F39B7FFF", 
           'IN'= "#00A087FF", #1st Gen  vaccines
           'VV' = "#3C5488FF", #3rd Gen vaccines
           'RNA' = "#4DBBD5FF",
           'SU' = "#8491B4FF",
           'I'= "#DC0000FF",
           "H" = "grey95"),
  target_pathogen_disease = c('MENINGOCOCCUS'	= "#00A087FF",
                              'PNEUMOCOCCUS'	= "#44C199",
                              'TUBERCULOSIS'	= "#99e2b4",
                              'F TULARENSIS'	= "#4DBBD5FF",
                              'LEISHMANIA'	= "#118ab2",
                              'MALARIA' = "#015BA0",
                              'EBOV'	= "#5e60ce",
                              'HBV'	= "#D7B0EE",
                              'HBV, HAV'	= "#D7B0EE",
                              'HIV'	= "#b5179e",
                              'HPV'	= "#c77dff",
                              'INFLUENZA'	= "#deaaff",
                              'MEASLES'	= "#9d4edd",
                              'MMR'	= "#7b2cbf",
                              'SMALLPOX'	= "#e5b3fe",
                              'VEEV'	= "#ecbcfd",
                              'VZV'	= "#c8b6ff",
                              'YF'	= "#b8c0ff"),
  covid_other = c("COVID" = "#DC0000FF",
                  "OTHER" = "#4DBBD5FF"),
  microbe_type = c("VIRUS" = "#5e60ce",
                   'BACTERIUM' = "#00A087FF",
                   'PARASITE' = "#7E6148FF"),
  
  week = c("0" = "#ECF8FA",
           "1" = "#caf0f8",
           "2" = "#6CD5EA",
           "3" = "#0087BF",
           "4" = "#015BA0", 
           "6" = "#03045e",
           "7" = "#03045e",
           "8" = "#03045e"),
  month = c("1" = "#caf0f8",
            "0" = "#6CD5EA",
            "2" = "#015BA0"),
  vaccine = c("BBIBP" = "#00A087FF",
              "ZF2001" = "#8491B4FF",
              "BNT" = "#4DBBD5FF",
              "MO" = "#72ddf7",
              "ChAd" = "#3C5488FF",
              "I" = "grey95",
              "H" = "grey95"),
  dose = c(
    "0" = "grey95",
    "1" = "#91D1C2A0",
    "2" = "#00A087FF",
    "3" = "#3C5488FF"),
  day = c(
    "0" = "white",
    "1" = "#caf0f8",
    "2" = "#ade8f4",
    "3" = "#90e0ef",
    "4" = "#6CD5EA",
    "5" = "#48cae4",
    "6" = "#00b4d8",
    "7" = "#0096c7",
    "10" = "#0087BF",
    "11" = "#0087BF",
    "14" = "#0077b6",
    "26" = "#015BA0",
    "28" = "#023e8a",
    "51" = "#03045e"),
  infection = c("0" = "white",
                "1" = "#00A087FF",
                "2" = "#3C5488FF"),
  variant = c("None" = "grey95",
              "Beta" = "#00A087FF",
              "Omicron" = "#3C5488FF"),
  severity = c("H" = "grey95",
               "S" = "#DC0000FF",
               "MO" = "#8491B4FF",
               "MI" = "#91D1C2FF",
               "NA" = "grey95"),
  sex = c("Male" = "#4DBBD5FF",
          "Female" = "#E64B35FF",
          "M/F" = "#8491B4FF"),
  disease_vac = c("I" = "#DC0000FF",
                  "V" = "#4DBBD5FF",
                  "H" = "grey95"),
  correct = c("Correct" = "#00A087FF",
              "Incorrect" = "#DC0000FF"),
  condition_col = c(
                                "BBIBP (V3, D07)" = "#00A087FF",
                                "BBIBP (V3, D14)" = "#00A087FF",
                                "BBIBP (V3, D28)" = "#00A087FF",
                                "BNT (V1, D6)" = "#4DBBD5FF",
                                "BNT (V2, D1)" = "#4DBBD5FF",
                                "BNT (V3, D1)" = "#4DBBD5FF",
                                "BNT-I (D1)"= "#DC0000FF",
                                "BNT-I (D10, mild)"= "#DC0000FF",
                                "BNT-I (D10, severe)"= "#DC0000FF",
                                "BNT-I (D2)"= "#DC0000FF",
                                "BNT-I (D26, mild)"= "#DC0000FF",
                                "BNT-I (D26, severe)"= "#DC0000FF",
                                "BNT-I (D3)"= "#DC0000FF",
                                "BNT-I (D4)"= "#DC0000FF",
                                "BNT-I (D51, severe)"= "#DC0000FF",
                                "BNT-I-BNT (D51, mild)"= "#F5BB00",
                                "BNT-I-BNT (D51, severe)"= "#F5BB00",
                                "BNT-MO (V1, D6)"= "#72ddf7",
                                "BNT-MO (V3, D1)"= "#72ddf7",
                                "ChAd (V1, D3)"= "#3C5488FF",
                                "ChAd (V1, D6)"= "#3C5488FF",
                                "ChAd (V1, D7)"= "#3C5488FF",
                                "ChAd (V2, D1)"= "#3C5488FF",
                                "ChAd (V2, D3)"= "#3C5488FF",
                                "ChAd (V2, D7)"= "#3C5488FF",
                                "ChAd-BNT (V2, D0)"= "#4DBBD5FF",
                                "ChAd-BNT (V2, D3)"= "#4DBBD5FF",
                                "ChAd-BNT (V2, D7)"= "#4DBBD5FF",
                                "ChAd-BNT (V3, D1)"= "#4DBBD5FF",
                                "I (D1)"= "#DC0000FF",
                                "I (D10, moderate)"= "#DC0000FF",
                                "I (D10, severe)"= "#DC0000FF",
                                "I (D26, moderate)"= "#DC0000FF",
                                "I (D26, severe)"= "#DC0000FF",
                                "I (D51, moderate)"= "#DC0000FF",
                                "I (D51, severe)"= "#DC0000FF",
                                "I-BNT-I (D2)"= "#DC0000FF",
                                "I-BNT-I (D5)"= "#DC0000FF",
                                "I-I (D0)"= "#DC0000FF",
                                "I-I (D1)"= "#DC0000FF",
                                "I-I (D2)"= "#DC0000FF",
                                "I-I (D3)"= "#DC0000FF",
                                "I-I (D5)"= "#DC0000FF",
                                "ZF2001 (V3, D07)"= "#8491B4FF",
                                "ZF2001 (V3, D14)"= "#8491B4FF",
                                "ZF2001 (V3, D28)" = "#8491B4FF"
                              )
)



# Not immune processes -----
col_process_notimmune = list(
  "1" = c("Cellular" = "#3C5488FF",
          "Interspecies interaction" = "#00A087FF",
          "Metabolism" = "#4DBBD5FF",
          "Reg. of BP" = "#E64B35FF",
          "."="white"),
  "2" = c("Cellular" = "#3C5488FF",
          "Interspecies interaction" = "#00A087FF",
          "Metabolism" = "#4DBBD5FF",
          "Reg. of BP" = "#E64B35FF",
          "."="white"),
  "3" = c("Cellular" = "#3C5488FF",
          "Interspecies interaction" = "#00A087FF",
          "Metabolism" = "#4DBBD5FF",
          "Reg. of BP" = "#E64B35FF",
          "."="white"),
  "4" = c("Cellular" = "#3C5488FF",
          "Interspecies interaction" = "#00A087FF",
          "Metabolism" = "#4DBBD5FF",
          "Reg. of BP" = "#E64B35FF",
          "."="white"),
  "5" = c("Cellular" = "#3C5488FF",
          "Interspecies interaction" = "#00A087FF",
          "Metabolism" = "#4DBBD5FF",
          "Reg. of BP" = "#E64B35FF",
          "."="white"))


#Immune processes ------
col_process_immune = list(
  "1" = c("ADAPTIVE IMMUNE SYSTEM" = "#6f2dbd",
          "B CELL" = "#7b2cbf",
          "CELLULAR ADAPTIVE IMMUNE SYSTEM" = "#e0aaff",
          "HUMORAL ADAPTIVE IMMUNE SYSTEM" = "#9d4edd",
          "IMMUNOGLOBULIN MEDIATED RESPONSE"= "#5a189a",
          "T CELLS" = "#c77dff",
          "T HELPER CELLS" = "#c77dcc",
          "COMPLEMENT" = "#ffadc7",
          "ANTIVIRAL & IFN" = "#88d4ab",
          "ARPP" = "#14746f",
          "DENDRITIC CELL" = "#036666",
          "EOSINOPHIL" = "#67b99a",
          "INFLAMMATION" = "#99e2b4",
          "INNATE IMMUNE SYSTEM" = "#06d6a0",
          "MAST CELL" = "#56ab91",
          "MONOCYTE" = "#358f80",
          "NEUTROPHIL" = "#78c6a3",
          "NK CELL" = "#469d89",
          "MACROPHAGE" = "#14746f",
          "GENERAL" = "#343a40",
          "ANTIMICROBIAL" = "#48cae4",
          "."="white"),
  "2" = c("ADAPTIVE IMMUNE SYSTEM" = "#6f2dbd",
          "B CELLS" = "#7b2cbf",
          "CELLULAR ADAPTIVE IMMUNE SYSTEM" = "#e0aaff",
          "HUMORAL ADAPTIVE IMMUNE SYSTEM" = "#9d4edd",
          "IMMUNOGLOBULIN MEDIATED RESPONSE"= "#5a189a",
          "T CELL" = "#c77dff",
          "T HELPER CELLS" = "#c77dcc",
          "COMPLEMENT" = "#ffadc7",
          "ANTIVIRAL & IFN" = "#88d4ab",
          "ARPP" = "#14746f",
          "DENDRITIC CELL" = "#036666",
          "EOSINOPHIL" = "#67b99a",
          "INFLAMMATION" = "#99e2b4",
          "INNATE IMMUNE SYSTEM" = "#06d6a0",
          "MAST CELL" = "#56ab91",
          "MONOCYTE" = "#358f80",
          "NEUTROPHIL" = "#78c6a3",
          "NK CELL" = "#469d89",
          "MACROPHAGE" = "#14746f",
          "GENERAL" = "#343a40",
          "ANTIMICROBIAL" = "#48cae4",
          "."="white"),
  "3" = c("ADAPTIVE IMMUNE SYSTEM" = "#6f2dbd",
          "B CELL" = "#7b2cbf",
          "CELLULAR ADAPTIVE IMMUNE SYSTEM" = "#e0aaff",
          "HUMORAL ADAPTIVE IMMUNE SYSTEM" = "#9d4edd",
          "IMMUNOGLOBULIN MEDIATED RESPONSE"= "#5a189a",
          "T CELL" = "#c77dff",
          "T HELPER CELLS" = "#c77dcc",
          "COMPLEMENT" = "#ffadc7",
          "ANTIVIRAL & IFN" = "#88d4ab",
          "ARPP" = "#14746f",
          "DENDRITIC CELL" = "#036666",
          "EOSINOPHIL" = "#67b99a",
          "INFLAMMATION" = "#99e2b4",
          "INNATE IMMUNE SYSTEM" = "#06d6a0",
          "MAST CELL" = "#56ab91",
          "MONOCYTE" = "#358f80",
          "NEUTROPHIL" = "#78c6a3",
          "NK CELL" = "#469d89",
          "MACROPHAGE" = "#14746f",
          "GENERAL" = "#343a40",
          "ANTIMICROBIAL" = "#48cae4",
          "."="white"),
  "4" = c("ADAPTIVE IMMUNE SYSTEM" = "#6f2dbd",
          "B CELL" = "#7b2cbf",
          "CELLULAR ADAPTIVE IMMUNE SYSTEM" = "#e0aaff",
          "HUMORAL ADAPTIVE IMMUNE SYSTEM" = "#9d4edd",
          "IMMUNOGLOBULIN MEDIATED RESPONSE"= "#5a189a",
          "T CELL" = "#c77dff",
          "T HELPER CELLS" = "#c77dcc",
          "COMPLEMENT" = "#ffadc7",
          "ANTIVIRAL & IFN" = "#88d4ab",
          "ARPP" = "#14746f",
          "DENDRITIC CELL" = "#036666",
          "EOSINOPHIL" = "#67b99a",
          "INFLAMMATION" = "#99e2b4",
          "INNATE IMMUNE SYSTEM" = "#06d6a0",
          "MAST CELL" = "#56ab91",
          "MONOCYTE" = "#358f80",
          "NEUTROPHIL" = "#78c6a3",
          "NK CELL" = "#469d89",
          "MACROPHAGE" = "#14746f",
          "GENERAL" = "#343a40",
          "ANTIMICROBIAL" = "#48cae4",
          "."="white"),
  "5" = c("ADAPTIVE IMMUNE SYSTEM" = "#6f2dbd",
          "B CELL" = "#7b2cbf",
          "CELLULAR ADAPTIVE IMMUNE SYSTEM" = "#e0aaff",
          "HUMORAL ADAPTIVE IMMUNE SYSTEM" = "#9d4edd",
          "IMMUNOGLOBULIN MEDIATED RESPONSE"= "#5a189a",
          "T CELL" = "#c77dff",
          "T HELPER CELLS" = "#c77dcc",
          "COMPLEMENT" = "#ffadc7",
          "ANTIVIRAL & IFN" = "#88d4ab",
          "ARPP" = "#14746f",
          "DENDRITIC CELL" = "#036666",
          "EOSINOPHIL" = "#67b99a",
          "INFLAMMATION" = "#99e2b4",
          "INNATE IMMUNE SYSTEM" = "#06d6a0",
          "MAST CELL" = "#56ab91",
          "MONOCYTE" = "#358f80",
          "NEUTROPHIL" = "#78c6a3",
          "NK CELL" = "#469d89",
          "MACROPHAGE" = "#14746f",
          "GENERAL" = "#343a40",
          "ANTIMICROBIAL" = "#48cae4",
          "."="white"),
  "6" = c("ADAPTIVE IMMUNE SYSTEM" = "#6f2dbd",
          "B CELL" = "#7b2cbf",
          "CELLULAR ADAPTIVE IMMUNE SYSTEM" = "#e0aaff",
          "HUMORAL ADAPTIVE IMMUNE SYSTEM" = "#9d4edd",
          "IMMUNOGLOBULIN MEDIATED RESPONSE"= "#5a189a",
          "T CELL" = "#c77dff",
          "T HELPER CELLS" = "#c77dcc",
          "COMPLEMENT" = "#ffadc7",
          "ANTIVIRAL & IFN" = "#88d4ab",
          "ARPP" = "#14746f",
          "DENDRITIC CELL" = "#036666",
          "EOSINOPHIL" = "#67b99a",
          "INFLAMMATION" = "#99e2b4",
          "INNATE IMMUNE SYSTEM" = "#06d6a0",
          "MAST CELL" = "#56ab91",
          "MONOCYTE" = "#358f80",
          "NEUTROPHIL" = "#78c6a3",
          "NK CELL" = "#469d89",
          "MACROPHAGE" = "#14746f",
          "GENERAL" = "#343a40",
          "ANTIMICROBIAL" = "#48cae4",
          "."="white"),
  "7" =c("ADAPTIVE IMMUNE SYSTEM" = "#6f2dbd",
         "B CELL" = "#7b2cbf",
         "CELLULAR ADAPTIVE IMMUNE SYSTEM" = "#e0aaff",
         "HUMORAL ADAPTIVE IMMUNE SYSTEM" = "#9d4edd",
         "IMMUNOGLOBULIN MEDIATED RESPONSE"= "#5a189a",
         "T CELL" = "#c77dff",
         "T HELPER CELLS" = "#c77dcc",
         "COMPLEMENT" = "#ffadc7",
         "ANTIVIRAL & IFN" = "#88d4ab",
         "ARPP" = "#14746f",
         "DENDRITIC CELL" = "#036666",
         "EOSINOPHIL" = "#67b99a",
         "INFLAMMATION" = "#99e2b4",
         "INNATE IMMUNE SYSTEM" = "#06d6a0",
         "MAST CELL" = "#56ab91",
         "MONOCYTE" = "#358f80",
         "NEUTROPHIL" = "#78c6a3",
         "NK CELL" = "#469d89",
         "MACROPHAGE" = "#14746f",
         "GENERAL" = "#343a40",
         "ANTIMICROBIAL" = "#48cae4",
         "."="white"),
  "8" = c("ADAPTIVE IMMUNE SYSTEM" = "#6f2dbd",
          "B CELL" = "#7b2cbf",
          "CELLULAR ADAPTIVE IMMUNE SYSTEM" = "#e0aaff",
          "HUMORAL ADAPTIVE IMMUNE SYSTEM" = "#9d4edd",
          "IMMUNOGLOBULIN MEDIATED RESPONSE"= "#5a189a",
          "T CELL" = "#c77dff",
          "T HELPER CELLS" = "#c77dcc",
          "COMPLEMENT" = "#ffadc7",
          "ANTIVIRAL & IFN" = "#88d4ab",
          "ARPP" = "#14746f",
          "DENDRITIC CELL" = "#036666",
          "EOSINOPHIL" = "#67b99a",
          "INFLAMMATION" = "#99e2b4",
          "INNATE IMMUNE SYSTEM" = "#06d6a0",
          "MAST CELL" = "#56ab91",
          "MONOCYTE" = "#358f80",
          "NEUTROPHIL" = "#78c6a3",
          "NK CELL" = "#469d89",
          "MACROPHAGE" = "#14746f",
          "GENERAL" = "#343a40",
          "ANTIMICROBIAL" = "#48cae4",
          "."="white"),
  "9" = c("ADAPTIVE IMMUNE SYSTEM" = "#6f2dbd",
          "B CELL" = "#7b2cbf",
          "CELLULAR ADAPTIVE IMMUNE SYSTEM" = "#e0aaff",
          "HUMORAL ADAPTIVE IMMUNE SYSTEM" = "#9d4edd",
          "IMMUNOGLOBULIN MEDIATED RESPONSE"= "#5a189a",
          "T CELL" = "#c77dff",
          "T HELPER CELLS" = "#c77dcc",
          "COMPLEMENT" = "#ffadc7",
          "ANTIVIRAL & IFN" = "#88d4ab",
          "ARPP" = "#14746f",
          "DENDRITIC CELL" = "#036666",
          "EOSINOPHIL" = "#67b99a",
          "INFLAMMATION" = "#99e2b4",
          "INNATE IMMUNE SYSTEM" = "#06d6a0",
          "MAST CELL" = "#56ab91",
          "MONOCYTE" = "#358f80",
          "NEUTROPHIL" = "#78c6a3",
          "NK CELL" = "#469d89",
          "MACROPHAGE" = "#14746f",
          "GENERAL" = "#343a40",
          "ANTIMICROBIAL" = "#48cae4",
          "."="white"),
  "10" = c("ADAPTIVE IMMUNE SYSTEM" = "#6f2dbd",
           "B CELL" = "#7b2cbf",
           "CELLULAR ADAPTIVE IMMUNE SYSTEM" = "#e0aaff",
           "HUMORAL ADAPTIVE IMMUNE SYSTEM" = "#9d4edd",
           "IMMUNOGLOBULIN MEDIATED RESPONSE"= "#5a189a",
           "T CELL" = "#c77dff",
           "T HELPER CELLS" = "#c77dcc",
           "COMPLEMENT" = "#ffadc7",
           "ANTIVIRAL & IFN" = "#88d4ab",
           "ARPP" = "#14746f",
           "DENDRITIC CELL" = "#036666",
           "EOSINOPHIL" = "#67b99a",
           "INFLAMMATION" = "#99e2b4",
           "INNATE IMMUNE SYSTEM" = "#06d6a0",
           "MAST CELL" = "#56ab91",
           "MONOCYTE" = "#358f80",
           "NEUTROPHIL" = "#78c6a3",
           "NK CELL" = "#469d89",
           "MACROPHAGE" = "#14746f",
           "GENERAL" = "#343a40",
           "ANTIMICROBIAL" = "#48cae4",
           "."="white"),
  "11" = c("ADAPTIVE IMMUNE SYSTEM" = "#6f2dbd",
           "B CELL" = "#7b2cbf",
           "CELLULAR ADAPTIVE IMMUNE SYSTEM" = "#e0aaff",
           "HUMORAL ADAPTIVE IMMUNE SYSTEM" = "#9d4edd",
           "IMMUNOGLOBULIN MEDIATED RESPONSE"= "#5a189a",
           "T CELL" = "#c77dff",
           "T HELPER CELLS" = "#c77dcc",
           "COMPLEMENT" = "#ffadc7",
           "ANTIVIRAL & IFN" = "#88d4ab",
           "ARPP" = "#14746f",
           "DENDRITIC CELL" = "#036666",
           "EOSINOPHIL" = "#67b99a",
           "INFLAMMATION" = "#99e2b4",
           "INNATE IMMUNE SYSTEM" = "#06d6a0",
           "MAST CELL" = "#56ab91",
           "MONOCYTE" = "#358f80",
           "NEUTROPHIL" = "#78c6a3",
           "NK CELL" = "#469d89",
           "MACROPHAGE" = "#14746f",
           "GENERAL" = "#343a40",
           "ANTIMICROBIAL" = "#48cae4",
           "."="white"),
  "12" = c("ADAPTIVE IMMUNE SYSTEM" = "#6f2dbd",
           "B CELL" = "#7b2cbf",
           "CELLULAR ADAPTIVE IMMUNE SYSTEM" = "#e0aaff",
           "HUMORAL ADAPTIVE IMMUNE SYSTEM" = "#9d4edd",
           "IMMUNOGLOBULIN MEDIATED RESPONSE"= "#5a189a",
           "T CELL" = "#c77dff",
           "T HELPER CELLS" = "#c77dcc",
           "COMPLEMENT" = "#ffadc7",
           "ANTIVIRAL & IFN" = "#88d4ab",
           "ARPP" = "#14746f",
           "DENDRITIC CELL" = "#036666",
           "EOSINOPHIL" = "#67b99a",
           "INFLAMMATION" = "#99e2b4",
           "INNATE IMMUNE SYSTEM" = "#06d6a0",
           "MAST CELL" = "#56ab91",
           "MONOCYTE" = "#358f80",
           "NEUTROPHIL" = "#78c6a3",
           "NK CELL" = "#469d89",
           "MACROPHAGE" = "#14746f",
           "GENERAL" = "#343a40",
           "ANTIMICROBIAL" = "#48cae4",
           "."="white"))

```

# 2. Select studies and retrieve data

## 2.1. Download and process data

Download general data (counts data and metadata). GEO supplementary
files have the counts matrices. Download studies individually. I
recommend downloading large files from the GEO website.

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, cache = TRUE}
# Function to read and standardize files
read_standardize <- function(file) {
  files <- read.table(file, header = FALSE, sep = "\t")
  if (ncol(files) >= 2) {
    colnames(file)[1:2] <- c("genes", tools::file_path_sans_ext(basename(file)))
    return(files)
  } else {
    return(NULL)
  }
}
```

GSE189039

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, cache = TRUE}
###### GSE189039 ----
#Metadata 
filename = "GSE189039"
GSE189039 <- getGEO("GSE189039", GSEMatrix = TRUE) 
GSE189039 <- GSE189039[[1]]
GSE189039_metadata = GSE189039 %>% 
  pData() %>% 
  select( 
    geo_sample = "geo_accession", 
    subject_id = "title", age = "age:ch1", 
    sex = "gender:ch1", disease_state = "diseas state:ch1", 
    severity = "severity:ch1") 
write_csv(GSE189039_metadata, file = here("raw_data", "GSE189039_metadata.csv"))

#Counts matrix
#Retrieve counts table from supplementary files
getGEOSuppFiles('GSE189039', makeDirectory = T, baseDir = here("raw_data"))
untar(here("raw_data", 'GSE189039_RAW.tar'))
files <- list.files(path = here("raw_data", "GSE189039"), pattern = "*.gz$", full.names = TRUE)
for(files_gz in files) {gunzip(files_gz)}
files_txt_GSE189039 <- list.files(path = here("raw_data", "GSE189039"), pattern = "*.txt$", full.names = TRUE)
list_data_GSE189039 <- lapply(files_txt_GSE189039, read_standardize)
counts_GSE189039 <- list_data_GSE189039 %>%
  purrr::discard(is.null) %>%
  reduce(full_join, by = "genes")
colnames(counts_GSE189039)[-1] <- gsub("^[^_]+_(.*)", "\\1", colnames(counts_GSE189039)[-1])
write_csv(counts_GSE189039, file = here("raw_data", "gse189039_counts.csv"))
```

GSE201533

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, cache = TRUE}
###### GSE201533 ------

###### Metadata
GSE201533 <- getGEO("GSE201533", GSEMatrix = TRUE, destdir = here("raw_data", "GSE201533")) 

GSE201533 <- GSE201533[[1]]

GSE201533_metadata = GSE201533 %>% 
  pData() %>% 
  select(
    geo_sample = "geo_accession", 
    sample_id = "title", age = "age:ch1", 
    sex = "gender:ch1", 
    dose_vaccine = "vaccine:ch1")

GSE201533_metadata = GSE201533_metadata %>%
  separate(sample_id, into = c("participant_id", "time"), sep = "-D", remove = F) %>%
  separate(dose_vaccine, into = c("dose", "vaccine"), sep = ",\\s*(?=[A-Z])", extra = "merge") %>%
  mutate(dose = str_extract(dose, "\\d+"),
         vaccine = if_else(vaccine == "ChAdOx1", "ChAd", "BNT"),
         condition = paste0(vaccine, " (V", dose, ", D", time, ")"),
         geo = "GSE201533") 

write_csv(GSE201533_metadata, file = here("raw_data", "GSE201533_metadata.csv"))

##### Counts matrix
getGEOSuppFiles('GSE201533', makeDirectory = T, baseDir = here("raw_data"))
untar(tarfile = here("raw_data", "GSE201533", "GSE201533_RAW.tar"))

list_data_gse201533 <- list.files(path = here("raw_data", 
                                              "GSE201533", 
                                              "GSE201533_RAW"), 
                                  pattern = "*.txt.gz$", 
                                  full.names = TRUE) %>%
  map(~ read.table(.x, header = TRUE, sep = "\t"))
counts_gse201533 <- do.call(cbind, map(list_data_gse201533, ~ .x[, 2]))

# Name columns (samples) and genes
colnames(counts_gse201533) <- paste0("GSM", seq_along(list_data_gse201533) + 6066177)
counts_gse201533 <- bind_cols(geneid = list_data_gse201533[[1]][, 1], counts_gse201533)
counts_gse201533[is.na(counts_gse201533)] <- 0 #Rename column names (ex. "X21.01684.hisat2.bam") to GSM codes, which start with GSM6066178.

counts_gse201533 <- list_data_gse201533 %>%
  purrr::map_dfc(~ .x[, 2]) %>%
  set_names(paste0("Sample_", seq_along(list_data_gse201533))) %>%
  bind_cols(geneid = list_data_gse201533[[1]][, 1], .) %>%
  relocate(geneid) %>%
  replace(is.na(.), 0)

saveRDS(counts_gse201533, file = here("raw_data", "gse201533_counts.rds"))
write.csv(counts_gse201533, file=here("raw_data", "gse201533_counts.csv"))
```

GSE201530

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, cache = TRUE}
###### GSE201530 ------
#Metadata
filename = "GSE201530"
GSE201530 <- getGEO("GSE201530", GSEMatrix = TRUE) 
GSE201530 <- GSE201530[[1]]
GSE201530_metadata = GSE201530 %>% 
  pData() %>% 
  select(
    geo_sample = "geo_accession", 
    subject_id = "title", 
    age = "age:ch1", 
    sex = "gender:ch1", 
    disease_state = "disease state:ch1", 
    timepoint = "days after positive pcr results:ch1",
    group = "group (by covid-19 vaccination, prior infection):ch1",
    variant = "omicron sublineage:ch1") 
write.csv(GSE201530_metadata, file = here("raw_data", "GSE201530_metadata.csv"))

# Counts matrix
getGEOSuppFiles('GSE201530', baseDir = here("raw_data"))
untar(here("raw_data", 'GSE201530_RAW.tar'))
files_txt_GSE201530 <- list.files(path = here("raw_data", "GSE201530"), pattern = "*.txt$", full.names = TRUE)
list_data_GSE201530 <- lapply(files_txt_GSE201530, read_standardize)
counts_gse201530 <- list_data_GSE201530 %>%
  purrr::discard(is.null) %>%
  reduce(full_join, by = "genes")
colnames(counts_gse201530)[-1] <- gsub("^[^_]+_(.*)", "\\1", colnames(counts_gse201530)[-1])
write_csv(counts_gse201530, file = here("raw_data", "gse201530_counts.csv"))
```

GSE199750

As we couldn't retrieved all GSE199750 counts matrices through R, we
downloaded the counts table from the Github repository:
<https://bitbucket.org/lynnlab/covirs>.

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, cache = TRUE}
###### GSE199750 ----
#Metadata
gse199750 <- getGEO("GSE199750", GSEMatrix = TRUE,  destdir = here("raw_data", "GSE199750")) 
gse199750 <- gse199750[[1]]
gse199750_metadata <- pData(gse199750) %>% 
  select(
    GEO = "geo_accession", 
    SampleN = "sample number:ch1", 
    SubjectID = "subject_id:ch1", 
    Age = "age:ch1", 
    Sex = "Sex:ch1", 
    Vaccine = "vaccine:ch1", 
    FirstSecondVaccine = "first/second vaccine:ch1", 
    ThirdVaccine = "third vaccine:ch1", 
    Timepoint = "timepoint:ch1",
    Tissue = "tissue:ch1", 
    Run = "run:ch1"
  )

#There are two similar columns. The first, "Vaccine," might be filled in, while the second, "FirstSecondVaccine," may not be, and vice versa. Therefore, one should equal the other. Thus, unify the columns.

gse199750_metadata <- gse199750_metadata %>%
  mutate(
    FirstSecondDose = coalesce(FirstSecondVaccine, Vaccine),
    Subject_Timepoint = paste(SubjectID, Timepoint, sep = "_")
  ) %>%
  select(
    Subject_Timepoint, GEO, SampleN, SubjectID, Age, Sex, Timepoint, 
    FirstSecondDose, ThirdVaccine, Tissue, Run
  ) %>%
  mutate(Age_ranges = cut(
    Age, 
    breaks = c(0, 18, 30, 45, 60, 70, 80, Inf), 
    labels = c("<18", "18-29", "30-44", "45-59", "60-69", "70-79", "80>"), 
    right = FALSE
  ) %>% 
  column_to_rownames("Subject_Timepoint")

write.csv(gse199750_metadata, file =here("raw_data", "metadata_gse199750.csv"))
saveRDS(gse199750_metadata, file = here("raw_data", "gse199750_metadata.rds"))

# Counts matrix
raw_RNASeq_counts = readRDS(here("raw_data", "raw_RNASeq_counts.RDS"))

# The counts table provided by the study("https://bitbucket.org/lynnlab/covirs/src/master/raw_RNASeq_counts.RDS") is named with Subject ID + Timepoint and not with the GSM code. Therefore, we will need to process the metadata table. Additionally, it lacks the age column. These data can be manipulated in Excel.
############# Gene annotation -----
library("biomaRt")

mart <- useMart("ensembl")
mart <- useDataset("hsapiens_gene_ensembl", mart)

gene_info <- getBM(attributes = c("entrezgene_id", "hgnc_symbol", "ensembl_gene_id"), 
                   mart = mart) %>% 
  select(ensembl_gene_id, hgnc_symbol) %>% 
  distinct()

raw_RNASeq_counts_ann <- raw_RNASeq_counts %>% 
  rownames_to_column("ensembl_gene_id") %>% 
  inner_join(gene_info, by = "ensembl_gene_id") %>% 
  filter(hgnc_symbol != "") %>% 
  distinct() %>%
  select(sort(names(.))) %>% 
  select(genes = hgnc_symbol, ensembl_gene_id, everything()) %>% 
  arrange(genes)

#Save
write_csv(raw_RNASeq_counts_ann, file= here("raw_data", "raw_RNASeq_counts_annGenes.csv"))

#Filter duplicated genes. Get only the older ensembl ids

not_interes = raw_RNASeq_counts_ann %>% 
  get_dupes(genes) %>% 
  group_by(genes) %>% 
  arrange(ensembl_gene_id) %>% 
  slice(2) %>% 
  ungroup() %>% 
  select(ensembl_gene_id)

gse199750_counts_ready = raw_RNASeq_counts_ann %>% 
  anti_join(not_interes, by = "ensembl_gene_id") %>% 
  select(-ensembl_gene_id) %>% 
  column_to_rownames("genes")

# Save
saveRDS(gse199750_counts_ready, file= here("raw_data", "gse199750_counts_ready.rds"))

```

GSE206023

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, cache = TRUE}
######### GSE206023 ------- 
gse206023 <- getGEO("GSE206023", 
                    GSEMatrix = TRUE,  
                    destdir = here("raw_data")) 

gse206023 <- gse206023[[1]]
gse206023_metadata <- pData(gse206023)
colnames(gse206023_metadata)

gse206023_metadata <- select(gse206023_metadata, "title", "geo_accession", "source_name_ch1", "organism_ch1", "time:ch1", "treatment:ch1"  )

colnames(gse206023_metadata) <-
  c("Sample name",
    "GEO",
    "Sample type",
    "Organism",
    "Timepoints",
    "Vaccine")

write.csv(gse206023_metadata, file= here("raw_data","gse206023_metadata.csv"))
saveRDS(gse206023_metadata, file=here("raw_data","gse206023_metadata.rds"))

#### Import matrix.
#Genes were named incorrectly and represent only 2.000 genes of >30.000. Hence, we externally performed a pseudoalignment to retrieve all genes that were not correctly annotated. 
gse206023_counts <- read.delim(file=here("raw_data", "GSE206023_tpm_of_48_samples.txt"), 
                               header = TRUE, sep = "\t", dec = ".")

#Pseudoalignment
gse206023_counts = read_excel(here("raw_data", "GSE206023_counts_Pseudoalignment.xlsx"))

gse206023_counts_ready = gse206023_counts %>% 
  select(!c(1, 2)) %>% 
  drop_na(external_gene_name) %>% 
  column_to_rownames("external_gene_name")

gse206023_counts_ready %>% 
  saveRDS(file = here("raw_data", "gse206023_counts_ready.rds"))
gse206023_counts_ready %>% 
  write_csv(file = here("raw_data", "gse206023_counts_ready.csv"))

#General statistics
GSE206023_pseudoalign_stats <- read_excel("raw_data/GSE206023_pseudoalignment_ST1.xlsx", 
    sheet = "General Statistics")
```

## 2.2. Combine raw counts

```{r cache = TRUE}
# Counts
####### Wide table
gse189039 = gse189039_counts_ready %>% 
  rownames_to_column("genes") 
gse201530 = gse201530_counts_ready %>% 
  rownames_to_column("genes") 
gse201533 = gse201533_counts_ready %>% 
  rownames_to_column("genes") 
gse199750 = gse199750_counts_ready %>% 
  as.data.frame() %>% 
  rownames_to_column("genes") 
gse206023 = gse206023_counts_ready

all_matrices_counts = gse189039 %>% 
  full_join(gse201530, by = "genes") %>% 
  full_join(gse201533, by = "genes") %>% 
  full_join(gse199750, by = "genes") %>% 
  full_join(gse206023, by = "genes")

write_csv(all_matrices_counts, file = "all_matrices_counts.csv")


####### Long table of genes
all_matrices_genes = bind_rows(gse189039 %>% 
  select(genes) %>% 
  mutate(gse_id = "GSE189039"),
gse201530 %>% 
  select(genes) %>% 
  mutate(gse_id = "GSE201530"),
gse201533 %>% 
  select(genes) %>% 
  mutate(gse_id = "GSE201533"),
gse199750 %>% 
  select(genes) %>% 
  mutate(gse_id = "GSE199750"),
gse206023 %>% 
  rownames_to_column("genes") %>% 
  select(genes) %>% 
  mutate(gse_id = "GSE206023")) 

all_matrices_genes %>% 
  write_csv(file = here("DGE analysis", "all_matrices_genes.csv"))
```

## 2.3. Principal Variance Components Analysis

### 2.3.1. Counts normalization
Log2fc by sample
```{r cache = TRUE}
#### Log2fc by sample
all_matrices_counts_long = all_matrices_counts %>% 
  pivot_longer(cols = -genes,
               names_to = "sample",
               values_to = "counts")

all_matrices_counts_long_annotated = all_matrices_counts_long %>% 
  inner_join(ann_vaccines_samples, by = "sample")

all_matrices_counts_long_annotated %>% saveRDS(here("DGE analysis", "all_matrices_counts_long_annotated.rds"))


# Log2FC by sample ------

# GSE206023
counts_control_gse206023 = all_matrices_counts_long_annotated %>% 
  filter(gse_id == "GSE206023") %>% 
  filter(!is.na(counts))

counts_gse206023_samples_l2fc = counts_control_gse206023 %>% 
  filter(day == 0) %>% 
  select(genes, counts) %>% 
  group_by(genes) %>% 
  summarize(control_mean_counts = mean(counts)) %>% 
  inner_join(counts_control_gse206023, by = "genes") %>% 
  mutate(diff = counts - control_mean_counts,
         log2fc = if_else(diff < 0, abs(diff) %>% log2(), 
                          log2(diff)),
         log2fc = if_else(log2fc == -Inf, 0, log2fc)) %>% 
  select(genes, condition, sample, control_mean_counts, counts,diff, log2fc)

counts_gse206023_samples_l2fc
```


```{r cache = TRUE}
# GSE189039
counts_control_gse189039 = all_matrices_counts_long_annotated %>% 
  filter(gse_id == "GSE189039") %>% 
  filter(!is.na(counts))

counts_gse189039_samples_l2fc = counts_control_gse189039 %>% 
  filter(day == 0) %>% 
  select(genes, counts) %>% 
  group_by(genes) %>% 
  summarize(control_mean_counts = mean(counts)) %>% 
  inner_join(counts_control_gse189039, by = "genes") %>% 
  mutate(diff = counts - control_mean_counts,
         log2fc = if_else(diff < 0, abs(diff) %>% log2(), 
                          log2(diff)),
         log2fc = if_else(log2fc == -Inf, 0, log2fc)) %>% 
  select(genes, condition, sample, control_mean_counts, counts,diff, log2fc)

# GSE201530
counts_control_gse201530 = all_matrices_counts_long_annotated %>% 
  filter(gse_id == "GSE201530") %>% 
  filter(!is.na(counts))

counts_gse201530_samples_l2fc = counts_control_gse201530 %>% 
  filter(day == 0) %>% 
  select(genes, counts) %>% 
  group_by(genes) %>% 
  summarize(control_mean_counts = mean(counts)) %>% 
  inner_join(counts_control_gse201530, by = "genes") %>% 
  mutate(diff = counts - control_mean_counts,
         log2fc = if_else(diff < 0, abs(diff) %>% log2(), 
                          log2(diff)),
         log2fc = if_else(log2fc == -Inf, 0, log2fc)) %>% 
  select(genes, condition, sample, control_mean_counts, counts,diff, log2fc)

# GSE201533
counts_control_gse201533 = all_matrices_counts_long_annotated %>% 
  filter(gse_id == "GSE201533") %>% 
  filter(!is.na(counts))

counts_gse201533_samples_l2fc = counts_control_gse201533 %>% 
  filter(day == 0) %>% 
  select(genes, counts) %>% 
  group_by(genes) %>% 
  summarize(control_mean_counts = mean(counts)) %>% 
  inner_join(counts_control_gse201533, by = "genes") %>% 
  mutate(diff = counts - control_mean_counts,
         log2fc = if_else(diff < 0, abs(diff) %>% log2(), 
                          log2(diff)),
         log2fc = if_else(log2fc == -Inf, 0, log2fc)) %>% 
  select(genes, condition, sample, control_mean_counts, counts,diff, log2fc)
  

# GSE199750
counts_control_gse199750 = all_matrices_counts_long_annotated %>% 
  filter(gse_id == "GSE199750") %>% 
  filter(!is.na(counts))

counts_gse199750_samples_l2fc = counts_control_gse199750 %>% 
  filter(day == 0) %>% 
  select(genes, counts) %>% 
  group_by(genes) %>% 
  summarize(control_mean_counts = mean(counts)) %>% 
  inner_join(counts_control_gse199750, by = "genes") %>% 
  mutate(diff = counts - control_mean_counts,
         log2fc = if_else(diff < 0, abs(diff) %>% log2(), 
                          log2(diff)),
         log2fc = if_else(log2fc == -Inf, 0, log2fc)) %>% 
  select(genes, condition, sample, control_mean_counts, counts,diff, log2fc)


all_samples_l2fc = bind_rows(counts_gse206023_samples_l2fc,
                         counts_gse199750_samples_l2fc,
                         counts_gse201533_samples_l2fc,
                         counts_gse201530_samples_l2fc,
                         counts_gse189039_samples_l2fc)

all_samples_l2fc %>% 
  saveRDS(file = here("DGE analysis", "all_samples_l2fc.rds"))
```

DESeq2 normalization
```{r cache = TRUE}
##### DESEQ2 Normalization
library(DESeq2)

ann_vaccines_samples = read_csv(here("Annotations and metadata", "ann_vaccines_samples.csv"))
all_matrices_counts = readRDS(here("DGE analysis", "all_matrices_counts.rds"))

cvrts = ann_vaccines_samples %>% 
  arrange(condition) %>%
  distinct() %>% 
  column_to_rownames("sample")

exprs_deseq = all_matrices_counts %>% 
  select(c("genes", cvrts %>% rownames_to_column("sample") %>% .$sample)) %>% 
  replace(is.na(.), 0) %>% 
  mutate(across(where(is.numeric), round, 0)) %>% 
  column_to_rownames("genes") 

cvrts = cvrts %>% 
  mutate(condition = as.factor(condition),
         age = as.factor(age),
         sex = as.factor(sex), 
         vaccine = as.factor(vaccine),
         day = as.factor(day),
         gse_id = as.factor(gse_id))
  
#Check dimensions
dim(exprs_deseq)
dim(cvrts)

#Normalize data
dds <- DESeqDataSetFromMatrix(countData = exprs_deseq, 
                              colData = cvrts %>% 
                                select(condition, gse_id) %>% 
                                rownames_to_column("sample"), 
                              design = ~ condition)
dds <- estimateSizeFactors(dds)
normalized_counts <- counts_batch_corrected %>% 
  counts(normalized=TRUE) %>% 
  as.data.frame()

#Remove batch
dds <- DESeqDataSetFromMatrix(countData = exprs_deseq, 
                              colData = cvrts %>% 
                                select(condition, gse_id) %>% 
                                rownames_to_column("sample"), 
                              design = ~ age + sex + condition)
dds <- DESeq(dds)
vsd <- vst(dds, blind=FALSE)
mat <- assay(vsd)
mat <- limma::removeBatchEffect(mat, vsd$gse_id)
assay(vsd) <- mat
counts_batch_corrected <- assay(vsd)


saveRDS(normalized_counts, file = here("DGE analysis", "all_matrices_normalized_counts.rds"))

normalized_counts = read_rds(here("DGE analysis", "all_matrices_normalized_counts.rds"))

```

### 2.3.2. PVCA of normalized raw counts

```{r cache = TRUE}
#### PVCA of normalized raw counts -----
# BiocManager::install("ExpressionNormalizationWorkflow")
library(ExpressionNormalizationWorkflow)

ImmuneGO_Annotated_Genes <- readRDS("~/Desktop/Github - Covid Atlas/VaxGO gene sets/ImmuneGO_Annotated_Genes_2024-03-26.rds")
#Expression data
exprs_deseq_immune = exprs_deseq %>% 
  rownames_to_column("genes") %>% 
  filter(genes %in% ImmuneGO_Annotated_Genes$genes) %>% 
  column_to_rownames("genes")

```

Covariants table

```{r cache = TRUE}
cvrts = cvrts %>% 
  rownames_to_column("sample") %>% 
  inner_join(exprs %>% 
               colnames() %>% 
               as.data.frame() %>% 
               select(sample = "."), 
             by = "sample") %>% 
  arrange(sample) %>% 
  column_to_rownames("sample")
cvrts
```

Inputs
```{r cache = TRUE}
# Input
#For vaccination only (no ongoing infection)
cvrts_eff_var =  c("day", 
                   "age", 
                   "sex", 
                   "dose", 
                   "type", 
                   "regimen") 

#For vaccination and infection
cvrts_eff_var = c(
  "day",
  "age",
  "sex",
  "dose",
  "type",
  "previous_vaccination",
  "variant",
  "prior_infection",
  "severity",
  "disease_vac",
  "regimen"
) 


#For vaccination and infection
cvrts_eff_var = c(
  "day",
  "age",
  "sex",
  "dose",
  "type",
  "previous_vaccination",
  "variant",
  # "country_enroll",
  # "time_enroll",
  "prior_infection",
  "severity",
  "disease_vac",
  "regimen"
) 

#Convert to Expression Dataset Object
inpData <- expSetobj(exprs_deseq_immune, cvrts) 

#Threshold
pct_thrsh <- 0.75 
```

Run PVCA analysis

```{r cache = TRUE}
#PVCA analysis
pvca = pvcAnaly(inpData, pct_thrsh, cvrts_eff_var) 

pvca_df = pvca$dat %>% 
  as.data.frame() %>% 
  t() %>%
  as.data.frame() %>% 
  rename(wavgpv = V1) %>% 
  cbind(pvca$label %>% as.data.frame() %>% rename(batch = '.')) %>% 
  as.data.frame() %>% 
  mutate(batch = as.factor(batch),
         wavgpv = as.numeric(wavgpv),
         batch = fct_rev(fct_reorder(batch, wavgpv)),
         batch = fct_relevel(batch, after = Inf)) %>% 
  arrange(batch)

pvca_df %>% saveRDS(here("DGE analysis", "pvca_results_immunegenes.rds"))

pvca_df
```

Barplot: Covariants contributions

```{r cache = TRUE, fig.width= 12, fig.height=10}
# Visualize
pvca_df_plot = ggplot(pvca_df) +
  aes(x = batch, y = wavgpv) +
  geom_col(fill = "#4DBBD5FF") +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 20, angle = 45, vjust = 1, hjust=1, color = "black"),
        axis.text.y = element_text(size = 20, vjust = 1, hjust=1, color = "black")) +
  geom_text(aes(label = round(wavgpv,3), y = wavgpv), 
            position = position_dodge(width = 0.9), 
            vjust = -0.2, 
            hjust = 0.5, 
            size = 4,
            angle = 0) 

ggsave(pvca_df_plot, file = here("Figures", "pvca_raw_normalized_immunegenes_allconditions.png"), width = 12, height = 10)

pvca_df_plot
```

Scatterplot of PVCA

```{r cache = TRUE}
# Visualize
library(ggfortify)
library(plotly)

pca_res <- prcomp(exprs_deseq_immune %>% t(), scale. = F)

pca_res_ann = exprs_deseq_immune %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column("sample") %>% 
  inner_join(cvrts %>% 
               rownames_to_column("sample"),
             by = "sample") %>% 
  distinct()

dim(pca_res)
dim(pca_res_ann)

#Study
normalizedcounts_pca_plot = autoplot(pca_res, data = pca_res_ann) +
  geom_point(aes(fill = gse_id, label = condition), colour="black",pch=21, size = 3) +
  theme_few() +
  scale_fill_aaas()

ggsave(normalizedcounts_pca_plot, file = here("Figures", "covid_vax_pca_samples_study_immune.png"), height = 5, width = 8) 

#Type
normalizedcounts_pca_plot_type = autoplot(pca_res, data = pca_res_ann) +
  geom_point(aes(fill = type, label = condition), colour="black",pch=21, size = 3) +
  theme_few() +
  scale_fill_manual(values = ann_vaxsig_colors$type)

ggsave(normalizedcounts_pca_plot_type, file = here("Figures", "covid_vax_pca_samples_type_immune.png"), height = 5, width = 8) 


#Day
normalizedcounts_pca_plot_day = autoplot(pca_res, data = pca_res_ann %>% 
                                           mutate(day = as.factor(day))) +
  geom_point(aes(fill = day, label = condition), colour="black",pch=21, size = 3) +
  theme_few() +
  scale_fill_manual(values = ann_vaxsig_colors$day)

ggsave(normalizedcounts_pca_plot_day, file = here("Figures", "covid_vax_pca_samples_day_immune.png"), height = 5, width = 8)


#Sex
normalizedcounts_pca_plot_sex = autoplot(pca_res, data = pca_res_ann %>% 
                                           mutate(day = as.factor(day))) +
  geom_point(aes(fill = sex, label = condition), colour="black",pch=21, size = 3) +
  theme_few() +
  scale_fill_manual(values = ann_vaxsig_colors$sex)

ggsave(normalizedcounts_pca_plot_sex, file = here("Figures", "covid_vax_pca_samples_sex_immune.png"), height = 5, width = 8) 

```

# 3. General data analysis

## 3.1. Metadata

### 3.1.1. Annotate metadata

Conditions

```{r eval=FALSE, echo = TRUE, cache = TRUE}
#Metadata ------
gse189039_metadata_2 = GSE189039_metadata_1_ %>% 
  separate(sample, into = c("participant_id"), sep = "_", remove = F) %>% 
  mutate(geo = "GSE189039") %>% 
  rename(day = timepoint_day,
         gsm_id = geo_sample) %>% 
  select(sample, participant_id)

gse199750_metadata_2 = gse199750_metadata_annotated_14_11_23_2_ %>% 
  rename(gsm_id = geo,
         participant_id = subject_id) %>% 
  mutate(geo = "GSE199750") %>% 
  select(sample, participant_id)

gse206023_metadata_3 = gse206023_metadata %>% 
  mutate(day = as.numeric(day),
         geo = "GSE206023") %>%  
  inner_join(gse206023_metadata_ready_2, by = "sample_id") %>% 
  inner_join(ann_vaccines_samples %>% 
            select(condition, sample_id = sample, age, sex, vaccine),
            by = "sample_id") %>% 
  rename(gsm_id = gsm_id.x) %>% 
  select(sample = sample_id, participant_id)

gse201530_metadata_2 = gse201530_metadata %>% 
  rename(gsm_id = geo_sample) %>% 
  separate(subject_id, into = c("variant", "participant_id_num"), sep = "_", remove = F) %>% 
  mutate(participant_id = paste0(variant, "_", participant_id_num)) %>% 
  select(participant_id, sample = subject_id)

gse201533_metadata_2 = GSE201533_metadata %>% 
  mutate(age = as.numeric(age),
         dose = as.numeric(dose),
         gsm_id = geo_sample) %>% 
  select(geo_sample = sample_id, participant_id) %>% 
  rownames_to_column("sample")
```

Samples

```{r eval=FALSE, include=TRUE, cache = TRUE}
ann_vaccines_samples_2.1 = ann_vaccines_samples_2 %>% 
  filter(is.na(participant_id)) %>% 
  separate(sample, into = c("participant_id_1", "participant_id_2", "participant_id_3", "delete"), remove = F) %>% 
  mutate(participant_id = paste0(participant_id_1, "_", participant_id_2, "_", participant_id_3)) %>% 
  select(!c(participant_id_1, participant_id_2, participant_id_3)) %>% 
  select(sample, participant_id)

all_participants = bind_rows(gse189039_metadata_2,
          gse199750_metadata_2,
          gse206023_metadata_3,
          gse201533_metadata_2,
          gse201530_metadata_2) %>% 
  bind_rows(ann_vaccines_samples_2.1)

ann_vaccines_samples_2 = ann_vaccines_samples %>% 
  left_join(all_participants, by = "sample") %>% 
  select(condition, sample, age, sex, vaccine:previous_vaccination, participant_id) %>% 
  left_join(ann_vaccines_samples_2.1, by = "sample")


ann_vaccines_samples_participants = ann_vaccines_samples_2 %>% 
  select(-participant_id.y, participant_id = participant_id.x)
  
write.csv(ann_vaccines_samples_participants, file = "ann_vaccines_samples.csv")
```

Conditions annotations

```{r eval=FALSE, include=TRUE, cache = TRUE}
library(tidyverse)

demographics = ann_vaccines_samples_4_12_23 %>%
  select(vaccine, gse_id, condition, sample) %>% 
  distinct() %>% 
  group_by(vaccine, gse_id, condition) %>% 
  summarise(samples = n()) %>% 
  ungroup()

ann_vaccines = demographics %>% 
  select(condition, samples) %>% 
  inner_join(ann_vaccines_18_1_24, by = "condition") %>% 
  distinct() %>% 
  mutate(week = as.factor(week))

ann_vaccines_2 = ann_vaccines %>% 
  group_by(vaccine) %>% 
  summarise(samples_byvaccine = sum(samples)) %>% 
  ungroup() %>% 
  inner_join(ann_vaccines, by = "vaccine") 

 ann_vaccines_3 = ann_vaccines_2 %>% 
  group_by(gse_id) %>% 
  summarise(samples_bygse = sum(samples)) %>% 
  ungroup() %>% 
  inner_join(ann_vaccines_2, by = "gse_id") 

write.csv(ann_vaccines_3, file = "ann_vaccines_19-1-24.csv")



ann_vaccines_conditions = ann_vaccines_samples %>% 
  select(condition, disease_vac, gse_id) %>% 
  group_by(condition, gse_id) %>% 
  summarise(samples = n()) %>% 
  inner_join(ann_vaccines %>% select(-samples), by = join_by("condition", "gse_id")) %>% 
  mutate(day = if_else(str_detect(condition, "D0\\)"), 0, day),
         week = if_else(str_detect(condition, "D0\\)"), 0, week),
         disease_vac = if_else(disease_vac == "Healthy", "H", disease_vac)) %>% 
  distinct() %>% 
  ungroup()

ann_vaccines_conditions %>% 
  write_csv(here("Annotations and metadata", "ann_vaccines_conditions.csv"))

```


```{r}
ann_vaccines_conditions_ordered = ann_vaccines_conditions %>% 
  filter(condition != "BNT-MO (V1, D0)",
         condition != "BNT-MO (V1, D6)") %>% 
  mutate(disease_vac = if_else(disease_vac == "Healthy", "H", disease_vac)) %>% 
  mutate(disease_vac = fct_relevel(disease_vac, "H", "I", "V"),
           type = fct_relevel(type, "I", "RNA", "VV", "IN", "SU")) %>% 
  arrange(disease_vac,type, condition) 

ann_vaccines_conditions_ordered = ann_vaccines_conditions_ordered %>% 
  mutate(condition = fct_relevel(condition, 
                                 ann_vaccines_conditions_ordered %>% 
                                   filter(str_detect(condition, "^H \\(D0\\)")) %>% 
                                   select(condition) %>% 
                                   distinct() %>% 
                                   pull(condition), 
                                 ann_vaccines_conditions_ordered %>% 
                                   filter(str_detect(condition, "^I")) %>% 
                                   filter(!str_detect(condition, "^I-I")) %>% 
                                   select(condition) %>% 
                                   arrange(condition) %>% 
                                   distinct() %>% 
                                   pull(condition),
                                 ann_vaccines_conditions_ordered %>% 
                                   filter(disease_vac == "I") %>% 
                                   filter(str_detect(condition, "^BNT-I")) %>% 
                                    filter(!str_detect(condition, "^BNT-I \\(D\\d+\\)")) %>% 
                                    arrange(day, condition) %>%
                                   select(condition) %>% 
                                    distinct() %>% 
                                    pull(condition),
                                 ann_vaccines_conditions_ordered %>% 
                                    filter(str_detect(condition, "^BNT-I \\(D\\d+\\)")) %>% 
                                    arrange(day, condition) %>%
                                   select(condition) %>% 
                                    distinct() %>% 
                                    pull(condition),
                                 ann_vaccines_conditions_ordered %>% 
                                   filter(disease_vac == "V",
                                          str_detect(condition, "^BNT \\(V1, D\\d+\\)")) %>% 
                                   arrange(day, condition) %>% 
                                   select(condition) %>% 
                                   distinct() %>% 
                                   pull(condition),
                                 ann_vaccines_conditions_ordered %>% 
                                   filter(disease_vac == "V",
                                          !str_detect(condition, "^BNT \\(V1, D\\d+\\)"),
                                          !str_detect(condition, "BBIBP"),
                                          !str_detect(condition, "ZF2001")) %>% 
                                   arrange(condition) %>% 
                                   select(condition) %>% 
                                   distinct() %>% 
                                   pull(condition),
                                 ann_vaccines_conditions_ordered %>% 
                                   filter(str_detect(condition, "BBIBP")) %>% 
                                   select(condition) %>% 
                                   arrange(condition) %>% 
                                   distinct() %>% 
                                   pull(condition), 
                                 ann_vaccines_conditions_ordered %>% 
                                   filter(str_detect(condition, "ZF2001")) %>% 
                                   select(condition) %>% 
                                   arrange(condition) %>% 
                                   distinct() %>% 
                                   pull(condition))) %>%
  mutate(type = if_else(type == "H", "I", type),
         disease_vac = if_else(disease_vac == "H", "I", disease_vac)) 


ann_vaccines_conditions_ordered %>% 
  saveRDS(file = here("Annotations and metadata", "ann_vaccines_conditions_ordered.rds"))
```


### 3.1.2. Samples by condition

```{r fig.height=10, fig.width=20, cache = TRUE}

ann_vaccines = read_csv(here("Annotations and metadata", "ann_vaccines_conditions.csv"))
ann_vaccines_conditions = ann_vaccines
ann_vaccines_samples <- read_csv(here("Annotations and metadata","ann_vaccines_samples.csv"))

#### SAMPLES BY CONDITION -----
samples_by_condition  = ann_vaccines %>% 
  select(samples, condition, vaccine) %>% 
  distinct() %>% 
  group_by(condition) %>% 
  summarise(samples = sum(samples)) %>% 
  inner_join(ann_vaccines %>% select(vaccine, condition) %>% distinct(), by = "condition")


samples_by_condition_plot = samples_by_condition %>% 
  ggplot(aes(x = fct_reorder(condition, -samples), weight = samples, fill = vaccine)) +
  geom_bar() +
  scale_fill_manual(name = "Vaccine or infection", labels = c("BBIBP", 
                                                                "BNT", 
                                                                "ChAd",
                                                                "Healthy",
                                                                "Infection",
                                                                "MO",
                                                                "ZF2001"),
    values = c("BBIBP" = "#00A087FF",
                "ZF2001" = "#8491B4FF",
                "BNT" = "#4DBBD5FF",
                "MO" = "#72ddf7",
                "ChAd" = "#3C5488FF",
                "I" = "#DC0000FF",
                "H" = "grey80")) +
  theme_minimal() +
  theme(legend.position = "top",
        axis.text.x = element_text(size = 15, color = "black", angle = 45, hjust = 1, vjust = 1.1),
        axis.text.y = element_blank(), 
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size = 25),
        axis.title.y = element_text(angle = 180, color = "white"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        plot.margin = margin(2, 2, 2, 2, "cm")) +
  guides(fill=guide_legend(nrow=1,byrow=TRUE)) +
  geom_label(aes(label = samples, y = samples),
             fill = "white",
            position = position_dodge(width = 0), 
            vjust = -0.5, 
            size = 4,
            angle = 0) +
  ggtitle("Samples by condition") +
  labs(x = "") +
  ylim(0, 80)

ggsave(samples_by_condition_plot, file = here("Figures", "demographics_samples-by-condition.png"), width = 20, height = 10)

samples_by_condition_plot
```

### 3.1.3. Age by GSE

```{r fig.height=5, fig.width=6, cache = TRUE}
#### AGE BY GSE -------------
age = ann_vaccines_samples %>% 
  select(age, participant_id, gse_id) %>% 
  distinct()

age_stats = ggbetweenstats(
  data = age,
  x = gse_id,
  y = age,
  p.adjust.method = "BH", 
  point.args = list(alpha = 1),
  type = "np", ggsignif.args = list(textsize = 2, tip_length = 0.0)
) +
  ggplot2::scale_color_manual(
    values = c("GSE199750" = "#80ed99",
               "GSE201533" = "#5e60ce", 
               "GSE201530" = "#7400b8",
               "GSE206023" = "#4361ee",
               "GSE189039" = "#48bfe3")) +
  theme_few() +
  ylim(0, 110) +
  theme(legend.position = "none",
        plot.title = element_text(size = 20),
        text = element_text(size = 10),
        axis.text.x = element_text(size = 10, color = "black", angle = 0),
        axis.text.y = element_text(size = 10, color = "black", angle = 0)) +
  labs(y = "Age",
       x = "",
       color = "GSE ID",
       title = "Study by age")

ggsave(age_stats, file = here("Figures", "Demographics_age.png") , width = 6, height = 5)

age_stats
```

### 3.1.4. Sex by GSE
This figure's text was manipulated further in a design software.
```{r fig.height=8, fig.width=10, cache = TRUE}
#### AGE BY GSE -------------

sex_stats = ann_vaccines_samples %>% 
  select(sex, participant_id, gse_id) %>% 
  tabyl(gse_id, sex) %>%
  adorn_percentages() %>% 
  as.data.frame() %>% 
  pivot_longer(cols = -gse_id,
               values_to = "value",
               names_to = "sex") %>% 
    filter(value > 0) %>% 
  filter(sex != "Total") %>% 
  mutate(value = value * 100,
         value = round(value, 0),
         sex = if_else(sex == "M/F", "Male", sex),
         value = if_else(gse_id == "GSE206023", 50, value)) %>% 
  add_row(gse_id = "GSE206023",
          sex = "Female", 
          value = 50) %>% 
  group_by(gse_id, sex)

sex_stats_annotated = sex_stats %>% 
 ggplot() +
  aes(
    x = gse_id,
    y = value,
    fill = sex,
    weight = value,
    label = value
  ) +
  geom_col() +
  geom_text(vjust = -3, size = 5) +
  scale_fill_hue(direction = 1) +
  coord_polar(theta = "y") +
  theme_minimal() +
  labs(title = "Sex by study",
       fill = "Sex") +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        plot.title = element_text(size = 25, hjust = 0.5),
        strip.text = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        legend.position = "top") +
  facet_wrap(vars(gse_id), scales = "free") +
  scale_fill_manual(values = c("Male" = "#4DBBD5FF",
          "Female" = "#E64B35FF",
          "M/F" = "#8491B4FF"))


sex_stats_nonumb = sex_stats %>% 
 ggplot() +
  aes(
    x = gse_id,
    y = value,
    fill = sex,
    weight = value,
    label = value
  ) +
  geom_col() +
  scale_fill_hue(direction = 1) +
  coord_polar(theta = "y") +
  theme_minimal() +
  labs(title = "Sex by study",
       fill = "Sex") +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        plot.title = element_text(size = 25, hjust = 0.5),
        strip.text = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        legend.position = "top") +
  facet_wrap(vars(gse_id), scales = "free") +
  scale_fill_manual(values = c("Male" = "#4DBBD5FF",
          "Female" = "#E64B35FF",
          "M/F" = "#8491B4FF"))

ggsave(sex_stats_annotated, 
       file = here("Figures", "Demographics_Sex_annotated.png") , 
       width = 10, height = 10)

ggsave(sex_stats_nonumb, 
       file = here("Figures", "Demographics_Sex_nonumbers.png") , 
       width = 10, height = 10)

sex_stats_annotated
```


### 3.1.5. Participants by condition

```{r cache = TRUE}
#### Participants by condition ------

participants = ann_vaccines_conditions %>% 
  select(condition, samples, gse_id) %>% 
  distinct() %>% 
  group_by(gse_id) %>% 
  select(samples, gse_id) %>% 
  distinct() %>% 
  summarise(n_participants_study = sum(samples)) %>% 
  inner_join(ann_vaccines_conditions, by = "gse_id") %>% 
  relocate(.after = week, gse_id, n_participants_study)
```


### 3.1.6. Participants by day

```{r fig.height=5, fig.width=8, cache = TRUE}

demographics_time = ann_vaccines_samples %>% 
  mutate(day_f = as.factor(day),
         day_f = fct_reorder(day_f, day),
         type = fct_rev(fct_relevel(type, "H", "I", "RNA", "VV", "SU", "IN"))) %>% 
  ggplot(.) +
  aes(x = day_f, fill = type) +
  geom_bar() +
  labs(
    x = "Day",
    y = "Participants",
    title = "Participants by day",
    fill = "Type"
  ) +
  ggthemes::theme_few() +
  theme(
    legend.position = c(0.8, 0.6),
    plot.title = element_text(size = 15)
  ) +
  scale_fill_manual(values = ann_vaxsig_colors$Platform)

demographics_time %>% 
  ggsave(file = here("Figures", "Demographics_Time.png"),
         width = 8, height = 5)

demographics_time
```




### 3.1.7. Studies designs

```{r fig.height=5, fig.width=6}

library(ggforce)
demographics_days_samples_doses = ann_vaccines_conditions %>% 
  mutate(condition = as.factor(condition),
         condition = fct_relevel(condition, as.character(unique(ann_vaccines_conditions_ordered$condition))),
         day_f = as.factor(day),
         day_f = fct_reorder(day_f, day),
         dose_f = as.factor(dose),
         dose_f = fct_reorder(dose_f, dose),
         condition = if_else(condition == "BNT (V1, D0)" & 
                               gse_id == "GSE189039", "H (D0)", 
                             condition)) %>%
  separate(condition, into = c("condition_2"), sep = " \\(", remove = F) %>%
  mutate(dose_f = if_else(day_f == "0", "0", dose_f),
         condition_2 = if_else(severity != "H", 
                             paste0(condition_2, " (", severity, ")"),
                             condition_2),
         condition = fct_relevel(condition, as.character(unique(ann_vaccines_conditions_ordered$condition))),
         dose_f = if_else(dose == "0" & infection != "0", "Infection", dose_f))



demographics_plot_days_samples_doses = demographics_days_samples_doses %>% 
  mutate(condition_2 = fct_relevel(condition_2, as.character(unique(demographics_days_samples_doses$condition_2))),
         condition_2 = fct_rev(condition_2)) %>% 
  group_by(gse_id, dose_f) %>% 
  ggplot(.) +
  aes(x = day_f,
      y = condition_2, 
      fill = dose_f,
      size = samples,
      group = dose_f) +
  geom_point(position = position_dodge(width = 0.8),
             pch = 21,
             # size = 3, 
             color = "black") +
  scale_fill_manual(values =  c(ann_vaxsig_colors$dose, "Infection" = "red")) +
  scale_size_binned(breaks = c(1, 10, 50),
                    range = c(2, 5)) +
  theme_minimal() +
  theme(axis.text = element_text(color = "black"),
        strip.text.y = element_text(angle = 0, color = "black")) +
  labs(x = "Days",
       y = "",
       title = "Studies design",
       shape = "Disease or vaccination",
       size = "Samples",
       fill = "Dose") +
  ggforce::facet_col(~gse_id, scales = "free_y", space = "free")

demographics_plot_days_samples_doses

demographics_plot_days_samples_doses %>% 
  ggsave(filename = here("Figures", "Demographics_studies_design.png"),
         width = 6,
         height = 6)


```






# 3. Differential Gene Expression Analysis

## 3.1. GSE201530

Metadata

A tabela de counts fornecida pelo estudo é nomeada com o
Subject ID + Timepoint e não com o codigo GSM. Por isso, teremos de
tratar a tabela de metadados. Além disso, ela não possui a coluna de
idade. É possível manipular estes dados no excel.

```{r eval=FALSE, echo=TRUE, cache = TRUE}
#Standardize counts tables
############### GSE201530
# Reorder table
gse201530_counts_ready <- counts_gse201530 %>%
  column_to_rownames("genes") %>% 
  t() %>%
  as.data.frame() %>% 
  rownames_to_column("sample") %>% 
  arrange(sample) %>% 
  column_to_rownames("sample") %>% 
  t() %>% 
  as.data.frame() %>%
  rownames_to_column("genes") %>% 
  filter(!grepl("_", genes)) %>% 
  column_to_rownames("genes")

saveRDS(gse201530_counts_ready, file = here("DGE analysis", "gse201530_counts_ready.rds"))
```

```{r cache = TRUE}
gse201530_counts_ready = readRDS(here("DGE analysis", "gse201530_counts_ready.rds"))

GSE201530_metadata = ann_vaccines_samples %>% 
  filter(gse_id == "GSE201530")

countData <- gse201530_counts_ready
colData <- GSE201530_metadata %>%
  mutate(
    condition = as.factor(condition),
    condition = fct_relevel(condition, "H (D0)")) %>% 
  select(sample, everything())


###### DESeqDataSet

dds <- DESeqDataSetFromMatrix(countData = countData, 
                              colData = colData, 
                              design = ~ condition)

keep <- rowSums(counts(dds)) >= 10
dds <- dds[keep,]

###### Execute DESeq

#Wald
dds <- DESeq(dds, )
resultsNames(dds)

###### overall DEGs
res <- results(dds) %>% 
  as.data.frame() %>% 
  rownames_to_column("genes")

gse201530_H_BNT_I_D1 = results(dds, name = "condition_BNT.I..D1._vs_H..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "BNT-I (D1)")  %>% 
  rownames_to_column("genes")

gse201530_H_BNT_I_D3 = results(dds, name = "condition_BNT.I..D3._vs_H..D0.") %>%
  as.data.frame() %>%
  arrange(padj) %>%
  mutate(condition = "BNT-I (D3)") %>% 
  rownames_to_column("genes")

gse201530_H_BNT_I_D4 = results(dds, name = "condition_BNT.I..D4._vs_H..D0.") %>%
  as.data.frame() %>%
  arrange(padj) %>%
  mutate(condition = "BNT-I (D4)")  %>% 
  rownames_to_column("genes")

gse201530_I_BNT_I_D2 = results(dds, name = "condition_I.BNT.I..D2._vs_H..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "I-BNT-I (D2)")  %>% 
  rownames_to_column("genes")

gse201530_I_BNT_I_D5 = results(dds, name = "condition_I.BNT.I..D5._vs_H..D0.") %>%
  as.data.frame() %>%
  arrange(padj) %>%
  mutate(condition = "I-BNT-I (D5)") %>% 
  rownames_to_column("genes")

gse201530_H_I_D1 = results(dds, name = "condition_I..D1._vs_H..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "I (D1)")  %>% 
  rownames_to_column("genes")

gse201530_H_I_D1 = results(dds, name = "condition_I..D1._vs_H..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "I (D1)")  %>% 
  rownames_to_column("genes")

gse201530_I_I_D0 = results(dds, name = "condition_I.I..D0._vs_H..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "I-I (D0)")  %>% 
  rownames_to_column("genes")

gse201530_I_I_D1 = results(dds, name = "condition_I.I..D1._vs_H..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "I-I (D1)")  %>% 
  rownames_to_column("genes")

gse201530_I_I_D2 = results(dds, name = "condition_I.I..D2._vs_H..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "I-I (D2)")  %>% 
  rownames_to_column("genes")

gse201530_I_I_D3 = results(dds, name = "condition_I.I..D3._vs_H..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "I-I (D3)")  %>% 
  rownames_to_column("genes")

gse201530_I_I_D5 = results(dds, name = "condition_I.I..D5._vs_H..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "I-I (D5)")  %>% 
  rownames_to_column("genes")


#Bind all
gse201530_DEGs = bind_rows(gse201530_H_BNT_I_D1, 
          gse201530_H_BNT_I_D3,
          gse201530_H_BNT_I_D4,
          gse201530_H_I_D1,
          gse201530_I_BNT_I_D2,
          gse201530_I_BNT_I_D5,
          gse201530_I_I_D0,
          gse201530_I_I_D1,
          gse201530_I_I_D2,
          gse201530_I_I_D3,
          gse201530_I_I_D5)

write_csv(gse201530_DEGs, file = here("DGE analysis", "gse201530_DEGs.csv"))

```

## 3.2. GSE189039

```{r eval=FALSE, echo=TRUE, cache = TRUE}
############### GSE189039
# Reorder table
gse189039_counts_ready <- counts_GSE189039 %>%
  column_to_rownames("genes") %>% 
  t() %>%
  as.data.frame() %>% 
  rownames_to_column("sample") %>% 
  arrange(sample) %>% 
  column_to_rownames("sample") %>% 
  t() %>% 
  as.data.frame() %>%
  rownames_to_column("genes") %>% 
  filter(!grepl("_", genes)) %>% 
  column_to_rownames("genes")

saveRDS(gse189039_counts_ready, file = "gse189039_counts_ready.rds")
```


```{r eval=FALSE, echo=TRUE, cache = TRUE}
#DESeq2
gse189039_counts_ready = readRDS(here("DGE analysis", "gse189039_counts_ready.rds"))
GSE189039_metadata = ann_vaccines_samples %>% 
  filter(gse_id == "GSE189039")
  
countData <- gse189039_counts_ready
colData = GSE189039_metadata %>% 
  mutate(condition = as.factor(condition),
         condition = fct_relevel(condition, "BNT (V1, D0)"))


###### Crie o objeto DESeqDataSet ######
dds <- DESeqDataSetFromMatrix(countData = countData, 
                              colData = colData, 
                              design = ~ condition)

keep <- rowSums(counts(dds)) >= 10
dds <- dds[keep,]
dds <- DESeq(dds)

resultsNames(dds)

```


```{r }

gse189039_BNT_V1_D11 = results(dds, name = "condition_BNT..V1..D10._vs_BNT..V1..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "BNT (V1, D11)")  %>% 
  rownames_to_column("genes")

gse189039_BNT_V1_D7 = results(dds, name = "condition_BNT..V1..D7._vs_BNT..V1..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "BNT (V1, D7)")  %>% 
  rownames_to_column("genes")

gse189039_BNT_I_D10_mild = results(dds, name = "condition_BNT.I..D10..mild._vs_BNT..V1..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "BNT-I (D10, mild)")  %>% 
  rownames_to_column("genes")

gse189039_BNT_I_D10_severe = results(dds, name = "condition_BNT.I..D10..severe._vs_BNT..V1..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "BNT-I (D10, severe)")  %>% 
  rownames_to_column("genes")

gse189039_BNT_I_D26_mild = results(dds, name = "condition_BNT.I..D26..mild._vs_BNT..V1..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "BNT-I (D26, mild)")  %>% 
  rownames_to_column("genes")

gse189039_BNT_I_D26_severe = results(dds, name = "condition_BNT.I..D26..severe._vs_BNT..V1..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "BNT-I (D26, severe)")  %>% 
  rownames_to_column("genes")

gse189039_BNT_I_D51_severe = results(dds, name = "condition_BNT.I..D51..severe._vs_BNT..V1..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "BNT-I (D51, severe)")  %>% 
  rownames_to_column("genes")

gse189039_BNT_I_BNT_D51_severe = results(dds, name = "condition_BNT.I.BNT..D51..severe._vs_BNT..V1..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "BNT-I-BNT (D51, severe)")  %>% 
  rownames_to_column("genes")

gse189039_I_D10_moderate = results(dds, name = "condition_I..D10..moderate._vs_BNT..V1..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "I (D10, moderate)")  %>% 
  rownames_to_column("genes")

gse189039_I_D10_severe = results(dds, name = "condition_I..D10..severe._vs_BNT..V1..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "I (D10, severe)")  %>% 
  rownames_to_column("genes")

gse189039_I_D26_moderate = results(dds, name = "condition_I..D26..moderate._vs_BNT..V1..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "I (D26, moderate)")  %>% 
  rownames_to_column("genes")

gse189039_I_D26_severe = results(dds, name = "condition_I..D26..severe._vs_BNT..V1..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "I (D26, severe)")  %>% 
  rownames_to_column("genes")

gse189039_I_D51_moderate = results(dds, name = "condition_I..D51..moderate._vs_BNT..V1..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "I (D51, moderate)")  %>% 
  rownames_to_column("genes")

gse189039_I_D51_severe = results(dds, name = "condition_I..D51..severe._vs_BNT..V1..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "I (D51, severe)")  %>% 
  rownames_to_column("genes")


gse189039_DEGs = bind_rows(
gse189039_BNT_V1_D11,
gse189039_BNT_V1_D7,
gse189039_BNT_I_D10_mild,
gse189039_BNT_I_D10_severe,
gse189039_BNT_I_D26_mild,
gse189039_BNT_I_D26_severe,
gse189039_BNT_I_D51_severe,
gse189039_BNT_I_BNT_D51_severe,
gse189039_I_D10_moderate,
gse189039_I_D10_severe,
gse189039_I_D26_moderate,
gse189039_I_D26_severe,
gse189039_I_D51_moderate,
gse189039_I_D51_severe
)


write_csv(gse189039_DEGs, here("DGE analysis", "gse189039_DEGS.csv"))
```

## 3.3. GSE206023

```{r}
##Defina as variáveis
gse206023_counts_ready <- readRDS(here("raw_data", "gse206023_counts_ready.rds")) %>%
  round(., 0)

gse206023_metadata = ann_vaccines_samples %>% 
  filter(gse_id == "GSE206023")

countData <- gse206023_counts_ready %>%
  select(
    colnames(gse206023_counts_ready) %>%
      as.data.frame() %>%
      rename(sample = ".") %>%
      arrange(sample) %>%
      pull()
  )


colData <- gse206023_metadata %>% 
  mutate(condition = case_when(condition == "BBIBP (V3, D0)" ~ "H (D0)",
                               condition == "ZF2001 (V3, D0)" ~ "H (D0)",.default = condition),
         condition = as.factor(condition),
         condition = fct_relevel(condition, "H (D0)")) %>% 
  arrange(sample) %>% 
  select(sample, everything())


# DESeq2
dds <- DESeqDataSetFromMatrix(countData = countData, 
                              colData = colData, 
                              design = ~ age + condition)

keep <- rowSums(counts(dds)) >= 10
dds <- dds[keep,]
dds <- DESeq(dds, test = "LRT", reduced = ~age)

resultsNames(dds)


gse206023_BBIBP_V3_D7 = results(dds, name = "condition_BBIBP..V3..D07._vs_H..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "BBIBP (V3, D07)")  %>% 
  rownames_to_column("genes")

gse206023_BBIBP_V3_D14 = results(dds, name = "condition_BBIBP..V3..D14._vs_H..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "BBIBP (V3, D14)")  %>% 
  rownames_to_column("genes")

gse206023_BBIBP_V3_D28 = results(dds, name = "condition_BBIBP..V3..D28._vs_H..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "BBIBP (V3, D28)")  %>% 
  rownames_to_column("genes")


gse206023_ZF2001_V3_D7 = results(dds, name = "condition_ZF2001..V3..D07._vs_H..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "ZF2001 (V3, D07)")  %>% 
  rownames_to_column("genes")

gse206023_ZF2001_V3_D14 = results(dds, name = "condition_ZF2001..V3..D14._vs_H..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "ZF2001 (V3, D14)")  %>% 
  rownames_to_column("genes")

gse206023_ZF2001_V3_D28 = results(dds, name = "condition_ZF2001..V3..D28._vs_H..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "ZF2001 (V3, D28)")  %>% 
  rownames_to_column("genes")

gse206023_DEGs =
  bind_rows(
    gse206023_BBIBP_V3_D7,
    gse206023_BBIBP_V3_D14,
    gse206023_BBIBP_V3_D28,
    gse206023_ZF2001_V3_D7,
    gse206023_ZF2001_V3_D14,
    gse206023_ZF2001_V3_D28
  )

gse206023_DEGs %>% 
  write_csv(file = here("DGE analysis", "gse206023_DEGs.csv"))

```

## 3.4. GSE201533

```{r}
############ Matrix counts ############

gse201533_counts <- as.data.frame(counts_gse201533)
rownames(gse201533_counts) <- gse201533_counts$geneid 
gse201533_counts <- gse201533_counts[, -1]
saveRDS(gse201533_counts, file="gse201533_counts_ready.rds")

########## Metadata #############
gse201533_metadata <- as.data.frame(gse201533_metadata)
rownames(gse201533_metadata) <- gse201533_metadata$GEO 

#A coluna de Sample name corresponde aos timepoints da coleta de amostra pós vacinacao. Por isso, vamos extrair somente o numero do timepoint (0,2,3,4,7)

gse201533_metadata$Timepoint <- sub(".*(0|2|3|4|7).*", "\\1", gse201533_metadata$`Sample name`)

head(gse201533_metadata)

gse201533_metadata <- gse201533_metadata[, -2]
gse201533_metadata <- gse201533_metadata[, -1]

saveRDS(gse201533_metadata, file="gse201533_metadata_ready.rds")
```

DESeq2
```{r}
gse201533_counts_ready <- readRDS(here("raw_data", "gse201533_counts_ready.rds"))
gse201533_metadata_ready = ann_vaccines_samples %>% 
  filter(gse_id == "GSE201533")

countData <- gse201533_counts_ready %>% 
  select(gse201533_metadata_ready$sample)
colData <- gse201533_metadata_ready %>% 
  mutate(condition = as.factor(condition),
         condition = fct_relevel(condition, "ChAd (V1, D0)")) %>% 
  select(sample, everything())
  


# DESeqDataSet
dds <- DESeqDataSetFromMatrix(countData = countData, 
                              colData = colData, 
                              design = ~condition)
keep <- rowSums(counts(dds)) >= 10
dds <- dds[keep,]

# Execute DESeq
dds <- DESeq(dds)

resultsNames(dds)
```

```{r}
gse201533_ChAd_V1_D3 = results(dds, name = "condition_ChAd..V1..D3._vs_ChAd..V1..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "ChAd (V1, D3)")  %>% 
  rownames_to_column("genes")

gse201533_ChAd_V1_D7 = results(dds, name = "condition_ChAd..V1..D7._vs_ChAd..V1..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "ChAd (V1, D7)")  %>% 
  rownames_to_column("genes")

gse201533_ChAd_V2_D3 = results(dds, name = "condition_ChAd..V2..D3._vs_ChAd..V1..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "ChAd (V2, D3)")  %>% 
  rownames_to_column("genes")

gse201533_ChAd_V2_D7 = results(dds, name = "condition_ChAd..V2..D7._vs_ChAd..V1..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "ChAd (V2, D7)")  %>% 
  rownames_to_column("genes")


gse201533_ChAd_BNT_V2_D3 = results(dds, name = "condition_ChAd.BNT..V2..D3._vs_ChAd..V1..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "ChAd-BNT (V2, D3)")  %>% 
  rownames_to_column("genes")

gse201533_ChAd_BNT_V2_D7 = results(dds, name = "condition_ChAd.BNT..V2..D7._vs_ChAd..V1..D0.") %>% 
  as.data.frame() %>% 
  arrange(padj) %>% 
  mutate(condition = "ChAd-BNT (V2, D7)")  %>% 
  rownames_to_column("genes")

gse201533_DEGs = bind_rows(
  gse201533_ChAd_V1_D3,
  gse201533_ChAd_V1_D7,
  gse201533_ChAd_V2_D3,
  gse201533_ChAd_V2_D7,
  gse201533_ChAd_BNT_V2_D3,
  gse201533_ChAd_BNT_V2_D7
)


gse201533_DEGs %>% 
  write_csv(here("DGE analysis", "gse201533_DEGs.csv"))

```









## 3.5. GSE199750

```{r}
# Required files
gse199750_counts_ready = readRDS(here("raw_data", "gse199750_counts_ready.rds")) %>% 
  as.data.frame()

gse199750_metadata = ann_vaccines_samples %>% 
  filter(gse_id == "GSE199750")

countData <- gse199750_counts_ready %>% 
  select(gse199750_metadata$sample)

colData <- gse199750_metadata %>% 
  select(sample, everything()) %>% 
  mutate(condition = if_else(day == 0, 
                             "H (D0)", condition),
         condition = as.factor(condition),
         condition = fct_relevel(condition, "H (D0)")) %>% 
  arrange(sample)


###### DESeqDataSet objetct
dds <- DESeqDataSetFromMatrix(countData = countData, 
                              colData = colData, 
                              design = ~ condition)


###### Pre-filtering
keep <- rowSums(counts(dds)) >= 10
dds <- dds[keep,]

###### Execute DESeq2
dds <- DESeq(dds)

###### Retrieve comparisons
resultsNames(dds)


# Get all comparisons
generate_all_DESeq2_results <- function(dds) {
  result_names <- resultsNames(dds)
  all_results <- data.frame()
  
  for (name in result_names) {
    condition_label <- name
      result_df <- results(dds, name = name) %>%
      as.data.frame() %>%
      arrange(padj) %>%
      mutate(condition = condition_label) %>%
      rownames_to_column("genes")
        
    all_results <- bind_rows(all_results, result_df)
  }
  
  return(all_results)
}


gse199750_dds <- generate_all_DESeq2_results(dds)
  
gse199750_DEGs =  gse199750_dds %>% 
  mutate(condition = case_when( condition == "condition_BNT..V1..D6._vs_H..D0." ~ "BNT (V1, D6)", 
                                condition == "condition_ChAd..V1..D6._vs_H..D0." ~ "ChAd (V1, D6)", 
                                condition == "condition_BNT..V2..D1._vs_H..D0." ~ "BNT (V2, D1)", 
                                condition == "condition_ChAd..V2..D1._vs_H..D0." ~ "ChAd (V2, D1)",
                                condition == "condition_BNT..V3..D1._vs_H..D0." ~ "ChAd (V3, D1)",  
                                condition == "condition_BNT.MO..V3..D1._vs_H..D0." ~ "BNT-MO (V3, D1)", 
                                condition == "condition_ChAd.BNT..V3..D1._vs_H..D0." ~ "ChAd-BNT (V3, D1)", 
                                .default = condition)) %>% 
  filter(!condition %in% c("Intercept", "condition_BNT.MO..V1..D6._vs_H..D0."))

gse199750_DEGs %>% 
  write_csv(file = here("DGE analysis", "gse199750_DEGs.csv"))

```


## 3.6. Merge all

```{r}

all_degs = bind_rows(gse199750_DEGs,
                     gse189039_DEGs,
                     gse201530_DEGs,
                     gse201533_DEGs,
                     gse206023_DEGs)
#Check if there is any repetition
all_degs %>% 
dplyr::summarise(n = dplyr::n(), .by = c(genes, condition)) |>
dplyr::filter(n > 1L)

#Save
all_degs %>% 
  saveRDS(file = here("DGE analysis", "all_studies_degs.csv"))

all_degs
```

## 3.7. Weight and adjust p values

```{r}

all_degs_annotated = all_degs %>%
  inner_join(ann_vaccines_conditions %>% select(condition, n = samples),
             by = "condition") %>%
  mutate(pvalue = if_else(is.na(pvalue), 1, pvalue)) %>% 
  select(-padj)

all_studies_degs_weighted <- all_degs_annotated %>%
  group_by(genes, condition) %>%
  summarise(
    meta_p = wtd.mean(pvalue, weights = n), 
    .groups = "drop"
  ) %>% 
  inner_join(all_degs_annotated, by = join_by("genes", "condition"))  %>% 
  mutate(fdr = p.adjust(meta_p, method = "BH"),
         direction = case_when(log2FoldChange >= 1 ~ "UP",
                               log2FoldChange <= -1 ~ "DOWN",
                               .default = "NEUTRAL")) %>% 
  clean_names() %>% 
  select(genes, condition, log2fold_change, direction, meta_p, fdr)


all_studies_degs_weighted %>% 
  saveRDS(file = here("DGE analysis", "all_studies_degs_weighted.rds"))

```


# 4. DEGs analysis

## 4.1. Up and down-regulated DEGs

```{r}
#Required files
all_degs_p_05_vac_infected = read_rds(file = here("DGE analysis", "all_studies_degs_weighted.rds")) %>% 
  filter(fdr <= 0.05) 

ann_vaccines = read_csv(here("Annotations and metadata", "ann_vaccines_conditions.csv"))

all_degs = all_degs_p_05_vac_infected %>% 
  group_by(condition, direction) %>% 
  summarise(n_degs = n()) %>% 
  inner_join(ann_vaccines, by="condition")

all_degs_total = all_degs %>% 
  pivot_wider(names_from = "direction", values_from = "n_degs") %>% 
  mutate(TOTAL = sum(DOWN + NEUTRAL + UP)) %>% 
  select(condition, DOWN:TOTAL)

all_degs_total
```

By vaccination or disease

```{r fig.height=6, fig.width=10}
# Plot 1
ggplot_degs_bars_I = all_degs %>%
 filter(disease_vac == "I") %>% 
 ggplot() +
  aes(x = reorder(condition, day), fill = direction, weight = n_degs) +
  geom_bar(position = "dodge") +
  scale_fill_manual(
    values = c(DOWN = "#4DBBD5FF",
    NEUTRAL = "gray80",
    UP = "#d90429")) +
  theme_few() +
  ylim(0, 1400) +
  geom_text(aes(label = n_degs, y = n_degs), 
            position = position_dodge(width = 0.9), 
            angle = 90,
            vjust = 0.5, 
            hjust = -0.2, 
            size = 2) +
  theme(legend.position = "right",
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, size = 7),
        axis.text.y = element_text(vjust = 0.5)) +
  labs(x = "",
       y = "Total",
       fill = "",
       title = "Vaccination")


ggplot_degs_bars_V = all_degs %>%
 filter(disease_vac == "V") %>% 
 ggplot() +
  aes(x = reorder(condition, day), fill = direction, weight = n_degs) +
  geom_bar(position = "dodge") +
  scale_fill_manual(
    values = c(DOWN = "#4DBBD5FF",
    NEUTRAL = "gray80",
    UP = "#d90429")) +
  theme_few() +
  ylim(0, 3500) +
  geom_text(aes(label = n_degs, y = n_degs), 
            position = position_dodge(width = 0.9), 
            angle = 90,
            vjust = 0.5, 
            hjust = -0.2, 
            size = 2) +
  theme(legend.position = "right",
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, size = 7),
        axis.text.y = element_text(vjust = 0.5)) +
  labs(x = "",
       y = "Total",
       fill = "",
       title = "Infection")

ggplot_degs_bars = ggplot_degs_bars_V /
  ggplot_degs_bars_I +
  plot_layout(guides = "collect", axes = "collect")

ggsave(ggplot_degs_bars, file = here("Figures", "DEGs_up_down_barplot_pvalue05_1.png"),  width = 10, height = 6)

ggplot_degs_bars

# ggplot_degs_bars %>% 
#   ggplotly()
```

By type

```{r fig.height=6, fig.width=10}
#Plot 2
ggplot_degs_bars_2 = all_degs %>%
 ggplot(aes(x = condition, fill = direction, weight = n_degs,
            label = condition)) +
  geom_bar(position = "dodge") +
  scale_fill_manual(
    values = c(DOWN = "#4DBBD5FF",
    NEUTRAL = "gray",
    UP = "#d90429")) +
  theme_minimal() +
  facet_wrap(vars(type), scales = "free", nrow = 2) +
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, size = 7),
        axis.text.y = element_text(vjust = 0.5)) +
  ggtitle("DEGs - all studies, p<0.05")

ggsave(ggplot_degs_bars_2, file = here("Figures", "DEGs_up_down_barplot_pvalue05_2.png"),  width = 10, height = 6)

```

## 4.2. Overlapping genes

### 4.2.1. Input

```{r}
# DEGs table
degs_all_updown = read_rds(file = here("DGE analysis", "all_studies_degs_weighted.rds")) %>% 
  filter(fdr <= 0.05) %>% 
  filter(direction != "NEUTRAL") %>% 
  mutate_all(~ replace(., is.na(.), "NA"))

ann_vaccines = read_csv(here("Annotations and metadata", "ann_vaccines_conditions.csv"))

# Only up and down
data = degs_all_updown %>% 
  filter(fdr < 0.05) %>% 
 dplyr::select(process = condition, genes)

filename = "All_covid"
```

### 4.2.2. Function

```{r}
# Function for overlapping -------
overlap_genes <- function(cond1, cond2, data) {
  genes_cond1 <- data$genes[data$process == cond1]
  genes_cond2 <- data$genes[data$process == cond2]
  
  genes_shared <- intersect(genes_cond1, genes_cond2)
  
  genes_notshared_cond1 <- setdiff(genes_cond1, genes_cond2)
  genes_notshared_cond2 <- setdiff(genes_cond2, genes_cond1)
  
  total_genes_cond1 <- length(genes_cond1)
  total_genes_cond2 <- length(genes_cond2)
  
  percentage_shared_cond1 <- length(genes_shared) / total_genes_cond1 * 100
  percentage_shared_cond2 <- length(genes_shared) / total_genes_cond2 * 100
  
  shared_genes <- data.frame(
    Cond1 = cond1,
    Cond2 = cond2,
    Shared = length(genes_shared),
    NotShared_cond1 = length(genes_notshared_cond1),
    NotShared_cond2 = length(genes_notshared_cond2),
    Total_Genes_Cond1 = total_genes_cond1,
    Total_Genes_Cond2 = total_genes_cond2,
    Genes_Names = paste(genes_shared, collapse = ", "),
    Percentage_Shared_Cond1 = percentage_shared_cond1,
    Percentage_Shared_Cond2 = percentage_shared_cond2
  )
  
  return(shared_genes)
}
```

### 4.2.3. Perform calculations

```{r}

conflicted::conflicts_prefer(base::intersect)
conflicted::conflicts_prefer(base::setdiff)
conflicted::conflicts_prefer(stats::fisher.test)

# Perform calculations
unique_cond <- unique(data$process) # List sets
shared_genes_df <- data.frame() # Store data

for (i in 1:(length(unique_cond) - 1)) {
  for (j in (i + 1):length(unique_cond)) {
    resultado_temp <- overlap_genes(unique_cond[i], unique_cond[j], data)
    shared_genes_df <- bind_rows(shared_genes_df, resultado_temp)
  }
}

# Fisher's exact test
fisher_exact_test <- function(shared, notshared1, notshared2) {
  cont_table <- matrix(c(shared, notshared1, notshared2, 0), nrow = 2)
  results_fisher <- fisher.test(cont_table)
  return(results_fisher$p.value)
}
shared_genes_df = shared_genes_df %>%
  mutate(pvalue = pmap_dbl(list(Shared, NotShared_cond1, NotShared_cond2), fisher_exact_test)) %>% 
  mutate("-log(p)" = -log10(pvalue))


#Mirror table
shared_genes_df2 = shared_genes_df %>% 
  rename(Cond1_temp = Cond1, Cond2_temp = Cond2) %>%
  rename(Cond1 = Cond2_temp, Cond2 = Cond1_temp)

shared_genes_df_mirror = shared_genes_df %>% 
  bind_rows(shared_genes_df2) %>% 
  mutate(Percentage_Shared_Cond1 = round(Percentage_Shared_Cond1, 2),
         Percentage_Shared_Cond2 = round(Percentage_Shared_Cond2, 2))
  
#Jaccard distance
jaccard.matrix <- data %>%
  mutate(present = 1) %>% 
  distinct() %>% 
  pivot_wider(names_from = genes, values_from = present, values_fill = 0) %>%
  column_to_rownames(var = "process") %>%
  vegdist(binary = TRUE, method = "jaccard", diag = TRUE, upper = TRUE) %>%
  as.matrix() %>%
  {1 - .}

shared_genes_df_mirror = jaccard.matrix %>% 
  as.data.frame() %>% 
  rownames_to_column("Cond1") %>% 
  pivot_longer(cols = -"Cond1",
               names_to = "Cond2",
               values_to = "jaccard_distance") %>% 
  inner_join(shared_genes_df_mirror, by = join_by(Cond1, Cond2)) %>% 
  mutate(jaccard_distance = round(jaccard_distance, 3))

#Save
write_csv(shared_genes_df_mirror, 
          file = here("DGE analysis", paste0(filename, "_sharedgenes_Fisher_Jaccard.csv")))

```

### 4.2.4. Heatmap

#### 4.2.4.1. Shared genes

```{r}
filename = "All_covid_Shared"
#Anotar colunas
# Converter para wide table
matrix_data = shared_genes_df_mirror %>% 
  dcast(Cond1 ~ Cond2, 
        value.var = "Shared", 
        fun.aggregate = mean) %>% 
  column_to_rownames("Cond1") %>%
  mutate_if(is.character, as.numeric) %>% 
  as.matrix() 

dim(matrix_data)

# Verificar se todas as vacinas da anotação estão na matriz e unir as tabelas
ann_vaccines_complex = matrix_data %>% 
  as.data.frame() %>%
  rownames_to_column("condition") %>% 
  select(condition) %>% 
  inner_join(ann_vaccines, by = "condition") %>%
  select(condition, vaccine:regimen, week) %>% 
  distinct() 

# Unir tabela de anotações
ann_vaccines_heatmap = matrix_data %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "process") %>% 
  rename(condition = '.') %>% 
  inner_join(ann_vaccines_complex, by = "condition") %>% 
  arrange(condition) %>% 
  relocate(dose, .before=vaccine) %>% 
  column_to_rownames(var= "condition")  %>% 
  mutate(dose = ifelse(is.na(dose), "NA", dose))

# Ordenar colunas da matriz para a mesma ordem das linhas da tabela de anotações
matrix_data_ordered = matrix_data %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  merge(ann_vaccines_complex, by.y = "condition", all.x=TRUE) %>% 
  arrange(condition) %>% #Trocar a variável pela qual deseja ordenar (Vaccine, Day, Condition, etc.)
  select(!c(vaccine:regimen, week)) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>% #Converter em numéricos
  as.matrix()

matrix_data_ordered_rows = matrix_data_ordered %>% 
  as.data.frame() %>% 
  rownames_to_column("condition") %>% 
  arrange(condition) %>% 
  column_to_rownames(var= "condition") %>% 
  as.matrix()

#Verificar se as linhas sao iguais------
dim(matrix_data_ordered_rows) #Usar se for ordenar por colunas
dim(ann_vaccines_heatmap) #Anotações sobre as colunas

#Espectro de cores
col_fun <- colorRamp2(c(0, 500), c("white", "#d90429"))

```

```{r}
######## HEATMAP ANNOTATION
ann_vaccines_heatmap = ann_vaccines_heatmap %>% 
  select(type, vaccine, day) %>% 
  mutate(day = as_factor(day),
         day = fct_reorder(day, as.numeric(day)))

ha = HeatmapAnnotation(df = ann_vaccines_heatmap, 
                       col = ann_vaxsig_colors, 
                       annotation_name_side = "left",
                       show_legend = F)

row_ha = rowAnnotation(df = ann_vaccines_heatmap, 
                       col = ann_vaxsig_colors)



mat = matrix_data_ordered_rows
width_image = 40
height_image = 40
width = unit(20, "cm")
height = unit(20, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)
gp = gpar(fontsize = 5)
rect_gp = gpar(col = "gray1", lwd = 0)



fileimageheatmap_grouped = paste0(filename, sep ="_", "Heatmap.png")

png(
  file = here("Figures", fileimageheatmap_grouped),
  width = width_image,
  height = height_image,
  units = "cm",
  res = 900
)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "Shared DEGs", #Legend
                        col = col_fun, #color
                         cell_fun = function(j, i, x, y, width, height, fill) {
  if (!is.na(mat[i, j]) && mat[i, j] > 0) {
    grid.text(sprintf("%.f", mat[i, j]), x, y, gp = gpar(fontsize = 5))
  }
},
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
                        column_names_rot = 90,
                        column_names_gp = column_names_gp,
                        cluster_rows = TRUE,
                        rect_gp = rect_gp,
                        row_names_gp = row_names_gp,
                        # row_split = 2, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        na_col = "black",
                        column_split = NULL, #Split group clusters
                        #column_km = 3,
                        column_gap = unit(8, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = width, 
                        height = height
)

draw(heatmap_plot_all, annotation_legend_side = "left")

dev.off()
```

#### 4.2.4.2. Jaccard distance

```{r}
filename = "All_covid_Jaccarddist"


matrix_data = shared_genes_df_mirror %>% 
  dcast(Cond1 ~ Cond2, 
        value.var = "jaccard_distance", 
        fun.aggregate = mean) %>% 
  column_to_rownames("Cond1") %>%
  mutate_if(is.character, as.numeric) %>% 
  as.matrix() 

ann_vaccines_complex = matrix_data %>% 
  as.data.frame() %>%
  rownames_to_column("condition") %>% 
  select(condition) %>% 
  inner_join(ann_vaccines, by = "condition") %>%
  select(condition, vaccine:regimen, week) %>% 
  distinct() 


ann_vaccines_heatmap = matrix_data %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "process") %>% 
  rename(condition = '.') %>% 
  merge(ann_vaccines_complex, by = "condition", all.x = TRUE) %>% 
  arrange(condition) %>% 
  relocate(dose, .before=vaccine) %>% 
  column_to_rownames(var= "condition")  %>% 
  mutate(dose = ifelse(is.na(dose), "NA", dose))

matrix_data_ordered = matrix_data %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  merge(ann_vaccines_complex, by.y = "condition", all.x=TRUE) %>% 
  arrange(condition) %>% 
  select(!c(vaccine:regimen, week)) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>% 
  as.matrix()

matrix_data_ordered_rows = matrix_data_ordered %>% 
  as.data.frame() %>% 
  rownames_to_column("condition") %>% 
  arrange(condition) %>% 
  column_to_rownames(var= "condition") %>% 
  as.matrix()

dim(matrix_data_ordered)
dim(ann_vaccines_heatmap)

col_fun <- colorRamp2(c(0, 0.50), c("white", "#d90429")) #Immune

```

```{r}

######## HEATMAP ANNOTATION
ann_vaccines_heatmap = ann_vaccines_heatmap %>% 
  select(type, vaccine, day) %>% 
  mutate(day = as_factor(day),
         day = fct_reorder(day, as.numeric(day)))

ha = HeatmapAnnotation(df = ann_vaccines_heatmap, 
                       col = ann_vaxsig_colors, 
                       annotation_name_side = "left",
                       show_legend = F)

row_ha = rowAnnotation(df = ann_vaccines_heatmap, 
                       col = ann_vaxsig_colors)



mat = matrix_data_ordered_rows
width_image = 40
height_image = 40
width = unit(20, "cm")
height = unit(20, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)
gp = gpar(fontsize = 5)
rect_gp = gpar(col = "gray1", lwd = 0)



fileimageheatmap_grouped = paste0(filename, sep ="_", "Heatmap.png")

png(
  file = here("Figures", fileimageheatmap_grouped),
  width = width_image,
  height = height_image,
  units = "cm",
  res = 900
)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "Shared DEGs", #Legend
                        col = col_fun, #color
                         cell_fun = function(j, i, x, y, width, height, fill) {
  if (!is.na(mat[i, j]) && mat[i, j] > 0.01) {
    grid.text(sprintf("%.2f", mat[i, j]), x, y, gp = gpar(fontsize = 5))
  }
},
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
                        column_names_rot = 90,
                        column_names_gp = column_names_gp,
                        cluster_rows = TRUE,
                        rect_gp = rect_gp,
                        row_names_gp = row_names_gp,
                        # row_split = 2, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        na_col = "black",
                        column_split = NULL, #Split group clusters
                        #column_km = 3,
                        column_gap = unit(8, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = width, 
                        height = height
)

draw(heatmap_plot_all, annotation_legend_side = "left")

dev.off()
```

### 4.2.5. Chord diagram

#### 4.2.5.1. Shared

##### 4.2.5.1.1. All conditions (Interactive)

```{r}
library(chorddiag)

matrix_vaccines <- shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  dplyr::select(Cond1, Cond2, Shared) %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

types = shared_genes_df_mirror %>% 
  dplyr::select(condition = Cond1) %>% 
  distinct() %>% 
  inner_join(ann_vaccines %>% 
 dplyr::select(condition, type), by = "condition") %>% 
  dplyr::select(type)

colors = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(ann_vaccines %>% 
 dplyr::select(condition, type), by = "type") %>% 
  inner_join(matrix_vaccines %>% 
               as.data.frame() %>% 
               colnames() %>% as.data.frame() %>% rename(condition = "."),
             by = "condition") %>% 
  pull(color)

# Build the chord diagram:
all_shared = chorddiag(matrix_vaccines,
          groupColors = colors,
          type = "directional",
          width = NULL,
          height = NULL,
          margin = 100,
          showGroupnames = TRUE,
          groupThickness = 0.1,
          groupPadding = 2,
          groupnamePadding = 1,
          groupnameFontsize = 10,
          groupedgeColor = NULL,
          chordedgeColor = NULL,
          categoryNames = NULL,
          categorynamePadding = 100,
          categorynameFontsize = 28,
          showTicks = TRUE,
          tickInterval = NULL,
          ticklabelFontsize = 10,
          fadeLevel = 0.1,
          showTooltips = TRUE,
          showZeroTooltips = TRUE,
          tooltipNames = NULL,
          tooltipUnit = NULL,
          tooltipFontsize = 12,
          tooltipGroupConnector = " &#x25B6; ",
          precision = NULL,
          clickAction = NULL,
          clickGroupAction = NULL
)
all_shared
```

##### 4.2.5.1.2. Weeks

Prepare tables

```{r fig.height=5, fig.width=5}
#Week 1 ------
links_df_W1 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(ann_vaccines %>% 
               filter(week == 1) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(ann_vaccines %>% 
               filter(week == 1) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, Shared)

mat_week1 = links_df_W1 %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()
grid.col_w1 = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(ann_vaccines %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W1,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)
group_w1 = ann_vaccines %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W1,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)


#Week 2 ------
links_df_W2 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(ann_vaccines %>% 
               filter(week == 2) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(ann_vaccines %>% 
               filter(week == 2) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, Shared)

mat_week2 = links_df_W2 %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_w2 = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(ann_vaccines %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W2,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_w2 = ann_vaccines %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W2,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)


#Week 4 ------
links_df_W4 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(ann_vaccines %>% 
               filter(week == 4) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(ann_vaccines %>% 
               filter(week == 4) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, Shared)

mat_week4 = links_df_W4 %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_w4 = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(ann_vaccines %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W4,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_w4 = ann_vaccines %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W4,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

#Week 7 ------
links_df_W7 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(ann_vaccines %>% 
               filter(week == 7) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(ann_vaccines %>% 
               filter(week == 7) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, Shared)

mat_week7 = links_df_W7 %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_w7 = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(ann_vaccines %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W7,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_w7 = ann_vaccines %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W7,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

```

Plot

```{r fig.height= 5, fig.width=10}
#Plot
png(filename = here("Figures","ChordDiagram_Covid19_Weeks_1-2-4-7.png"), 
    width = 12, height = 14, units = "in", res = 300)

par(mfrow = c(2, 2))
#WEEK 1
chordDiagram(mat_week1, 
             grid.col = grid.col_w1, 
             annotationTrack = "grid", 
             directional = -1,
             big.gap = 6,
             transparency = 0,
             small.gap = 3,
             link.zindex = rank(mat_week1),
             h.ratio = 0.7, 
             group = group_w1,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week1))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Week 1")

# WEEK 2
chordDiagram(mat_week2, grid.col = grid.col_w2, 
             annotationTrack = "grid", 
            big.gap = 50,
             group = group_w2,
             small.gap = 3,
             link.zindex = rank(mat_week2),
             h.ratio = 0.7, 
             directional = -1,
             transparency = 0,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week2))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},
  bg.border = NA)

title("Week 2")


# WEEK 4
chordDiagram(mat_week4, grid.col = grid.col_w4, 
             annotationTrack = "grid", 
            big.gap = 50,
             group = group_w4,
             small.gap = 3,
             link.zindex = rank(mat_week4),
             h.ratio = 0.7, 
             directional = -1,
             transparency = 0,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week4))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},
  bg.border = NA)

title("Week 4")

# WEEK 7
chordDiagram(mat_week7, grid.col = grid.col_w7, 
             annotationTrack = "grid", 
            big.gap = 50,
             group = group_w7,
             small.gap = 3,
             link.zindex = rank(mat_week7),
             h.ratio = 0.7, 
             directional = -1,
             transparency = 0,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week7))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},
  bg.border = NA)

title("Week 7")

dev.off()
circos.clear()

```

##### 4.2.5.1.3. Types

Prepare tables

```{r fig.height= 10, fig.width=10}
#Types
###### All -----
links_df = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  dplyr::select(Cond1, Cond2, Shared)

mat_types = links_df %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_types = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(ann_vaccines %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_types = ann_vaccines %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

# Vaccination only -------
links_df_vac = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(ann_vaccines %>% 
               filter(disease_vac == "V") %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(ann_vaccines %>% 
               filter(disease_vac == "V") %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, Shared)

mat_types_vac = links_df_vac %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_types_vac = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(ann_vaccines %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_vac,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_types_vac = ann_vaccines %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_vac,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

#Infection only
links_df_inf = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(ann_vaccines %>% 
               filter(disease_vac == "I") %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(ann_vaccines %>% 
               filter(disease_vac == "I") %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, Shared)

mat_types_inf = links_df_inf %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_types_inf = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(ann_vaccines %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_inf,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_types_inf = ann_vaccines %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_inf,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)
```

Plot All conditions and stats

```{r fig.height= 5, fig.width=5}
#Plot

#Types

png(filename = here("Figures","ChordDiagram_Covid19_Types_All.png"), 
    width = 5, height = 5, units = "in", res = 300)

#Infection and vaccination
chordDiagram(mat_types, grid.col = grid.col_types,
             annotationTrack = "grid",  transparency = 0,
             big.gap = 10,
             small.gap = 3,
             directional = -1, 
             group = group_types,
             link.zindex = rank(mat_types),
              h.ratio = 0.7, 
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_types))))))

circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.5, #Label size
      font = 0.1
      )},
  bg.border = NA)
title("Infection and Vaccination")

dev.off()
circos.clear()
```

By state

```{r fig.height= 5, fig.width=15}

png(filename = here("Figures","ChordDiagram_Covid19_Types_Inf_Vac.png"), 
    width = 6, height = 12, units = "in", res = 300)

par(mfrow = c(2, 1))
#Vaccination
chordDiagram(mat_types_vac, grid.col = grid.col_types_vac, 
             annotationTrack = "grid", transparency = 0,
             big.gap = 6,
             small.gap = 3,
                          directional = -1,
             group = group_types,
             link.zindex = rank(mat_types_vac),
             h.ratio = 0.7, 
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_types_vac))))))

circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.5, #Label size
      font = 0.1
      )},
  bg.border = NA) 
title("Vaccination only")

#Infection
chordDiagram(mat_types_inf, grid.col = grid.col_types_inf, 
             annotationTrack = "grid", transparency = 0,
             big.gap = 50,
             small.gap = 3,
            directional = -1,
             group = group_types,
             h.ratio = 0.7, 
             link.zindex = rank(mat_types_inf),
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_types_inf))))))

circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.5, #Label size
      font = 0.1
      )},
  bg.border = NA) 
title("Infection only")
circos.clear()
dev.off()
```

#### 4.2.5.2. Jaccard distance

##### 4.2.5.2.1. All conditions (Interactive)

```{r}

matrix_vaccines <- shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance) %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

types = shared_genes_df_mirror %>% 
  dplyr::select(condition = Cond1) %>% 
  distinct() %>% 
  inner_join(ann_vaccines %>% 
 dplyr::select(condition, type), by = "condition") %>% 
  dplyr::select(type)

colors = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(ann_vaccines %>% 
 dplyr::select(condition, type), by = "type") %>% 
  inner_join(matrix_vaccines %>% 
               as.data.frame() %>% 
               colnames() %>% as.data.frame() %>% rename(condition = "."),
             by = "condition") %>% 
  pull(color)

# Build the chord diagram:
chorddiag(matrix_vaccines,
          groupColors = colors,
          type = "directional",
          width = NULL,
          height = NULL,
          margin = 100,
          showGroupnames = TRUE,
          groupThickness = 0.1,
          groupPadding = 2,
          groupnamePadding = 1,
          groupnameFontsize = 10,
          groupedgeColor = NULL,
          chordedgeColor = NULL,
          categoryNames = NULL,
          categorynamePadding = 100,
          categorynameFontsize = 28,
          showTicks = TRUE,
          tickInterval = NULL,
          ticklabelFontsize = 10,
          fadeLevel = 0.1,
          showTooltips = TRUE,
          showZeroTooltips = TRUE,
          tooltipNames = NULL,
          tooltipUnit = NULL,
          tooltipFontsize = 12,
          tooltipGroupConnector = " &#x25B6; ",
          precision = NULL,
          clickAction = NULL,
          clickGroupAction = NULL
)
```

##### 4.2.5.2.2. Weeks

Prepare tables

```{r fig.height=5, fig.width=5}
#Week 1 ------
links_df_W1 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(ann_vaccines %>% 
               filter(week == 1) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(ann_vaccines %>% 
               filter(week == 1) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance)

mat_week1 = links_df_W1 %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()
grid.col_w1 = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(ann_vaccines %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W1,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)
group_w1 = ann_vaccines %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W1,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)


#Week 2 ------
links_df_W2 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(ann_vaccines %>% 
               filter(week == 2) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(ann_vaccines %>% 
               filter(week == 2) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance)

mat_week2 = links_df_W2 %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_w2 = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(ann_vaccines %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W2,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_w2 = ann_vaccines %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W2,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)


#Week 4 ------
links_df_W4 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(ann_vaccines %>% 
               filter(week == 4) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(ann_vaccines %>% 
               filter(week == 4) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance)

mat_week4 = links_df_W4 %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_w4 = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(ann_vaccines %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W4,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_w4 = ann_vaccines %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W4,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

#Week 7 ------
links_df_W7 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(ann_vaccines %>% 
               filter(week == 7) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(ann_vaccines %>% 
               filter(week == 7) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance)

mat_week7 = links_df_W7 %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_w7 = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(ann_vaccines %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W7,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_w7 = ann_vaccines %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W7,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

```

Plot

```{r fig.height= 5, fig.width=10}
#Plot
png(filename = here("Figures","ChordDiagram_Covid19_Weeks_1-2-4-7_jaccard.png"), 
    width = 12, height = 14, units = "in", res = 300)

par(mfrow = c(2, 2))
#WEEK 1
chordDiagram(mat_week1, 
             grid.col = grid.col_w1, 
             annotationTrack = "grid", 
             directional = -1,
             big.gap = 6,
             transparency = 0,
             small.gap = 3,
             link.zindex = rank(mat_week1),
             h.ratio = 0.7, 
             group = group_w1,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week1))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Week 1")

# WEEK 2
chordDiagram(mat_week2, grid.col = grid.col_w2, 
             annotationTrack = "grid", 
            big.gap = 50,
             group = group_w2,
             small.gap = 3,
             link.zindex = rank(mat_week2),
             h.ratio = 0.7, 
             directional = -1,
             transparency = 0,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week2))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},
  bg.border = NA)

title("Week 2")


# WEEK 4
chordDiagram(mat_week4, grid.col = grid.col_w4, 
             annotationTrack = "grid", 
            big.gap = 50,
             group = group_w4,
             small.gap = 3,
             link.zindex = rank(mat_week4),
             h.ratio = 0.7, 
             directional = -1,
             transparency = 0,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week4))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},
  bg.border = NA)

title("Week 4")

# WEEK 7
chordDiagram(mat_week7, grid.col = grid.col_w7, 
             annotationTrack = "grid", 
            big.gap = 50,
             group = group_w7,
             small.gap = 3,
             link.zindex = rank(mat_week7),
             h.ratio = 0.7, 
             directional = -1,
             transparency = 0,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week7))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},
  bg.border = NA)

title("Week 7")

dev.off()
circos.clear()

```

##### 4.2.5.2.3. Types

Prepare tables

```{r fig.height= 10, fig.width=10}
#Types
###### All -----
links_df = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance)

mat_types = links_df %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(jaccard_distance = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_types = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(ann_vaccines %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_types = ann_vaccines %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

# Vaccination only -------
links_df_vac = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(ann_vaccines %>% 
               filter(disease_vac == "V") %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(ann_vaccines %>% 
               filter(disease_vac == "V") %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance)

mat_types_vac = links_df_vac %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(jaccard_distance = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_types_vac = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(ann_vaccines %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_vac,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_types_vac = ann_vaccines %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_vac,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

#Infection only
links_df_inf = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(ann_vaccines %>% 
               filter(disease_vac == "I") %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(ann_vaccines %>% 
               filter(disease_vac == "I") %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance)

mat_types_inf = links_df_inf %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(jaccard_distance = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_types_inf = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(ann_vaccines %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_inf,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_types_inf = ann_vaccines %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_inf,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)
```

Plot All conditions and stats

```{r fig.height= 5, fig.width=5}
#Plot

#Types

png(filename = here("Figures","ChordDiagram_Covid19_Types_All_jaccard_distance.png"), 
    width = 5, height = 5, units = "in", res = 300)

#Infection and vaccination
chordDiagram(mat_types, grid.col = grid.col_types,
             annotationTrack = "grid",  transparency = 0,
             big.gap = 10,
             small.gap = 3,
             directional = -1, 
             group = group_types,
             link.zindex = rank(mat_types),
              h.ratio = 0.7, 
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_types))))))

circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.5, #Label size
      font = 0.1
      )},
  bg.border = NA)
title("Infection and Vaccination")

dev.off()
circos.clear()
```

By state

```{r fig.height= 5, fig.width=15}

png(filename = here("Figures","ChordDiagram_Covid19_Types_Inf_Vac_jaccard_distance.png"), 
    width = 6, height = 12, units = "in", res = 300)

par(mfrow = c(2, 1))
#Vaccination
chordDiagram(mat_types_vac, grid.col = grid.col_types_vac, 
             annotationTrack = "grid", transparency = 0,
             big.gap = 6,
             small.gap = 3,
                          directional = -1,
             group = group_types,
             link.zindex = rank(mat_types_vac),
             h.ratio = 0.7, 
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_types_vac))))))

circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.5, #Label size
      font = 0.1
      )},
  bg.border = NA) 
title("Vaccination only")

#Infection
chordDiagram(mat_types_inf, grid.col = grid.col_types_inf, 
             annotationTrack = "grid", transparency = 0,
             big.gap = 50,
             small.gap = 3,
            directional = -1,
             group = group_types,
             h.ratio = 0.7, 
             link.zindex = rank(mat_types_inf),
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_types_inf))))))

circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.5, #Label size
      font = 0.1
      )},
  bg.border = NA) 
title("Infection only")
circos.clear()
dev.off()
```

## 4.3.Immune and non-immune DEGs

```{r}
ImmuneGO_Annotated_GO <- read_csv(here("VaxGO gene sets", "ImmuneGO_Annotated_GO_2024_03_26.csv"))

immunego = ImmuneGO_Annotated_GO %>% 
  mutate(genes = str_split(genes, ",")) %>%
  unnest(genes)
#### Not immune
all_degs_infected_notimmune = all_degs_p_05_vac_infected %>%
  anti_join(immunego %>%
              select(genes) %>%
              distinct(),
            by = "genes") %>%
  distinct() %>% 
  mutate(bioprocess = "Other")

all_degs_infected_notimmune %>% 
  tabyl(condition, bioprocess)

```

```{r}
#### Immune
all_degs_vac_infected_immune = all_degs_p_05_vac_infected %>% 
  inner_join(immunego %>% 
              select(genes) %>% 
              distinct(),
            by = "genes") %>% 
  distinct() %>% 
  mutate(bioprocess = "Immune")

all_degs_vac_infected_immune %>% 
  tabyl(condition, bioprocess) 
```

```{r}
##### Immune and other
all_degs_processes_immune_nonimmune = bind_rows(all_degs_vac_infected_immune, 
                               all_degs_infected_notimmune)

all_degs_processes_immune_nonimmune %>%
  tabyl(condition, bioprocess) %>% 
  adorn_totals("col") %>% 
  adorn_percentages() %>% 
  adorn_pct_formatting() 

write_csv(all_degs_processes_immune_nonimmune, file = here("DGE analysis", "all_degs_processes_immune_nonimmune.csv"))
```

### 4.4.1. Retrieving genes by Gene Ontology

```{r}
organism = "org.Hs.eg.db"
conflicted::conflicts_prefer(dplyr::summarize)
# install.packages("GO.db")
# BiocManager::install(organism, character.only = TRUE)
library(organism, character.only = TRUE)
library(clusterProfiler)
library(GO.db)

#HGNC symbol to Entrez
x <- org.Hs.egSYMBOL
mapped_genes <- mappedkeys(x)
symbols_entrez <- as.data.frame(x[mapped_genes])

## Entrez to GO
x <- org.Hs.egGO
mapped_genes <- mappedkeys(x)
entrez_geneontology <- as.data.frame(x[mapped_genes])

## GO BP ancestors
go_bp_ancestor = GOBPANCESTOR %>% 
  as.data.frame()
colnames(go_bp_ancestor)[1] <- "go_id"
colnames(go_bp_ancestor)[2] <- "go_ancestor"

## GO ID to terms
go_bp = AnnotationDbi::select(GO.db, columns=c("GOID","TERM"), keys= "BP", keytype= "ONTOLOGY") %>% 
  clean_names() %>% 
  select(go_id = goid, term)

## GO child and ancestor
go_bp_ancestor = go_bp_ancestor %>% 
  inner_join(go_bp %>% rename(go_ancestor = go_id), by = "go_ancestor") %>% 
  rename(term_ancestor = term)

#GO ids to terms
go_bp = AnnotationDbi::select(GO.db, columns=c("GOID","TERM"), keys="BP", keytype="ONTOLOGY") %>% 
  clean_names() %>% 
  rename(go_id = goid) %>% 
  select(-ontology) %>% 
  right_join(entrez_geneontology, by = "go_id") %>% 
  right_join(symbols_entrez, by = "gene_id") %>% 
  clean_names() %>% 
  left_join(go_bp_ancestor, by = "go_id") %>% 
  distinct()

#Filter main GO BP terms
go_bp_main = go_bp %>%
  filter(go_ancestor %in% c(
      "GO:0040011",
      "GO:0043473",
      "GO:0044419",
      "GO:0009987",
      "GO:0048518",
      "GO:0050789",
      "GO:0065007",
      "GO:0048511",
      "GO:0022414",
      "GO:0002376",
      "GO:0008152")) %>% 
  filter(str_detect(term_ancestor, "cellular process|biological process involved in interspecies interaction between organisms|regulation of biological process|immune system process|No annotation|Not mapped|metabolic process"),
         !term_ancestor == "positive regulation of biological process") %>% 
  mutate(term_ancestor = case_when(
           term_ancestor == "biological process involved in interspecies interaction between organisms" ~ "Interspecies interaction",
           term_ancestor == "biological regulation" ~ "Biological reg.",
           term_ancestor == "cellular process" ~ "Cellular",
           term_ancestor == "immune system process" ~ "Immune system",
           term_ancestor == "regulation of biological process" ~ "Reg. of BP",
           term_ancestor == "locomotion" ~ "Locomotion",
           term_ancestor == "metabolic process" ~ "Metabolism",
           TRUE ~ term_ancestor))

#Add set size column
go_bp_main_2 = go_bp_main %>% 
  group_by(term_ancestor) %>% 
  summarise(set_size = n()) %>% 
  inner_join(go_bp_main) %>% 
  select(term_ancestor, set_size, go_ancestor, symbol) %>% 
  distinct() %>% 
  mutate(annotation = "Major process")

go_bp_child = go_bp_main %>% 
  select(term_ancestor, go_ancestor, symbol) %>% 
  distinct() %>% 
  group_by(term_ancestor) %>% 
  summarise(set_size = n()) %>% 
  inner_join(go_bp_main, by = "term_ancestor") %>% 
  select(term_ancestor, set_size, go_ancestor, symbol) %>% 
  distinct() %>% 
  mutate(annotation = "Minor process")

go_bp_all = bind_rows(go_bp_main_2, go_bp_child)

write_csv(go_bp_all, file = here("VaxGO gene sets", "OtherGOs_Annotated_Genes.csv"))

# Collapse rows 
go_bp_all_comma = go_bp_all %>% 
  group_by(term_ancestor) %>% 
  summarize(genes = paste0(symbol, collapse = ",")) %>% 
  inner_join(go_bp_all, by = "term_ancestor") %>% 
  select(-symbol) %>% 
  distinct() %>% 
  arrange(desc(set_size))

write_csv(go_bp_all_comma, file = here("VaxGO gene sets","OtherGOs_Annotated_GOs.csv"))

go_bp_all
go_bp_all_comma
```

```{r}

# DEGs to Entrez and GO ids --------
degs_GO = all_degs_p_05_vac_infected %>% 
  filter(direction != "NEUTRAL") %>% 
  select(condition, genes, direction) %>% 
  left_join(go_bp_all %>% rename(genes = symbol), by = "genes") %>% 
  mutate(go_ancestor = if_else(is.na(go_ancestor), "Not mapped", go_ancestor),
         term_ancestor = if_else(is.na(term_ancestor), "Not mapped", term_ancestor),
         mapped = if_else(term_ancestor == "Not mapped", "Not mapped", "Mapped"))



# Collapse gene column --------
degs_GO_comma = degs_GO %>% 
  distinct() %>% 
  group_by(condition, term_ancestor) %>% 
  summarize(genes = paste0(genes, collapse = ",")) %>% 
  inner_join(ann_vaccines, by = "condition")

write_csv(degs_GO_comma, file = here("DGE analysis", "degs_annotated_allGOs.csv"))


#DEGs annotated by Main GO BPs ------

main_go = degs_GO %>%
  filter(go_ancestor %in% c(
      "Not mapped",
      "GO:0040011",
      "GO:0043473",
      "GO:0044419",
      "GO:0009987",
      "GO:0048518",
      "GO:0050789",
      "GO:0065007",
      "GO:0048511",
      "GO:0022414",
      "GO:0002376",
      "GO:0008152")) %>% 
  select(condition, genes, direction, term_ancestor) %>% 
  distinct() %>% 
  group_by(condition, direction, term_ancestor) %>% 
  summarise(n = n()) %>% 
  mutate(term_ancestor = if_else(is.na(term_ancestor), "No annotation", term_ancestor))

main_go_2 = degs_GO %>% 
  select(condition, genes, mapped, direction) %>% 
  distinct() %>% 
  group_by(condition, direction) %>% 
  summarise(n_genes_total = n()) %>% 
  inner_join(main_go, by = join_by("condition", direction)) %>% 
  ungroup() %>% 
  select(condition, direction, term_ancestor, n_genes = n, n_genes_total) %>% 
  mutate(n_genes_perc = round(n_genes/n_genes_total * 100, 1),
         term_ancestor = case_when(
           term_ancestor == "biological process involved in interspecies interaction between organisms" ~ "Interspecies interaction",
           term_ancestor == "biological regulation" ~ "Biological reg.",
           term_ancestor == "cellular process" ~ "Cellular",
           term_ancestor == "immune system process" ~ "Immune system",
           term_ancestor == "regulation of biological process" ~ "Reg. of BP",
           term_ancestor == "locomotion" ~ "Locomotion",
           term_ancestor == "metabolic process" ~ "Metabolism",
           TRUE ~ term_ancestor),
         term_ancestor = fct_relevel(term_ancestor, "Not mapped", after = Inf),
         direction = fct_relevel(direction, "UP", "DOWN"))
  
write_csv(main_go_2, file = here("DGE analysis", "degs_annotated_mainGOs_stats.csv"))
```

###4.4.2.1. Boxplot

```{r fig.height=10, fig.width=15, warning=FALSE}
degs_annotated_mainGOs_stats <- read_csv(here("DGE analysis", "degs_annotated_mainGOs_stats.csv"))

# Table
df_day =  degs_annotated_mainGOs_stats %>% 
  inner_join(ann_vaccines, by = "condition") %>% 
  select(condition, 
         direction, 
         term_ancestor, 
         n_genes, 
         n_genes_perc,
         day,
         disease_vac) %>% 
  filter(!term_ancestor %in% c("Interspecies interaction","Not mapped", "Reg. of BP")) %>% 
  mutate(day_f = as.factor(day),
         day_f = fct_reorder(day_f, day),
         day_dv = paste(day_f, sep = "",  " (", disease_vac, ")") %>% as.factor(),
         day_dv = fct_reorder(day_dv, day),
         term_ancestor = fct_relevel(term_ancestor, "Immune system", "Cellular", "Metabolism"),
         direction = fct_relevel(direction, "UP", "DOWN"))
df_day
```

```{r fig.height=10, fig.width=20}
all_up_down_day = df_day %>% 
  group_by(disease_vac) %>%
  arrange(desc(n_genes_perc)) %>% 
  ggplot() +
  aes(
    x = day_dv,
    y = n_genes_perc
  ) +
  geom_jitter(aes(colour = disease_vac),
              na.rm = TRUE,
              size = 4) +
  geom_boxplot(aes(fill = disease_vac, color = disease_vac),
               outlier.shape = NA,
               alpha = 0) +
  theme_few() +
  facet_grid(~direction~term_ancestor) +
  theme(axis.text.x = element_text(size = 15, color = "black", angle = 90, vjust = 0.5),
        axis.text.y = element_text(size = 15, color = "black"),
        axis.title.x = element_text(size = 15, color = "black", vjust = -1),
        axis.title.y = element_text(size = 15, color = "black"),
        strip.text.x = element_text(size = 15, face = "bold"),
        strip.text.y = element_text(size = 15, angle = 0,hjust = 0, face = "bold"),
        legend.text = element_text(size = 15, color = "black"),
        legend.title = element_text(size = 15, color = "black"),
        plot.title = element_text(hjust = 0.5,
                                  size = 15,
                                  face = "bold")) +
  labs(x = "Day",
       y = "Number of genes (%)",
       size = "Total number of genes",
       shape = "Type") + 
  scale_fill_npg() + 
  scale_colour_npg() 

all_up_down_day

ggsave(all_up_down_day, width = 20, height = 10, file = here("Figures", "MainGOs_percgenes_boxplot_up_down_day.png"))
```

Explore data with interactive plots

###4.4.2.2. Barplot by term

```{r fig.height=15, fig.width=20, message=FALSE, warning=FALSE}

ann_vaccines_conditions = ann_vaccines_conditions_ordered

main_go_2_plot_up_down = main_go_2 %>%
  inner_join(ann_vaccines_conditions, by = "condition") %>% 
  mutate(
    term_ancestor = fct_relevel(
      term_ancestor,
      "Immune system",
      "Cellular",
      "Metabolism",
      "Reg. of BP"
    )
  ) %>%
  filter(term_ancestor %in% c("Immune system", "Cellular", "Metabolism")) %>% 
mutate(disease_vac = fct_relevel(disease_vac, "I", "V")) %>% 
  arrange(disease_vac) %>% 
  mutate(condition = factor(condition, levels = ann_vaccines_conditions$condition %>% unique())) %>% 
  ggplot() +
 aes(x = fct_rev(factor(condition)), y = n_genes_perc, fill = type) +
 geom_col() +
 coord_flip() +
 theme_minimal() +
   scale_fill_manual(name = "Type",
    values = c('IN'= "#00A087FF", #1st Gen  vaccines
           'VV' = "#3C5488FF", #3rd Gen vaccines
           'RNA' = "#4DBBD5FF",
           'SU' = "#8491B4FF",
           'I'= "#DC0000FF",
           "H" = "grey95")) +
  theme(
    legend.position = "right",
    panel.grid.major.x = element_blank(),
    plot.title = element_text(size = 25, hjust = 0.5),
    legend.title = element_text(size = 15),
    legend.text = element_text(size = 15),
    axis.text.x = element_text(size = 12,
                                color = "black",
                                angle = 0,
                                hjust = 1),
    axis.title.x = element_text(size = 15,
                                color = "black"),
    axis.text.y = element_blank(),
    strip.text.x = element_text(size = 15, 
                                face = "bold"),
    strip.text.y = element_text(
      size = 15,
      angle = 0,
      hjust = 0,
      face = "bold"),
  ) +
  geom_text(aes(label = paste0(n_genes_perc, "% (", n_genes, ")"), 
                y = n_genes_perc), 
            hjust = 0, 
            size = 4,
            angle = 0) +
  labs(title = "",
       x = "",
       y = "Number of genes (%)") +
  ylim(0,120) +
  facet_grid(vars(direction),  vars(term_ancestor))

main_go_2_plot_up_down_totals = main_go_2 %>% 
    inner_join(ann_vaccines_conditions, by = "condition") %>% 
    select(condition, n_genes_total, type, direction, disease_vac) %>% 
  distinct() %>% 
  mutate(disease_vac = fct_relevel(disease_vac, "I", "V")) %>% 
  mutate(stat = "Total genes") %>% 
  arrange(disease_vac) %>% 
  mutate(condition = factor(condition, levels = ann_vaccines_conditions$condition %>% unique())) %>%   ggplot() +
 aes(x = fct_rev(factor(condition)), y = n_genes_total, fill = type) +
 geom_col() +
 coord_flip() +
 theme_minimal() +
   scale_fill_manual(name = "Type",
    values = c('IN'= "#00A087FF", #1st Gen  vaccines
           'VV' = "#3C5488FF", #3rd Gen vaccines
           'RNA' = "#4DBBD5FF",
           'SU' = "#8491B4FF",
           'I'= "#DC0000FF",
           "H" = "grey95")) +
  theme(
    legend.position = "none",
    panel.grid.major.x = element_blank(),
    plot.title = element_text(size = 25, hjust = 0.5),
    legend.title = element_text(size = 15),
    legend.text = element_text(size = 15),
    axis.text.x = element_text(size = 12,
                                color = "black",
                                angle = 0,
                                hjust = 1),
        axis.title.x = element_text(size = 15,
                                color = "black"),
    axis.text.y = element_text(
      size = 12,
      color = "black",
      angle = 0,
      hjust = 1
    ),
    strip.text.x = element_text(size = 15, 
                                face = "bold"),
    strip.text.y = element_blank(),
  ) +
  geom_text(aes(label = n_genes_total, y = n_genes_total),
            hjust = 0, 
            size = 4,
            angle = 0) +
  labs(title = "",
       x = "",
       y = "Total number of genes") +
  ylim(0, 2100) +
   facet_grid(vars(direction),  vars(stat))

patch_maingo = main_go_2_plot_up_down_totals + main_go_2_plot_up_down +
  plot_layout(widths = c(1, 3)) +
  plot_annotation(title = "Main Gene Ontologies (term ancestor), by condition",
                  theme = theme(plot.title = element_text(size = 25,
                                                          face = "bold",
                                                     hjust = 0.5)))

patch_maingo
ggsave(patch_maingo, file = here("Figures", "main_go_2_plot_values_UP_DOWN_regulated.png"), 
                                           width = 20, 
                                           height = 15)
```




```{r fig.height=7, fig.width=10}
### Immune in totals ------

#UP
immune_other_plot  = main_go_2 %>% 
  mutate(direction = if_else(direction == "UP", "Upregulated", "Downregulated"),
         term_ancestor = fct_relevel(term_ancestor, "Immune system", "Cellular", "Metabolism", "Reg. of BP")) %>%
  filter(term_ancestor %in% c("Immune system")) %>% 
  rename(n_genes_immune = n_genes) %>% 
  pivot_longer(names_to = "totals", values_to = "total_number", cols = c(n_genes_immune, n_genes_total)) %>% 
  select(condition, direction, term_ancestor, n_genes_perc, totals, total_number) %>% 
  group_by(condition) %>% 
  mutate(immune_genes = if_else(totals == "n_genes_immune", total_number, NA),
         total_degs = if_else(totals == "n_genes_total", total_number, NA),
         totals = fct_rev(factor(totals)),
         direction = fct_rev(direction)) %>% 
  fill(total_degs, .direction = "up") %>% 
  mutate(condition = factor(condition, levels = ann_vaccines_conditions$condition %>% unique())) %>%
ggplot() +
 aes(x = fct_rev(factor(condition)), y = total_number, fill = totals) +
 geom_col() +
 coord_flip() +
 theme_minimal() +
  scale_fill_manual(name = "",
    values = c("n_genes_total" = "gray90",
              "n_genes_immune" = "#4DBBD5FF"),
    labels = c('Total', 'Immune')) +
  facet_grid(~direction) +
  theme(legend.position = "right", 
        legend.title = element_text(size = 10),
        legend.text = element_text(size=10),
        axis.title.x = element_text(size = 10, color = "black"),
        axis.text.x = element_text(size = 10, color = "black", angle = 0, hjust = 1),
        axis.text.y = element_text(size = 10, color = "black", angle = 0, hjust = 1),
        strip.text.x = element_text(size = 12, color = "black", hjust = 0.5),
        strip.text.y = element_text(size = 15, angle = 0)
        ) +
  geom_text(aes(label = if_else(!is.na(immune_genes), paste0(immune_genes, " (", n_genes_perc, "% of ", total_degs,")") , NA), 
                y = total_degs + immune_genes), 
            hjust = -0.05, 
            size = 3,
            angle = 0) +
  labs(title = "DEGs - Classification by type - Immune vs. Non-immune",
       fill = "Gene type",
       x = "",
       y = "Number of genes") +
  ylim(0, 2800)

ggsave(immune_other_plot, file = here("Figures", "immune_other_plot.png"), width = 15, height = 7)
immune_other_plot

```

```{r fig.height=7, fig.width=15}
degs_immune = main_go_2 %>% 
  mutate(direction = if_else(direction == "UP", "Upregulated", "Downregulated"),
         term_ancestor = fct_relevel(term_ancestor, "Immune system", "Cellular", "Metabolism", "Reg. of BP")) %>%
  filter(term_ancestor %in% c("Immune system")) %>% 
  rename(n_genes_immune = n_genes) %>% 
  pivot_longer(names_to = "totals", values_to = "total_number", cols = c(n_genes_immune, n_genes_total)) %>% 
  select(condition, direction, term_ancestor, n_genes_perc, totals, total_number) %>% 
  group_by(condition) %>% 
  mutate(immune_genes = if_else(totals == "n_genes_immune", total_number, NA),
         total_degs = if_else(totals == "n_genes_total", total_number, NA),
         totals = fct_rev(factor(totals)),
         direction = fct_rev(direction)) %>% 
  fill(total_degs, .direction = "up") %>% 
  inner_join(ann_vaccines %>% select(condition, disease_vac)) %>% 
  mutate(disease_vac = if_else(disease_vac == "V", "Vaccination", "Infection"))
```


```{r fig.height=10, fig.width=10}
#UP
immune_other_plot_diseaseorvac_I  = degs_immune %>% 
  filter(disease_vac == "Infection") %>% 
    mutate(condition = factor(condition, levels = ann_vaccines_conditions$condition %>% unique())) %>%
  ggplot() +
 aes(x = fct_rev(factor(condition)), y = total_number, fill = totals) +
 geom_col() +
 coord_flip() +
 theme_minimal() +
  scale_fill_manual(name = "",
    values = c("n_genes_total" = "gray90",
              "n_genes_immune" = "#4DBBD5FF"),
    labels = c('Total', 'Immune')) +
  theme(legend.position=c(1, 0.1),
        panel.grid = element_blank(),
        legend.title = element_text(size = 10),
        legend.text = element_text(size= 15),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 10, color = "black", angle = 0, hjust = 1),
        strip.text.x = element_text(size = 15, color = "white", hjust = 0.5),
        strip.text.y = element_text(size = 15, angle = 0, face = "bold"),
        strip.background.x = element_rect(
          fill = "black", 
          color = "black", 
          linewidth = 1 )) +
  geom_text(aes(label = if_else(!is.na(immune_genes),
                                paste0(immune_genes, " (", n_genes_perc, "% of ", total_degs, ")") ,
                                NA), 
                y = total_degs + immune_genes), 
            hjust = -0.05, 
            size = 3,
            angle = 0) +
  labs(title = "",
       fill = "Gene type",
       x = "",
       y = "Number of genes") +
  ylim(0, 4000) +
    facet_grid(~disease_vac~direction, scales = "free_y")

immune_other_plot_diseaseorvac_V  = degs_immune %>% 
  filter(disease_vac == "Vaccination") %>% 
  ggplot() +
 aes(x = fct_rev(factor(condition)), y = total_number, fill = totals) +
 geom_col() +
 coord_flip() +
 theme_minimal() +
  scale_fill_manual(name = "Type",
    values = c("n_genes_total" = "gray90",
              "n_genes_immune" = "#4DBBD5FF"),
    labels = c('Total', 'Immune')) +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        legend.title = element_text(size = 10),
        legend.text = element_text(size=10),
        axis.title.x = element_text(size = 10, color = "black"),
        axis.text.x = element_text(size = 10, color = "black", angle = 0, hjust = 1),
        axis.text.y = element_text(size = 10, color = "black", angle = 0, hjust = 1),
        strip.text.x = element_blank(),
        strip.text.y = element_text(size = 15, angle = 0, face = "bold"),
        strip.background.x = element_blank()) +
  geom_text(aes(label = if_else(!is.na(immune_genes),
                                paste0(immune_genes, " (", n_genes_perc, "% of ", total_degs, ")") ,
                                NA), 
                y = total_degs + immune_genes), 
            hjust = -0.05, 
            size = 3,
            angle = 0) +
  labs(title = "",
       fill = "Gene type",
       x = "",
       y = "Number of genes") +
  ylim(0, 4000) +
    facet_grid(~disease_vac~direction, scales = "free_y")

patch_immune_degs = immune_other_plot_diseaseorvac_I / immune_other_plot_diseaseorvac_V 

ggsave(patch_immune_degs, file = here("Figures", "immune_other_plot_diseaseorvac.png"), width = 10, height = 10)

patch_immune_degs
```


### 4.4.3 Shared genes

#### 4.4.3.1. Immune related only

```{r}

degs_all_updown = all_degs_p_05_vac_infected %>% 
  filter(direction != "NEUTRAL") %>% 
  distinct()

ImmuneGO_Annotated_Genes = readRDS(here("VaxGO gene sets", "ImmuneGO_Annotated_Genes_2024-03-26.rds"))

ImmuneGO_Annotated_Genes = ImmuneGO_Annotated_Genes %>% 
  filter(!(process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE")))



shared_genes_infection = degs_all_updown %>%
  select(condition, genes) %>% 
  inner_join(ann_vaccines, by = "condition") %>% 
    filter(disease_vac == "I") %>%
  select(condition, genes, vaccine) %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% select(genes) %>% distinct(), by = "genes") %>% 
  group_by(genes) %>% 
  summarise("Infection" = n()) %>% 
  arrange(desc("Infection"), genes) %>% 
  ungroup() %>% 
  pivot_longer(-genes, names_to = "infection_vaccination", values_to = "n_conditions") %>% 
  inner_join(ImmuneGO_Annotated_Genes , by = "genes") %>% 
  select(genes, infection_vaccination, n_conditions) %>% 
  mutate(comparison = "Infection only") %>% 
  arrange(desc(n_conditions)) %>% 
  distinct()

shared_genes_vaccines = degs_all_updown %>%
  select(condition, genes) %>% 
  distinct() %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% select(genes) %>% distinct(), by = "genes") %>% 
  inner_join(ann_vaccines, by = "condition") %>% 
  filter(disease_vac == "V") %>% 
  select(condition, genes, vaccine) %>% 
  group_by(genes) %>% 
  summarise("Vaccination" = n()) %>% 
  arrange(desc("Vaccination"), genes) %>% 
  ungroup() %>% 
  pivot_longer(-genes, names_to = "infection_vaccination", values_to = "n_conditions") %>% 
  inner_join(ImmuneGO_Annotated_Genes , by = "genes") %>% 
  select(genes, infection_vaccination,n_conditions) %>% 
  mutate(comparison = "Vaccination only") %>% 
  arrange(desc(n_conditions)) %>% 
  distinct()


# Infection and vaccination
shared_genes_vaccines_infection = shared_genes_vaccines %>% 
  select(genes, n_conditions) %>% 
  inner_join(shared_genes_infection %>% select(genes, n_conditions), by = "genes") %>% 
  rename(Vaccination = n_conditions.x, Infection = n_conditions.y) %>% 
  distinct() %>% 
  pivot_longer(-genes, names_to = "infection_vaccination", values_to = "n_conditions") %>% 
  inner_join(ImmuneGO_Annotated_Genes , by = "genes") %>% 
  select(genes, infection_vaccination,n_conditions) %>% 
  mutate(comparison = "Infection and vaccination") %>% 
  distinct()
  

shared_genes_comparisons = bind_rows(shared_genes_infection, 
                                     shared_genes_vaccines, 
                                     shared_genes_vaccines_infection)

write_csv(shared_genes_comparisons, file = here("Figures", "shared_genes_infection_vaccination_comparisons.csv"))

```

```{r fig.height=9, fig.width=10}
# Vaccine and infection ----
shared_genes_infection_vaccination = shared_genes_comparisons %>% 
  filter(comparison == "Infection and vaccination")

shared_genes_infection = shared_genes_comparisons %>% 
  filter(comparison == "Infection only")

shared_genes_vaccines = shared_genes_comparisons %>% 
  filter(comparison == "Vaccination only")


shared_genes_vaccines_infection_plot = shared_genes_infection_vaccination %>% 
  select(genes, infection_vaccination, n_conditions, comparison) %>% 
  distinct() %>%
  slice_head(n=40) %>%  
  ggplot() +
  aes(
    x = reorder(genes, -n_conditions),
    y = n_conditions,
    fill = infection_vaccination
  ) +
  geom_col() +
  scale_fill_manual(
    values = c("Vaccination" = "#4DBBD5FF",
              "Infection" = "#DC0000FF")
    )+
  theme_minimal() +
  labs(fill = "Status") +
  xlab("") + 
  ylab("") +
  theme(legend.position = "right",
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, size = 10, color = "black"),
        axis.text.y = element_text(size = 10, angle = 90, color = "black"),
        panel.grid.minor.y = element_blank(),
        legend.text = element_text(size=10),
        legend.title = element_text(size = 10, face = "bold")) 

#Vaccination only -----
shared_genes_vaccines_only = shared_genes_vaccines %>% 
  anti_join(shared_genes_infection, by = "genes") %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% select(genes), by = "genes") %>% 
  select(genes, n_conditions) %>% 
  mutate(comparison = "Vaccination only") %>% 
  arrange(desc(n_conditions)) %>% 
  distinct()

shared_genes_vaccines_only_plot = shared_genes_vaccines_only %>% 
  select(genes, n_conditions, comparison) %>% 
  distinct() %>%
  slice_head(n=20) %>% 
  ggplot() +
  aes(x = reorder(genes, -n_conditions), 
      fill = comparison, 
      weight = n_conditions) +
  geom_bar() +
  scale_fill_manual(
    values = c("Vaccination only" = "#4DBBD5FF",
              "Infection only" = "#DC0000FF")) +
  theme_minimal() +
  labs(fill = "Vaccination only") +
  xlab("") + 
  ylab("Number of shared conditions") +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, size = 10, color = "black"),
        axis.text.y = element_text(size = 10, angle = 0, color = "black"),
        panel.grid.minor.y = element_blank(),
        legend.text = element_text(size=10),
        legend.title = element_text(size = 10, face = "bold")) 


# Infection only
shared_genes_infection_only = shared_genes_infection %>% 
  anti_join(shared_genes_vaccines_only, by = "genes") %>%
  inner_join(ImmuneGO_Annotated_Genes, by = "genes") %>% 
  select(genes, n_conditions) %>% 
  mutate(comparison = "Infection only") %>% 
  arrange(desc(n_conditions))

shared_genes_infection_only_plot = shared_genes_infection_only %>% 
  select(genes, n_conditions, comparison) %>% 
  arrange(desc(n_conditions)) %>% 
  distinct() %>%
  slice_head(n=20) %>% 
  ggplot() +
  aes(x = reorder(genes, -n_conditions), 
      fill = comparison, 
      weight = n_conditions) +
  geom_bar() +
  scale_fill_manual(
    values = c("Vaccination only" = "#4DBBD5FF",
              "Infection only" = "#DC0000FF")) +
  theme_minimal() +
  labs(fill = "Infection only") +
  xlab("Genes") + 
  ylab("") +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, size = 10, color = "black"),
        axis.text.y = element_text(size = 10, angle = 0, color = "black"),
        panel.grid.minor.y = element_blank(),
        legend.text = element_text(size=10),
        legend.title = element_text(size = 10, face = "bold"))



patch = shared_genes_vaccines_infection_plot / shared_genes_vaccines_only_plot / shared_genes_infection_only_plot + plot_layout(guides = 'collect') +
  plot_annotation(
  title = "Top 20 shared immune-related genes",
  subtitle = "Infection and vaccination, Vaccination only, Infection only ")

ggsave(patch, file = here("Figures", "Genes_shared_Vaccination_Infection_united.png"), width = 10, height = 9)

patch
```

#### 4.4.3.1. Not-immune related only

```{r}
degs_all_updown = all_degs_p_05_vac_infected %>% 
  filter(direction != "NEUTRAL") %>% 
  distinct()

ImmuneGO_Annotated_Genes = ImmuneGO_Annotated_Genes

## Processing -----

#Infection -----
shared_genes_infection = degs_all_updown %>%
  select(condition, genes) %>% 
  inner_join(ann_vaccines, by = "condition") %>% 
  filter(disease_vac == "I") %>% 
  select(condition, genes, vaccine) %>% 
  anti_join(ImmuneGO_Annotated_Genes %>% select(genes) %>% distinct(), by = "genes") %>% 
  group_by(genes) %>% 
  summarise("Infection" = n()) %>% 
  arrange(desc("Infection"), genes) %>% 
  ungroup() %>% 
  pivot_longer(-genes, names_to = "infection_vaccination", values_to = "n_conditions") %>% 
  anti_join(ImmuneGO_Annotated_Genes , by = "genes") %>% 
  select(genes, infection_vaccination,n_conditions) %>% 
  mutate(comparison = "Infection only") %>% 
  arrange(desc(n_conditions))

#Vaccine -----
shared_genes_vaccines = degs_all_updown %>%
  select(condition, genes) %>% 
  anti_join(ImmuneGO_Annotated_Genes %>% select(genes) %>% distinct(), by = "genes") %>% 
  inner_join(ann_vaccines, by = "condition") %>% 
    filter(disease_vac == "V") %>% 
  select(condition, genes, vaccine) %>% 
  group_by(genes) %>% 
  summarise("Vaccination" = n()) %>% 
  arrange(desc("Vaccination"), genes) %>% 
  ungroup() %>% 
  pivot_longer(-genes, names_to = "infection_vaccination", values_to = "n_conditions") %>% 
  anti_join(ImmuneGO_Annotated_Genes %>% select(genes) %>% distinct(), by = "genes") %>% 
  select(genes, infection_vaccination,n_conditions) %>% 
  mutate(comparison = "Vaccination only") %>% 
  arrange(desc(n_conditions))


# Infection and vaccination -----
shared_genes_vaccines_infection = shared_genes_vaccines %>% 
  inner_join(shared_genes_infection, by = "genes") %>% 
  select(genes, Vaccination = n_conditions.x, Infection = n_conditions.y) %>% 
  pivot_longer(-genes, names_to = "infection_vaccination", values_to = "n_conditions") %>% 
  anti_join(ImmuneGO_Annotated_Genes , by = "genes") %>% 
  select(genes, infection_vaccination,n_conditions) %>% 
  mutate(comparison = "Infection and vaccination") 

shared_genes_comparisons = bind_rows(shared_genes_infection, 
                                     shared_genes_vaccines, 
                                     shared_genes_vaccines_infection) %>% 
  arrange(desc(n_conditions))

write_csv(shared_genes_comparisons, file = here("DGE analysis", "non_Immune_shared_genes_infection_vaccination_comparisons.csv"))

shared_genes_comparisons
```

```{r fig.height=9, fig.width=10}
# Plotting ------
shared_genes_infection_vaccination = shared_genes_comparisons %>%
  filter(comparison == "Infection and vaccination")

shared_genes_infection = shared_genes_comparisons %>% 
  filter(comparison == "Infection only")

shared_genes_vaccines = shared_genes_comparisons %>% 
  filter(comparison == "Vaccination only")


#Infection and vaccination
shared_genes_vaccines_infection_plot = shared_genes_vaccines_infection %>% 
  select(genes, infection_vaccination, n_conditions) %>% 
  distinct() %>%
  slice_head(n=40) %>% 
  ggplot() +
  aes(
    x = reorder(genes, -n_conditions),
    y = n_conditions,
    fill = infection_vaccination
  ) +
  geom_col() +
  scale_fill_manual(
    values = c("Vaccination" = "#4DBBD5FF",
              "Infection" = "#DC0000FF")) +
  theme_minimal() +
  labs(fill = "Status") +
  xlab("") + 
  ylab("") +
  theme(legend.position = "right",
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, size = 10, color = "black"),
        axis.text.y = element_text(size = 10, angle = 0, color = "black"),
        panel.grid.minor.y = element_blank(),
        legend.text = element_text(size=10),
        legend.title = element_text(size = 10, face = "bold"))

#Vaccination only -----

shared_genes_vaccines_only_plot = shared_genes_vaccines %>% 
  select(genes, infection_vaccination, n_conditions, comparison) %>% 
  arrange(desc(n_conditions)) %>% 
  distinct() %>%
  slice_head(n=20) %>% 
  ggplot() +
  aes(x = reorder(genes, -n_conditions), 
      fill = comparison, 
      weight = n_conditions) +
  geom_bar() +
  scale_fill_manual(
    values = c("Vaccination only" = "#4DBBD5FF",
              "Infection only" = "#DC0000FF")) +
  theme_minimal() +
  labs(fill = "Infection only") +
  xlab("") + 
  ylab("Number of shared conditions") +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, size = 10, color = "black"),
        axis.text.y = element_text(size = 10, angle = 0, color = "black"),
        panel.grid.minor.y = element_blank(),
        legend.text = element_text(size=10),
        legend.title = element_text(size = 10, face = "bold")) 

# Infection only -------

shared_genes_infection_only_plot = shared_genes_infection %>% 
  select(genes, infection_vaccination, n_conditions, comparison) %>% 
  arrange(desc(n_conditions)) %>% 
  distinct() %>%
  slice_head(n=20) %>% 
  ggplot() +
  aes(x = reorder(genes, -n_conditions), 
      fill = comparison, 
      weight = n_conditions) +
  geom_bar() +
  scale_fill_manual(
    values = c("Vaccination only" = "#4DBBD5FF",
              "Infection only" = "#DC0000FF")) +
  theme_minimal() +
  labs(fill = "Infection only") +
  xlab("Genes") + 
  ylab("") +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, size = 10, color = "black"),
        axis.text.y = element_text(size = 10, angle = 0, color = "black"),
        panel.grid.minor.y = element_blank(),
        legend.text = element_text(size=10),
        legend.title = element_text(size = 10, face = "bold"))

patch = shared_genes_vaccines_infection_plot / shared_genes_vaccines_only_plot / shared_genes_infection_only_plot + plot_layout(guides = 'collect') +
  plot_annotation(
  title = "Top 20 shared non-immune-related genes",
  subtitle = "Infection and vaccination, Vaccination only, Infection only ")


ggsave(patch, file =here("Figures", "NonImmune_Genes_shared_Vaccination_Infection_united.png"), width = 10, height = 9)

patch
```

# 5. Gene set enrichment analysis

### 5.1. Input

```{r}


#Gene sets
ImmuneGO_Annotated_Genes = readRDS(here("VaxGO gene sets", "ImmuneGO_Annotated_Genes_2024-03-26.rds"))

CellMarker_ImmuneCells = read_csv(here("VaxGO gene sets", "CellMarker_ImmuneCells.csv"))


Immune_GO_T2G_general = ImmuneGO_Annotated_Genes %>% 
  filter(go_term == "Manual",
         !process %in% c("ADAPTIVE IMMUNE SYSTEM",
                         "INNATE IMMUNE SYSTEM",
                         "BCR REPERTOIRE",
                         "TCR REPERTOIRE")) %>% 
  select(process, genes)


Immune_GO_T2G_specfic = ImmuneGO_Annotated_Genes %>% 
  filter(!process %in% c("ADAPTIVE IMMUNE SYSTEM",
                         "INNATE IMMUNE SYSTEM",
                         "BCR REPERTOIRE",
                         "TCR REPERTOIRE")) %>% 
  select(process=gene_set_short, genes) 


CellMarker_genes = CellMarker_ImmuneCells %>% 
  select(cell_name, marker) %>% 
  tibble()


TERM2GENE = Immune_GO_T2G_specfic
geneset_name = "Immune_GO_T2G_specfic"


```

### 5.2. Over representation analysis (ORA)

#### 5.2.1. Multiple

```{r}
# Filtrar os genes para todas as condições
df <- all_degs_p_05_vac_infected

ora_results <- list()
for (condition_2 in unique(df$condition)) {

    genes <- df %>% 
    filter(condition == condition_2) %>% 
    pull(genes)

  go_enrich <- tryCatch({
    enrichGO(gene = genes,
             OrgDb = organism, 
             keyType = 'SYMBOL',
             readable = T,
             ont = "BP",
             pvalueCutoff = 0.05, 
             qvalueCutoff = 0.10) %>% 
      as.data.frame() %>%
      mutate(condition = condition_2)
  }, error = function(e) {
    return(NULL)
  })

  if (!is.null(go_enrich)) {
    ora_results[[condition_2]] <- go_enrich   
  }
}

ora_results_final <- bind_rows(ora_results)

write.csv(ora_results_final, file = "all_degs_other_ORA_2.csv", row.names = F)

```

#### 5.2.2. GO Analysis

```{r}
library(GO.db)
columns(GO.db)

go_bp_ancestor =  GOBPANCESTOR %>% 
  as.data.frame()
names(go_bp_ancestor[, 1]) = "go_child"

go = ora_results_final %>% 
  clean_names() %>% 
  rownames_to_column("delete") %>% 
  mutate(log_fdr = -log10(qvalue)) %>% 
  select(condition, go_id = id, description, log_fdr, qvalue, gene_id, gene_ratio, count) %>% 
  filter(qvalue < 0.10) %>%
  group_by(condition) %>% 
  arrange(desc(log_fdr)) %>% 
  slice_head(n = 5)

```

#### 5.2.3. Heatmap

```{r}

# Anotações das amostras/condições (Vacinas)
ann_vaccines

heatmap_data = go
file = "degs_up_down_notimmune_ora_top10"

heatmap_data_log_fdr = heatmap_data %>% 
  select(description, condition, log_fdr)

matrix_data <- dcast(heatmap_data_log_fdr, 
                         description ~ condition, 
                         value.var = "log_fdr", 
                         fun.aggregate = mean) %>% 
  column_to_rownames('description') %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0)

matrix_data_ready =  matrix_data %>% 
  round(2)

ann_vaccines_complex = heatmap_data %>% 
  select(condition) %>% 
  distinct() %>% 
  inner_join(ann_vaccines, by = "condition")

ann_vaccines_heatmap = matrix_data %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  merge(ann_vaccines_complex, by = "condition", all.x = TRUE) %>% 
  arrange(dose) %>% 
  relocate(dose, .before=vaccine) %>% 
  column_to_rownames(var= "condition")  %>% 
  mutate(dose = ifelse(is.na(dose), "NA", dose))

matrix_data_ordered = matrix_data %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  merge(ann_vaccines_complex, by.y = "condition", all.x=TRUE) %>% 
  arrange(dose) %>% 
  select(!c("...1":previous_vaccination)) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>%
  replace(is.na(.), 0) %>% 
  as.matrix()

dim(matrix_data_ordered) 
dim(ann_vaccines_heatmap) 

ann_vaccines_heatmap = ann_vaccines_heatmap %>% 
  select(type, week, day)


#heatmap annotation
ha = HeatmapAnnotation(df = ann_vaccines_heatmap, 
                       col = ann_colors, 
                       annotation_name_side = "left")


col_fun <- colorRamp2(c(0, 3), c("white", "#ed6a5a"))

#Parameters
mat = matrix_data_ordered
width_image = 30
height_image = 30
width = unit(15, "cm")
height = unit(20, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)


#Plot
fileimageheatmap_ungrouped= paste0(file, sep ="_", "Ungrouped_Complexheatmap.png")

png(file = fileimageheatmap_ungrouped, width= width_image, height=height_image ,units="cm",res=800)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = ha,
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "NES", #Legend
                        cell_fun = function(j, i, x, y, width, height, fill) {
        if(mat[i, j] > 0)
            grid.text(sprintf("%.1f", mat[i, j]), x, y, gp = gpar(fontsize = 8))},
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = gpar(fontsize = 10),
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        # row_split = NULL, #Split row clusters
                        # row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_split = 3, #Split group clusters
                        #column_km = 2,
                        column_gap = unit(8, "mm"),
                        show_column_dend = TRUE,
                        show_row_dend = TRUE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = width, 
                        height = height
)

draw(heatmap_plot_all, annotation_legend_side = "right", heatmap_legend_side = "right")

dev.off()

```

### 5.3. Gene set enrichment analysis (GSEA)

#### 5.3.1. Multiple

```{r}
autoGSEA <- function(df, TERM2GENE, geneset_name) {
  resultados <- list()

  condicoes <- df$condition %>% 
    unique() %>% 
    as.character()

  for (condicao in condicoes) {
    
    degs_condicao <- df %>% 
      filter(condition == condicao) %>%
      select(genes, log2fold_change) %>%
      distinct() %>%
      mutate(rank = rank(log2fold_change, ties.method = "random")) %>%
      arrange(desc(rank))

    gene_list_lf2c <- as.vector(degs_condicao$log2fold_change)
    names(gene_list_lf2c) <- degs_condicao$genes
    gene_list_lf2c <- na.omit(gene_list_lf2c)
    gene_list_lf2c <- sort(gene_list_lf2c, decreasing = TRUE)

    auto_gsea <- tryCatch({
      GSEA(geneList = gene_list_lf2c,
           TERM2GENE = TERM2GENE,
           minGSSize = 1,
           maxGSSize = 1000,
           pvalueCutoff = 0.25,
           pAdjustMethod = "BH") %>%
        as.data.frame() %>%
        arrange(qvalue) %>%
        mutate(condition = condicao,
               gsea_enrichment = geneset_name)
    }, error = function(e) {
      return(NULL)
    })

    if (!is.null(auto_gsea)) {
      resultados[[paste(condicao, geneset_name, sep = "_")]] <- auto_gsea
    }
  }
  

  # Combinar todos os resultados em um único dataframe
  resultado_final <- bind_rows(resultados)

  return(resultado_final)
}
```

```{r}
# Perform GSEA

TERM2GENE = Immune_GO_T2G_general
geneset_name = "Immune_GO_T2G_general"

all_degs_p_05_vac_infected_GSEA_ALL <- all_degs_p_05_vac_infected %>%
  select(condition, genes, log2fold_change) %>% 
  autoGSEA(TERM2GENE = Immune_GO_T2G_general, 
           geneset_name = "Immune_GO_T2G_general") 

all_degs_p_05_vac_infected_GSEA = all_degs_p_05_vac_infected_GSEA_ALL %>% 
  rownames_to_column("delete") %>% 
  clean_names() %>% 
    select(condition, id, everything()) 

all_degs_p_05_vac_infected_GSEA

#Save
write_csv(all_degs_p_05_vac_infected_GSEA, 
          file = here("Gene set enrichment analysis", paste0("all_degs_p_05_vac_infected_", geneset_name, "_GSEA_ALL", ".csv")))

all_degs_p_05_vac_infected_GSEA

```

#### 5.3.2. Bubbleplot (Heatmap with ggplot)
https://davemcg.github.io/post/lets-plot-scrna-dotplots/
```{r fig.height=8, fig.width=10}
library(ggdendro)
library(cowplot)

all_degs_p_05_vac_infected_Immune_GO_T2G_general_GSEA_ALL <- read_csv("Gene set enrichment analysis/all_degs_p_05_vac_infected_Immune_GO_T2G_general_GSEA_ALL.csv")

df = all_degs_p_05_vac_infected_Immune_GO_T2G_general_GSEA_ALL %>% 
  mutate(logq = -log10(qvalue)) %>% 
  inner_join(ann_vaccines_conditions, by = "condition") %>% 
  mutate(day = as.factor(day),
         week = as.factor(week),
         dose = as.factor(dose))

row_clustered = df %>% 
  select(condition, id, nes) %>% 
  distinct() %>% 
  pivot_wider(names_from = "condition",
              values_from= "nes") %>%
  column_to_rownames("id") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0) %>% 
  dist(.) %>% 
  hclust()


col_clustered_vac = df %>% 
  filter(disease_vac == "V",
         id %in% row_clustered$labels) %>% 
  select(condition, id, nes) %>% 
  distinct() %>% 
  pivot_wider(names_from = "id",
              values_from= "nes") %>%
  column_to_rownames("condition") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0) %>% 
  dist(.) %>% 
  hclust()


col_clustered_inf = df %>% 
  filter(disease_vac == "I",
         id %in% row_clustered$labels) %>% 
  select(condition, id, nes) %>% 
  distinct() %>% 
  pivot_wider(names_from = "id",
              values_from= "nes") %>%
  column_to_rownames("condition") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0) %>% 
  dist(.) %>% 
  hclust()

column_order = 
  c(col_clustered_vac$labels[col_clustered_vac$order], col_clustered_inf$labels[col_clustered_inf$order])


labels_disease_vac <- df %>% 
  filter(id %in% row_clustered$labels) %>% 
  mutate(condition = factor(condition, levels = column_order)) %>% 
  ggplot() +
  aes(x = condition, y = 1, fill = disease_vac) + 
  geom_tile() + 
  scale_fill_manual(values = ann_vaxsig_colors$disease_vac) + 
  theme_void() +
  labs(y = "Infection/Vaccination") +
  theme(axis.title.y = element_text(size = 10, hjust = 1),
        legend.position = "none") 

labels_type <- df %>% 
  filter(id %in% row_clustered$labels) %>% 
  mutate(condition = factor(condition, levels = column_order)) %>% 
  ggplot() +
  aes(x = condition, y = 1, fill = type) + 
  geom_tile() + 
  scale_fill_manual(values = ann_vaxsig_colors$Platform) + 
  theme_void() +
  labs(y = "Type") +
  theme(axis.title.y = element_text(size = 10, hjust = 1),
        legend.position = "none") 

labels_week = df %>% 
  filter(id %in% row_clustered$labels) %>% 
  mutate(condition = factor(condition, column_order)) %>% 
  ggplot() +
  aes(x = condition, y = 1, fill = week) + 
  geom_tile() + 
  scale_fill_manual(values = ann_vaxsig_colors$week) + 
  theme_void() +
  labs(y = "Week") +
  theme(axis.title.y = element_text(size = 10, hjust = 1),
        legend.position = "none")
#Plot
dotplot = df %>% 
  filter(id %in% row_clustered$labels) %>% 
  mutate(condition = factor(condition, column_order),
         id = factor(id, levels = row_clustered$labels[row_clustered$order]),
         id = str_to_title(id),
         id = case_when(id == "Humoral Adaptive Immune System" ~ "Humoral Adap.",
                        id == "Cellular Adaptive Immune System" ~ "Cellular Adap.",
                        id == "Complement Immune System" ~ "Complement",
                        id == "Immunoglobulin Mediated Response" ~ "Ig-mediated",
                        id == "Antiviral And Interferon" ~ "Antiviral/IFN",.default = id)) %>% 
  ggplot(aes(x=condition, y = id, color = nes, size = logq)) +
  geom_point() + 
  theme_minimal() + 
  theme(axis.text = element_text(color = "black", size = 12) ,
        axis.line  = element_blank(),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        axis.ticks = element_blank(),
        legend.direction = "horizontal",
        legend.position = "bottom") +
  labs(x = "",
       y = "") +
  scale_color_gradient2(low = "blue",
                        mid = "white",
                        midpoint = 0, 
                        name = "NES",
                      high = "#DC0000FF") +
  scale_y_discrete(position = "right") +
  scale_size(range = c(3, 6))
  

patch_immune_main = 
  labels_disease_vac /
  labels_type /
  labels_week/
  dotplot +
  plot_layout(heights = c(0.3, 0.3, 0.3, 5),
              guides = 'collect') +
  plot_annotation(title = "GSEA ImmuneGO",
                  subtitle = "Main processes",
                  theme = theme(legend.position = "bottom",
                                plot.margin = margin(0.5, 0, 0.5, 1, unit = "cm"),
                                legend.direction = "horizontal", 
                                legend.box = "horizontal"))


patch_immune_main %>% 
  ggsave(filename = here("Figures", "GSEA_ImmuneGO_MainGOs_Bubbleplot.png"),
         width = 10,
         height = 8)
patch_immune_main

```

Specific
```{r fig.height=22, fig.width=10}
library(ggdendro)
library(cowplot)

all_degs_p_05_vac_infected_Immune_GO_T2G_specfic_GSEA_ALL = read_csv(here("Gene set enrichment analysis", "all_degs_p_05_vac_infected_Immune_GO_T2G_specfic_GSEA_ALL.csv")) 


df = all_degs_p_05_vac_infected_Immune_GO_T2G_specfic_GSEA_ALL %>% 
  clean_names() %>% 
  mutate(logq = -log10(qvalue)) %>% 
  inner_join(ann_vaccines_conditions, by = "condition") %>% 
  mutate(day = as.factor(day),
         week = as.factor(week),
         dose = as.factor(dose))

row_clustered = df %>% 
  select(condition, id, nes) %>% 
  distinct() %>% 
  pivot_wider(names_from = "condition",
              values_from= "nes") %>%
  column_to_rownames("id") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0) %>% 
  dist(.) %>% 
  hclust()


col_clustered_vac = df %>% 
  filter(disease_vac == "V",
         id %in% row_clustered$labels) %>% 
  select(condition, id, nes) %>% 
  distinct() %>% 
  pivot_wider(names_from = "id",
              values_from= "nes") %>%
  column_to_rownames("condition") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0) %>% 
  dist(.) %>% 
  hclust()


col_clustered_inf = df %>% 
  filter(disease_vac == "I",
         id %in% row_clustered$labels) %>% 
  select(condition, id, nes) %>% 
  distinct() %>% 
  pivot_wider(names_from = "id",
              values_from= "nes") %>%
  column_to_rownames("condition") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0) %>% 
  dist(.) %>% 
  hclust()

column_order = 
  c(col_clustered_vac$labels[col_clustered_vac$order], col_clustered_inf$labels[col_clustered_inf$order])

labels_type <- df %>% 
  filter(id %in% row_clustered$labels) %>% 
  mutate(condition = factor(condition, levels = column_order)) %>% 
  ggplot() +
  aes(x = condition, y = 1, fill = type) + 
  geom_tile() + 
  scale_fill_manual(values = ann_vaxsig_colors$Platform) + 
  theme_void() +
  labs(y = "Type") +
  theme(axis.title.y = element_text(size = 10),
        legend.position = "none") 

labels_week = df %>% 
  filter(id %in% row_clustered$labels) %>% 
  mutate(condition = factor(condition, column_order)) %>% 
  ggplot() +
  aes(x = condition, y = 1, fill = week) + 
  geom_tile() + 
  scale_fill_manual(values = ann_vaxsig_colors$week) + 
  theme_void() +
  labs(y = "Week") +
  theme(axis.title.y = element_text(size = 10),
        legend.position = "none")
#Plot
dotplot_specific = df %>% 
  filter(id %in% row_clustered$labels) %>% 
  mutate(condition = factor(condition, column_order),
         id = factor(id, levels = row_clustered$labels[row_clustered$order])) %>% 
  ggplot(aes(x=condition, y = id, color = nes, size = logq)) +
  geom_point() + 
  theme_minimal() + 
  theme(axis.text = element_text(color = "black") ,
        axis.line  = element_blank(),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        axis.ticks = element_blank(),
        legend.direction = "horizontal",
        legend.position = "bottom") +
  labs(x = "",
       y = "") +
  scale_color_gradient2(low = "blue",
                        mid = "white",
                        midpoint = 0, 
                        name = "NES",
                      high = "red") +
  scale_y_discrete(position = "right") 
  

patch_immune_specific = labels_type /
  labels_week/
  dotplot_specific +
  plot_layout(heights = c(0.05, 0.05, 5),
              guides = 'collect') +
  plot_annotation(title = "GSEA ImmuneGO",
                  subtitle = "Specific processes",
                  theme = theme(legend.position = "bottom",
                                plot.margin = margin(0.5, 0, 0.5, 1, unit = "cm"),
                                legend.direction = "horizontal", 
                                legend.box = "horizontal"))
patch_immune_specific

```
Divide by immune system

Innate
```{r fig.height=15, fig.width=10}


ImmuneGO_Annotated_GO <- read_csv("VaxGO gene sets/ImmuneGO_Annotated_GO_2024_03_26.csv")
df = all_degs_p_05_vac_infected_Immune_GO_T2G_specfic_GSEA_ALL %>% 
  clean_names() %>% 
  mutate(logq = -log10(qvalue)) %>% 
  inner_join(ann_vaccines_conditions, by = "condition") %>% 
  mutate(day = as.factor(day),
         week = as.factor(week),
         dose = as.factor(dose)) %>% 
  inner_join(ImmuneGO_Annotated_GO %>% 
               rename(id = gene_set_short), by = "id") %>% 
  filter(immune_system == "Innate")

row_clustered = df %>% 
  select(condition, id, nes) %>% 
  distinct() %>% 
  pivot_wider(names_from = "condition",
              values_from= "nes") %>%
  column_to_rownames("id") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0) %>% 
  dist(.) %>% 
  hclust()


col_clustered_vac = df %>% 
  filter(disease_vac == "V",
         id %in% row_clustered$labels) %>% 
  select(condition, id, nes) %>% 
  distinct() %>% 
  pivot_wider(names_from = "id",
              values_from= "nes") %>%
  column_to_rownames("condition") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0) %>% 
  dist(.) %>% 
  hclust()


col_clustered_inf = df %>% 
  filter(disease_vac == "I",
         id %in% row_clustered$labels) %>% 
  select(condition, id, nes) %>% 
  distinct() %>% 
  pivot_wider(names_from = "id",
              values_from= "nes") %>%
  column_to_rownames("condition") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0) %>% 
  dist(.) %>% 
  hclust()

column_order = 
  c(col_clustered_vac$labels[col_clustered_vac$order], col_clustered_inf$labels[col_clustered_inf$order])

labels_type <- df %>% 
  filter(id %in% row_clustered$labels) %>% 
  mutate(condition = factor(condition, levels = column_order)) %>% 
  ggplot() +
  aes(x = condition, y = 1, fill = type) + 
  geom_tile() + 
  scale_fill_manual(values = ann_vaxsig_colors$Platform) + 
  theme_void() +
  labs(y = "Type") +
  theme(axis.title.y = element_text(size = 10),
        legend.position = "none") 

labels_week = df %>% 
  filter(id %in% row_clustered$labels) %>% 
  mutate(condition = factor(condition, column_order)) %>% 
  ggplot() +
  aes(x = condition, y = 1, fill = week) + 
  geom_tile() + 
  scale_fill_manual(values = ann_vaxsig_colors$week) + 
  theme_void() +
  labs(y = "Week") +
  theme(axis.title.y = element_text(size = 10),
        legend.position = "none")
#Plot
dotplot_specific = df %>% 
  filter(id %in% row_clustered$labels) %>% 
  mutate(condition = factor(condition, column_order),
         id = factor(id, levels = row_clustered$labels[row_clustered$order])) %>% 
  ggplot(aes(x=condition, y = id, color = nes, size = logq)) +
  geom_point() + 
  theme_minimal() + 
  theme(axis.text = element_text(color = "black") ,
        axis.line  = element_blank(),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        axis.ticks = element_blank(),
        legend.direction = "horizontal",
        legend.position = "bottom") +
  labs(x = "",
       y = "") +
  scale_color_gradient2(low = "blue",
                        mid = "white",
                        midpoint = 0, 
                        name = "NES",
                      high = "red") +
  scale_y_discrete(position = "right") 
  

patch_immune_specific = labels_type /
  labels_week/
  dotplot_specific +
  plot_layout(heights = c(0.1, 0.1, 5),
              guides = 'collect') +
  plot_annotation(title = "GSEA ImmuneGO",
                  subtitle = "Specific processes, Innate",
                  theme = theme(legend.position = "bottom",
                                plot.margin = margin(0.5, 0, 0.5, 1, unit = "cm"),
                                legend.direction = "horizontal", 
                                legend.box = "horizontal"))
patch_immune_specific
```

Adaptive
```{r fig.height=15, fig.width=10}
df = all_degs_p_05_vac_infected_Immune_GO_T2G_specfic_GSEA_ALL %>% 
  clean_names() %>% 
  mutate(logq = -log10(qvalue)) %>% 
  inner_join(ann_vaccines_conditions, by = "condition") %>% 
  mutate(day = as.factor(day),
         week = as.factor(week),
         dose = as.factor(dose)) %>% 
  inner_join(ImmuneGO_Annotated_GO %>% 
               rename(id = gene_set_short), by = "id") %>% 
  filter(immune_system == "Adaptive")

row_clustered = df %>% 
  select(condition, id, nes) %>% 
  distinct() %>% 
  pivot_wider(names_from = "condition",
              values_from= "nes") %>%
  column_to_rownames("id") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0) %>% 
  dist(.) %>% 
  hclust()


col_clustered_vac = df %>% 
  filter(disease_vac == "V",
         id %in% row_clustered$labels) %>% 
  select(condition, id, nes) %>% 
  distinct() %>% 
  pivot_wider(names_from = "id",
              values_from= "nes") %>%
  column_to_rownames("condition") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0) %>% 
  dist(.) %>% 
  hclust()


col_clustered_inf = df %>% 
  filter(disease_vac == "I",
         id %in% row_clustered$labels) %>% 
  select(condition, id, nes) %>% 
  distinct() %>% 
  pivot_wider(names_from = "id",
              values_from= "nes") %>%
  column_to_rownames("condition") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0) %>% 
  dist(.) %>% 
  hclust()

column_order = 
  c(col_clustered_vac$labels[col_clustered_vac$order], col_clustered_inf$labels[col_clustered_inf$order])

labels_type <- df %>% 
  filter(id %in% row_clustered$labels) %>% 
  mutate(condition = factor(condition, levels = column_order)) %>% 
  ggplot() +
  aes(x = condition, y = 1, fill = type) + 
  geom_tile() + 
  scale_fill_manual(values = ann_vaxsig_colors$Platform) + 
  theme_void() +
  labs(y = "Type") +
  theme(axis.title.y = element_text(size = 10),
        legend.position = "none") 

labels_week = df %>% 
  filter(id %in% row_clustered$labels) %>% 
  mutate(condition = factor(condition, column_order)) %>% 
  ggplot() +
  aes(x = condition, y = 1, fill = week) + 
  geom_tile() + 
  scale_fill_manual(values = ann_vaxsig_colors$week) + 
  theme_void() +
  labs(y = "Week") +
  theme(axis.title.y = element_text(size = 10),
        legend.position = "none")
#Plot
dotplot_specific = df %>% 
  filter(id %in% row_clustered$labels) %>% 
  mutate(condition = factor(condition, column_order),
         id = factor(id, levels = row_clustered$labels[row_clustered$order])) %>% 
  ggplot(aes(x=condition, y = id, color = nes, size = logq)) +
  geom_point() + 
  theme_minimal() + 
  theme(axis.text = element_text(color = "black") ,
        axis.line  = element_blank(),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        axis.ticks = element_blank(),
        legend.direction = "horizontal",
        legend.position = "bottom") +
  labs(x = "",
       y = "") +
  scale_color_gradient2(low = "blue",
                        mid = "white",
                        midpoint = 0, 
                        name = "NES",
                      high = "red") +
  scale_y_discrete(position = "right") 
  

patch_immune_specific = labels_type /
  labels_week/
  dotplot_specific +
  plot_layout(heights = c(0.1, 0.1, 5),
              guides = 'collect') +
  plot_annotation(title = "GSEA ImmuneGO",
                  subtitle = "Specific processes, Adaptive",
                  theme = theme(legend.position = "bottom",
                                plot.margin = margin(0.5, 0, 0.5, 1, unit = "cm"),
                                legend.direction = "horizontal", 
                                legend.box = "horizontal"))
patch_immune_specific
```

General
```{r fig.height=8, fig.width=10}
df = all_degs_p_05_vac_infected_Immune_GO_T2G_specfic_GSEA_ALL %>% 
  clean_names() %>% 
  mutate(logq = -log10(qvalue)) %>% 
  inner_join(ann_vaccines_conditions, by = "condition") %>% 
  mutate(day = as.factor(day),
         week = as.factor(week),
         dose = as.factor(dose)) %>% 
  inner_join(ImmuneGO_Annotated_GO %>% 
               rename(id = gene_set_short), by = "id") %>% 
  filter(immune_system == "General")

row_clustered = df %>% 
  select(condition, id, nes) %>% 
  distinct() %>% 
  pivot_wider(names_from = "condition",
              values_from= "nes") %>%
  column_to_rownames("id") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0) %>% 
  dist(.) %>% 
  hclust()


col_clustered_vac = df %>% 
  filter(disease_vac == "V",
         id %in% row_clustered$labels) %>% 
  select(condition, id, nes) %>% 
  distinct() %>% 
  pivot_wider(names_from = "id",
              values_from= "nes") %>%
  column_to_rownames("condition") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0) %>% 
  dist(.) %>% 
  hclust()


col_clustered_inf = df %>% 
  filter(disease_vac == "I",
         id %in% row_clustered$labels) %>% 
  select(condition, id, nes) %>% 
  distinct() %>% 
  pivot_wider(names_from = "id",
              values_from= "nes") %>%
  column_to_rownames("condition") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0) %>% 
  dist(.) %>% 
  hclust()

column_order = 
  c(col_clustered_vac$labels[col_clustered_vac$order], col_clustered_inf$labels[col_clustered_inf$order])

labels_type <- df %>% 
  filter(id %in% row_clustered$labels) %>% 
  mutate(condition = factor(condition, levels = column_order)) %>% 
  ggplot() +
  aes(x = condition, y = 1, fill = type) + 
  geom_tile() + 
  scale_fill_manual(values = ann_vaxsig_colors$Platform) + 
  theme_void() +
  labs(y = "Type") +
  theme(axis.title.y = element_text(size = 10),
        legend.position = "none") 

labels_week = df %>% 
  filter(id %in% row_clustered$labels) %>% 
  mutate(condition = factor(condition, column_order)) %>% 
  ggplot() +
  aes(x = condition, y = 1, fill = week) + 
  geom_tile() + 
  scale_fill_manual(values = ann_vaxsig_colors$week) + 
  theme_void() +
  labs(y = "Week") +
  theme(axis.title.y = element_text(size = 10),
        legend.position = "none")
#Plot
dotplot_specific = df %>% 
  filter(id %in% row_clustered$labels) %>% 
  mutate(condition = factor(condition, column_order),
         id = factor(id, levels = row_clustered$labels[row_clustered$order])) %>% 
  ggplot(aes(x=condition, y = id, color = nes, size = logq)) +
  geom_point() + 
  theme_minimal() + 
  theme(axis.text = element_text(color = "black") ,
        axis.line  = element_blank(),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        axis.ticks = element_blank(),
        legend.direction = "horizontal",
        legend.position = "bottom") +
  labs(x = "",
       y = "") +
  scale_color_gradient2(low = "blue",
                        mid = "white",
                        midpoint = 0, 
                        name = "NES",
                      high = "red") +
  scale_y_discrete(position = "right") 
  

patch_immune_specific = labels_type /
  labels_week/
  dotplot_specific +
  plot_layout(heights = c(0.3, 0.3, 5),
              guides = 'collect') +
  plot_annotation(title = "GSEA ImmuneGO",
                  subtitle = "Specific processes, General",
                  theme = theme(legend.position = "bottom",
                                plot.margin = margin(0.5, 0, 0.5, 1, unit = "cm"),
                                legend.direction = "horizontal", 
                                legend.box = "horizontal"))
patch_immune_specific
```

Complement
```{r fig.height=5, fig.width=10}
df = all_degs_p_05_vac_infected_Immune_GO_T2G_specfic_GSEA_ALL %>% 
  clean_names() %>% 
  mutate(logq = -log10(qvalue)) %>% 
  inner_join(ann_vaccines_conditions, by = "condition") %>% 
  mutate(day = as.factor(day),
         week = as.factor(week),
         dose = as.factor(dose)) %>% 
  inner_join(ImmuneGO_Annotated_GO %>% 
               rename(id = gene_set_short), by = "id") %>% 
  filter(immune_system == "Complement")

row_clustered = df %>% 
  select(condition, id, nes) %>% 
  distinct() %>% 
  pivot_wider(names_from = "condition",
              values_from= "nes") %>%
  column_to_rownames("id") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0) %>% 
  dist(.) %>% 
  hclust()


col_clustered_vac = df %>% 
  filter(disease_vac == "V",
         id %in% row_clustered$labels) %>% 
  select(condition, id, nes) %>% 
  distinct() %>% 
  pivot_wider(names_from = "id",
              values_from= "nes") %>%
  column_to_rownames("condition") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0) %>% 
  dist(.) %>% 
  hclust()


col_clustered_inf = df %>% 
  filter(disease_vac == "I",
         id %in% row_clustered$labels) %>% 
  select(condition, id, nes) %>% 
  distinct() %>% 
  pivot_wider(names_from = "id",
              values_from= "nes") %>%
  column_to_rownames("condition") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0) %>% 
  dist(.) %>% 
  hclust()

column_order = 
  c(col_clustered_vac$labels[col_clustered_vac$order], col_clustered_inf$labels[col_clustered_inf$order])

labels_type <- df %>% 
  filter(id %in% row_clustered$labels) %>% 
  mutate(condition = factor(condition, levels = column_order)) %>% 
  ggplot() +
  aes(x = condition, y = 1, fill = type) + 
  geom_tile() + 
  scale_fill_manual(values = ann_vaxsig_colors$Platform) + 
  theme_void() +
  labs(y = "Type") +
  theme(axis.title.y = element_text(size = 10),
        legend.position = "none") 

labels_week = df %>% 
  filter(id %in% row_clustered$labels) %>% 
  mutate(condition = factor(condition, column_order)) %>% 
  ggplot() +
  aes(x = condition, y = 1, fill = week) + 
  geom_tile() + 
  scale_fill_manual(values = ann_vaxsig_colors$week) + 
  theme_void() +
  labs(y = "Week") +
  theme(axis.title.y = element_text(size = 10),
        legend.position = "none")
#Plot
dotplot_specific = df %>% 
  filter(id %in% row_clustered$labels) %>% 
  mutate(condition = factor(condition, column_order),
         id = factor(id, levels = row_clustered$labels[row_clustered$order])) %>% 
  ggplot(aes(x=condition, y = id, color = nes, size = logq)) +
  geom_point() + 
  theme_minimal() + 
  theme(axis.text = element_text(color = "black") ,
        axis.line  = element_blank(),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        axis.ticks = element_blank(),
        legend.direction = "horizontal",
        legend.position = "bottom") +
  labs(x = "",
       y = "") +
  scale_color_gradient2(low = "blue",
                        mid = "white",
                        midpoint = 0, 
                        name = "NES",
                      high = "red") +
  scale_y_discrete(position = "right") 
  

patch_immune_specific = labels_type /
  labels_week/
  dotplot_specific +
  plot_layout(heights = c(0.5, 0.5, 5),
              guides = 'collect') +
  plot_annotation(title = "GSEA ImmuneGO",
                  subtitle = "Specific processes, Complement",
                  theme = theme(legend.position = "bottom",
                                plot.margin = margin(0.5, 0, 0.5, 1, unit = "cm"),
                                legend.direction = "horizontal", 
                                legend.box = "horizontal"))
patch_immune_specific
```




## 5.4. Cell proportion

<https://www.datacamp.com/tutorial/pca-analysis-r>
<https://rpkgs.datanovia.com/factoextra/index.html>
<http://www.sthda.com/english/articles/31-principal-component-methods-in-r-practical-guide/114-mca-multiple-correspondence-analysis-in-r-essentials/>
<https://statisticsglobe.com/pca-before-k-means-clustering-r>\>



### 5.4.1. ssGSEA: CellMarker
```{r}
library(corto)

#Import files
ann_vaccines_samples <- read_csv(here("Annotations and metadata", "ann_vaccines_samples.csv"))

normalized_counts <- readRDS(here("DGE analysis", "all_matrices_normalized_counts.rds")) 

all_samples_l2fc <- readRDS(here("DGE analysis", "all_samples_l2fc.rds")) %>%
  filter(!condition %in% c(ann_vaccines_samples %>% 
           filter(day == 0) %>% 
           pull(condition)))

head(all_samples_l2fc)

######## CELL MARKER IMMUNE ---------

CellMarker_ImmuneCells = read_csv(here("VaxGO gene sets", "CellMarker_ImmuneCells.csv"))

CellMarker_annotation = CellMarker_ImmuneCells %>% 
 dplyr::select(cell_name, Type) %>% 
  distinct()

CellMarker_genes = CellMarker_ImmuneCells %>% 
 dplyr::select(process = cell_name, genes = marker)

############## Inputs

ssgsea_gene = normalized_counts 
metadata = ann_vaccines_samples 
filename = "covid_all"
go_dataset = "CellMarkerImmune"

#Extract sample names
sample_names = ssgsea_gene %>% 
  as.data.frame() %>% 
  colnames() %>% 
  as.data.frame() %>% 
  rename(sample_names = '.')

#CellMarker immune-------
genelist_CellMarker_genes = CellMarker_genes %>%dplyr::select(process, genes)
genelist_CellMarker_genes = split(genelist_CellMarker_genes$genes, genelist_CellMarker_genes$process) 

nesmat_result = ssgsea(inmat = ssgsea_gene, 
                                        groups = genelist_CellMarker_genes)

nesmat_result_CellMarker =  nesmat_result %>% 
  as.data.frame() %>% 
  t() %>% 
  as.data.frame() %>% 
  cbind(sample_names) %>% 
  select(sample_names, everything()) %>% 
  rownames_to_column("delete") %>% 
  select(-delete) %>% 
  column_to_rownames("sample_names") %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column("process") %>% 
  select(process,everything()) %>% 
  pivot_longer(cols = -process, names_to = "sample", values_to = "nes") %>%
  mutate(pvalue = z2p(nes), #Convert NES into pvalue
         qvalue = p.adjust(pvalue, method = "BH"),
         logq = - log10(qvalue),
         geneset_name = "CellMarker Immune") %>%
  inner_join(metadata, by= "sample") 



#save
write_csv(nesmat_result_CellMarker, file = here("Gene set enrichment analysis", paste0(filename, sep = "_", go_dataset, "_ssgsea_results.csv")))

head(nesmat_result_CellMarker)
```



### 5.4.2. ssGSEA: immunedeconv/XCell

```{r fig.height=6, fig.width=12}
all_matrices_counts <- readRDS(here("DGE analysis", "all_matrices_counts.rds"))

all_matrices_counts_matrix = all_matrices_counts %>% 
  column_to_rownames("genes") %>% 
  as.matrix()

library(immunedeconv)
library(tidyverse)
tidymodels_prefer()

res_quantiseq <- deconvolute(all_matrices_counts_matrix, "quantiseq",tumor = F)
res_quantiseq %>%
  gather(sample, fraction, -cell_type) %>%
  # plot as stacked bar chart
  ggplot(aes(x = sample, y = fraction, fill = cell_type)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  scale_fill_brewer(palette = "Paired") +
  scale_x_discrete(limits = rev(levels(res_quantiseq)))
```


```{r fig.height=6, fig.width=12}
#XCell (ssGSEA) ----
xcell_results = immunedeconv::deconvolute(all_matrices_counts_matrix, "xcell") 

xcell_results %>% 
  write_csv(file = here("Cell populations", "all_covid_degs_xcell_results.csv"))

xcell_results_annotated = xcell_results %>% 
  pivot_longer(cols = -cell_type,
               names_to = "sample",
               values_to = "value") %>% 
  inner_join(ann_vaccines_samples, by = "sample") %>% 
   distinct() %>% 
  filter(condition != "BNT-MO (V1, D0)",
         condition != "BNT-MO (V1, D6)") %>% 
  mutate(disease_vac = if_else(disease_vac == "Healthy", "H", disease_vac)) %>% 
  mutate(disease_vac = fct_relevel(disease_vac, "H", "I", "V"),
           type = fct_relevel(type, "I", "RNA", "VV", "IN", "SU")) %>% 
  arrange(disease_vac,type, condition) %>% 
  inner_join(ann_vaccines_conditions %>% select(condition, samples), by = "condition")



#boxplot
xcell_results_annotated_2_plot =  xcell_results_annotated %>% 
  mutate(condition = fct_relevel(condition, 
                                 ann_vaccines_conditions_ordered$condition %>% unique())) %>% 
  filter(cell_type == "B cell") %>% 
  ggplot() +
  aes(x = condition, y = value, fill = if_else(day == 0, "Day 0", type)) +  
  geom_hline(yintercept = 0, linetype = 2) +
  geom_jitter(aes(color = if_else(day == 0, "Day 0", type)),
              alpha = 0.3, size = 0.1) +
  geom_boxplot(outliers = F) +
  theme_few() +
  scale_fill_manual(values = c("Day 0" = "white", 
                               ann_vaxsig_colors$type)) +
    scale_color_manual(values = c("Day 0" = "gray80", 
                               ann_vaxsig_colors$type)) +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1,
                                   vjust = 1),
        plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.margin = margin(0, 0, 0, 2, "cm"),
        panel.grid.major = element_line(size = 0.05),
        panel.grid.minor = element_line(size = 0.05)) +
  labs(y = "NES",
       title = "B cell",
       x="",
       subtitle = "By week",
       fill = "Type") +
  guides(color = "none") +
  facet_wrap(~disease_vac, scales = "free_x")

```


```{r}
#Function to create boxplots
create_boxplots <- function(result_df) {
  
  unique_processes <- unique(result_df$cell_type)
  
  purrr::map(unique_processes, function(process_name) {
    cellmarker_boxplot <- result_df %>% 
      filter(cell_type == process_name) %>% 
  ggplot() +
  aes(x = condition, y = value, fill = if_else(day == 0, "Day 0", type)) +  
  geom_hline(yintercept = 0, linetype = 2) +
  geom_jitter(aes(color = if_else(day == 0, "Day 0", type)),
              alpha = 0.3, size = 0.1) +
  geom_boxplot(outliers = F) +
  theme_few() +
  scale_fill_manual(values = c("Day 0" = "white", 
                               ann_vaxsig_colors$type)) +
    scale_color_manual(values = c("Day 0" = "gray80", 
                               ann_vaxsig_colors$type)) +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1,
                                   vjust = 1),
        plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.margin = margin(0, 0, 0, 2, "cm")) +
  labs(y = "score",
       title = process_name,
       x="",
       subtitle = "By week",
       fill = "Type") +
  guides(color = "none") +
  facet_wrap(~disease_vac, scales = "free_x")

    ggsave(cellmarker_boxplot, 
           file = here("Figures", paste0("ssgsea_xcell_boxplot_", process_name, ".png")),
           width = 12, height = 6)
  })
}

# Apply to all processes
create_boxplots(xcell_results_annotated_2_plot)
```



### 5.4.3. Visualization

Generate a single boxplot
```{r fig.height=6, fig.width=12}

nesmat_result_CellMarker = read_csv(here("Gene set enrichment analysis", "covid_all_CellMarkerImmune_ssgsea_results.csv"))

unique(nesmat_result_CellMarker$process)

process_selected = "Neutrophil"

nesmat_result_CellMarker_1 = nesmat_result_CellMarker %>% 
  distinct() %>% 
  filter(condition != "BNT-MO (V1, D0)",
         condition != "BNT-MO (V1, D6)") %>% 
  mutate(disease_vac = if_else(disease_vac == "Healthy", "H", disease_vac)) %>% 
  mutate(disease_vac = fct_relevel(disease_vac, "H", "I", "V"),
           type = fct_relevel(type, "I", "RNA", "VV", "IN", "SU")) %>% 
  arrange(disease_vac,type, condition) %>% 
  inner_join(ann_vaccines_conditions %>% select(condition, samples), by = "condition") %>% 
  mutate(condition = factor(condition, levels = c(unique(condition[order(condition)]))),
         condition = paste0(condition, " (n=", samples, ")"))

nesmat_result_CellMarker_2 = nesmat_result_CellMarker_1 %>% 
  mutate(condition = fct_relevel(condition, 
                                 nesmat_result_CellMarker_1 %>% 
                                   filter(str_detect(condition, "^H \\(D0\\)")) %>% 
                                   select(condition) %>% 
                                   distinct() %>% 
                                   pull(condition), 
                                 nesmat_result_CellMarker_1 %>% 
                                   filter(str_detect(condition, "^I")) %>% 
                                   filter(!str_detect(condition, "^I-I")) %>% 
                                   select(condition) %>% 
                                   arrange(condition) %>% 
                                   distinct() %>% 
                                   pull(condition),
                                 nesmat_result_CellMarker_1 %>% 
                                   filter(disease_vac == "I") %>% 
                                   filter(str_detect(condition, "^BNT-I")) %>% 
                                    filter(!str_detect(condition, "^BNT-I \\(D\\d+\\)")) %>% 
                                    arrange(day, condition) %>%
                                   select(condition) %>% 
                                    distinct() %>% 
                                    pull(condition),
                                 nesmat_result_CellMarker_1 %>% 
                                    filter(str_detect(condition, "^BNT-I \\(D\\d+\\)")) %>% 
                                    arrange(day, condition) %>%
                                   select(condition) %>% 
                                    distinct() %>% 
                                    pull(condition),
                                 nesmat_result_CellMarker_1 %>% 
                                   filter(disease_vac == "V",
                                          str_detect(condition, "^BNT \\(V1, D\\d+\\)")) %>% 
                                   arrange(day, condition) %>% 
                                   select(condition) %>% 
                                   distinct() %>% 
                                   pull(condition),
                                 nesmat_result_CellMarker_1 %>% 
                                   filter(disease_vac == "V",
                                          !str_detect(condition, "^BNT \\(V1, D\\d+\\)"),
                                          !str_detect(condition, "BBIBP"),
                                          !str_detect(condition, "ZF2001")) %>% 
                                   arrange(condition) %>% 
                                   select(condition) %>% 
                                   distinct() %>% 
                                   pull(condition),
                                 nesmat_result_CellMarker_1 %>% 
                                   filter(str_detect(condition, "BBIBP")) %>% 
                                   select(condition) %>% 
                                   arrange(condition) %>% 
                                   distinct() %>% 
                                   pull(condition), 
                                 nesmat_result_CellMarker_1 %>% 
                                   filter(str_detect(condition, "ZF2001")) %>% 
                                   select(condition) %>% 
                                   arrange(condition) %>% 
                                   distinct() %>% 
                                   pull(condition))) %>%
  mutate(type = if_else(type == "H", "I", type),
         disease_vac = if_else(disease_vac == "H", "I", disease_vac)) 

nesmat_result_CellMarker_2 %>% 
  select(condition) %>% 
  distinct()

ssgsea_boxplot_by_type 

nesmat_result_CellMarker_2 %>% 
  filter(process == process_selected) %>% 
  ggplot() +
  aes(x = condition, y = nes, fill = if_else(day == 0, "Day 0", type)) +  
  geom_hline(yintercept = 0, linetype = 2) +
  geom_jitter(aes(color = if_else(day == 0, "Day 0", type)),
              alpha = 0.3, size = 0.1) +
  geom_boxplot(outliers = F) +
  theme_few() +
  scale_fill_manual(values = c("Day 0" = "white", 
                               ann_vaxsig_colors$type)) +
    scale_color_manual(values = c("Day 0" = "gray80", 
                               ann_vaxsig_colors$type)) +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1,
                                   vjust = 1),
        plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.margin = margin(0, 0, 0, 2, "cm"),
        panel.grid.major = element_line(size = 0.05),
        panel.grid.minor = element_line(size = 0.05)) +
  labs(y = "NES",
       title = process_selected,
       x="",
       subtitle = "By week",
       fill = "Type") +
  guides(color = "none") +
  facet_wrap(~disease_vac, scales = "free_x")

  ssgsea_boxplot_by_type
```

Generate boxplots for all processes
```{r fig.height=6, fig.width=12}
#Function to create boxplots
create_boxplots <- function(result_df) {
  
  unique_processes <- unique(result_df$process)
  
  purrr::map(unique_processes, function(process_name) {
    cellmarker_boxplot <- result_df %>% 
      filter(process == process_name) %>% 
  ggplot() +
  aes(x = condition, y = nes, fill = if_else(day == 0, "Day 0", type)) +  
  geom_hline(yintercept = 0, linetype = 2) +
  geom_jitter(aes(color = if_else(day == 0, "Day 0", type)),
              alpha = 0.3, size = 0.1) +
  geom_boxplot(outliers = F) +
  theme_few() +
  scale_fill_manual(values = c("Day 0" = "white", 
                               ann_vaxsig_colors$type)) +
    scale_color_manual(values = c("Day 0" = "gray80", 
                               ann_vaxsig_colors$type)) +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1,
                                   vjust = 1),
        plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.margin = margin(0, 0, 0, 2, "cm")) +
  labs(y = "NES",
       title = process_name,
       x="",
       subtitle = "By week",
       fill = "Type") +
  guides(color = "none") +
  facet_wrap(~disease_vac, scales = "free_x")

    ggsave(cellmarker_boxplot, 
           file = here("Figures", paste0("ssgsea_CellMarkerImmune_boxplot_", process_name, ".png")),
           width = 12, height = 6)
  })
}

# Apply to all processes
create_boxplots(nesmat_result_CellMarker_2)
```


```{r fig.height=5, fig.width=5}
#PCA -----
# install.packages("ggfortify")
# library(ggfortify)
nesmat_result_immunego_general_matrix = nesmat_result_immunego_general %>% 
  dplyr::select(sample, process, nes) %>% 
  pivot_wider(names_from = "process",
              values_from = "nes") %>% 
    column_to_rownames("sample")

labels = nesmat_result_immunego_general_matrix %>% 
  rownames_to_column("sample") %>% 
  inner_join(nesmat_result_immunego_general %>% 
               dplyr::select(sample, condition, type, day, week) %>% distinct(),
               by = "sample") 

pca_res <- prcomp(nesmat_result_immunego_general_matrix, scale. = TRUE)

ssgsea_pca_type = autoplot(pca_res,  data = labels) +
  geom_point(aes(fill = type, label = condition), colour="black",pch=21, size = 3) +
  theme_few()+
  scale_fill_manual(values = ann_vaxsig_colors$Platform)

ssgsea_pca_day = autoplot(pca_res,  data = labels) +
  geom_point(aes(fill = day), colour="black",pch=21, size = 3) +
  theme_few()+
  scale_fill_stepsn(colors = c(
    "0" = "white",
    "1" = "#caf0f8",
    "2" = "#0087BF",
    "3" = "#90e0ef",
    "4" = "#6CD5EA",
    "5" = "#48cae4",
    "6" = "#00b4d8",
    "7" = "#0096c7",
    "10" = "#0087BF",
    "11" = "#0087BF",
    "14" = "#0077b6",
    "26" = "#015BA0",
    "28" = "#023e8a",
    "51" = "#03045e"))

```

### 5.4.4. Statistical analysis

```{r}
# install.packages("ggstatsplot")
library(ggstatsplot)

ssgsea_interesting = ssgsea_interesting %>% 
  filter(process == "INNATE IMMUNE SYSTEM") %>% 
  distinct()

process = "INNATE IMMUNE SYSTEM"

ggbetweenstats(
  data  = ssgsea_interesting,
  x     = condition,
  y     = nes,
  title =  paste0("ImmuneGO ssGSEA ", filename, process)
)

#Agrupado
grouped_ggbetweenstats(
  data             = ssgsea_interesting,
  x                = condition,
  y                = nes,
  grouping.var     = process,
  ggsignif.args    = list(textsize = 4, tip_length = 0.01),
  p.adjust.method  = "bonferroni",
  palette          = "default_jama",
  package          = "ggsci",
  plotgrid.args    = list(nrow = 1),
  annotation.args  = list(title = paste0("ImmuneGO ssGSEA ", filename))
)

```

#### 5.4.3.2. Kruskal Wallis

```{r}
library(ggsignif)
library(rstatix)

df = test
df$Condition <- as.factor(df$Condition)

stat.test <- df %>%
  t_test(Condition ~ NES) %>%
  add_significance()


test %>%
  filter(Process %in% "INNATE IMMUNE RESPONSE") %>%
  ggboxplot(x = "Process", y = "NES",
          color = "Condition", palette = "jco") +
  facet_wrap(vars(Vaccine)) +
  stat_compare_means(method = "anova", label.y = 4) +      # Add global p-value
  stat_compare_means(label = "p.signif", method = "t.test",
                     ref.group = ".all.")    # Comparação múltipla usando Tukey HSD


# Box plots with p-values
bxp <- ggboxplot(df, x = "Process", y = "NES", fill = "#00AFBB")
stat.test <- stat.test %>% add_xy_position(x = "supp")
bxp + 
  stat_pvalue_manual(stat.test, label = "p") +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.1)))

```

# 6. Principal components analysis

Tutorials [Data Camp - PCA Analysis in
R](https://www.datacamp.com/tutorial/pca-analysis-r){.uri}

[FactoExtra](https://rpkgs.datanovia.com/factoextra/index.html){.uri}
[STHDA: Principal Component Methods in R - Practical
guide](http://www.sthda.com/english/articles/31-principal-component-methods-in-r-practical-guide/114-mca-multiple-correspondence-analysis-in-r-essentials/){.uri}

[Statistics globe: PCA before K Means
Clustering](https://statisticsglobe.com/pca-before-k-means-clustering-r){.uri}\>

## 6.1. Packages and colors

```{r}
library(tidyverse)
library(ggrepel) #load before factoextra
library(factoextra)
library(caret)
library(stats)
library(ggfortify)
library(ggplot2)
library(corrplot)
library(cowplot)
library(ggcorrplot)
library(ComplexHeatmap)
library(circlize)
library(ggExtra)
library(FactoMineR)
library(here)

```

## 6.2. Process data

**Required files**

```{r}
# Genes in long table format
all_degs_p_05_vac_infected = readRDS(here("DGE analysis", "all_studies_degs_weighted.rds"))

# Gene set annotation.Used only to merge and filter genes.
ImmuneGO_Annotated_Genes = readRDS(here("VaxGO gene sets", "ImmuneGO_Annotated_Genes_2024-03-26.rds"))

# Sample or condition annotation
ann_vaccines <-
  read_csv(here("Annotations and metadata", "ann_vaccines_conditions.csv"))

data_annotation = ann_vaccines %>%
  mutate(day = as.factor(day),
         dose = as.factor(dose)) 
```

**Filtering data**

```{r}
# Gene set data.
ImmuneGO_Annotated_Genes_all = ImmuneGO_Annotated_Genes
ImmuneGO_Annotated_Genes = ImmuneGO_Annotated_Genes_all %>% 
  filter(!process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE"))

ImmuneGO_Genes = all_degs_p_05_vac_infected %>%
  inner_join(ImmuneGO_Annotated_Genes %>% 
               select(genes, process) %>% 
               distinct() %>% 
               select(genes),
               by = "genes") %>% 
  distinct()
```

**Input**

```{r}
#INPUT
data_genes = ImmuneGO_Genes 
filename = "COVID_Infec_Vac_ImmuneGO"

#Convert long to wide table format.
#Dataframe with sample annotation

ann_vaccines_pca_matrix = data_genes %>% 
  dplyr::summarise(n = dplyr::n(), .by = c(genes, condition)) |>
  dplyr::filter(n > 1L)
  select(condition, genes, log2fold_change) %>% 
  distinct() %>% 
  pivot_wider(names_from = "condition", 
              values_from = "log2fold_change") %>% 
  replace(is.na(.), 0) %>%
  column_to_rownames("genes") %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column("condition") %>% 
  inner_join(data_annotation %>% 
               select(condition, disease_vac, vaccine, day, week, dose, infection, type), by = "condition") 

# Convert dataframe to matrix without annotation columns
ann_vaccines_pca_matrix_ready = ann_vaccines_pca_matrix %>% 
  column_to_rownames("condition") %>% 
  select(!disease_vac:type) %>% 
  as.matrix()

dim()

```

## 6.3. PCA: COVID-19 conditions only

```{r cache = TRUE}
# Delete columns with near 0 variance
nearZeroVarCols <- nearZeroVar(ann_vaccines_pca_matrix_ready, saveMetrics = TRUE)
ann_vaccines_pca_matrix_ready <- ann_vaccines_pca_matrix_ready[, !nearZeroVarCols$nzv]
pca_res <- prcomp(ann_vaccines_pca_matrix_ready, scale. = T)

# Correlation plot ----
corr_matrix = cor(ann_vaccines_pca_matrix_ready %>% scale()) 
var <- get_pca_var(pca_res)

# corrplot = ggcorrplot(corr_matrix, hc.order = TRUE) + 
#   theme(axis.text.x = element_text(angle = 90, size = 5), 
#         axis.text.y = element_text(size = 5))
# #Salvar
# ggsave(corrplot, file = paste0(filename, "_corrplot.png"), 
#        width = 20, #Grande 20, pequeno 10
#        height= 20) #Grande 20, pequeno 10
# print(corrplot)

#PCA ----
data.pca = prcomp(corr_matrix) #PCA

#Scree plot ----
scree_plot = fviz_eig(data.pca, 
                      addlabels = TRUE,
                      ylim = c(0, 70),barfill = "#00AFBB") +
  theme_few()

#Save
ggsave(scree_plot, file = here("Figures", paste0(filename, "_screeplot.png")), width = 10, height = 3) 
scree_plot

```

## 6.3.1. Loadings plot

```{r}
# Loadings plot ----
options(ggrepel.max.overlaps = Inf)

circle_contrib= fviz_pca_var(pca_res, col.var = "cos2",
                              gradient.cols = c("#4DBBD5FF", "#DC0000FF"),
                              select.var= list(cos2 = 20), 
                              repel = T, 
                              labelsize = 4,
                              col.circle = NA) +
  xlab("PC1") + 
  ylab("PC2") +
  theme_classic() +
theme(panel.grid = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()) 

#Save
ggsave(circle_contrib, file = here("Figures", paste0(filename, "_circle_contrib_wide.png")), width = 10, height = 5)

circle_contrib
```

## 6.3.2. KNN

```{r}
#KNN classification -----
#Use the screeplot generated % of explained variance for each dimension
scree_plot #Dim 1 = 68.2%, Dim 2 = 15.9%


# PC1-PC2 ------
#Determine the number of clusters
pca_scores <- data.frame(pca_res$x[, 1:2])
fviz_nbclust(pca_scores,  
                     FUNcluster = kmeans,
                     method = "wss")

pcas = "PC1-PC2"

set.seed(666) # Set seed for randomization
cluster_model <- kmeans(pca_res$x[, 1:2], centers = 3)  #Set the number of clusters

ann_vaccines_pca_matrix$cluster <- as.factor(cluster_model$cluster)
```

## 6.3.3. Plot

```{r fig.height=7, fig.width=10, paged.print=FALSE, cache=TRUE}
# Condition with density plot ------
pca_plot_knn_cluster = autoplot(pca_res, 
        data = ann_vaccines_pca_matrix)  +
  stat_ellipse(aes(color = cluster, fill = cluster), 
               geom = "polygon", 
               alpha = 0.2, 
               linetype = 1,
               size = 0.3,
               type = "t") +
  labs(title=paste0(filename, "_bycondition"),
       x = "PC1 (68.2%)",
       y = "PC2 (15.9%)") + 
  geom_hline(yintercept = 0, size = 0.3, color = "gray50", linetype = 4) +
  geom_vline(xintercept = 0, size = 0.3, color = "gray50", linetype = 4) +
  geom_point(aes(fill = condition,
                 color = condition),
             stroke = 0.2) +
   scale_color_manual(values = c("1" = "#8491B4FF", 
                                "2" = "#4DBBD5FF", 
                                "3" = "#DC0000FF",
                                condition_col), 
                     guide = "none") +
  scale_fill_manual(values = c("1" = "#8491B4FF", 
                               "2" = "#4DBBD5FF", 
                               "3" = "#DC0000FF",
                               condition_col),
                    guide = "none") + 
  guides(col="none") +
  theme_few() +
  theme(panel.grid.minor = element_blank(),
        text = element_text(color = "black"),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black")) +
  geom_text_repel(aes(label = condition,
                      segment.colour="gray70"),
                  box.padding = 0.3,
                  size = 3) +
  xlim(-0.4, 0.6)
pca_plot_knn_cluster

ggsave(pca_plot_knn_cluster, 
       file = here( "Figures", paste0(filename, pcas, "_KNN_Clustered_labels.png")), width = 10, height = 7)
pca_plot_knn_cluster


# pca_plot_knn_cluster_marginal = ggMarginal(
#   pca_plot_knn_cluster,
#   type = "histogram",
#   groupFill = T,
#   groupColour = T,
#   xparams = list(binwidth = 0.1, size = 0.1),
#   yparams = list(binwidth = 0.1, size = 0.1)
# )
# 
# ggsave(
#   pca_plot_knn_cluster_marginal,
#   file = here(paste0(filename, pcas, "_KNN_Clustered_labels_Marginal.png"), "Figures"),
#   width = 8,
#   height = 5
# )


```

## 6.3.4. Heatmap

### 6.3.4.1. Get PC1 and PC2 genes

Inputs
```{r}
####### INPUT
PC1 = var$cos2 %>%
  as.data.frame() %>%
  arrange(desc(Dim.1)) %>%
  filter(Dim.1 >= 0.5) %>% 
  #slice_head(n=20) %>% 
  rownames_to_column("genes") %>% 
  distinct() %>% 
  select(genes, cos2 = Dim.1) %>% 
    mutate(dimension = "PC1")

PC2 = var$cos2 %>%
  as.data.frame() %>%
  filter(Dim.2 >= 0.5) %>% 
  #slice_head(n=20) %>% 
  rownames_to_column("genes") %>% 
  distinct() %>% 
  select(genes, cos2 = Dim.2) %>% 
  mutate(dimension = "PC2")

PC1_2 = bind_rows(PC1, PC2) 
PC1_2 %>% 
  select(genes) %>% distinct()

PC1_2 %>% write.csv(file = "PC_1_2_cos2.csv", row.names = F)


# Gene annotation
ImmuneGO_Annotated_Genes
```


#### 6.3.4.1.1. PC1 genes heatmap
```{r}
# INPUT
ann_genes = ImmuneGO_Annotated_Genes
pc = "PC1"
data_2 =  PC1 %>% 
  slice_max(order_by = cos2, n = 20) %>% 
  inner_join(data_genes, by = "genes")
filename_2 = paste0(filename, "_PCA_",pc, "_COVID")

######## Matrix
matrix = data_2 %>% 
  select(genes, condition, log2fold_change) %>%
  pivot_wider(names_from = "condition", 
              values_from = "log2fold_change", 
              values_fn = mean) %>% 
  replace(is.na(.), 0) %>%
  arrange(genes) %>% 
  column_to_rownames(var="genes") %>% 
  as.matrix()

######## Annotations
ann_vaccines_covid = data_2 %>% 
  select(condition) %>% 
  distinct() %>% 
  inner_join(ann_vaccines, by = "condition") %>% 
  select(condition, disease_vac, type, day) %>% 
  distinct()

#Columns
ann_cols_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  inner_join(ann_vaccines_covid, by = "condition") %>% 
  distinct() %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  mutate(day_n = day,
         day = as.factor(day_n),
         day = fct_reorder(day, day_n)) %>%
  select(-day_n)

matrix_data = matrix %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  inner_join(ann_cols_heatmap %>% rownames_to_column("condition"), by = "condition") %>% 
  select(!c(disease_vac:day)) %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>%
  as.matrix()

#Rows Immune -----
ann_rows_immune = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  inner_join(ann_genes, by = "genes") %>%
  filter(go_term == "Manual") %>%
  select(genes, process) %>%
  distinct() %>%
  group_by(genes) %>%
  arrange(genes, factor(process, levels = c("INNATE IMMUNE SYSTEM", "ADAPTIVE IMMUNE SYSTEM", "OTHER", "ANTIMICROBIAL IMMUNE RESPONSE")), .by_group = TRUE) %>%
  mutate(i_process = row_number()) %>%
  pivot_wider(., names_from = "i_process", values_from = "process") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("index") %>%
  arrange(desc(as.numeric(index))) %>%
  column_to_rownames("index") %>%
  t() %>%
  as.data.frame() %>%
  replace(is.na(.), ".")

#Verificar dimensões do dataset
dim(matrix_data)
dim(ann_rows_immune)
dim(ann_cols_heatmap)

```

```{r fig.height=7, fig.width=10}
#Heatmap annotation -----
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "right")

row_ha = HeatmapAnnotation(df = ann_rows_immune, 
                            which = "row",
                       col = col_process_immune, #col_process_immune / col_process_notimmune 
                       show_annotation_name = F,
                       show_legend = F,
                       simple_anno_size = unit(2, "mm"))

# Values colors -----
col_fun <- colorRamp2(c(-2, 0, 2), c("#9bc1bc", "white", "#ed6a5a"))


# Parameters -----
file = filename_2
mat = matrix_data
width_image = 30
height_image = 30
width = unit(15, "cm")
height = unit(10, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)
rect_gp = gpar(col = "gray80", lwd = 0.5)

fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = here("Figures", fileimageheatmap_grouped), 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                       name = "L2FC",
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        col = col_fun, #color
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "white",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(2, "cm"),
                        column_split = 2,
                        row_split = 2,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(8, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height 
)

draw(heatmap_plot, 
     annotation_legend_side = "left", 
     heatmap_legend_side = "bottom")
dev.off()

```
####  6.3.4.1.2. PC2 genes heatmap
```{r}
# INPUT
ann_genes = ImmuneGO_Annotated_Genes
pc = "PC2"
data_2 =  PC2 %>% 
  slice_max(order_by = cos2, n = 20) %>% 
  inner_join(data_genes, by = "genes")
filename_2 = paste0(filename, "_PCA_",pc, "_COVID")

######## Matrix
matrix = data_2 %>% 
  select(genes, condition, log2fold_change) %>%
  pivot_wider(names_from = "condition", 
              values_from = "log2fold_change", 
              values_fn = mean) %>% 
  replace(is.na(.), 0) %>%
  arrange(genes) %>% 
  column_to_rownames(var="genes") %>% 
  as.matrix()

######## Annotations
ann_vaccines_covid = data_2 %>% 
  select(condition) %>% 
  distinct() %>% 
  inner_join(ann_vaccines, by = "condition") %>% 
  select(condition, disease_vac, type, day) %>% 
  distinct()

#Columns
ann_cols_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  inner_join(ann_vaccines_covid, by = "condition") %>% 
  distinct() %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  mutate(day_n = day,
         day = as.factor(day_n),
         day = fct_reorder(day, day_n)) %>%
  select(-day_n)

matrix_data = matrix %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  inner_join(ann_cols_heatmap %>% rownames_to_column("condition"), by = "condition") %>% 
  select(!c(disease_vac:day)) %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>%
  as.matrix()

#Rows Immune -----
ann_rows_immune = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  inner_join(ann_genes, by = "genes") %>%
  filter(go_term == "Manual") %>%
  select(genes, process) %>%
  distinct() %>%
  group_by(genes) %>%
  arrange(genes, factor(process, levels = c("INNATE IMMUNE SYSTEM", "ADAPTIVE IMMUNE SYSTEM", "OTHER", "ANTIMICROBIAL IMMUNE RESPONSE")), .by_group = TRUE) %>%
  mutate(i_process = row_number()) %>%
  pivot_wider(., names_from = "i_process", values_from = "process") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("index") %>%
  arrange(desc(as.numeric(index))) %>%
  column_to_rownames("index") %>%
  t() %>%
  as.data.frame() %>%
  replace(is.na(.), ".")

#Verificar dimensões do dataset
dim(matrix_data)
dim(ann_rows_immune)
dim(ann_cols_heatmap)

```

```{r fig.height=7, fig.width=10}
#Heatmap annotation -----
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "right")

row_ha = HeatmapAnnotation(df = ann_rows_immune, 
                            which = "row",
                       col = col_process_immune, #col_process_immune / col_process_notimmune 
                       show_annotation_name = F,
                       show_legend = F,
                       simple_anno_size = unit(2, "mm"))

# Values colors -----
col_fun <- colorRamp2(c(-2, 0, 2), c("#9bc1bc", "white", "#ed6a5a"))


# Parameters -----
file = filename_2
mat = matrix_data
width_image = 30
height_image = 30
width = unit(15, "cm")
height = unit(10, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)
rect_gp = gpar(col = "gray80", lwd = 0.5)

fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = here("Figures", fileimageheatmap_grouped), 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                       name = "L2FC",
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        col = col_fun, #color
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "white",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(2, "cm"),
                        column_split = 2,
                        row_split = NULL,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(8, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height 
)

draw(heatmap_plot, 
     annotation_legend_side = "left", 
     heatmap_legend_side = "bottom")
dev.off()

```


### 6.3.4.2 Gene expression by gender

#### PC1 genes

```{r}
#### PC1 -------
PC1 = var$cos2 %>%
  as.data.frame() %>%
  arrange(desc(Dim.1)) %>%
  slice_head(n = 5) %>%
  rownames_to_column("genes") %>% 
  distinct() %>% 
  select(genes, Dim.1)

PC1_genes_counts = normalized_counts %>% 
  rownames_to_column("genes") %>% 
  inner_join(PC1, by = "genes") %>% 
  pivot_longer(cols = -c("genes", "Dim.1"), names_to = "sample", values_to = "counts") %>% 
  mutate(counts = round(counts, 0)) %>% 
  select(genes, sample, counts, Dim.1) %>% 
  inner_join(ann_vaccines_samples, by = "sample") %>% 
  filter(gse_id != "GSE206023") %>% 
  group_by(condition) %>%
  filter(any(sex == 'Male') & any(sex == 'Female'),
         condition != "H (D0)") %>% 
  ungroup() %>% 
  mutate(age_inter = cut(
    age,
    breaks = c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100),
    labels = c(
      "10-20",
      "21-30",
      "31-40",
      "41-50",
      "51-60",
      "61-70",
      "71-80",
      "81-90",
      "91-100"
    )
  ))
  
write_csv(PC1_genes_counts, file = here("PCA", "PC1_genes_samples_counts.csv"))

PC1_genes_counts
```

Sex

```{r fig.height=20, fig.width=20}
#Sex ----
pc1_5genes  = ggplot(PC1_genes_counts) +
  aes(x = condition, y = counts, fill = sex, colour = sex) +
  geom_boxplot() +
  scale_fill_hue(h = c(180, 270)) +
  scale_color_hue(h = c(180, 270)) +
  scale_y_continuous(trans = "log2") +
  theme_light() +
  labs(fill = "Sex") +
  theme(legend.position = "right") +
  facet_wrap(vars(genes), scales = "free", ncol =1) +
  theme(axis.text.x = element_text(size = 10, color = "black", angle = 45, vjust = 1, hjust = 1),
        axis.text.y = element_text(size = 10, color = "black"),
        strip.background = element_rect(fill = "black"),
        strip.text = element_text(color = "white", face = "bold", size = 15))
```

Age

```{r fig.height=20, fig.width=20}
#Age ----

pc1_5genes_age  = ggplot(PC1_genes_counts) +
  aes(x = condition, y = counts, fill = age_inter) +
  geom_boxplot() +
  scale_fill_hue(h = c(180, 360)) +
  scale_color_hue(h = c(180, 360)) +
  scale_y_continuous(trans = "log2") +
  theme_light() +
  labs(fill = "Age") +
  theme(legend.position = "right") +
  theme(axis.text.x = element_text(size = 10, color = "black", angle = 45, vjust = 1, hjust = 1),
        axis.text.y = element_text(size = 10, color = "black"),
        strip.background = element_rect(fill = "black"),
        strip.text = element_text(color = "white", face = "bold", size = 15)) +
  facet_wrap(vars(genes), scales = "free", ncol = 1)
```

Unite

```{r fig.height=20, fig.width=20}
patch_pc1_genes = pc1_5genes_age + pc1_5genes + plot_layout(guides = "collect")

ggsave(patch_pc1_genes, file = here("Figures","pc1_5genes_age_sex.png"), width = 20, height = 20)

patch_pc1_genes

```

#### PC2 genes

```{r fig.height=20, fig.width=20}
#### PC2 -------
PC2 = var$cos2 %>%
  as.data.frame() %>%
  arrange(desc(Dim.2)) %>%
  slice_head(n = 5) %>%
  rownames_to_column("genes") %>% 
  distinct() %>% 
  select(genes, Dim.1)

PC2_genes_counts = normalized_counts %>% 
  rownames_to_column("genes") %>% 
  inner_join(PC2, by = "genes") %>% 
  pivot_longer(cols = -c("genes", "Dim.1"), names_to = "sample", values_to = "counts") %>% 
  mutate(counts = round(counts, 0)) %>% 
  select(genes, sample, counts, Dim.1) %>% 
  inner_join(ann_vaccines_samples, by = "sample") %>% 
  filter(gse_id != "GSE206023") %>% 
  group_by(condition) %>%
  filter(any(sex == 'Male') & any(sex == 'Female'),
         condition != "H (D0)") %>% 
  ungroup() %>% 
  mutate(age_inter = cut(
    age,
    breaks = c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100), 
    labels = c(
      "10-20",
      "21-30",
      "31-40",
      "41-50",
      "51-60",
      "61-70",
      "71-80",
      "81-90",
      "91-100"
    )
  ))

write_csv(PC2_genes_counts, file = here("PCA","PC2_genes_samples_counts.csv"))
```

Sex

```{r fig.height=20, fig.width=20}
#Sex ----
pc2_5genes  = ggplot(PC2_genes_counts) +
  aes(x = condition, y = counts, fill = sex, colour = sex) +
  geom_boxplot() +
  scale_fill_hue(h = c(180, 270)) +
  scale_color_hue(h = c(180, 270)) +
  scale_y_continuous(trans = "log2") +
  theme_light() +
  labs(fill = "Sex") +
  theme(legend.position = "right") +
  facet_wrap(vars(genes), scales = "free", ncol =1) +
  theme(axis.text.x = element_text(size = 10, color = "black", angle = 45, vjust = 1, hjust = 1),
        axis.text.y = element_text(size = 10, color = "black"),
        strip.background = element_rect(fill = "black"),
        strip.text = element_text(color = "white", face = "bold", size = 15))
```

Age

```{r fig.height=20, fig.width=20}
#Age ----

pc2_5genes_age  = ggplot(PC2_genes_counts) +
  aes(x = condition, y = counts, fill = age_inter, colour = age_inter) +
  geom_boxplot() +
  scale_fill_hue(h = c(180, 360)) +
  scale_color_hue(h = c(180, 360)) +
  scale_y_continuous(trans = "log2") +
  theme_light() +
  theme(legend.position = "right") +
  labs(fill = "Age") +
  theme(axis.text.x = element_text(size = 10, color = "black", angle = 45, vjust = 1, hjust = 1),
        axis.text.y = element_text(size = 10, color = "black"),
        strip.background = element_rect(fill = "black"),
        strip.text = element_text(color = "white", face = "bold", size = 15)) +
  facet_wrap(vars(genes), scales = "free", ncol = 1)
```

Unite

```{r fig.height=20, fig.width=20}
patch_pc2_genes = pc2_5genes_age + pc2_5genes + plot_layout(guides = "collect")

ggsave(patch_pc2_genes, file = here("Figures","pc2_5genes_age_sex.png"), width = 20, height = 20)

patch_pc2_genes
```


## 6.4. PCA: COVID-19 and others

Required files
```{r}
# Gene set annotation
degs_covid_vax = readRDS(here("VaxGO gene sets", "degs_covid_vaxsig_up_down_immune.rds"))
VAXSigDB_Annotated = read_csv(here("VaxGO gene sets", "VAXSigDB_Annotated.csv"))

ImmuneGO_Annotated_Genes = read_rds(file = here("VaxGO gene sets", "ImmuneGO_Annotated_Genes_2024-03-26.rds"))
ann_vaccines_covid_other = read_csv(here("Annotations and metadata", "ann_vaccines_vaxsig_covid.csv"))

ImmuneGO_Genes = degs_covid_vax
```

Process data
```{r}
# Sample or condition annotation
data_annotation = VAXSigDB_Annotated %>% 
  clean_names() %>% 
  select(condition = vaccine_condition, type = platform, microbe_type, target_pathogen_disease, time) %>% 
  mutate(time = if_else(time == "ANY", "0", time),
         time = if_else(time == "1-3", "2", time),
         time = as.numeric(time)) %>% 
  bind_rows(ann_vaccines_covid_other %>% rename(time = day_total)) %>% 
  select(condition, type, target_pathogen_disease, time)

VAXSigDB_Annotated_days = VAXSigDB_Annotated %>% 
  select(VACCINE_CONDITION, `DATE-TIME`:TIME) %>% 
  mutate(TIME = case_when(TIME == "ANY" ~ "0",
                          TIME == "1-3" ~ "2", 
                          TRUE ~ TIME),
         TIME = as.numeric(TIME)) %>% 
 mutate(day = case_when(DATE == "H" ~ TIME/24,
                        DATE == "M" ~ TIME * 30,
                        DATE == "W" ~ TIME * 7,
                        TRUE ~ TIME)) %>% 
  select(condition = VACCINE_CONDITION, day) %>% 
  distinct()

sars = data_annotation %>% 
  filter(target_pathogen_disease == "SARS") %>% 
  mutate(target_pathogen_disease = "COVID-19") %>% 
  rename(day = time)

data_annotation = data_annotation %>% 
  left_join(VAXSigDB_Annotated_days, by = "condition") %>% 
  filter(day < 100,
         day > 0) %>% 
  distinct() %>% 
  select(-time) %>% 
  bind_rows(sars) %>% 
  filter(type != "I") %>% 
  mutate(target_pathogen_disease = if_else(target_pathogen_disease == "COVID-19", "COVID-19", "OTHER"))

```

Inputs
```{r}
#INPUT
data_genes = ImmuneGO_Genes 
filename = "ImmuneGO_Genes_UP_DOWN_COVID_OTHER"

#Convert long to wide table format.
#Dataframe with sample annotation
ann_vaccines_pca_matrix = data_genes %>% 
  mutate(regulation_numeric = as.numeric(regulation_numeric)) %>% 
  select(genes, condition, regulation_numeric) %>% 
  distinct() %>%
  pivot_wider(names_from = "condition", 
              values_from = "regulation_numeric",
              values_fn = mean) %>% 
  replace(is.na(.), 0) %>%
  column_to_rownames("genes") %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column("condition") %>% 
  inner_join(data_annotation, by = "condition") %>% 
  distinct() 

# Convert dataframe to matrix without annotation columns
ann_vaccines_pca_matrix_ready = ann_vaccines_pca_matrix %>% 
  column_to_rownames("condition") %>% 
  select(!c(type, target_pathogen_disease, day)) %>% 
  as.matrix()

```

#### 6.4.1. Scree plot
```{r}
# Delete columns with near 0 variance
nearZeroVarCols <- nearZeroVar(ann_vaccines_pca_matrix_ready, saveMetrics = TRUE)
ann_vaccines_pca_matrix_ready <- ann_vaccines_pca_matrix_ready[, !nearZeroVarCols$nzv]
pca_res <- prcomp(ann_vaccines_pca_matrix_ready)

# Correlation plot ----
corr_matrix = cor(ann_vaccines_pca_matrix_ready) 
var <- get_pca_var(pca_res)

#PCA ----
data.pca = prcomp(corr_matrix) #PCA
summary(corr_matrix) #Retornar PCs

#Scree plot ----
scree_plot = fviz_eig(data.pca, 
                      addlabels = TRUE,
                      ylim = c(0, 60)) +
  geom_col(color = "#00AFBB", fill = "#00AFBB") +
  theme_classic()

#PC1 = 51.9%
#PC2 = 12.7

#Save
ggsave(scree_plot, file = here("Figures", paste0(filename, "_screeplot.png")), width = 10, height = 3) 
print(scree_plot)

```

#### 6.4.2. Loadings plot
```{r}
# Loadings plot ----
options(ggrepel.max.overlaps = Inf)

# Filter top vars for each PC
cos2_df <- get_pca_var(pca_res)$cos2
cos2_df <- as.data.frame(cos2_df)
cos2_df$variable <- rownames(cos2_df)
top_n_cos2 <- function(df, n = 10) {
  df %>%
    arrange(desc(cos2)) %>%
    slice_head(n = n)
}
top_cos2_Dim1 <- top_n_cos2(cos2_df %>% select(variable, cos2 = Dim.1))
top_cos2_Dim2 <- top_n_cos2(cos2_df %>% select(variable, cos2 = Dim.2))
top_cos2_combined <- bind_rows(top_cos2_Dim1, top_cos2_Dim2) %>%
  distinct(variable, .keep_all = TRUE)



circle_contrib= fviz_pca_var(pca_res, col.var = "cos2",
                              gradient.cols = c("black", "#DC0000FF"),
                              select.var = list(name = top_cos2_combined$variable),
                              repel = T, 
                              labelsize = 4,
                              col.circle = NA) +
  xlab("") + 
  ylab("") +
  theme_minimal() +
theme(panel.grid = element_blank(),  # Remover linhas de grade
        axis.text = element_blank(),   # Remover rótulos de texto dos eixos
        axis.ticks = element_blank()) 

circle_contrib

#Save
ggsave(circle_contrib, file = here("Figures",paste0(filename, "_circle_contrib_wide.png")), width = 5, height = 5)

```
#### 6.4.3. KNN classification
```{r KNN classification}
#KNN classification -----
#Use the screeplot generated % of explained variance for each dimension

# PC1-PC2 ------
#Determine the number of clusters
pca_scores <- data.frame(pca_res$x[, 1:2])
fviz_nbclust(pca_scores,  
                     FUNcluster = kmeans,
                     method = "wss")

pcas = "PC1-PC2"

set.seed(666) # Set seed for randomization
cluster_model <- kmeans(pca_res$x[, 1:2], centers = 2)  #Set the number of clusters

ann_vaccines_pca_matrix$cluster <- as.factor(cluster_model$cluster)
```

#### 6.4.4 Plot
```{r}
# Condition with density plot ------
pca_plot_knn_cluster = autoplot(pca_res, 
        data = ann_vaccines_pca_matrix)  +
  stat_ellipse(aes(fill = cluster), 
               geom = "path", 
               alpha = 0.1, 
               linetype = 1,
               size = 1,
               type = "t", 
               show.legend = FALSE) +
  labs(title=paste0(filename, "_bycondition"),
       x = "PC1 (51.9%)",
       y = "PC2 (12.7%)",
       color = "Type",
       shape = "Target disease") + 
  xlab("PC1 (51.9%)") +
  ylab("PC2 (12.7%)") +
  geom_hline(yintercept = 0, size = 0.3, color = "gray50", linetype = 4) +
  geom_vline(xintercept = 0, size = 0.3, color = "gray50", linetype = 4) +
  geom_point(aes(shape = target_pathogen_disease),
             color = "black", size = 4) +
  geom_point(aes(color = type,
                 fill = type,
                 shape = target_pathogen_disease),
             size = 3) +
  scale_fill_manual(values = ann_vaxsig_colors$type,
                    guide = "none") +
  scale_color_manual(values = ann_vaxsig_colors$type) +
  theme_few() +
  theme(panel.grid.minor = element_blank(),
        text = element_text(color = "black"),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black")) +
  geom_text_repel(aes(label = condition,
                      segment.colour="gray70"),
                  box.padding = 0.3,
                  size = 2)

pca_plot_knn_cluster 

ggsave(pca_plot_knn_cluster, file = here("Figures", paste0(filename, pcas, "_KNN_Clustered_labels.png")), width = 10, height = 5)
```

```{r}
pca_plot_knn_cluster_interactive = autoplot(pca_res, 
        data = ann_vaccines_pca_matrix)  +
  stat_ellipse(aes(fill = cluster), 
               geom = "path", 
               alpha = 0.1, 
               linetype = 1,
               size = 1,
               type = "t", 
               show.legend = FALSE) +
  labs(title=paste0(filename, "_bycondition"),
       x = "PC1 (51.9%)",
       y = "PC2 (12.7%)",
       color = "Type") + 
  xlab("PC1 (51.9%)") +
  ylab("PC2 (12.7%)") +
  geom_hline(yintercept = 0, size = 0.3, color = "gray50", linetype = 4) +
  geom_vline(xintercept = 0, size = 0.3, color = "gray50", linetype = 4) +
  geom_point(aes(shape = target_pathogen_disease),
             color = "black", size = 4) +
  geom_point(aes(color = type,
                 fill = type,
                 label = condition,
                 shape = target_pathogen_disease),
             size = 3) +
  scale_fill_manual(values = ann_vaxsig_colors$type,
                    guide = "none") +
  scale_color_manual(values = ann_vaxsig_colors$type) +
  theme_few() +
  theme(panel.grid.minor = element_blank(),
        text = element_text(color = "black"),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black")) 

ggsave(pca_plot_knn_cluster_interactive, file = here("Figures", paste0(filename, pcas, "_KNN_Clustered_NO_labels.png")), width = 10, height = 5)

pca_plot_knn_cluster_interactive %>% ggplotly()
```

#### 6.4.5. Heatmap

##### 6.4.5.1. Get PC1 and PC2 genes
```{r}
####### INPUT
PC1 = var$cos2 %>%
  as.data.frame() %>%
  arrange(desc(Dim.1)) %>%
  slice_head(n=20) %>% 
  rownames_to_column("genes") %>% 
  distinct() %>% 
  select(genes, cos2 = Dim.1) %>% 
    mutate(dimension = "PC1")

PC2 = var$cos2 %>%
  as.data.frame() %>%
  # filter(Dim.2 >= 0.5) %>% 
  slice_head(n=20) %>% 
  rownames_to_column("genes") %>% 
  distinct() %>% 
  select(genes, cos2 = Dim.2) %>% 
  mutate(dimension = "PC2")

PC1_2 = bind_rows(PC1, PC2) 
PC1_2 %>% 
  select(genes) %>% distinct()


# Gene annotation
ImmuneGO_Annotated_Genes
ann_vaccines_covid_other
```

##### 6.4.5.2. PC1 genes heatmap
```{r}
# INPUT

ann_genes = ImmuneGO_Annotated_Genes
pc = "PC1"
data_2 =  PC1 %>% 
  slice_max(order_by = cos2, n = 20) %>% 
  inner_join(data_genes, by = "genes")
filename_2 = paste0(filename, "_PCA_",pc, "_COVID")

######## Matrix
matrix = data_2 %>% 
  select(genes, condition, regulation_numeric) %>%
  pivot_wider(names_from = "condition", 
              values_from = "regulation_numeric", 
              values_fn = mean) %>% 
  replace(is.na(.), 0) %>%
  arrange(genes) %>% 
  column_to_rownames(var="genes") %>% 
  as.matrix()

######## Annotations
ann_vaccines_covid = data_2 %>% 
  select(condition) %>% 
  distinct() %>% 
  inner_join(ann_vaccines_covid_other, by = "condition") %>% 
  select(condition, microbe_type, covid_other, type, week) %>% 
  distinct()

#Columns
ann_cols_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  inner_join(ann_vaccines_covid, by = "condition") %>% 
  distinct() %>% 
  arrange(condition) %>% 
  column_to_rownames("condition")

matrix_data = matrix %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  inner_join(ann_cols_heatmap %>% rownames_to_column("condition"), by = "condition") %>% 
  select(!c(microbe_type:week)) %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>%
  as.matrix()

#Rows Immune -----
ann_rows_immune = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  inner_join(ann_genes, by = "genes") %>%
  filter(go_term == "Manual") %>%
  select(genes, process) %>%
  distinct() %>%
  group_by(genes) %>%
  arrange(genes, factor(process, levels = c("INNATE IMMUNE SYSTEM", "ADAPTIVE IMMUNE SYSTEM", "OTHER", "ANTIMICROBIAL IMMUNE RESPONSE")), .by_group = TRUE) %>%
  mutate(i_process = row_number()) %>%
  pivot_wider(., names_from = "i_process", values_from = "process") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("index") %>%
  arrange(desc(as.numeric(index))) %>%
  column_to_rownames("index") %>%
  t() %>%
  as.data.frame() %>%
  replace(is.na(.), ".")

#Verificar dimensões do dataset
dim(matrix_data)
dim(ann_rows_immune)
dim(ann_cols_heatmap)
```

```{r}
#Heatmap annotation -----
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "right")

row_ha = HeatmapAnnotation(df = ann_rows_immune, 
                            which = "row",
                       col = col_process_immune,
                       show_annotation_name = F,
                       show_legend = F,
                       simple_anno_size = unit(2, "mm"))

# Values colors -----
col_fun <- colorRamp2(c(-1, 0, 1), c("#9bc1bc", "white", "#ed6a5a"))


# Parameters -----
file = filename_2
mat = matrix_data
width_image = 40
height_image = 20
width = unit(30, "cm")
height = unit(10, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)
rect_gp = gpar(col = "gray80", lwd = 0.5)

fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = here("Figures", fileimageheatmap_grouped), 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        name = "L2FC",
                        heatmap_legend_param = list(direction = "horizontal"),
                        col = col_fun, #color
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "white",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(2, "cm"),
                        column_split = 2,
                        row_split = NULL,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(8, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height 
)

draw(heatmap_plot, 
     annotation_legend_side = "left", 
     heatmap_legend_side = "bottom")
dev.off()

```


##### 6.4.5.3. PC2 genes heatmap
```{r}
# INPUT

ann_genes = ImmuneGO_Annotated_Genes
pc = "PC2"
data_2 =  PC2 %>% 
  slice_max(order_by = cos2, n = 20) %>% 
  inner_join(data_genes, by = "genes")
filename_2 = paste0(filename, "_PCA_",pc, "_COVID")

######## Matrix
matrix = data_2 %>% 
  select(genes, condition, regulation_numeric) %>%
  pivot_wider(names_from = "condition", 
              values_from = "regulation_numeric", 
              values_fn = mean) %>% 
  replace(is.na(.), 0) %>%
  arrange(genes) %>% 
  column_to_rownames(var="genes") %>% 
  as.matrix()

######## Annotations
ann_vaccines_covid = data_2 %>% 
  select(condition) %>% 
  distinct() %>% 
  inner_join(ann_vaccines_covid_other, by = "condition") %>% 
  select(condition, microbe_type, covid_other, type, week) %>% 
  distinct()

#Columns
ann_cols_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  inner_join(ann_vaccines_covid, by = "condition") %>% 
  distinct() %>% 
  arrange(condition) %>% 
  column_to_rownames("condition")

matrix_data = matrix %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  inner_join(ann_cols_heatmap %>% rownames_to_column("condition"), by = "condition") %>% 
  select(!c(microbe_type:week)) %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>%
  as.matrix()

#Rows Immune -----
ann_rows_immune = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  inner_join(ann_genes, by = "genes") %>%
  filter(go_term == "Manual") %>%
  select(genes, process) %>%
  distinct() %>%
  group_by(genes) %>%
  arrange(genes, factor(process, levels = c("INNATE IMMUNE SYSTEM", "ADAPTIVE IMMUNE SYSTEM", "OTHER", "ANTIMICROBIAL IMMUNE RESPONSE")), .by_group = TRUE) %>%
  mutate(i_process = row_number()) %>%
  pivot_wider(., names_from = "i_process", values_from = "process") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("index") %>%
  arrange(desc(as.numeric(index))) %>%
  column_to_rownames("index") %>%
  t() %>%
  as.data.frame() %>%
  replace(is.na(.), ".")

#Verificar dimensões do dataset
dim(matrix_data)
dim(ann_rows_immune)
dim(ann_cols_heatmap)
```

```{r}
#Heatmap annotation -----
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "right")

row_ha = HeatmapAnnotation(df = ann_rows_immune, 
                            which = "row",
                       col = col_process_immune,
                       show_annotation_name = F,
                       show_legend = F,
                       simple_anno_size = unit(2, "mm"))

# Values colors -----
col_fun <- colorRamp2(c(-1, 0, 1), c("#9bc1bc", "white", "#ed6a5a"))


# Parameters -----
file = filename_2
mat = matrix_data
width_image = 40
height_image = 20
width = unit(30, "cm")
height = unit(10, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)
rect_gp = gpar(col = "gray80", lwd = 0.5)

fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = here("Figures", fileimageheatmap_grouped), 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        name = "L2FC",
                        heatmap_legend_param = list(direction = "horizontal"),
                        col = col_fun, #color
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "white",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(2, "cm"),
                        column_split = 2,
                        row_split = NULL,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(8, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height 
)

draw(heatmap_plot, 
     annotation_legend_side = "left", 
     heatmap_legend_side = "bottom")
dev.off()

```

# 7. VAXGO

## 7.1. VaxGO gene sets construction

```{r eval=FALSE, echo=TRUE}
library(readr)
library(explore)
library(maditr)
library(GEOquery)
library(Matrix)
library(circlize)
library(RColorBrewer)
library(celldex)
library(biomaRt)
library(org.Hs.eg.db)
library(plotly)
library(DESeq2)
library(msigdbr)
library(ape)
library(GSVA)
library(sva)
library(clusterProfiler)
library(pheatmap)
library(EnhancedVolcano)
library(ggbeeswarm)
library(tidyverse)
library(corrr)
library(ggcorrplot)
library(FactoMineR)
library(factoextra)
library(esquisse)
library(corto)
library(factoextra)
library(reshape2)
library(ComplexHeatmap)
library(janitor)
```


## 7.1. Gene set databases

### 7.1.1. Blood transcription modules <https://www.nature.com/articles/ni.2789>

```{r}
#Converter ítens de "Module member genes" em linhas em uma tabela longa
btm_annotation_table_long_immune <- BTM_modules %>%
  separate_rows(`Module member genes`, sep = ",") %>% 
  filter(`Module category` == "immune")

#Salvar
write.csv(btm_annotation_table_long_immune, file = "btm_annotation_table_long_immune.csv")

#Display
head(btm_annotation_table_long_immune)

#Calculate Set size
btm_annotation_nested <- btm_annotation_table_long_immune %>%
  group_by(`Module title`) %>% #Somar e agrupar
  mutate(SetSize = n())

#Convert gene symbol column to aggregated rows
btm_annotation_nested <- btm_annotation_nested %>%
  group_by(`Module title`) %>%
  summarize(Genes = paste(`Module member genes`, collapse = ", "), .groups = "drop") %>% 
  left_join(btm_annotation_nested, by = "Module title") %>% 
  filter(Genes != "NA") %>% 
  relocate(Genes, .after="SetSize")

#Salvar
write.csv(btm_annotation_nested, file = "btm_annotation_genes.csv")

#Convert to unique values table
btm_annotation_unique = btm_annotation_nested %>% 
  select(-`Module member genes`)

btm_annotation_unique = btm_annotation_unique %>% 
  distinct() %>% 
  relocate(Genes, .after="SetSize") %>% 
  filter(Genes != "NA")

#salvar
write.csv(btm_annotation_unique, file = "btm_annotation_unique.csv")

#Display
head(btm_annotation_unique)
```

### 7.1.2. CellMarker

Download database from
"<http://117.50.127.228/CellMarker/CellMarker_download_files/file/Cell_marker_Human.xlsx>"

```{r}
##################### Baixar tabela de marcadores celulares

url <- "http://117.50.127.228/CellMarker/CellMarker_download_files/file/Cell_marker_Human.xlsx" 
f <- tempfile(fileext = ".xlsx")
download.file(url, f)
cell_marker_data <- readxl::read_excel(f, 1)

##################### Sub-agrupar células por sistema imunológico

#Filtrar marcadores e células por tecido (Blood)
cells <- cell_marker_data %>%
    filter(tissue_class == "Blood") %>%
    select(cell_name, marker)

##################### Filtrar células
# Acessar todos os tipos de células no dataset de Blood
cellmarker_celltypes <- unique(cells$cell_name)

# Filtrar apenas os tipos que contêm "B cell" e plasmacell
Bcells_no = cellmarker_celltypes[grep("B cell", cellmarker_celltypes)] #44 outputs
Plasmacells_no = cellmarker_celltypes[grep("plasma", cellmarker_celltypes)] #5 outputs

# Filtrar apenas os tipos que contêm "T cell" e seus subtipos "CD4" e "CD8"
Tcells_no = cellmarker_celltypes[grep("T cell", cellmarker_celltypes)] #93 outputs
TCD4_no = cellmarker_celltypes[grep("CD4", cellmarker_celltypes)] #35 outputs
TCD8_no = cellmarker_celltypes[grep("CD8", cellmarker_celltypes)] #34 outputs
Treg_no = cellmarker_celltypes[grep("Treg", cellmarker_celltypes)] #7 outputs
Thelper_no = cellmarker_celltypes[grep("helper", cellmarker_celltypes)] #17 outputs

# Filtrar outros tipos celulares da resposta imune
Neutrophils_no = cellmarker_celltypes[grep("neutrophil", cellmarker_celltypes)] #7 outputs
Monocyte_no = cellmarker_celltypes[grep("monocyte", cellmarker_celltypes)] #14 outputs
DCells_no = cellmarker_celltypes[grep("dendritic", cellmarker_celltypes)] #25 outputs
Macrophages_no = cellmarker_celltypes[grep("macrophage", cellmarker_celltypes)] #7 outputs
NKcells_no = cellmarker_celltypes[grep("killer", cellmarker_celltypes)] # 11 outputs
Neutrophils_no = cellmarker_celltypes[grep("mastcell", cellmarker_celltypes)] #7 outputs

# Criar variáveis para cada célula para enriquecimento

# Filtrar apenas as células da resposta imune adaptativa
Bcells <- filter(cells, str_detect(cell_name, regex("B cell|plasma cell|plasmablast", ignore_case = TRUE)))
TCD4 <- filter(cells, str_detect(cell_name, regex("CD4", ignore_case = TRUE)))
TCD8 <- filter(cells, str_detect(cell_name, regex("CD8", ignore_case = TRUE)))
Treg <- filter(cells, str_detect(cell_name, regex("Treg", ignore_case = TRUE)))
Thelper <- filter(cells, str_detect(cell_name, regex("helper", ignore_case = TRUE)))


# Filtrar células da resposta imune inata
Neutrophils <- filter(cells, str_detect(cell_name, regex("neutrophil", ignore_case = TRUE)))
Monocyte <- filter(cells, str_detect(cell_name, regex("monocyte", ignore_case = TRUE)))
DCells <- filter(cells, str_detect(cell_name, regex("dendritic", ignore_case = TRUE)))
Macrophages <- filter(cells, str_detect(cell_name, regex("macrophage", ignore_case = TRUE)))
Mastcells <- filter(cells, str_detect(cell_name, regex("mast cell", ignore_case = TRUE)))
NKcells <- filter(cells, str_detect(cell_name, regex("killer", ignore_case = TRUE)))
Platelets <- filter(cells, str_detect(cell_name, regex("Platelet", ignore_case = TRUE)))
Eosinophil <- filter(cells, str_detect(cell_name, regex("Eosinophil", ignore_case = TRUE)))
Basophil <- filter(cells, str_detect(cell_name, regex("Basophil", ignore_case = TRUE)))
Granulocyte <- filter(cells, str_detect(cell_name, regex("Granulocyte", ignore_case = TRUE)))

#Agrupar todos os resultados em Immune cells
Immune_adap = rbind(Bcells, TCD4, TCD8, Treg, Thelper)
Immune_adap$Type = "Adaptive"

Immune_innate = rbind(Neutrophils, Monocyte, DCells, Macrophages, Mastcells, NKcells, Platelets, Eosinophil, Basophil, Granulocyte)
Immune_innate$Type = "Innate"

#Unir tabelas
Immune_cells = rbind(Immune_adap, Immune_innate) 

#Salvar
write.csv(Immune_cells, file = "CellMarker_ImmuneCells.csv")

esquisser(Immune_cells_markersbycells)
```

Top 20 cells by #markers

```{r}

Immune_cells_markersbycells = Immune_cells %>% 
  group_by(cell_name, Type) %>% 
  summarise(n_markers = n()) %>% 
  arrange(desc(n_markers))
Immune_cells_markersbycells_top = Immune_cells_markersbycells[1:20, ]

ggImmune_cells_cellsbyimmune = ggplot(Immune_cells_markersbycells_top) +
  aes(x = reorder(cell_name, n_markers), y = n_markers, fill = Type) +
  scale_fill_manual(values = c('Innate' = "#989898",
                               'Adaptive' = "#6DF8DF")) +
  geom_col() +
  labs(
    x = "#Markers",
    y = "Cells",
    title = "Top 20 cells by #markers"
  ) +
  coord_flip() +
  theme_minimal() +
  geom_text(aes(label = n_markers, y = n_markers), 
            position = position_dodge(width = 0.9), 
            vjust = -0.2, 
            hjust = -0.2, 
            size = 3)

ggsave(ggImmune_cells_cellsbyimmune, file= "CellMarker_Top10_cellsbyn_markers.png", width = 10, height = 5)

print(ggImmune_cells_cellsbyimmune)

```

Number of Cells by immune system

```{r}
Immune_cells_cellsbyimmune = Immune_cells %>% 
  group_by(Type, cell_name) %>% 
  summarise(n_cells = n()) %>% 
  group_by(Type) %>% 
  summarise(n_cells = n())

ggImmune_cells_cellsbyimmune = ggplot(Immune_cells_cellsbyimmune) +
  aes(x = reorder(Type, n_cells), y = n_cells, fill = Type) +
  geom_col() +
  scale_fill_manual(values = c('Innate' = "#989898",
                               'Adaptive' = "#6DF8DF")) +
  labs(
    x = "#Cells",
    y = "Immune system",
    title = "#Cells by immune system"
  ) +
  coord_flip() +
  theme_minimal() +
  geom_text(aes(label = n_cells, y = n_cells), 
            position = position_dodge(width = 0.9), 
            vjust = -0.2, 
            hjust = -0.2, 
            size = 3)
ggsave(ggImmune_cells_cellsbyimmune, file= "CellMarker_nCellsbyimmunesystem.png", width = 10, height = 2)

print(ggImmune_cells_cellsbyimmune)
```

### 7.1.3. ImmuneGO

```{r}
organism = "org.Hs.eg.db"
install.packages("GO.db")
BiocManager::install(organism, character.only = TRUE)
library(organism, character.only = TRUE)
library(clusterProfiler)
library(GO.db)

#HGNC symbol to Entrez
x <- org.Hs.egSYMBOL
mapped_genes <- mappedkeys(x)
symbols_entrez <- as.data.frame(x[mapped_genes])

## Entrez to GO
x <- org.Hs.egGO
mapped_genes <- mappedkeys(x)
entrez_geneontology <- as.data.frame(x[mapped_genes])

## GO BP ancestors
go_bp_ancestor = GOBPANCESTOR %>% 
  as.data.frame()
colnames(go_bp_ancestor)[1] <- "go_id"
colnames(go_bp_ancestor)[2] <- "go_ancestor"

## GO ID to terms
go_bp = AnnotationDbi::select(GO.db, columns=c("GOID","TERM"), keys= "BP", keytype= "ONTOLOGY") %>% 
  clean_names() %>% 
  select(go_id = goid, term)

## GO child and ancestor
go_bp_ancestor = go_bp_ancestor %>% 
  inner_join(go_bp %>% rename(go_ancestor = go_id), by = "go_ancestor") %>% 
  rename(term_ancestor = term)

#GO ids to terms
go_bp = AnnotationDbi::select(GO.db, columns=c("GOID","TERM"), keys="BP", keytype="ONTOLOGY") %>% 
  clean_names() %>% 
  rename(go_id = goid) %>% 
  select(-ontology) %>% 
  right_join(entrez_geneontology, by = "go_id") %>% 
  right_join(symbols_entrez, by = "gene_id") %>% 
  clean_names() %>% 
  left_join(go_bp_ancestor, by = "go_id") %>% 
  distinct()

#GO immune process

immunego_go.bp = go_bp %>% 
  filter(term_ancestor == "immune system process") %>% 
  mutate(term = toupper(term))

ImmuneGO_Annotated_Genes_26_2_24 = ImmuneGO_Annotated_GO_8_2_24 %>% 
  select(-"...1") %>% 
  mutate(genes = str_replace_all(genes, "\\s+", "")) %>% 
  separate_rows(genes, sep = ",") %>% 
  full_join(immunego_go.bp %>% select(genes = symbol, process = term), by = join_by("process", "genes")) %>% 
  distinct()

ImmuneGO_Annotated_GO_26_2_24 = ImmuneGO_Annotated_Genes_26_2_24 %>% 
  group_by(process) %>%
  summarize(genes = paste0(genes, collapse = ",")) %>%
  inner_join(ImmuneGO_Annotated_Genes_26_2_24 %>% select(-genes) %>% distinct(), by = "process")

write.csv(ImmuneGO_Annotated_GO_26_2_24, file = "ImmuneGO_Annotated_GO_26_2_24.csv", row.names = F)

write.csv(ImmuneGO_Annotated_Genes_26_2_24, file = "ImmuneGO_Annotated_Genes_26_2_24.csv", row.names = F)

```

Group immune system genes by process and cell

```{r}
ImmuneGO_Annotated_unique = ImmuneGO_Annotated_Genes %>% 
  filter(go_term != "Manual")

#Agrupar genes de todos os processos do sistema imune ----

ImmuneGO_Adaptive <- ImmuneGO_Annotated_unique %>%
  filter(immune_system == "Adaptive") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "ADAPTIVE IMMUNE SYSTEM",
  `Gene set, short` = "Adaptive immune system",
  `Immune system` = "Adaptive",
  `Immune sub-system` = "General",
  `Immune tissue` = "General",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Innate <- ImmuneGO_Annotated_unique %>%
  filter(immune_system == "Innate") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "INNATE IMMUNE SYSTEM",
  `Gene set, short` = "Innate immune system",
  `Immune system` = "Innate",
  `Immune sub-system` = "General",
  `Immune tissue` = "General",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Complement <- ImmuneGO_Annotated_unique %>%
  filter(immune_system == "Complement") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "COMPLEMENT",
  `Gene set, short` = "Complement immune system",
  `Immune system` = "Complement",
  `Immune sub-system` = "General",
  `Immune tissue` = "General",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Inflammation <- ImmuneGO_Annotated_unique %>%
  filter(immune_sub_system == "Inflammation") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "INFLAMMATION",
  `Gene set, short` = "Inflammation",
  `Immune system` = "Innate",
  `Immune sub-system` = "Inflammation",
  `Immune tissue` = "General",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Interferon <- ImmuneGO_Annotated_unique %>%
  filter(immune_sub_system %in% c("Antiviral", "Interferon")) %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "ANTIVIRAL & IFN",
  `Gene set, short` = "Antiviral and Interferon",
  `Immune system` = "Innate",
  `Immune sub-system` = "Antiviral and Interferon",
  `Immune tissue` = "General",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_ARPP = ImmuneGO_Annotated_unique %>%
  filter(immune_sub_system %in% c("PRR", "APC")) %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "ARPP",
  `Gene set, short` = "Antigen receptors, processing and presentation",
  `Immune system` = "Innate",
  `Immune sub-system` = "APC",
  `Immune tissue` = "APC",
  `GO.TERM` = "Manual") %>% 
  clean_names()


ImmuneGO_Innate_DC <- ImmuneGO_Annotated_unique %>%
  filter(immune_tissue == "Dendritic cell") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "DENDRITIC CELL",
  `Gene set, short` = "Dendritic cell",
  `Immune system` = "Innate",
  `Immune sub-system` = "Cell",
  `Immune tissue` = "APC",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Innate_Macrophage <- ImmuneGO_Annotated_unique %>%
  filter(immune_tissue == "Macrophage") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "MACROPHAGE",
  `Gene set, short` = "Macrophage",
  `Immune system` = "Innate",
  `Immune sub-system` = "Cell",
  `Immune tissue` = "APC",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Innate_Mastcell <- ImmuneGO_Annotated_unique %>%
  filter(immune_tissue == "Mast cell") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "MAST CELL",
  `Gene set, short` = "Mast cell",
  `Immune system` = "Innate",
  `Immune sub-system` = "Cell",
  `Immune tissue` = "Mast cell",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Innate_Neutrophil <- ImmuneGO_Annotated_unique %>%
  filter(immune_tissue == "Neutrophil") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "NEUTROPHIL",
  `Gene set, short` = "Neutrophil",
  `Immune system` = "Innate",
  `Immune sub-system` = "Cell",
  `Immune tissue` = "Neutrophil",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Innate_Eosinophil <- ImmuneGO_Annotated_unique %>%
  filter(immune_tissue == "Eosinophil") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "EOSINOPHIL",
  `Gene set, short` = "Eosinophil",
  `Immune system` = "Innate",
  `Immune sub-system` = "Cell",
  `Immune tissue` = "Eosinophil",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Innate_NK <- ImmuneGO_Annotated_unique %>%
  filter(immune_tissue == "NK cell") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "NK CELL",
  `Gene set, short` = "Natural Killer Cell",
  `Immune system` = "Innate",
  `Immune sub-system` = "Cell",
  `Immune tissue` = "NK cell",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Innate_Monocyte <- ImmuneGO_Annotated_unique %>%
  filter(immune_tissue == "Monocyte") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "MONOCYTE",
  `Gene set, short` = "Monocyte",
  `Immune system` = "Innate",
  `Immune sub-system` = "Cell",
  `Immune tissue` = "APC",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Adap_Cellular <- ImmuneGO_Annotated_unique %>% 
  filter(immune_sub_system == "Cellular") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "CELLULAR ADAPTIVE IMMUNE SYSTEM",
  `Gene set, short` = "Cellular adaptive immune system",
  `Immune system` = "Adaptive",
  `Immune sub-system` = "Cellular",
  `Immune tissue` = "Cellular",
  `GO.TERM` = "Manual") %>% 
  clean_names()


ImmuneGO_Adap_Tcell <- ImmuneGO_Annotated_unique %>%
  filter(immune_tissue == "T cell") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "T CELL",
  `Gene set, short` = "T cell",
  `Immune system` = "Adaptive",
  `Immune sub-system` = "Cellular",
  `Immune tissue` = "Cellular",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Adap_Thelper <- ImmuneGO_Annotated_unique %>%
  filter(immune_tissue == "T helper") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "T HELPER CELLS",
  `Gene set, short` = "T helper cell",
  `Immune system` = "Adaptive",
  `Immune sub-system` = "Cellular",
  `Immune tissue` = "Cellular",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Adap_Humoral <- ImmuneGO_Annotated_unique %>%
  filter(immune_sub_system == "Humoral") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "HUMORAL ADAPTIVE IMMUNE SYSTEM",
  `Gene set, short` = "Humoral adaptive immune system",
  `Immune system` = "Adaptive",
  `Immune sub-system` = "Humoral",
  `Immune tissue` = "Humoral",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Adap_Bcell <- ImmuneGO_Annotated_unique %>%
  filter(immune_tissue == "B cell") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "B CELL",
  `Gene set, short` = "B cell",
  `Immune system` = "Adaptive",
  `Immune sub-system` = "Humoral",
  `Immune tissue` = "B cell",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Adap_Ig <- ImmuneGO_Annotated_unique %>%
  filter(immune_tissue == "B cell") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "IMMUNOGLOBULIN MEDIATED RESPONSE",
  `Gene set, short` = "Ig-mediated response",
  `Immune system` = "Adaptive",
  `Immune sub-system` = "Humoral",
  `Immune tissue` = "B cell",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_other <- ImmuneGO_Annotated_unique %>%
  filter(immune_system == "General" |
         immune_tissue == "Leukocyte") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "GENERAL",
  `Gene set, short` = "General",
  `Immune system` = "General",
  `Immune sub-system` = "General",
  `Immune tissue` = "General",
  `GO.TERM` = "Manual") %>% 
  clean_names()


ImmuneGO_antimicrobial <- ImmuneGO_Annotated_unique %>%
  filter(immune_tissue == "Antimicrobial") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "ANTIMICROBIAL",
  `Gene set, short` = "Antimicrobial immune response",
  `Immune system` = "General",
  `Immune sub-system` = "General",
  `Immune tissue` = "General",
  `GO.TERM` = "Manual") %>% 
  clean_names()


# Unite sets -----

ImmuneGO_Annotated_GO = bind_rows(ImmuneGO_Adaptive, 
                            ImmuneGO_Innate, 
                            ImmuneGO_Complement, 
                            ImmuneGO_Inflammation,
                            ImmuneGO_Interferon,
                            ImmuneGO_ARPP,
                            ImmuneGO_Innate_Macrophage,
                            ImmuneGO_Innate_Mastcell,
                            ImmuneGO_Innate_Neutrophil,
                            ImmuneGO_Innate_Eosinophil,
                            ImmuneGO_Innate_NK,
                            ImmuneGO_Innate_Monocyte,
                            ImmuneGO_Adap_Cellular,
                            ImmuneGO_Adap_Tcell,
                            ImmuneGO_Adap_Thelper,
                            ImmuneGO_Adap_Humoral,
                            ImmuneGO_Adap_Bcell,
                            ImmuneGO_Adap_Ig,
                            ImmuneGO_other,
                            ImmuneGO_antimicrobial,
                            ImmuneGO_Innate_DC,
                            ImmuneGO_Annotated_unique) %>% 
  select(process:go_term, set_size:genes) %>% 
  distinct()

ImmuneGO_Annotated_Genes = ImmuneGO_Annotated_GO %>% 
   separate_rows(genes, sep = ",")

# Separate TCR and BCR repertoire genes
TCR_BCR_repertoire = ImmuneGO_Annotated_Genes %>% 
  filter(grepl("^TR", genes) & process == "ADAPTIVE IMMUNE SYSTEM" |
           grepl("^IG", genes) & process == "ADAPTIVE IMMUNE SYSTEM" |
           grepl("^TR", genes) & process == "CELLULAR ADAPTIVE IMMUNE SYSTEM" |
         grepl("^IG", genes) & process == "HUMORAL ADAPTIVE IMMUNE SYSTEM") %>% 
  mutate(process = if_else(process == "CELLULAR ADAPTIVE IMMUNE SYSTEM", "TCR REPERTOIRE", 
                           "BCR REPERTOIRE"),
         gene_set_short = if_else(process == "TCR REPERTOIRE", 
                                  "TCR REPERTOIRE", 
                           "BCR REPERTOIRE"),
         process = if_else(grepl("^TR", genes), "TCR REPERTOIRE", "BCR REPERTOIRE"),
         immune_sub_system = if_else(process == "TCR REPERTOIRE", "Cellular", "Humoral"),
         immune_tissue = if_else(process == "TCR REPERTOIRE", "Cellular", "Humoral"))

immunego_manual = ImmuneGO_Annotated_Genes %>%
  filter(go_term == "Manual") %>% 
  anti_join(TCR_BCR_repertoire %>% select(genes) %>% distinct(), by = "genes") %>% 
  bind_rows()

#Verify if all genes are annotated. If there are no left genes, you are good to go
a = ImmuneGO_Annotated_Genes %>% filter(go_term == "Manual") %>% select(genes) %>% distinct()
ImmuneGO_Annotated_Genes %>% select(process, genes, immune_system) %>% anti_join(a, by = "genes")


#Salvar
write.csv(ImmuneGO_Annotated_GO, file = paste0("ImmuneGO_Annotated_GO_", today(), ".csv"), row.names = F)
saveRDS(ImmuneGO_Annotated_GO, file = paste0("ImmuneGO_Annotated_GO_", today(), ".rds"))
saveRDS(ImmuneGO_Annotated_Genes, file = paste0("ImmuneGO_Annotated_Genes_", today(), ".rds"))

#Display
view(ImmuneGO_Annotated_GO)
view(ImmuneGO_Annotated_Genes)

```

Top 10 gene sets
```{r}
#Top 10 gene sets
ImmuneGO_Annotated_unique_top10 = ImmuneGO_Annotated_GO %>% 
  clean_names() %>% 
  arrange(desc(set_size)) %>% 
  slice_head(n = 20) %>% 
  mutate(immune_system = if_else(gene_set_short == "Adaptive Immune response", "Adaptive", immune_system))

#Gráfico de barras
ImmuneGO_top10_barplot = ggplot(ImmuneGO_Annotated_unique_top10) +
 aes(x = reorder(gene_set_short, set_size), 
     weight = set_size, 
     fill = immune_system) +  # Use reorder para reordenar as barras +
  geom_bar()+
  scale_fill_manual(
    values = c(Adaptive = "#6DF8DF",
    Complement = "#e9edc9",
    General = "#bde0fe",
    Innate = "#989898",
    Undefined = "#edede9")) +
 labs(y = "Set size", title = "ImmuneGO", subtitle = "Top 10 GO, by set size") +
 coord_flip() +
 theme_minimal()

#Salvar
ggsave(ImmuneGO_top10_barplot, file="ImmuneGO_top10_barplot.png", width = 10, height = 6)

#Display
head(ImmuneGO_top10_barplot)
```

### 7.1.4. VAX MSigDB


```{r}
#Importar arquivo
VaxSigDB_genesets = VAX_GeneSets_Annotated_26_10_23

# Divida os dados em blocos de informações para cada vacina
vaccines_att <- split(VaxSigDB_genesets$Col2, VaxSigDB_genesets$Col1)

# Combine data
VAX_Genesets <- bind_rows(lapply(vaccines_att, function(x) data.frame(t(x))), .id = "V")

# Name a new index column
colnames(VAX_Genesets) <- paste0("V", seq_len(ncol(VAX_Genesets)))

# Transpose
rownames(VAX_Genesets) <- VAX_Genesets$V1
VAX_Genesets = VAX_Genesets %>% 
  t() %>%
  as.data.frame()

#Order columns
VAX_Genesets = VAX_Genesets %>% 
  select(STANDARD_NAME, everything()) %>% 
  filter(STANDARD_NAME != "STANDARD_NAME") 
rownames(VAX_Genesets) = VAX_Genesets$SYSTEMATIC_NAME
VAX_Genesets = VAX_Genesets %>% select(STANDARD_NAME, 
                                       DESCRIPTION_BRIEF,
                                       DESCRIPTION_FULL,
                                       PMID,
                                       AUTHORS,
                                       SYSTEMATIC_NAME,
                                       GENE_SYMBOLS,
                                       everything())

#Anotar novas colunas
VAX_Genesets <- VAX_Genesets %>%
  mutate(
    SAMPLE_SOURCE = ifelse(
      grepl("pbmc|peripheral blood mononuclear cell|peripheral blood mononuclear cells", DESCRIPTION_FULL, ignore.case = TRUE) |
      grepl("pbmc|peripheral blood mononuclear cell|peripheral blood mononuclear cells", DESCRIPTION_BRIEF, ignore.case = TRUE),
      "PBMC",
      ifelse(
        grepl("whole blood", DESCRIPTION_FULL, ignore.case = TRUE) |
        grepl("whole blood", DESCRIPTION_BRIEF, ignore.case = TRUE) |
        grepl("_BLOOD", STANDARD_NAME, ignore.case = TRUE)  ,
        "WHOLE BLOOD",
        "OTHER")),
    REGULATION = ifelse(
      grepl("up", DESCRIPTION_BRIEF, ignore.case = TRUE),
      "UP",
      ifelse(
        grepl("down", DESCRIPTION_BRIEF, ignore.case = TRUE),
        "DOWN",
        "UNKNOWN")))

#Reordenar colunas
VAX_Genesets = VAX_Genesets %>% select(SAMPLE_SOURCE, REGULATION, everything())

# Salvar
write.csv(VAX_Genesets, file = "VAXSigDB_Annotated.csv") #Continuar a anotação no Google Sheets

head(VAX_Genesets)
```

 Long table with Gene symbols

```{r}
############## Long table with Gene symbols

VAX_Genesets = VAXSigDB_Annotated

VAX_Genes <- VAX_Genesets %>%
  mutate(GENE = GENE_SYMBOLS) %>% 
  separate_rows(GENE, sep = ",") %>% 
  select(GENE, everything()) %>%
  group_by(STANDARD_NAME) %>%
  mutate(SetSize = n()) %>% 
  relocate(SetSize, .after = GENE_SYMBOLS)

VAX_GeneSets_annotated <- VAX_Genes %>%
  select(-GENE) %>% 
  distinct()

#Salvar
write.csv(VAX_Genes, file = "VAX_Genes_Annotated_RAW.csv")
write.csv(VAX_GeneSets_annotated, file = "VAX_Genesets_Annotated_RAW.csv")

#Display
head(VAX_GeneSets_annotated)
```

Filtering

```{r}
unique(VAX_GeneSets_annotated$STUDY_TYPE) 
#"CORRELATION"
#"VACCINE"
#"SUBSET"
#"CHALLENGE"

unique(VAX_GeneSets_annotated$STUDY_SUBTYPE)
# "ANTIBODY"				
# "VAC ONLY"				
# "BOOSTER"				
# "VAC VS CTRL"				
# "SIGNATURE"				
# "ADVERSE EVENT"			
# "COMPARISON"				
# "RESPONDER VS NON RESPONDER"				
# "AGE"				
# "RESPONDER"				
# "ADJUVANT"				
# "NON RESPONDER"				
# "ANTIMICROBIAL ACTIVITY"				
# "CELLS"				
# "CHALLENGE"				
# "TOP DEGS"				
# "PROTECTION"				
# "TRAINING SET"				
# "EXON ANALYSIS"				
# "DOSE"				
# "VAC VS OTHER"


# Subset de vacinas para as seguintes análises comparativas
VAX_GeneSets_Blood_PBMC_VAC = VAX_GeneSets_annotated %>% 
  filter(SAMPLE_SOURCE %in% c("PBMC", "WHOLE BLOOD"), 
         STUDY_TYPE %in% c("VACCINE"))

# Subset de vacinas com resultados de comparações entre vacinas, adjuvantes, idade e sexo
VAX_GeneSets_Blood_PBMC_CORR = VAX_GeneSets_annotated %>% 
  filter(SAMPLE_SOURCE %in% c("PBMC", "WHOLE BLOOD"), 
         STUDY_TYPE %in% c("CORRELATION"))

# Subset com resultados de correlações com resposta inata, celular e humoral
VAX_GeneSets_Blood_PBMC_SUBSETS = VAX_GeneSets_annotated %>% 
  filter(SAMPLE_SOURCE %in% c("PBMC", "WHOLE BLOOD"), 
         STUDY_TYPE %in% c("SUBSET"))


# Subset de vacinas com genes associados a eventos adversos
VAX_GeneSets_Blood_PBMC_CHALLENGE = VAX_GeneSets_annotated %>% 
  filter(SAMPLE_SOURCE %in% c("PBMC", "WHOLE BLOOD"), 
         STUDY_TYPE %in% c("CHALLENGE"))

VAX_GeneSets_Blood_PBMC_VAC.stats = VAX_GeneSets_Blood_PBMC_VAC %>% 
  group_by(VACCINE, PLATFORM, REGULATION, `TARGET_PATHOGEN_DISEASE`, MICROBE_TYPE) %>% 
  summarise(Count = n()) %>% 
  arrange(desc(Count))

```

## 7.2 Immune genes representation in the datasets
Are all immune-related genes represented in all datasets?

```{r}
genes_raw_combined = all_matrices_genes
ImmuneGO_Annotated_Genes

datasets_immune_genes = genes_raw_combined %>% 
  right_join(ImmuneGO_Annotated_Genes %>% 
               filter(go_term == "Manual") %>% 
               select(process, genes)  %>%  
               filter(process %in% c('INNATE IMMUNE SYSTEM',
                                     'ADAPTIVE IMMUNE SYSTEM',
                                     'CELLULAR ADAPTIVE IMMUNE SYSTEM',
                                     'HUMORAL ADAPTIVE IMMUNE SYSTEM')), by = "genes") %>% 
  mutate(process = fct_relevel(process, 'INNATE IMMUNE SYSTEM',
                                     'ADAPTIVE IMMUNE SYSTEM',
                                     'CELLULAR ADAPTIVE IMMUNE SYSTEM',
                                     'HUMORAL ADAPTIVE IMMUNE SYSTEM'),
         gse_id = fct_relevel(gse_id, 'GSE199750', 
                                          'GSE201533',
                                          'GSE201530',
                                          'GSE189039',
                                          "GSE206023")) %>% 
  filter(gse_id != "NA")

```



```{r fig.height=10, fig.width=20}
######## ALL

ImmuneGO_Interesting_Genes_plot.higher <- datasets_immune_genes %>%
  ggplot() +
  aes(x = fct_rev(gse_id), y = genes, fill = gse_id) +
  geom_tile() +
  facet_wrap(vars(process), scales = "free_x",
             ncol = 1) +
  scale_fill_manual(
    values = c("GSE199750" = "#80ffdb",
               "GSE201533" = "#5e60ce", 
               "GSE201530" = "#7400b8",
               "GSE206023" = "#4361ee",
               "GSE189039" = "#48bfe3")) +
  coord_flip() +
  theme_void() +
  labs(
    x = "GSE_ID",
    y = "#Genes",
    fill = "GSE ID",
    title = "") + 
  theme(axis.text.x = element_text(angle = 90, size = 0),
        axis.text.y = element_text(size = 0, hjust = 20),
        plot.title = element_text(size = 20),
        legend.position = "right",
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20),
        strip.text = element_text(size= 20))

#Save
ggsave(ImmuneGO_Interesting_Genes_plot.higher, 
       file = here("Figures", "ImmuneGO_Dataset_Representation_label.png"), 
       width = 20, height = 10)

ImmuneGO_Interesting_Genes_plot.higher
```


```{r fig.height=10, fig.width=20}
############### Grouped
ImmuneGO_genes_indatasets.merge_grouped = genes_raw_combined %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% 
               filter(go_term == "Manual") %>% 
               select(process, genes)  %>%  
               filter(process %in% c('INNATE IMMUNE SYSTEM',
                                     'ADAPTIVE IMMUNE SYSTEM',
                                     'CELLULAR ADAPTIVE IMMUNE SYSTEM',
                                     'HUMORAL ADAPTIVE IMMUNE SYSTEM')), by = "genes") %>% 
  group_by(gse_id, process) %>% 
  summarize(n_in = n()) %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% select(process, set_size)) %>% 
  mutate(n_perc_in = n_in/set_size,
         n_perc_in = n_perc_in *100,
         n_perc_in = round(n_perc_in,0)) %>% 
    distinct() %>% 
    mutate(process = fct_relevel(process, 'INNATE IMMUNE SYSTEM',
                                     'ADAPTIVE IMMUNE SYSTEM',
                                     'CELLULAR ADAPTIVE IMMUNE SYSTEM',
                                     'HUMORAL ADAPTIVE IMMUNE SYSTEM'))

#Plot
ggImmuneGO_genes_indatasets.stats =  ImmuneGO_genes_indatasets.merge_grouped %>% 
  mutate(gse_id = fct_relevel(gse_id,  'GSE199750', 
                                          'GSE201533',
                                          'GSE201530',
                                          'GSE189039',
                                          'GSE206023') %>% 
           fct_rev()) %>% 
  ggplot() +
  aes(x = gse_id, y = n_perc_in, fill = gse_id) +
  geom_col() +
  scale_fill_manual(
    values = c("GSE199750" = "#80ffdb",
               "GSE201533" = "#5e60ce", 
               "GSE201530" = "#7400b8",
               "GSE206023" = "#4361ee",
               "GSE189039" = "#48bfe3")) +
  coord_flip() +
  theme_void() +
  geom_text(aes(label = n_perc_in, y = n_perc_in), 
            position = position_dodge(width = 0.9), 
            vjust = 0.5, 
            hjust = -0.05, 
            size = 6) +
  labs(
    x = "",
    y = "#Genes",
    title = ""
  ) +
  facet_wrap(vars(process), ncol = 1) +
    theme(axis.text.x = element_text(angle = 90, size = 0, hjust = 1),
        axis.text.y = element_text(size = 20),
        plot.title = element_text(size = 20),
        legend.position = "none",
        strip.text = element_text(size= 20)) +
  ylim(0, 110)

patch_indatasets = ggImmuneGO_genes_indatasets.stats + ImmuneGO_Interesting_Genes_plot.higher +
  plot_layout(widths = c(1, 2)) +
  plot_annotation(title = "Number of genes represented in ImmuneGO, by study", 
                  theme = theme(plot.title = element_text(size = 30)))

ggsave(patch_indatasets, file = here("Figures", "ImmuneGO_Genesrepresented_bystudy.png"), width = 20, height = 10)
patch_indatasets

```

Line plots

```{r}

Immune_GO_GSEA

################## Innate
Immune_GO_innate = Immune_GO_GSEA %>% filter(`Immune system` == "Innate")
write.csv(Immune_GO_innate, file = "Immune_GO_innate_l2fc.csv")

Immune_GO_innate_SUM <- Immune_GO_innate %>% 
  rename(Condition = study) %>% 
  group_by(Condition, Process) %>%
  mutate(Soma = n()) %>% select(Vaccine, Condition, Process, `Immune group`, `Immune response gene set, specific`, `Immune system`, Soma) %>% filter(Vaccine != "NA")
write.csv(Immune_GO_innate_SUM, file="Immune_GO_innate_SUM.csv")


################## Adaptive
#Humoral
Immune_GO_humoral = Immune_allgenes %>% filter(`Immune system` == "Humoral")
write.csv(Immune_GO_humoral, file = "Immune_GO_humoral_l2fc.csv")

Immune_GO_humoral_SUM <- Immune_GO_humoral %>% 
  rename(Condition = study) %>% 
  group_by(Condition, Process) %>%
  mutate(Soma = n()) %>% select(Vaccine, Condition, Process, `Immune group`, `Immune response gene set, specific`, `Immune system`, Soma) %>% filter(Vaccine != "NA")
write.csv(Immune_GO_humoral_SUM, file="Immune_GO_humoral_SUM.csv")

#Cellular
Immune_GO_cellular = Immune_allgenes %>% filter(`Immune system` == "Cellular")
write.csv(Immune_GO_cellular, file = "Immune_GO_cellular_l2fc.csv")

Immune_GO_cellular_SUM <- Immune_GO_cellular %>% 
  rename(Condition = study) %>% 
  group_by(Condition, Process) %>%
  mutate(Soma = n()) %>% select(Vaccine, Condition, Process, `Immune group`, `Immune response gene set, specific`, `Immune system`, Soma) %>% filter(Vaccine != "NA")
write.csv(Immune_GO_cellular_SUM, file="Immune_GO_cellular_SUM.csv")

################## General
Immune_GO_general = Immune_allgenes %>% filter(`Immune system` == "General")
write.csv(Immune_GO_general, file = "Immune_GO_general_l2fc.csv")

Immune_GO_general_SUM <- Immune_GO_general %>% 
  rename(Condition = study) %>% 
  group_by(Condition, Process) %>%
  mutate(Soma = n()) %>% select(Vaccine, Condition, Process, `Immune group`, `Immune response gene set, specific`, `Immune system`, Soma) %>% filter(Vaccine != "NA")
write.csv(Immune_GO_general_SUM, file = "Immune_GO_general_SUM.csv")

################## All immune processes and genes
Immune_allgenes_vaccines = Immune_allgenes_l2fc %>% rename(Condition = study, Genes = genes) %>% filter(Vaccine != "NA")
ann_vaccines_pca_matrix = merge(ann_vaccines_pca, matrix_data_pca, by.x = "Condition", all.x = F, all.y = F)
ann_vaccines_pca_matrix_long = ann_vaccines_pca_matrix %>% gather(Genes, L2FC, -Condition, -Vaccine, -Day, -Dose)

Immune_allgenes_vaccines_SUM <- Immune_allgenes_vaccines %>%
  group_by(Condition, Process) %>% #Somar e agrupar
  summarize(Soma = n())

Immune_allgenes_vaccines_SUM = merge(ann_vaccines_pca, Immune_allgenes_vaccines_SUM, by.x = "Condition", all.x = F, all.y = F) # Anotar vacinas
write.csv(Immune_allgenes_vaccines_SUM, file="Immune_allgenes_vaccines_SUM.csv") #Salvar

```


## 7.3. COVID-19 and other vaccines

```{r}
# Input files ------
immunego = ImmuneGO_Annotated_Genes # ImmuneGO Annotation
degs_updown_p_05_vac_infected = read_csv(here("DGE analysis", "all_degs_p_05_vac_infected_19_12_23.csv")) # DEGs
ann_vaccines_covid_other = read_csv(here("Annotations and metadata", "ann_vaccines_vaxsig_covid.csv")) #Conditions annotation
VAX_Genes_Annotated_RAW_2 = read_csv(here("VaxGO gene sets", "VaxSigDB_Gene_sets_Annotated_RAW.csv")) %>% 
  separate_rows(GENE_SYMBOLS)
ann_vaccines = read_csv(here("Annotations and metadata", "ann_vaccines_conditions.csv"))


# Processing
VAX_Genes_Annotated_RAW_3 = VAX_Genes_Annotated_RAW_2 %>% 
  clean_names() %>% 
  filter(study_subtype == "VAC ONLY",
         sample_source == "PBMC") %>% 
  mutate(condition = paste0(vaccine, " (", date_time, ")")) %>% 
  select(condition, everything())

degs_all_updown_vax = VAX_Genes_Annotated_RAW_3 %>%
  clean_names() %>% 
  mutate(condition = paste0(vaccine, " (", date_time, ")")) %>% 
  select(condition, genes = gene_symbols) %>% 
  distinct()

degs_all_updown_covid= degs_updown_p_05_vac_infected %>% 
  as.data.frame() %>% 
  select(condition:direction) %>% 
  filter(direction %in% c("UP", "DOWN")) %>% 
  inner_join(ann_vaccines, by = "condition") %>%
  distinct() %>% 
  select(condition, genes)

degs_all_updown_covid_other = bind_rows(degs_all_updown_vax, degs_all_updown_covid) %>% 
  distinct()


degs_all_updown_covid_other_immune = degs_all_updown_covid_other %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% select(genes) %>% distinct(), by = "genes") %>% 
  distinct()

degs_all_updown_covid_other_nonimmune = degs_all_updown_covid_other %>% 
  anti_join(ImmuneGO_Annotated_Genes %>% select(genes) %>% distinct(), by = "genes") %>% 
  distinct()

write.csv(degs_all_updown_covid_other, file = here("VaxGO gene sets", "degs_all_updown_covid_vax_other.csv"))
write.csv(degs_all_updown_covid_other_immune, file = here("VaxGO gene sets","degs_all_updown_covid_vax_other_immune.csv"))
write.csv(degs_all_updown_covid_other_nonimmune, file = here("VaxGO gene sets","degs_all_updown_covid_vax_other_nonimmune.csv"))


degs_covid = degs_updown_p_05_vac_infected %>% 
  select(condition, genes, direction) %>% 
  filter(direction != "NEUTRAL") %>% 
  mutate(regulation_numeric = if_else(direction == "UP", "1", "-1"),
         regulation_numeric = as.numeric(regulation_numeric))


degs_vax = VAX_Genes_Annotated_RAW_2 %>% 
  filter(STUDY_SUBTYPE == "VAC ONLY") %>% 
  mutate(condition_vaccine = paste0(VACCINE, " (", `DATE-TIME`, ")")) %>% 
  select(condition_vaccine, SYSTEMATIC_NAME, VACCINE, everything()) %>% 
  separate_rows(GENE_SYMBOLS, sep = ",")
degs_vax %>% saveRDS(file = here("VaxGO gene sets","VAXSigDB_Genes.rds"))


degs_vaxsig = degs_vax %>% 
  filter(STUDY_SUBTYPE == "VAC ONLY") %>% 
  select(condition = condition_vaccine, genes = GENE_SYMBOLS, regulation = REGULATION) %>% 
  mutate(regulation_numeric = if_else(regulation == "UP", 1, -1))


degs_covid_vax = degs_covid %>% 
  bind_rows(degs_vaxsig) %>% 
  select(-regulation) %>% 
  inner_join(ImmuneGO_Annotated_Genes %>%
               filter(process != c("TCR REPERTOIRE", "BCR REPERTOIRE")) %>% 
               select(genes) %>%
               distinct(), 
             by = "genes")

degs_covid_vax %>% 
  saveRDS(file = here("VaxGO gene sets", "degs_covid_vaxsig_up_down_immune.rds"))

```

### 7.3.1. Gene overlap analysis

```{r}
#Input
data = degs_all_updown_covid_other_immune %>% 
  rename(process = condition) %>% 
  select(process, genes)

filename = "degs_all_updown_covid_other_immune"
  
```

Function for overlapping
```{r}

# Function for overlapping -------
overlap_genes <- function(cond1, cond2, data) {
  genes_cond1 <- data$genes[data$process == cond1]
  genes_cond2 <- data$genes[data$process == cond2]
  
  genes_shared <- intersect(genes_cond1, genes_cond2)
  
  genes_notshared_cond1 <- setdiff(genes_cond1, genes_cond2)
  genes_notshared_cond2 <- setdiff(genes_cond2, genes_cond1)
  
  total_genes_cond1 <- length(genes_cond1)
  total_genes_cond2 <- length(genes_cond2)
  
  percentage_shared_cond1 <- length(genes_shared) / total_genes_cond1 * 100
  percentage_shared_cond2 <- length(genes_shared) / total_genes_cond2 * 100
  
  shared_genes <- data.frame(
    Cond1 = cond1,
    Cond2 = cond2,
    Shared = length(genes_shared),
    NotShared_cond1 = length(genes_notshared_cond1),
    NotShared_cond2 = length(genes_notshared_cond2),
    Total_Genes_Cond1 = total_genes_cond1,
    Total_Genes_Cond2 = total_genes_cond2,
    Genes_Names = paste(genes_shared, collapse = ", "),
    Percentage_Shared_Cond1 = percentage_shared_cond1,
    Percentage_Shared_Cond2 = percentage_shared_cond2
  )
  
  return(shared_genes)
}
conflicted::conflicts_prefer(base::intersect)
conflicted::conflicts_prefer(base::setdiff)
conflicted::conflicts_prefer(janitor::fisher.test)
```

Perform calculations
```{r}
# Perform calculations
unique_cond <- unique(data$process) # List sets
shared_genes_df <- data.frame() # Store data

for (i in 1:(length(unique_cond) - 1)) {
  for (j in (i + 1):length(unique_cond)) {
    resultado_temp <- overlap_genes(unique_cond[i], unique_cond[j], data)
    shared_genes_df <- bind_rows(shared_genes_df, resultado_temp)
  }
}

# Fisher's exact test
fisher_exact_test <- function(shared, notshared1, notshared2) {
  cont_table <- matrix(c(shared, notshared1, notshared2, 0), nrow = 2)
  results_fisher <- fisher.test(cont_table)
  return(results_fisher$p.value)
}
shared_genes_df = shared_genes_df %>%
  mutate(pvalue = pmap_dbl(list(Shared, NotShared_cond1, NotShared_cond2), fisher_exact_test)) %>% 
  mutate("-log(p)" = -log10(pvalue))


#Mirror table
shared_genes_df2 = shared_genes_df %>% 
  rename(Cond1_temp = Cond1, Cond2_temp = Cond2) %>%
  rename(Cond1 = Cond2_temp, Cond2 = Cond1_temp)

shared_genes_df_mirror = shared_genes_df %>% 
  bind_rows(shared_genes_df2) %>% 
  mutate(Percentage_Shared_Cond1 = round(Percentage_Shared_Cond1, 2),
         Percentage_Shared_Cond2 = round(Percentage_Shared_Cond2, 2))
  
#Jaccard distance
jaccard.matrix <- data %>%
  mutate(present = 1) %>% 
  distinct() %>% 
  pivot_wider(names_from = genes, values_from = present, values_fill = 0) %>%
  column_to_rownames(var = "process") %>%
  vegdist(binary = TRUE, method = "jaccard", diag = TRUE, upper = TRUE) %>%
  as.matrix() %>%
  {1 - .}

shared_genes_df_mirror = jaccard.matrix %>% 
  as.data.frame() %>% 
  rownames_to_column("Cond1") %>% 
  pivot_longer(cols = -"Cond1",
               names_to = "Cond2",
               values_to = "jaccard_distance") %>% 
  inner_join(shared_genes_df_mirror, by = join_by(Cond1, Cond2)) %>% 
  mutate(jaccard_distance = round(jaccard_distance, 3))

#Save
write_csv(shared_genes_df_mirror, 
          file = here("VaxGO gene sets", paste0(filename, "_sharedgenes_Fisher_Jaccard.csv")))
```


### 7.3.2. Other comparisons

```{r}
############# VACCINE
#Use "vax_degs_up_VAXSigDB_sharedgenes_ann.csv" for comparing UP degs with UP degs from other conditions

#VAC ONLY
shared_genes_ann_vac = shared_genes_df_mirror_ann %>%
  select(vac_condition, vaccine_condition, vac_ref, Cond2:sample_source, pmid, gene_symbols:participants) %>% 
  filter(study_type == "VACCINE", 
         sample_source == "PBMC",
         !(vaccine_condition %in% c("BBIBP", "ZF2001"))) 

vac_only = shared_genes_ann_vac %>%
  filter(study_subtype == "VAC ONLY")

```

### 7.3.3. Heatmap

```{r}
# INPUT ------

degs_all_updown_covid_other_immune_shared = read_csv(here("VaxGO gene sets", "degs_all_updown_covid_other_immune_shared.csv"))

table = degs_all_updown_covid_other_immune_shared
filename = "ImmuneGO_Genes" 

data = table %>% 
  filter(qvalue <0.25) %>% 
  inner_join(ann_vaccines_covid_other %>% 
               select(Cond1 = condition, everything()), by = "Cond1") %>% 
  inner_join(ann_vaccines %>% 
               select(Cond2 = condition, everything()), by = "Cond2") %>% 
  clean_names() %>% 
  rename(vac_ref = cond1, vac_condition = cond2)

# Matrix ------
matrix = data %>%
  filter(qvalue <= 0.10) %>% 
  select(vac_condition, vac_ref, shared) %>% 
  pivot_wider(names_from = vac_condition, values_from = shared, values_fn = mean) %>% 
  replace(is.na(.), 0) %>%
  column_to_rownames(var="vac_ref") %>%
  as.matrix() %>%
  round(0)

# Annotations -------
ann_vaccines_covid = ann_vaccines_covid_other %>% 
  filter(covid_other == "COVID")
ann_vaccines_other = ann_vaccines_covid_other %>% 
  filter(covid_other == "OTHER")

# Columns
ann_cols_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "process") %>% 
  rename(vac_condition = '.') %>% 
  merge(ann_vaccines_covid, by.x = "vac_condition", by.y = "condition", all.y = F) %>% 
  select(vac_condition, type, vaccine, week) %>% #ordenar colunas para anotação
  distinct() %>% 
  column_to_rownames(var = "vac_condition") %>% 
  mutate_all(as.factor)

# Rows
ann_rows_heatmap = matrix %>%  
  as.data.frame() %>% 
  rownames_to_column("condition") %>% 
  distinct() %>% 
  inner_join(ann_vaccines_other, by = "condition") %>% 
  mutate_all(as.factor) %>%
  arrange(condition) %>%
  distinct() %>% 
  column_to_rownames(var= "condition") %>% 
  select(vaccine:infection) %>% 
  select(microbe_type, type, week)

# Arrange cols and rows in matrix
matrix_data = matrix %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>%
  rownames_to_column("condition") %>% 
  inner_join(ann_rows_heatmap %>% 
               rownames_to_column("condition") %>% 
               select(condition),
             by = "condition") %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  mutate_if(is.character, as.numeric) %>%
  replace(is.na(.), 0) %>% 
  as.matrix()

#Check dimensions
dim(matrix_data)
dim(ann_rows_heatmap)
dim(ann_cols_heatmap)

```

Plot
```{r}

#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "left")

row_ha = rowAnnotation(df =  ann_rows_heatmap, 
                       col = ann_vaxsig_colors)

# Values colors
col_fun <- colorRamp2(c(0, max(matrix_data)), c("white", "#ed6a5a"))


mat = matrix_data
width_image = 40
height_image = 30
width = unit(20, "cm")
height = unit(15, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)
file = paste0("VAXSig_", filename_2)

fileimageheatmap_grouped = paste0(filename, sep ="_", "Complexheatmap_ALL_CLUSTERED.png")

png(file = here("Figures", fileimageheatmap_grouped), 
    width = width_image, 
    height = height_image,
    units="cm", res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "left",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(title = "Shared", direction = "vertical"),
                        col = col_fun, #color
                        cell_fun = function(j, i, x, y, width, height, fill) {
                                            if(mat[i, j] > 0)
                                            grid.text(sprintf("%.f", mat[i, j]), 
                                                      x, y, 
                                                      gp = gpar(fontsize = 8))},
                        row_title = "",
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 90,
                        column_names_gp = column_names_gp,
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp, #Grande = 6, Pequeno 15
                        row_dend_width = unit(5, "cm"), #Altura do dendrograma
                        column_split = NULL, #Split column clusters 
                        row_split = NULL, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(8, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = width, # 20 para pequeno e grande
                        height = height # 20 para pequeno, 60 para grande
)

draw(heatmap_plot,
     merge_legend = TRUE,
     annotation_legend_side = "right", 
     heatmap_legend_side = "right")
dev.off()

```

## 7.4. ORA COVID vs. VAXGO com ImmuneGO

```{r}
#Input
degs_all_updown_covid = degs_updown_p_05_vac_infected %>% 
   as.data.frame() %>% 
   select(condition:direction) %>% 
   filter(direction %in% c("UP", "DOWN")) %>% 
  inner_join(ann_vaccines, by = "condition") %>% 
   distinct() %>% 
  select(condition, genes)

VAX_Genes_Annotated_RAW = VAX_Genes_Annotated_RAW_2 %>% 
  clean_names() %>% 
  mutate(condition = paste0(vaccine, " (", date_time, ")"))

ann_vaccines_covid_other 

degs_all_updown_vax_immunego = VAX_Genes_Annotated_RAW %>%
  clean_names() %>% 
  mutate(condition = paste0(vaccine, " (", date_time, ")")) %>% 
  select(condition, genes = gene_symbols) %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% 
               select(genes), by = "genes") %>% 
  distinct()

degs_all_updown_covid_other = bind_rows(degs_all_updown_vax_immunego, degs_all_updown_covid) %>% 
  distinct()

Immune_GO_T2G = ImmuneGO_Annotated_Genes %>% 
  filter(go_term == "Manual",
         !process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE", "ADAPTIVE IMMUNE SYSTEM", "INNATE IMMUNE SYSTEM")) %>% 
  select(process, genes)
```

```{r}
# GSEA function
perform_ORA <- function(df, Immune_GO_T2G) {
  resultados <- list()
  
  # Obter condições únicas na coluna "condition"
  condicoes <- df$condition %>% 
    unique() %>% 
    as.character()
  
  for (condicao in condicoes) {
    # Selecionar DEGs para a condição atual
    degs_condicao <- df %>% 
      filter(condition == condicao) %>%
      select(genes) %>%
      distinct()

    # Preparar gene list
    gene_list_ora <- degs_condicao$genes

    ############ IMMUNE GO
    immune_GO_ORA <- tryCatch({
      enricher(gene_list_ora, 
               TERM2GENE = Immune_GO_T2G, 
               minGSSize = 1,
               maxGSSize = 1000,
               pvalueCutoff = 0.25,
               pAdjustMethod = "BH") %>% 
        as.data.frame() %>% 
        arrange(qvalue) %>% 
        mutate(condition = condicao,
               ora_enrichment = "ImmuneGO")
    }, error = function(e) {
      return(NULL)  # Retorna NULL caso ocorra o erro
    })

    if (!is.null(immune_GO_ORA)) {
      resultados[[paste(condicao, "ImmuneGO", sep = "_")]] <- immune_GO_ORA
    }
  }

  # Combinar todos os resultados em um único dataframe
  resultado_final <- bind_rows(resultados)

  return(resultado_final)
}

df_resultados <- perform_ORA(degs_all_updown_covid_other, Immune_GO_T2G)
print(df_resultados)

#Anotar
immune_GO_ORA_covid_other = df_resultados %>% 
  clean_names() %>% 
  select(process = id, gene_ratio:ora_enrichment) %>% 
  inner_join(ann_vaccines_covid_other, by = "condition") %>% 
  distinct() %>% 
  mutate(log_q = -log10(qvalue))

write.csv(immune_GO_ORA_covid_other, file = here("VaxGO gene sets", "COVID_VAX_immune_GO_ORA.csv"))

```

#### 7.4.1. Heatmap

```{r}
####### INPUT
data_2 = immune_GO_ORA_covid_other
  
filename_2 = "immune_GO_ORA_covid_other"

######## Matrix
matrix = data_2 %>% 
  filter(qvalue <= 0.25) %>% 
  select(condition, process, log_q) %>% #Percentage_Shared_Cond1
  pivot_wider(names_from = "condition", 
              values_from = "log_q",  #Percentage_Shared_Cond1
              values_fn = mean) %>% 
  replace(is.na(.), 0) %>% 
  column_to_rownames(var="process") %>% 
  as.matrix() %>% 
  round(2)

######## Annotations
ann_cols = matrix %>% 
  as.data.frame() %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column("condition") %>% 
  select(condition) %>% 
  inner_join(ann_vaccines_covid_other, by = "condition") %>% 
  select(condition, covid_other, microbe_type, disease_vac, type, week) %>% 
  distinct() %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") 

matrix_data = matrix %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame()%>%  
  mutate_if(is.character, as.numeric) %>%
  replace(is.na(.), 0) %>% 
  as.matrix() 

#Check dimensions
dim(matrix_data)
dim(ann_cols)
```

```{r}
################# Plotar

#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "right")


# Values colors
col_fun <- colorRamp2(c(0, 2), c("white", "#ED6A5A"))


# Parameters
file = filename_2
mat = matrix_data
width_image = 40
height_image = 20
width = unit(25, "cm")
height = unit(7, "cm")
column_names_gp = gpar(fontsize = 9)
row_names_gp = gpar(fontsize = 9)
rect_gp = gpar(col = "gray90", lwd = 0.5)

###### CLUSTERIZED ALL VS ALL

fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = here("Figures", fileimageheatmap_grouped), width = width_image, height = height_image, units="cm", res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        show_row_names = TRUE,
                        row_names_side = "left",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "vertical",
                                                    title = "-log(FDR)"),
                        col = col_fun, #color
                        cell_fun = function(j, i, x, y, w, h, fill) {
                              if (mat[i, j] >= 2) {
                                grid.text("***", x, y, gp = gpar(fontsize = 8))
                              } else if (mat[i, j] > 1.5) {
                                grid.text("**", x, y, gp = gpar(fontsize = 9))
                              } else if (mat[i, j] >= 1) {
                                grid.text("*", x, y, gp = gpar(fontsize = 8))
                              } else {
                                grid.text("", x, y)
                              }
                            },
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp, #Grande = 6, Pequeno 15
                        row_dend_width = unit(5, "cm"), #Altura do dendrograma
                        row_split = NULL, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(8, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        width = width, # 20 para pequeno e grande
                        height = height # 20 para pequeno, 60 para grande
)

draw(heatmap_plot, 
     annotation_legend_side = "left", 
     heatmap_legend_side = "left",
          merge_legend = TRUE)
dev.off()


```

## 7.5. COVID-19 genes vs. VaxGO genes with ImmuneGO genes

```{r}
# VAX Genes  ------
VAX_Genes_Annotated_RAW = VAX_Genes_Annotated_RAW %>% 
  clean_names() %>% 
  mutate(condition = paste0(vaccine, " (", date_time, ")"))

#ImmuneGO
degs_all_updown_vax_immunego = VAX_Genes_Annotated_RAW %>%
  clean_names() %>% 
  mutate(condition = paste0(vaccine, " (", date_time, ")")) %>% 
  select(condition, genes = gene_symbols, regulation) %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% 
               select(genes), by = "genes") %>% 
  distinct()

# Covid-19 conditions ----
degs_all_updown = degs_updown_p_05_vac_infected

#Immune
degs_all_updown_covid_immune = degs_all_updown %>% 
  as.data.frame() %>% 
  select(condition:padj) %>% 
  mutate(direction = case_when(log2fold_change >= 1 ~ "UP",
                               log2fold_change <= -1 ~ "DOWN",
                               TRUE ~ "NEUTRAL")) %>% 
  inner_join(ann_vaccines, by = "condition") %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% select(genes) %>% distinct(), by = "genes") %>% 
  distinct() %>% 
  filter(vaccine != "I", 
         gse_id != "GSE189039") %>% 
  select(condition, genes, regulation = direction)  %>% 
  distinct()


# Bind Immune ------
degs_all_updown_covid_other = bind_rows(degs_all_updown_vax_immunego, degs_all_updown_covid_immune) %>% 
  distinct()


covid_other_immunego_genes = degs_all_updown_covid_other %>% 
  distinct() %>% 
  filter(regulation %in% c("UP", "DOWN")) %>% 
  mutate(regulation_numeric = case_when(
    regulation %in% c("UP") ~ 1,
    regulation %in% c("DOWN") ~ -1,
    TRUE ~ as.numeric(regulation)
  )) %>% 
  distinct()

saveRDS(covid_other_immunego_genes, file = "covid_other_immunego_genes.rds")

```

```{r}
###### Gene sets Immune GO ------

Immune_GO_genes_All = covid_other_immunego_genes 

# Immune_GO_genes_Innate = Immune_GO_genes_All %>%
#    filter(process == "INNATE IMMUNE SYSTEM")
# Immune_GO_genes_Adaptive = Immune_GO_genes_All %>%
#    filter(process == "ADAPTIVE IMMUNE SYSTEM")
# Immune_GO_genes_Complement = Immune_GO_genes_All %>%
#    filter(process == "COMPLEMENT IMMUNE SYSTEM")
# 
# # Sistema inato
# Immune_GO_genes_Inflammation = Immune_GO_genes_All %>%
#   filter(process == "INFLAMMATION")
# Immune_GO_genes_ARPP = Immune_GO_genes_All %>%
#   filter(process == "ARPP")
# Immune_GO_genes_IFN = Immune_GO_genes_All %>%
#   filter(process == "ANTIVIRAL AND INTERFERON")
# Immune_GO_genes_Neutrophil = Immune_GO_genes_All %>%
#   filter(process == "NEUTROPHIL")
# Immune_GO_genes_Eosinophil = Immune_GO_genes_All %>%
#   filter(process == "EOSINOPHIL")
# Immune_GO_genes_Complement = Immune_GO_genes_All %>%
#   filter(process == "COMPLEMENT IMMUNE SYSTEM")
# Immune_GO_genes_Monocytes = Immune_GO_genes_All %>%
#   filter(process == "MONOCYTES")
# Immune_GO_genes_DC = Immune_GO_genes_All %>%
#   filter(process == "DENDRITIC CELLS")
# Immune_GO_genes_Macro = Immune_GO_genes_All %>%
#   filter(process == "MACROPHAGES")
# Immune_GO_genes_NK = Immune_GO_genes_All %>%
#   filter(process == "NK CELL")
# 
# # Sistema adaptativo
# Immune_GO_genes_Cellular = Immune_GO_genes_All %>%
#   filter(process == "CELLULAR ADAPTIVE IMMUNE SYSTEM")
# Immune_GO_genes_Humoral = Immune_GO_genes_All %>%
#   filter(process == "HUMORAL ADAPTIVE IMMUNE SYSTEM")
# Immune_GO_genes_Tcells = Immune_GO_genes_All %>%
#   filter(process == "T CELLS")
# Immune_GO_genes_Bcells = Immune_GO_genes_All %>%
#   filter(process == "B CELLS")
# Immune_GO_genes_Ig = Immune_GO_genes_All %>%
#   filter(process == "IMMUNOGLOBULIN MEDIATED IMMUNE RESPONSE")

```

#### 7.5.1. Heatmap

```{r}
####### INPUT
data_2 = Immune_GO_genes_All
filename_2 = paste0("Immune_GO_genes_All", "_VAX_COVID")

######## Matrix
matrix = data_2 %>% 
  select(genes, condition, regulation_numeric) %>%
  pivot_wider(names_from = "condition", 
              values_from = "regulation_numeric", 
              values_fn = mean) %>% 
  replace(is.na(.), 0) %>%
  arrange(genes) %>% 
  column_to_rownames(var="genes") %>% 
  as.matrix()

######## Annotations
ann_vaccines_covid_other_2 = data_2 %>% 
  inner_join(ann_vaccines_covid_other, by = "condition") %>% 
  select(condition, covid_other, microbe_type, disease_vac, type, week) %>% 
  distinct()

#Columns
ann_cols_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  inner_join(ann_vaccines_covid_other_2, by = "condition") %>% 
  distinct() %>% 
  arrange(condition) %>% 
  column_to_rownames("condition")

matrix_data = matrix %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  inner_join(ann_cols_heatmap %>% rownames_to_column("condition"), by = "condition") %>% 
  select(!c(covid_other:week)) %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  filter(rowSums(. != 0) > 1) %>% 
  mutate_if(is.character, as.numeric) %>%
  as.matrix() 

#Rows Immune ----
ann_rows_immune = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  left_join(ImmuneGO_Annotated_Genes %>%
              filter(go_term == "Manual",
                     !process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE")), by = "genes") %>%
  select(genes, process) %>%
  distinct() %>%
  group_by(genes) %>%
  arrange(genes, factor(process, levels = c("INNATE IMMUNE SYSTEM", "ADAPTIVE IMMUNE SYSTEM")), .by_group = TRUE) %>%
  mutate(i_process = row_number()) %>%
  pivot_wider(., names_from = "i_process", values_from = "process") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("index") %>%
  mutate(index = as.numeric(index)) %>%
  arrange(desc(index)) %>%
  column_to_rownames("index") %>%
  t() %>%
  as.data.frame() %>%
  replace(is.na(.), ".")


#Check dimensions
dim(matrix_data)
dim(ann_cols_heatmap)
dim(ann_rows_immune)

```

Sizes: 1. Cellular adaptive immune system: width = unit(25, "cm"),
height = unit(60, "cm") #254 genes 2. Humoral adaptive immune system:
width = unit(25, "cm"), height = unit(30, "cm") #51 genes 3. T cells:
width = unit(25, "cm"), height = unit(60, "cm") #221 genes 4. B cells:
width = unit(25, "cm"), height = unit(50, "cm") #146 genes 5. Ig
mediated: width = unit(25, "cm"), height = unit(10, "cm") #146 genes 6.
Inflammation: width = unit(25, "cm"), height = unit(10, "cm") 7. ARPP:
width = unit(25, "cm"), height = unit(30, "cm") 60 genes 8. IFN: width =
unit(25, "cm"), height = unit(30, "cm") 93 genes 9. DC: width = unit(25,
"cm"), height = unit(20, "cm") #29 genes 10. Macrophages: width =
unit(25, "cm"), height = unit(25, "cm") \# 52 genes 11. Neutrophils:
width = unit(25, "cm"), height = unit(40, "cm") \# 70 genes 12.
Eosinophil: width = unit(25, "cm"), height = unit(10, "cm") \# 42 genes
13. Complement: width = unit(25, "cm"), height = unit(10, "cm") \# 40
genes 13. Monocytes: width = unit(25, "cm"), height = unit(15, "cm") \#
48 genes 15. All immune genes: width_image = 60, height_image = 70,
width = unit(30, "cm"), height = unit(60, "cm"), row_split = 7,
column_split = 2

More refs:
<https://debrowser.readthedocs.io/en/master/heatmap/heatmap.html>

#### 7.5.2. All genes

```{r}
################# Immune 
#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "left")

row_ha = HeatmapAnnotation(df = ann_rows_immune,
                       col = col_process_immune,
                       which= "row",
                       show_annotation_name = F,
                       show_legend = F,
                       simple_anno_size = unit(2, "mm")
                       )

# Values colors
col_fun <- colorRamp2(c(-1, 0, 1), c("#9bc1bc", "white", "#ed6a5a"))

file = filename_2
mat = matrix_data
width_image = 60
height_image = 50
width = unit(30, "cm")
height = unit(40, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 0)
rect_gp = gpar(col = "gray80", lwd = 0)
row_split = 2
column_split = 2


fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = here("Figures", fileimageheatmap_grouped), 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "vertical"),
                        col = col_fun, #color
                        name = "L2FC",
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "white",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(5, "cm"),
                        row_split = row_split,
                        column_split = column_split,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(8, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "right",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        clustering_distance_columns = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height,
                        use_raster = F)

heatmap_plot = draw(heatmap_plot)

dev.off()

```
#### Interactive heatmap
```{r}
library(InteractiveComplexHeatmap)

####### Input
heatmap_data = Immune_GO_genes_All
file = "Immune_GO_genes_All"

###### Process data

heatmap_data_l2fc= heatmap_data %>% 
  filter(condition != "NA", 
         process != "NA") %>% 
  select(genes, condition, log2fold_change)

# Convert to wide table
matrix_data <- dcast(heatmap_data_l2fc, 
                         genes ~ condition, 
                         value.var = "log2fold_change", 
                         fun.aggregate = mean) %>% 
  column_to_rownames('genes') %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0)

matrix_data_ready =  matrix_data %>% 
  round(2)

# Check if all vaccines are in the matrix and join annotations
ann_vaccines_complex = heatmap_data %>% 
  select(condition) %>% 
  distinct() %>% 
  inner_join(ann_vaccines %>% select(condition, disease_vac, type, week), by = "condition")

# Join annotations
ann_vaccines_heatmap = matrix_data %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  merge(ann_vaccines_complex, by = "condition", all.x = TRUE) %>% 
  arrange(condition) %>% 
  column_to_rownames(var= "condition") 


#Rows Immune ----
ann_rows_immune = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  left_join(ImmuneGO_Annotated_Genes %>%
              filter(go_term == "Manual",
                     !process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE")), by = "genes") %>%
  select(genes, process) %>%
  distinct() %>%
  group_by(genes) %>%
  arrange(genes, factor(process, levels = c("INNATE IMMUNE SYSTEM", "ADAPTIVE IMMUNE SYSTEM")), .by_group = TRUE) %>%
  mutate(i_process = row_number()) %>%
  pivot_wider(., names_from = "i_process", values_from = "process") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("index") %>%
  mutate(index = as.numeric(index)) %>%
  arrange(desc(index)) %>%
  column_to_rownames("index") %>%
  t() %>%
  as.data.frame() %>%
  replace(is.na(.), ".")

# Reorder columns (same order as lines in the annotation table)
matrix_data_ordered = matrix_data %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  merge(ann_vaccines_complex, by.y = "condition", all.x=TRUE) %>% 
  arrange(condition) %>% 
  select(!c(disease_vac, type, week)) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0) %>% 
  as.matrix() 


#Check dimensions
dim(matrix_data_ordered) 
dim(ann_vaccines_heatmap) 
dim(ann_rows_immune)

#Create heatmap annotation
ha = HeatmapAnnotation(df = ann_vaccines_heatmap, 
                       col = ann_colors, 
                       annotation_name_side = "left")

row_ha = HeatmapAnnotation(df = ann_rows_immune,
                       col = col_process_immune,
                       which= "row",
                       show_annotation_name = F,
                       show_legend = F)

col_fun <- colorRamp2(c(-2, 0, 2), 
                      c("#9bc1bc", "white", "#ed6a5a"))


#Parameters
#Parameters
mat = matrix_data_ordered
width_image = 40
height_image = 90
width = unit(30, "cm")
height = unit(80, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_heatmap_legend = TRUE, 
                        heatmap_legend_param = list(direction = "vertical"),
                        name = "L2FC", #Legend
                        col = col_fun,
                        show_row_dend = F,
                        row_split = 2, #Split group clusters
                        show_row_names = T,
                        column_names_gp = column_names_gp,
                        row_names_gp = row_names_gp)

ht_list = draw(heatmap_plot_all, 
               annotation_legend_side = "right", 
               heatmap_legend_side = "right")
htShiny(ht_list)

htShiny(ht_list, save = "Interactive_Covid_Other_Vax_Heatmap")

```



#### 7.5.3. Get Cluster 1 Immune genes
Get row clusters

```{r}
r.dend <- row_dend(heatmap_plot)  #Extract row dendrogram
rcl.list <- row_order(heatmap_plot)  #Extract clusters (output is a list)
lapply(rcl.list, function(x) length(x))  #check/confirm size cluster

gene_cluster <- NULL
for (i in 1:length(rcl.list)) {
  a <- row.names(mat[row_order(heatmap_plot)[[i]], ])
  gene_cluster <- rbind(gene_cluster, data.frame(genes = a, cluster = paste0("cluster ", i), gene_set = "Immune genes"))
}
write.csv(gene_cluster, file = here("DGE analysis", paste0(file, "_clustered_genes.csv")), row.names = F)
```

```{r}
####### INPUT
data_2 = Immune_GO_genes_All %>% 
  inner_join(gene_cluster %>% filter(cluster == "cluster 1") %>% select(genes), by = "genes")
filename_2 = paste0("Immune_GO_genes_cluster1", "_VAX_COVID")

######## Matrix
matrix = data_2 %>% 
  select(genes, condition, regulation_numeric) %>%
  pivot_wider(names_from = "condition", 
              values_from = "regulation_numeric", 
              values_fn = mean) %>% 
  replace(is.na(.), 0) %>%
  arrange(genes) %>% 
  column_to_rownames(var="genes") %>% 
  as.matrix()

######## Annotations
ann_vaccines_covid_other_2 = data_2 %>% 
  inner_join(ann_vaccines_covid_other, by = "condition") %>% 
  select(condition, covid_other, microbe_type, disease_vac, type, week) %>% 
  distinct()

#Columns
ann_cols_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  inner_join(ann_vaccines_covid_other_2, by = "condition") %>% 
  distinct() %>% 
  arrange(condition) %>% 
  column_to_rownames("condition")

matrix_data = matrix %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  inner_join(ann_cols_heatmap %>% rownames_to_column("condition"), by = "condition") %>% 
  select(!c(covid_other:week)) %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>%
  as.matrix() 

#Rows Immune ----
ann_rows_immune = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  left_join(ImmuneGO_Annotated_Genes %>% filter(go_term == "Manual"), by = "genes") %>%
  select(genes, process) %>%
  distinct() %>%
  group_by(genes) %>%
  arrange(genes, factor(process, levels = c("INNATE IMMUNE SYSTEM", "ADAPTIVE IMMUNE SYSTEM")), .by_group = TRUE) %>%
  mutate(i_process = row_number()) %>%
  pivot_wider(., names_from = "i_process", values_from = "process") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("index") %>%
  mutate(index = as.numeric(index)) %>%
  arrange(desc(index)) %>%
  column_to_rownames("index") %>%
  t() %>%
  as.data.frame() %>%
  replace(is.na(.), ".") %>% 
  mutate(`1` = if_else(`1` == ".", "INNATE IMMUNE SYSTEM", `1`))

dim(matrix)
dim(matrix_data)
dim(ann_cols_heatmap)
dim(ann_rows_immune)

```

More refs:
<https://debrowser.readthedocs.io/en/master/heatmap/heatmap.html>

```{r}
################# Immune 
#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "right")

row_ha = row_ha = HeatmapAnnotation(df = ann_rows_immune,
                       col = col_process_immune,
                       which= "row",
                       show_annotation_name = F,
                       show_legend = F,
                       simple_anno_size = unit(2, "mm"))

# Values colors
col_fun <- colorRamp2(c(-1, 0, 1), c("#9bc1bc", "white", "#ed6a5a"))

file = filename_2
mat = matrix_data
width_image = 50
height_image = 50
width = unit(30, "cm")
height = unit(30, "cm")
column_names_gp = gpar(fontsize = 12)
row_names_gp = gpar(fontsize = 12)
rect_gp = gpar(col = "gray80", lwd = 0.5)

fileimageheatmap_grouped = here("Figures", paste0(file, sep ="_", "Complexheatmap.png"))

png(file = fileimageheatmap_grouped, 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                       left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        col = col_fun, #color
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                       name = "L2FC",
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "white",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(0, "cm"),
                        row_split = NULL,
                        column_split = 2,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(8, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height)

heatmap_plot = draw(heatmap_plot, 
     annotation_legend_side = "left", 
     heatmap_legend_side = "left",
     merge_legend = TRUE)

heatmap_plot

dev.off()

```

#### 7.5.4. 50 most shared genes

```{r fig.height=10, fig.width=10}
#### Immune -----

degs_all_updown_covid_vax_other_immune = degs_all_updown_covid_other_immune

stats_1 = degs_all_updown_covid_vax_other_immune %>% 
  inner_join(ann_vaccines_covid_other, by = "condition") %>% 
  group_by(genes, covid_other) %>% 
  summarise(n_conditions = n()) %>% 
  filter(all(c("COVID", "OTHER") %in% covid_other)) %>% 
  arrange(desc(n_conditions), genes) %>% 
  group_by(genes) %>% 
  pivot_wider(., names_from = "covid_other", values_from = n_conditions) %>% 
  arrange(desc(OTHER)) %>% 
  ungroup() %>% 
  slice_head(n = 50) %>% 
  pivot_longer(-genes, names_to = "covid_other", values_to = "n_conditions")

stats_1 %>% 
  select(genes) %>% 
  distinct()

ggplot_stats1 = stats_1 %>% 
  ggplot() +
  aes(x = reorder(genes, n_conditions), fill = covid_other, weight = n_conditions) +
  geom_bar() +
  theme_minimal() +
  scale_fill_manual(
    values = ann_vaxsig_colors$covid_other) +
  theme_minimal() +
  labs(fill = "Covid or non-covid",
       title = "Genes shared",
       x = "",
       y = "Number of shared conditions") +
  theme(legend.position = "top",
        axis.text.x = element_text(vjust = 0, hjust=0, size = 12),
        axis.text.y = element_text(size = 12, angle = 0, color = "black"),
        panel.grid.minor.y = element_blank(),
        legend.text = element_text(size=12),
        legend.title = element_text(size = 12, face = "bold")) +
  coord_flip() +
    ylim(-0.1, 22)
ggplot_stats1


ggsave(ggplot_stats1, file = here("Figures", "Covid_Vax_genes_shared_column.png"), width = 10, height = 10)


# Subset the 50 most shared genes
covid_other_immune_genes_50_mostshared_all = stats_1 %>% 
  select(genes) %>% 
  distinct() %>% 
  inner_join(degs_all_updown_covid_vax_other_immune %>% 
               select(condition, genes), by = "genes")
```

# 8. Machine learning descriptors

## 8.1 Preparing

## 8.1.1. Library

```{r message=FALSE, warning=FALSE}
# install.packages("randomForest")
# install.packages("caret")
# install.packages("rpart")
# install.packages("rpart.plot")
# install.packages("tidymodels")
# install.packages("reticulate")
# install.packages("themis")
# install.packages("ranger")
# install.packages("workflowsets")
# install.packages("glmnet")
# install.packages("kknn")
# install.packages("nnet")
# install.packages("tictoc")

library(tidymodels)
tidymodels_prefer()
library(randomForest)
library(ranger)
library(caret)
library(reticulate)
library(themis)
library(tidyverse)
library(rpart)
library(rpart.plot)
library(here)
library(ggrepel)
library(ComplexHeatmap)
library(janitor)
library(ggsci)
library(vip)
library(here)
library(circlize)
library(workflowsets)
library(glmnet)
library(kknn)
library(nnet)
library(tictoc)
library(ggthemes)

```

## 8.1.2. Import files

```{r}
all_matrices_normalized_counts <- readRDS(here("DGE analysis", "all_matrices_normalized_counts.rds"))
all_matrices_counts <- readRDS(here("DGE analysis", "all_matrices_counts.rds"))
ann_vaccines_samples = read_csv(here("Annotations and metadata", "ann_vaccines_samples.csv"))
PC_1_2_cos2 = read_csv(here("PCA", "PC_1_2_cos2.csv"))


dim(all_matrices_normalized_counts)
```



## 8.2. COVID-19 vaccines vs infection

```{r}
# Input data ----
filename = "ImmuneGO_Genes_Type_including_Infection_"
df = all_matrices_normalized_counts

## Vaccination types
outcomevar = "disease_vac"

ann_vaccines_samples_filtered = ann_vaccines_samples %>% 
  mutate(outcomevar = disease_vac) %>% 
  filter(type != "H")

#How many samples by level?
count_levels = ann_vaccines_samples_filtered %>% 
  dplyr::count(outcomevar)

count_levels

#How many levels?
levels = nrow(count_levels)
order_levels = c("I", #TRUE
                 "V") #FALSE

#Select only important genes
PC1_2 = PC_1_2_cos2
```

### 8.2.1. Train and test

```{r fig.height=10, fig.width=10}
# Prepare data ------

df_input <- df %>%
  rownames_to_column("genes") %>%
  inner_join(PC1_2 %>% select(genes) %>% distinct(), by = "genes") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("sample") %>%
  inner_join(ann_vaccines_samples_filtered %>% select(sample,
                                                      outcomevar), #Outcome
             by = "sample") %>%
  select(sample,
         outcomevar,
         everything()) %>%
  column_to_rownames("sample") %>%
  mutate_if(is.character, factor) %>% 
  mutate(outcomevar = fct_relevel(outcomevar, order_levels))

# glimpse(df_input)

# Split data
set.seed(123)  
split <- initial_split(df_input, prop = 0.6, strata = outcomevar)
trees_train <- training(split)
trees_test <- testing(split)

# Create recipe
tree_rec <- recipe(outcomevar ~ ., data = trees_train) %>% #OUTCOME
  step_dummy(all_nominal(), -all_outcomes()) %>%
  # step_corr(all_numeric_predictors()) %>% 
  step_upsample(outcomevar) #Upsample unbalanced data

tree_prep <- prep(tree_rec)

juiced <- juice(tree_prep)

# Set random forest hyper parameters
tune_spec <- rand_forest(
  mtry = tune(),
  trees = 2000,
  min_n = tune()
) %>%
  set_mode("classification") %>% 
  set_engine("ranger")

# Create workflow
tune_wf <- workflow() %>%
  add_recipe(tree_rec) %>%
  add_model(tune_spec)

#Cross validation
set.seed(234)
trees_folds <- vfold_cv(trees_train)

#Define performance metrics
mer_metrics <- metric_set(yardstick::recall,
                          yardstick::specificity,
                          yardstick::accuracy,
                          yardstick::precision,
                          yardstick::roc_auc,
                          yardstick::pr_auc)

# Parallel computing 
doParallel::registerDoParallel()

set.seed(345)
tune_res <- tune_grid(
  tune_wf,
  metrics = mer_metrics,
  resamples = trees_folds,
  grid = 20
)
```

### 8.2.2. Assess metrics

```{r fig.height=10, fig.width=10}
# Assess data ----

#Metricss
metrics_tuneres = tune_res %>%
  collect_metrics() %>%
  select(mean, min_n, mtry, .metric) %>%
  pivot_longer(min_n:mtry,
    values_to = "value",
    names_to = "parameter") %>%
  ggplot()+
  aes(x = value, y = mean, colour = .metric, label = value) +
  geom_line() +
  geom_label() +
  scale_color_npg()+
  theme_few() +
  theme(axis.text.x = element_text(color = "black", size = 12)) +
  facet_grid(vars(.metric), vars(parameter), scales = "free")

metrics_tuneres

metrics_tuneres %>% ggsave(file = here("Figures",
                                       paste0(filename, 
                                              outcomevar,
                                              "_tuneres_metrics.png")),
                                        width = 10,
                                        height = 10)

min_n_selec = 5 #Observations by node)
mtry_selec = 6 #Features/genes by tree)
```

### 8.2.3. Hyperparameter tuning

```{r}
# Tune hyperparameters ----
rf_grid <- grid_regular(
  min_n(range = c(5, 5)),
  mtry(range = c(6, 6)),
  levels = levels
)

set.seed(456)
regular_res <- tune_grid(
  tune_wf,
  metrics = mer_metrics,
  resamples = trees_folds,
  grid = rf_grid
)

# Assess performance -----
regular_res %>%
  collect_metrics()

regular_res %>%
  collect_metrics() %>% 
  write_csv(file = here("Machine learning", paste("metrics_finalmodel_", filename, outcomevar, ".csv")))

#Metrics
regular_res_metrics = regular_res %>%
  collect_metrics() %>%
  select(mean, min_n, mtry, .metric) %>%
  pivot_longer(min_n:mtry,
    values_to = "value",
    names_to = "parameter") %>%
  ggplot()+
  aes(x = value, y = mean, colour = .metric, label = value) +
  geom_line() +
  geom_label(size = 3) +
  scale_color_npg()+
  theme_minimal() +
  facet_grid(vars(.metric), vars(parameter), scales = "free")

regular_res_metrics

# ggsave(regular_res_metrics, file = here("Figures", 
#                                         paste(filename, outcomevar, "metrics", today(), ".png")), 
#        width = 10, height = 10)

# Select best model -----
best_auc <- select_best(regular_res, metric = "pr_auc")
final_rf <- finalize_model(
  tune_spec,
  best_auc
)
```

### 8.2.4. Important features

```{r fig.height=3, fig.width=5}
final = final_rf %>%
  set_engine("ranger", importance = "permutation") %>%
  fit(outcomevar ~ .,
    data = juice(tree_prep)) %>% 
  vip()

genes_rf = final$data
genes_rf = genes_rf %>% select(genes = Variable, importance = Importance)
genes_rf %>% write_csv(file = here("Figures", paste0("vipgenes_tidymodels_", filename, outcomevar, ".csv")))

#Importance plot
importance_plot = ggplot(genes_rf) +
  aes(x = reorder(genes, importance),
    y = importance,
    fill = importance,
      weight = importance) +
  geom_col() +
  theme_few() +
  xlab("Genes") + 
  ylab("importance") +
  ylim(0, 0.035) +
  geom_text(aes(label = round(importance, 4), y = importance),
            hjust = -0.2, 
            size = 4,
            angle = 0,
            color = "black")+
  scale_fill_gradient(low = "#4DBBD5FF", high = "#DC0000FF") +
  theme(legend.position = "right",
        plot.subtitle = element_text(hjust = 0),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5, size = 12, color = "black"),
        axis.text.y = element_text(size = 12, angle = 0, color = "black"),
        panel.grid.minor.y = element_blank(),
        legend.text = element_text(size=12),
        legend.title = element_text(size = 12, face = "bold")) +
    coord_flip() +
  labs(title = "VIP genes",
       subtitle = "Random forest classification model for \nVaccination vs. Infection",
       x = "",
       y = "Importance",
       color = "Importance")

ggsave(importance_plot,
        file = here("Figures",
                    paste0("vipgenes_tidymodels_", filename, outcomevar,  ".png")),
        width = 5,
        height = 3)

importance_plot

```

### 8.2.5. Train final model with tuned hyperparameters

```{r}
# Train final model with tuned hyperparameters
final_wf <- workflow() %>%
  add_recipe(tree_rec) %>%
  add_model(final_rf)

final_res <- final_wf %>%
  last_fit(split)

final_res_preds = final_res %>%
  collect_predictions() %>%
  mutate(correct = case_when(
    outcomevar == .pred_class ~ "Correct",
    TRUE ~ "Incorrect"
  )) %>%
  bind_cols(trees_test)


#Confusion matrix
res_conf_mat = conf_mat(final_res_preds, truth = outcomevar...6,
         estimate = .pred_class)

#Accuracy
res_acc = accuracy(final_res_preds, truth = outcomevar...6,
         estimate = .pred_class)

#Specificity
res_spec = spec(final_res_preds, truth = outcomevar...6,
         estimate = .pred_class)

#Precision
res_prec = precision(final_res_preds, truth = outcomevar...6,
         estimate = .pred_class)

#Recall
res_recall = recall(final_res_preds, truth = outcomevar...6,
         estimate = .pred_class)
#Precision recall AUC
res_pr_auc = pr_auc(final_res_preds, outcomevar...6, .pred_I)


#Unite results
final_res_metrics = bind_rows(res_acc,
                         res_recall,
                         res_prec,
                         res_pr_auc,
                         res_spec) %>% 
  select(-".estimator")


final_res_metrics_conf = list(res_conf_mat, 
                         final_res_metrics,
                         final_res_preds)

final_res_metrics_conf

final_res_metrics_conf %>% 
  saveRDS(file = here("Machine learning", paste0("final_res_metrics", filename, outcomevar, ".rds")))


#Plot
final_model_metrics = final_res_metrics %>% 
  rename(metric = .metric,
         estimate = .estimate) %>% 
  mutate(metric = fct_relevel(metric, final_res_metrics$.metric)) %>% 
  ggplot() +
  aes(x = estimate,
    y = fct_rev(metric),
    fill = estimate,
    weight = estimate) +
  geom_col() +
  theme_few() +
  geom_text(aes(label = round(estimate, 3), y = metric),
            hjust = -0.2, 
            size = 4,
            angle = 0,
            color = "black") +
  xlim(0, 1.2) +
  scale_fill_gradient(low = "#4DBBD5FF", high = "#DC0000FF") +
  theme(legend.position = "right",
        plot.subtitle = element_text(hjust = 0),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5, size = 12, color = "black"),
        axis.text.y = element_text(size = 12, angle = 0, color = "black"),
        panel.grid.minor.y = element_blank(),
        legend.text = element_text(size=12),
        legend.title = element_text(size = 12, face = "bold")) +
  labs(title = "Model assessment",
       subtitle = "Random forest classification model for \nVaccination vs. Infection",
       x = "Estimate",
       y = "",
       fill = "Estimate")

ggsave(final_model_metrics,
        file = here("Figures",
                    paste0("final_model_metrics_", filename, outcomevar,  ".png")),
        width = 5,
        height = 3)


#Which are the incorrect?
final_res_preds %>% rownames_to_column("sample") %>%  
  inner_join(ann_vaccines_samples %>% 
               select(condition, sample), by = "sample") %>% 
  filter(correct == "Incorrect") %>% 
  select(sample, condition, everything())
```
#### Precision recall curve
```{r}
# Precision recall
pr_curve_res = pr_curve(final_res_preds, outcomevar...6, .pred_I) %>% 
  ggplot(aes(x = recall, y = precision)) +
  geom_path(color = "#DC0000FF",
            size = 2) +
  coord_equal() +
  theme_few() +
  labs(title = "Precision-Recall curve",
       subtitle = "Random forest classification \nmodel for Infection vs. Vaccination",
       x = "Recall",
       y = "Precision") 


pr_curve_res %>% 
  ggsave(file = here("Figures",
                    paste0("PR_Curve_tidymodels_", filename, outcomevar,  ".png")),
         width = 4,
         height = 3)

```

Multi ROC
```{r fig.height=5, fig.width=5}
multi_roc = final_res_preds %>% 
  group_by(id) %>%
  roc_curve(outcomevar...9, .pred_H:.pred_VV) %>%
  ggplot(aes(1 - specificity, sensitivity, color = .level)) +
  geom_abline(lty = 2, color = "gray80", size = 0.5) +
  geom_path(show.legend = FALSE, alpha = 0.6, size = 1.2) +
  facet_wrap(~.level, ncol = 3) +
  coord_equal() +
  theme_few() +
    theme(axis.text = element_text(size = 6, color = "black")) +
  labs(title ="Receiver-operator curve",
       subtitle = "Multiclass classification, Randomforest",
       x = "1-Specificity",
       y = "Sensitivity") +
  scale_colour_manual(values = c(ann_vaxsig_colors$type[names(ann_vaxsig_colors$type) != "H"], 
                                 H = "black"))
```

Confusion matrix
```{r fig.height=5, fig.width=5}
conf_matrix_heat = final_res_preds %>% 
  conf_mat(outcomevar...9, .pred_class) %>%
  autoplot(type = "heatmap") +
  scale_fill_gradient(low = "white", high = "#DC0000FF") +
  labs(title ="Confusion matrix",
       subtitle = "Multiclass classification, Randomforest",
       x = "Truth",
       y = "Prediction")

conf_matrix_heat / 
  multi_roc
  
```



```{r}
#Matrix counts of VIP genes
all_matrices_counts_genesRF = all_matrices_counts_long_annotated %>% 
  inner_join(genes_rf, by = "genes")
```


#### Relative effects

Function
```{r fig.height=5, fig.width=7}
REffect <- function(data, dep_vars, indep_var, n_boot = 1000, 
                    plot = TRUE, plot_colors = c("red", "darkblue"), 
                    plot_labels = list(y = "Relative effect", x = "Genes"), 
                    plot_theme = theme_few(), plot_legend_position = "top", 
                    plot_legend_labels = c("Vaccination", "Infection")) {
  
  library(npmv)
  library(ggplot2)
  library(reshape2)
  
  if(!all(data[[indep_var]] %in% c(0, 1))) {
    stop("A variável independente precisa conter apenas 0 e 1 (dois grupos).")
  }
  
  n_aab <- nrow(data)
  list_boot_aab <- list()
  
  # Loop de Bootstrap
  for (i in 0:n_boot) {
    if (i == 0) {
      df_sample <- 1:n_aab
    } else {
      df_sample <- sample(1:n_aab, n_aab, replace = TRUE)
    }
    
    formula_str <- paste(dep_vars, collapse = " | ")
    formula <- as.formula(paste(formula_str, "~", indep_var))
    
    manova_aab <- nonpartest(formula, data = data[df_sample, ], permtest = FALSE, plots = FALSE,
                             permreps = 1000, tests = c(1, 0, 0, 0))
    
    if (i == 0) obs_aab <- manova_aab
    
    list_boot_aab[[i + 1]] <- manova_aab
    
    cat("ANOVA/ boot/ aab/ i = ", i, "\n")
  }
  
  obs_manova <- list_boot_aab[[1]]$twogroupreleffects
  row_manova <- rownames(obs_manova)
  
  releffects <- lapply(list_boot_aab[-1], "[[", 2)
  
  df_perc_boot <- lapply(seq_len(nrow(obs_manova)), function(i) {
    q <- sapply(seq_len(ncol(obs_manova)), function(j) {
      v <- sapply(releffects, function(r) {
        row <- rownames(r)
        if(row[1] != row_manova[1]) r <- r[2:1,]
        r[i, j]
      })
      quantile(v, probs = c(0.025, 0.975))
    })
    colnames(q) <- colnames(obs_manova)
    df <- data.frame(Var2 = colnames(q), t(q),
                     group = ifelse(i == 1, row_manova[1], row_manova[2]))
    df$Var2 <- factor(df$Var2, levels = sort(unique(df$Var2)), ordered = TRUE)
    return(df)
  })
  
  names(df_perc_boot) <- row_manova
  
  df <- reshape2::melt(
    cbind(obs_manova, group = row_manova),
    id.vars = "group"
  )
  df$Var1 <- "point_est"
  df <- df[, c(4, 2, 3, 1)]
  colnames(df)[2] <- "Var2"
  
  df <- dplyr::arrange(df, group, desc(value), Var2)
  df$Var2 <- as.character(df$Var2)
  df$Var2 <- factor(df$Var2, levels = unique(df$Var2), ordered = TRUE)
  
  for (k in seq_len(2)) {
    df_perc_boot[[k]]$Var2 <- factor(df_perc_boot[[k]]$Var2, levels = levels(df$Var2), ordered = TRUE)
  }
  
  if (plot) {
    p <- ggplot(data = df, aes(x = Var2, y = value, group = group, color = group)) +
      geom_ribbon(inherit.aes = FALSE, data = df_perc_boot[[1]],
                  aes(x = Var2, ymin = X2.5., ymax = X97.5., group = group), fill = plot_colors[1],
                  alpha = 0.3) +
      geom_ribbon(inherit.aes = FALSE, data = df_perc_boot[[2]],
                  aes(x = Var2, ymin = X2.5., ymax = X97.5., group = group), fill = plot_colors[2],
                  alpha = 0.3) +
      geom_line() +
      geom_point(aes(size = value)) +
      scale_colour_manual("", values = c("1" = plot_colors[2], "0" = plot_colors[1]),
                          labels = plot_legend_labels) +
      plot_theme +
      theme(
        legend.text = element_text(size = 12),
        axis.text.x = element_text(size = 12, angle = 90),
        axis.text.y = element_text(size = 12),
        axis.line.y = element_blank(),
        axis.title = element_text(size = 15),
        panel.grid.major = element_line(),
        legend.position = plot_legend_position,
        legend.box.background = element_rect()
      ) +
      labs(y = plot_labels$y, x = plot_labels$x)
    
    print(p)
  }
  
  return(list(obs_manova = obs_manova, df_perc_boot = df_perc_boot, plot = p))
}
```

Plot
```{r fig.height=5, fig.width=7, message=FALSE, warning=FALSE}
head(all_matrices_counts_genesRF)

covid_vac_releff = all_matrices_counts_genesRF %>% 
  select(genes, sample, counts) %>% 
  pivot_wider(names_from = "genes",
              values_from = "counts") %>% 
  inner_join(all_matrices_counts_genesRF %>% 
               select(sample, disease_vac), by = "sample") %>% 
  mutate(disease_vac = if_else(disease_vac == "I", 1, 0))


releffect_disease_vac = REffect(covid_vac_releff, dep_vars = colnames(covid_vac_releff %>% 
                                              select(-disease_vac, -sample)),
        indep_var = "disease_vac", plot_colors = c("red", "#4DBBD5FF"), 
        n_boot=1000)


plot = releffect_disease_vac$plot +
  scale_colour_manual(values = c("1" = "#DC0000FF", 
                                 "0" = "#4DBBD5FF"),
                      labels = plot_legend_labels) +
  geom_ribbon(inherit.aes = FALSE, data = releffect_disease_vac$df_perc_boot[[1]],
                  aes(x = Var2, ymin = X2.5., ymax = X97.5., group = group), fill = "#4DBBD5FF",
                  alpha = 0.3) +
      geom_ribbon(inherit.aes = FALSE, data = releffect_disease_vac$df_perc_boot[[2]],
                  aes(x = Var2, ymin = X2.5., ymax = X97.5., group = group), fill = "#DC0000FF",
                  alpha = 0.3) +
  theme(
        legend.text = element_text(size = 12),
        axis.text.x = element_text(size = 12, angle = 45, hjust = 1, vjust = 1, color = "black"),
        axis.text.y = element_text(size = 12, color = "black"),
        axis.line.y = element_blank(),
        axis.title = element_text(size = 15),
        panel.grid.major = element_line(),
        legend.position = "top",
        plot.title = element_text(hjust = 0.5, size = 20),
        plot.subtitle = element_text(hjust = 0.5, size = 15),
        legend.box.background = element_blank()
      ) +
      labs(y = "Relative effect", x = "Genes",
           title = "Relative effects of VIP genes",
           subtitle = "Infection vs. Vaccination",
           color = "") +
  ylim(0, 1)

plot

```

#### Butterfly plot
```{r}
##### Butterfly plot
all_degs_p_05_vac_infected = read_csv("DGE analysis/all_degs_p_05_vac_infected_19_12_23.csv")
df_aggregated = 

df_wide = all_degs_p_05_vac_infected |>
  inner_join(ImmuneGO_Genes %>% select(genes) %>% distinct(), by = "genes") %>% 
  group_by(genes, disease_vac) |>
  summarise(avg_log2FC = mean(log2fold_change), .groups = 'drop') |>
  pivot_wider(names_from = disease_vac, values_from = avg_log2FC) |>
  mutate(Regulation = case_when(V >= 0 & I <= 0 ~ "no",
                               V >= 0 & I >= 0 ~ "up",
                               V <= 0 & I <= 0 ~ "down",
                               TRUE ~ "ns"))   

butterfly_plot = ggplot(df_wide, aes(x = V, y = I, color = Regulation)) +
  geom_point(aes(size = abs(V),
                 label = genes)) +
  geom_label_repel(data = df_wide %>% filter(V > 2.5 & I > 0 | 
                                               V < -1 & I < -2), aes(label = genes)) +
  theme_minimal() +
  scale_color_manual(values = c("no" = "gray",
                                "ns" = "gray",
                                "down" = "royalblue",
                                "up" = "red")) +
  theme_bw() +
  labs(x = "Vaccination",
       y = "Infection",
       size = "Abs(L2FC)",
       title = "Mean Log2FC")
butterfly_plot
ggplotly(butterfly_plot)

```


## ggheatmap
```{r fig.height=10, fig.width=10}

all_matrices_counts <- readRDS(here("DGE analysis", "all_matrices_counts.rds"))
all_matrices_counts_long = all_matrices_counts %>% 
  pivot_longer(cols = -genes,
               names_to = "sample", 
               values_to = "counts")
head(all_matrices_counts)
all_matrices_counts_long_annotated = all_matrices_counts_long %>% 
  inner_join(ann_vaccines_samples,
             by = "sample")

all_matrices_counts_long_annotated %>% saveRDS(here("DGE analysis", "all_matrices_counts_long_annotated.rds"))

control_counts_gse206023 = all_matrices_counts_long_annotated %>% 
  filter(gse_id == "GSE206023") %>% 
  select(genes, sample, counts, condition, vaccine, day) %>% 
  filter(day == 0) %>% 
  group_by(day, genes) %>% 
  summarize(control_counts_mean = mean(counts)) %>% 
  select(genes, control_counts_mean) %>% 
  inner_join()
  
```



```{r fig.height=10, fig.width=10}
pred_genes_counts = final_res_preds %>% 
  select(pred_class = .pred_class,
         pred_I = .pred_I,
         pred_V = .pred_V,
         truth = outcomevar...6,
         correct, 
         ACE:ZNF683) %>% 
  pivot_longer(cols = ACE:ZNF683, 
               names_to = "genes",
               values_to = "values") %>% 
  inner_join(genes_rf, by = "genes") %>% 
  inner_join(normalized_counts_long, by = "genes")
  
pred_genes_counts %>% 
  filter(disease_vac != "H",
         disease_vac != "Healthy") %>% 
  ggplot() +
  aes(y = sample,
      x = genes,
      fill = expression) +
  geom_tile() +
  facet_wrap(~disease_vac~type,scales = "free_y")
```


### 8.2.6. Heatmap: Gene L2FC per condition

```{r}
# Required files
ImmuneGO_Annotated_Genes = readRDS(here("VaxGO gene sets","ImmuneGO_Annotated_Genes_2024-03-26.rds"))
df = normalized_counts
ann_vaccines <- read_csv(here("Annotations and metadata", "ann_vaccines_19-1-24.csv"))
ann_vaccines_samples <- read_csv(here("Annotations and metadata", "ann_vaccines_samples.csv"))


#Inputs
ImmuneGO_Annotated_Genes_all = ImmuneGO_Annotated_Genes %>% 
  filter(!process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE"))

ImmuneGO_Genes = all_degs_p_05_vac_infected_19_12_23 %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% 
               select(genes, process) %>% 
               distinct() %>% 
               select(genes),
               by = "genes") %>% 
  distinct()

# Matrix
l2fc_imps = genes_rf %>% 
  select(genes = Variable, importance = Importance) %>% 
  inner_join(ImmuneGO_Genes, by = "genes") %>%
  select(genes, condition, log2fold_change) %>% 
  pivot_wider(names_from = condition, values_from = log2fold_change) %>% 
  column_to_rownames("genes") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0)

```

```{r}

#Which VIP genes?
#vipgenes_tidymodels_disease_vac2024_04_24 <- read_csv("vipgenes_tidymodels_disease_vac2024-04-24.csv")
vipgenes_tidymodels_type <- read_csv("vipgenes_tidymodels_type2024-06-21.csv")

vip_genes = vipgenes_tidymodels_type
outcomevar = "_Type_"

rf_genes = vip_genes %>% 
  clean_names() %>% 
  select(genes = variable, importance)

ImmuneGO_Genes = all_degs_p_05_vac_infected_19_12_23 %>% 
  inner_join(rf_genes %>% 
               select(genes) %>% 
               distinct() %>% 
               select(genes),
               by = "genes") %>% 
  distinct()

####### INPUT
data_2 = ImmuneGO_Genes
filename_2 = paste0("RandomForest_ImmuneGO_Genes", outcomevar, today())

######## Matrix
matrix = data_2 %>% 
  select(genes, condition, log2fold_change) %>%
  pivot_wider(names_from = "condition", 
              values_from = "log2fold_change", 
              values_fn = mean) %>% 
  replace(is.na(.), 0) %>%
  arrange(genes) %>% 
  column_to_rownames(var="genes") %>% 
  as.matrix()

######## Annotations
ann_vaccines_covid_other_2 = data_2 %>% 
  select(condition) %>% 
  inner_join(ann_vaccines, by = "condition") %>% 
  distinct() %>% 
  select(condition, disease_vac, type, week, day) %>% 
  arrange(week, day) %>% 
  mutate(week = fct_relevel(as.factor(week), sort(levels(week))),
         day = fct_relevel(as.factor(day), sort(levels(day))))

#Columns
ann_cols_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  inner_join(ann_vaccines_covid_other_2, by = "condition") %>% 
  distinct() %>% 
  arrange(condition) %>% 
  column_to_rownames("condition")

matrix_data = matrix %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  inner_join(ann_cols_heatmap %>% rownames_to_column("condition"), by = "condition") %>% 
  select(!c(disease_vac:day)) %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>%
  as.matrix() 

#Rows Immune ----
ann_rows_immune = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  left_join(ImmuneGO_Annotated_Genes %>% filter(go_term == "Manual"), by = "genes") %>%
  select(genes, process) %>%
  distinct() %>%
  group_by(genes) %>%
  arrange(genes, factor(process, levels = c("INNATE IMMUNE SYSTEM", "ADAPTIVE IMMUNE SYSTEM")), .by_group = TRUE) %>%
  mutate(i_process = row_number()) %>%
  pivot_wider(., names_from = "i_process", values_from = "process") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("index") %>%
  mutate(index = as.numeric(index)) %>%
  arrange(desc(index)) %>%
  column_to_rownames("index") %>%
  t() %>%
  as.data.frame() %>%
  replace(is.na(.), ".") %>% 
  mutate(`1` = if_else(`1` == ".", "INNATE IMMUNE SYSTEM", `1`)) 

#Verificar dimensões do dataset
dim(matrix)
dim(matrix_data)
dim(ann_cols_heatmap)
dim(ann_rows_immune)
```

```{r}
################# Immune 
#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "right")

row_ha = HeatmapAnnotation(df = ann_rows_immune,
                       col = col_process_immune,
                       which= "row",
                       show_annotation_name = F,
                       show_legend = F,
                       simple_anno_size = unit(2, "mm"))

# Values colors
col_fun <- colorRamp2(c(-2, 0, 2), c("#9bc1bc", "white", "#ed6a5a"))

file = filename_2
mat = matrix_data
width_image = 30
height_image = 15
width = unit(15, "cm")
height = unit(5, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)
rect_gp = gpar(col = "gray80", lwd = 0.5)

fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = fileimageheatmap_grouped, 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "vertical"),
                        name = "L2FC",
                        col = col_fun, #color
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "white",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(0, "cm"),
                        row_split = NULL,
                        column_split = NULL,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(2, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height)

heatmap_plot = draw(heatmap_plot, 
     annotation_legend_side = "left", 
     heatmap_legend_side = "left")

dev.off()

```

### 8.2.7. Boxplot: VIP gene expression by condition
Import tables
```{r fig.height=10, fig.width=10}
genes_rf = read_csv("Machine learning/vipgenes_tidymodels_ImmuneGO_Genes_Type_including_Infection_type2024-06-27.csv") 
ann_vaccines_conditions = read_csv(here("Annotations and metadata", "ann_vaccines_conditions.csv"))

all_matrices_counts_long_annotated <- readRDS("DGE analysis", "all_matrices_counts_long_annotated.rds"))

all_samples_l2fc = read_rds(here("DGE analysis", "all_samples_l2fc.rds"))


all_matrices_counts_genesRF = all_matrices_counts_long_annotated %>% 
  filter(genes %in% genes_rf$Variable) 

all_matrices_counts_genesRF %>% 
  saveRDS(here("Machine learning", "all_matrices_counts_genesRF.rds"))
```


```{r fig.height=10, fig.width=10}
df = all_samples_l2fc
table = df %>% 
  select(-condition) %>% 
  filter(genes == "IL10") %>% 
  #filter(genes %in% genes_rf$Variable) %>% 
  inner_join(ann_vaccines_samples, by = "sample") %>% 
  mutate(disease_vac = if_else(disease_vac == "Healthy", "H", disease_vac)) %>% 
  mutate(disease_vac = fct_relevel(disease_vac, "H", "I", "V"),
           type = fct_relevel(type, "I", "RNA", "VV", "IN", "SU")) %>% 
  arrange(disease_vac,type, condition) %>% 
  inner_join(ann_vaccines_conditions %>% select(condition, samples), by = "condition") %>% 
  mutate(condition = factor(condition, levels = c(unique(condition[order(condition)]))),
         condition = paste0(condition, " (n=", samples, ")")) 
  # mutate(genes = fct_relevel(genes, genes_rf$Variable))

table_ready = table %>% 
  mutate(condition = fct_relevel(condition, 
                                 table %>% 
                                   filter(str_detect(condition, "^H \\(D0\\)")) %>% 
                                   select(condition) %>% 
                                   distinct() %>% 
                                   pull(condition), 
                                 table %>% 
                                   filter(str_detect(condition, "^I")) %>% 
                                   filter(!str_detect(condition, "^I-I")) %>% 
                                   select(condition) %>% 
                                   arrange(condition) %>% 
                                   distinct() %>% 
                                   pull(condition),
                                 table %>% 
                                   filter(disease_vac == "I") %>% 
                                   filter(str_detect(condition, "^BNT-I")) %>% 
                                    filter(!str_detect(condition, "^BNT-I \\(D\\d+\\)")) %>% 
                                    arrange(day, condition) %>%
                                   select(condition) %>% 
                                    distinct() %>% 
                                    pull(condition),
                                 table %>% 
                                    filter(str_detect(condition, "^BNT-I \\(D\\d+\\)")) %>% 
                                    arrange(day, condition) %>%
                                   select(condition) %>% 
                                    distinct() %>% 
                                    pull(condition),
                                 table %>% 
                                   filter(disease_vac == "V",
                                          str_detect(condition, "^BNT \\(V1, D\\d+\\)")) %>% 
                                   arrange(day, condition) %>% 
                                   select(condition) %>% 
                                   distinct() %>% 
                                   pull(condition),
                                 table %>% 
                                   filter(disease_vac == "V",
                                          !str_detect(condition, "^BNT \\(V1, D\\d+\\)"),
                                          !str_detect(condition, "BBIBP"),
                                          !str_detect(condition, "ZF2001")) %>% 
                                   arrange(condition) %>% 
                                   select(condition) %>% 
                                   distinct() %>% 
                                   pull(condition),
                                 table %>% 
                                   filter(str_detect(condition, "BBIBP")) %>% 
                                   select(condition) %>% 
                                   arrange(condition) %>% 
                                   distinct() %>% 
                                   pull(condition), 
                                 table %>% 
                                   filter(str_detect(condition, "ZF2001")) %>% 
                                   select(condition) %>% 
                                   arrange(condition) %>% 
                                   distinct() %>% 
                                   pull(condition))) %>%
  mutate(type = if_else(type == "H", "I", type),
         disease_vac = if_else(disease_vac == "H", "I", disease_vac))
```


```{r fig.height=10, fig.width=10}
#Base value -----
median_h = table_ready %>% 
  select(genes, sample, log2fc, disease_vac) %>% 
  filter(disease_vac == "H") %>% 
  distinct() %>% 
  group_by(genes, disease_vac) %>% 
  summarize(median = median(counts), .groups = 'drop')

median_i = table_ready %>% 
  select(genes, sample, counts, disease_vac) %>% 
  filter(disease_vac == "H") %>% 
  distinct() %>% 
  group_by(genes, disease_vac) %>% 
  summarize(median = median(counts), .groups = 'drop') %>% 
  mutate(disease_vac = "I")

median_v = table_ready %>% 
  select(genes, sample, counts, disease_vac) %>% 
  filter(disease_vac == "H") %>% 
  distinct() %>% 
  group_by(genes, disease_vac) %>% 
  summarize(median = median(counts), .groups = 'drop') %>% 
  mutate(disease_vac = "V")

median = bind_rows(median_i, median_v)
```


```{r fig.height=5, fig.width=12, message=TRUE, warning=FALSE}
#Plots -----

disease_vac_boxplot_samples_VIP = table_ready %>% 
  # filter(genes == "GZMM") %>% 
  ggplot() +
  aes(x = condition, y = log2fc, fill = if_else(day == 0, "Day 0", type)) +  
  geom_hline(yintercept = 0, linetype = 2) +
  scale_y_log10()+
  geom_jitter(aes(color = if_else(day == 0, "Day 0", type)),
              alpha = 0.3, size = 0.1) +
  geom_boxplot(outliers = F) +
  theme_few() +
  scale_fill_manual(values = c("Day 0" = "white", 
                               ann_vaxsig_colors$type)) +
  scale_color_manual(values = c("Day 0" = "gray80", 
                               ann_vaxsig_colors$type)) +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1,
                                   size = 8,
                                   vjust = 1),
        plot.title = element_text(hjust = 0, face = "bold"),
        plot.margin = margin(0, 0, 0, 2, "cm"),
        strip.text.y = element_text(angle = 0),
        panel.grid.major = element_line(size = 0.05),
        panel.grid.minor = element_line(size = 0.05)) +
  labs(y = "Log2 fold-change",
       title = "VIP genes",
       subtitle = "Random forest classification model for Infection vs. Vaccination \n
       Log2FC calculated comparing each sample with their control (D0)",
       x="",
       fill = "Type") +
  guides(color = "none") +
  facet_grid(~genes~disease_vac, scales = "free")

disease_vac_boxplot_samples_VIP %>% 
  ggsave(file = here("Figures" , "ML_infec_vs_vac_boxplot_vipgenes.png"), 
         width = 10,
         height = 5)
```


```{r fig.height=10, fig.width=10}
#Type
vip_genes_boxplot_type = table %>% 
  filter(disease_vac != "H") %>% 
  ggplot() +
  aes(x = type, y = counts, fill = week_fac) +
  geom_boxplot() +
  geom_hline(data = median, aes(yintercept = median), linetype = "dashed", alpha = 0.5) +
  scale_fill_viridis_d(option = "cividis", direction = -1) +
  scale_y_continuous(trans = "log10") +
  labs(
    x = "Type",
    y = "Normalized counts",
    title = "Gene expression of the 5 most important genes",
    fill = "Week"
  ) +
  theme_linedraw() +
  theme(axis.text.y = element_text(hjust = 0.1),
        legend.position = "top") +
  facet_grid(~genes~disease_vac, scales = "free")

vip_genes_boxplot_type 

vip_genes_boxplot_type %>% 
  ggsave(file = here("Figures", paste0("vip_genes_boxplot_type", filename, outcomevar, today(), ".png")), 
                                  width = 10, height = 15)

#Sex
vip_genes_boxplot_type_sex = table %>% 
  mutate(type_sex = paste0(type, "_", sex),
         type_sex = fct_relevel(type_sex, "IN_M/F", "SU_M/F")) %>% 
  filter(disease_vac != "H",
         !type %in% c("IN", "SU")) %>% 
  ggplot() +
  aes(x = type_sex, y = counts, fill = week_fac) +
  geom_boxplot() +
  geom_hline(data = median, aes(yintercept = median), linetype = "dashed", alpha = 0.5) +
  scale_fill_viridis_d(option = "cividis", direction = -1) +
  scale_y_continuous(trans = "log10") +
  labs(
    x = "Type",
    y = "Normalized counts",
    title = "Gene expression of the 5 most important genes",
    fill = "Week"
  ) +
  theme_linedraw() +
  theme(axis.text.y = element_text(hjust = 0.1),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  facet_grid(~genes~disease_vac, scales = "free")

vip_genes_boxplot_type_sex 


```


#### PCA
**Input**

```{r}
#INPUT
data_genes = all_matrices_counts_genesRF 
data_annotation = ann_vaccines_samples
filename = "RandomforestGenes_COVID_Infec_Vac"
```

```{r}
#Convert long to wide table format.
#Dataframe with sample annotation

ann_vaccines_pca_matrix = data_genes %>% 
  select(sample, genes, counts) %>% 
  pivot_wider(., names_from = "sample", 
                     values_from = "counts") %>% 
  replace(is.na(.), 0) %>%
  column_to_rownames("genes") %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column("sample") %>% 
  inner_join(data_annotation %>% 
               select(sample, condition, disease_vac, gse_id, vaccine, day, week, dose, infection, type), by = "sample") 

# Convert dataframe to matrix without annotation columns
ann_vaccines_pca_matrix_ready = ann_vaccines_pca_matrix %>% 
  column_to_rownames("sample") %>% 
  select(!condition:type) %>% 
  as.matrix()

```

## 6.3. PCA

```{r}
# Delete columns with near 0 variance
nearZeroVarCols <- nearZeroVar(ann_vaccines_pca_matrix_ready, saveMetrics = TRUE)
ann_vaccines_pca_matrix_ready <- ann_vaccines_pca_matrix_ready[, !nearZeroVarCols$nzv]
pca_res <- prcomp(ann_vaccines_pca_matrix_ready, scale. = T)

# Correlation plot ----
corr_matrix = cor(ann_vaccines_pca_matrix_ready %>% scale()) 
var <- get_pca_var(pca_res)

# corrplot = ggcorrplot(corr_matrix, hc.order = TRUE) + 
#   theme(axis.text.x = element_text(angle = 90, size = 5), 
#         axis.text.y = element_text(size = 5))
# #Salvar
# ggsave(corrplot, file = paste0(filename, "_corrplot.png"), 
#        width = 20, #Grande 20, pequeno 10
#        height= 20) #Grande 20, pequeno 10
# print(corrplot)

#PCA ----
data.pca = prcomp(corr_matrix) #PCA
summary(corr_matrix) #Retornar PCs

#Scree plot ----
scree_plot = fviz_eig(data.pca, 
                      addlabels = TRUE,
                      ylim = c(0, 70)) +
  geom_col(color = "#00AFBB", fill = "#00AFBB") +
  theme_classic()

#Save
ggsave(scree_plot, file = here("Figures", paste0(filename, "_screeplot.png")), width = 10, height = 3) 
print(scree_plot)

```

## 6.3.1. Loadings plot

```{r}
# Loadings plot ----
options(ggrepel.max.overlaps = Inf)

circle_contrib = fviz_pca_var(pca_res, col.var = "cos2",
                              gradient.cols = c("black", "#DC0000FF"),
                              select.var= list(cos2 = 20), 
                              repel = T, 
                              labelsize = 4,
                              col.circle = NA) +
  xlab("") + 
  ylab("") +
  theme_minimal() +
theme(panel.grid = element_blank(),  # Remover linhas de grade
        axis.text = element_blank(),   # Remover rótulos de texto dos eixos
        axis.ticks = element_blank()) 

#Save
ggsave(circle_contrib, file = here("Figures", paste0(filename, "_circle_contrib_wide.png")), width = 10, height = 5)

circle_contrib
```

## 6.3.2. KNN

```{r}
#KNN classification -----
#Use the screeplot generated % of explained variance for each dimension
scree_plot #Dim 1 = 68.2%, Dim 2 = 15.9%


# PC1-PC2 ------
#Determine the number of clusters
pca_scores <- data.frame(pca_res$x[, 1:2])
fviz_nbclust(pca_scores,  
                     FUNcluster = kmeans,
                     method = "wss")

pcas = "PC1-PC2"

set.seed(666) # Set seed for randomization
cluster_model <- kmeans(pca_res$x[, 1:2], centers = 3)  #Set the number of clusters

ann_vaccines_pca_matrix$cluster <- as.factor(cluster_model$cluster)
```

## 6.3.3. Plot

```{r fig.height=7, fig.width=10, paged.print=FALSE}
# Condition with density plot ------
pca_plot_knn_cluster = autoplot(pca_res, 
        data = ann_vaccines_pca_matrix,
        colour = "gse_id")  +
  stat_ellipse(aes(color = cluster, fill = cluster), 
               geom = "polygon", 
               alpha = 0.2, 
               linetype = 1,
               size = 0.3,
               type = "t") +
  labs(title=paste0(filename, "_bycondition")) + 
  xlab("PC1 (68.2%)") +
  ylab("PC2 (15.9%)") +
    geom_hline(yintercept = 0, size = 0.3, color = "gray50", linetype = 4) +
  geom_vline(xintercept = 0, size = 0.3, color = "gray50", linetype = 4) +
  geom_point(aes(fill = type,
                 color = type),
             stroke = 0.2) +
   scale_color_manual(values = c("1" = "#8491B4FF", 
                                "2" = "#4DBBD5FF", 
                                "3" = "#DC0000FF",
                                ann_vaxsig_colors$type), 
                     guide = "none") +
  scale_fill_manual(values = c("1" = "#8491B4FF", 
                               "2" = "#4DBBD5FF", 
                               "3" = "#DC0000FF",
                               ann_vaxsig_colors$type),
                    guide = "none") + 
  guides(col="none") +
  theme_few() +
  theme(panel.grid.minor = element_blank(),
        text = element_text(color = "black"),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black")) +
  geom_text_repel(aes(label = condition,
                      segment.colour="gray70"),
                  box.padding = 0.3,
                  size = 3) +
  xlim(-0.4, 0.6)
pca_plot_knn_cluster

ggsave(pca_plot_knn_cluster, 
       file = here( "Figures", paste0(filename, pcas, "_KNN_Clustered_labels.png")), width = 10, height = 7)
pca_plot_knn_cluster
# pca_plot_knn_cluster_marginal = ggMarginal(
#   pca_plot_knn_cluster,
#   type = "histogram",
#   groupFill = T,
#   groupColour = T,
#   xparams = list(binwidth = 0.1, size = 0.1),
#   yparams = list(binwidth = 0.1, size = 0.1)
# )
# 
# ggsave(
#   pca_plot_knn_cluster_marginal,
#   file = here(paste0(filename, pcas, "_KNN_Clustered_labels_Marginal.png"), "Figures"),
#   width = 8,
#   height = 5
# )


```


### 8.2.6. Heatmap: Gene L2FC per condition

```{r}
# Required files
ImmuneGO_Annotated_Genes = readRDS(here("VaxGO gene sets","ImmuneGO_Annotated_Genes_2024-03-26.rds"))
all_degs_p_05_vac_infected = read_csv(here("DGE analysis", "all_degs_p_05_vac_infected_19_12_23.csv"))
ann_vaccines <- read_csv(here("Annotations and metadata", "ann_vaccines_conditions.csv"))
df = read_csv("Machine Learning/vipgenes_tidymodels_ImmuneGO_Genes_Type_including_Infection_disease_vac.csv")
#Inputs
ImmuneGO_Annotated_Genes_all = ImmuneGO_Annotated_Genes %>% 
  filter(!process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE"))

ImmuneGO_Genes = all_degs_p_05_vac_infected %>% 
  filter(genes%in% df$genes) %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% 
               select(genes, process) %>% 
               distinct() %>% 
               select(genes),
               by = "genes") %>% 
  distinct() %>% 
  select(genes, condition, log2fold_change) %>% 
  pivot_wider(names_from = condition, values_from = log2fold_change)

# Matrix
l2fc_imps = ImmuneGO_Genes %>% 
  column_to_rownames("genes") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0)

outcomevar = "Infection_Vaccine"
####### INPUT
filename_2 = paste0("RandomForest_ImmuneGO_Genes_Conditions_", outcomevar)

######## Matrix
matrix = ImmuneGO_Genes

######## Annotations
ann_vaccines_covid_other_2 = ImmuneGO_Genes %>% 
  column_to_rownames("genes") %>% 
  colnames() %>% 
  as.data.frame() %>% 
  select(condition = ".") %>% 
  inner_join(ann_vaccines, by = "condition") %>% 
  distinct() %>% 
  select(condition, disease_vac, type, week, day) %>% 
  arrange(week, day) %>% 
  mutate(week = fct_relevel(as.factor(week), sort(levels(week))),
         day = fct_relevel(as.factor(day), sort(levels(day)))) 

```


```{r}
#Columns
ann_cols_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  inner_join(ann_vaccines_covid_other_2, by = "condition") %>% 
  distinct() %>% 
  arrange(condition) %>% 
  column_to_rownames("condition")

matrix_data = matrix %>% 
  column_to_rownames("genes") %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  inner_join(ann_cols_heatmap %>% rownames_to_column("condition"), by = "condition") %>% 
  select(!c(disease_vac:day)) %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>%
  as.matrix()  %>% 
  replace(is.na(.), 0)

#Rows Immune ----
ann_rows_immune = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  left_join(ImmuneGO_Annotated_Genes %>% filter(go_term == "Manual"), by = "genes") %>%
  select(genes, process) %>%
  distinct() %>%
  group_by(genes) %>%
  arrange(genes, factor(process, levels = c("INNATE IMMUNE SYSTEM", "ADAPTIVE IMMUNE SYSTEM")), .by_group = TRUE) %>%
  mutate(i_process = row_number()) %>%
  pivot_wider(., names_from = "i_process", values_from = "process") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("index") %>%
  mutate(index = as.numeric(index)) %>%
  arrange(desc(index)) %>%
  column_to_rownames("index") %>%
  t() %>%
  as.data.frame() %>%
  replace(is.na(.), ".") %>% 
  mutate(`1` = if_else(`1` == ".", "INNATE IMMUNE SYSTEM", `1`)) %>% 
  rownames_to_column("genes") %>% 
  mutate(genes = rownames(matrix_data)) %>% 
  column_to_rownames("genes")

#Verificar dimensões do dataset
dim(matrix)
dim(matrix_data)
dim(ann_cols_heatmap)
dim(ann_rows_immune)
```

```{r}
################# Immune 
#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "right")

row_ha = HeatmapAnnotation(df = ann_rows_immune,
                       col = col_process_immune,
                       which= "row",
                       show_annotation_name = F,
                       show_legend = F,
                       simple_anno_size = unit(1, "mm"))

# Values colors
col_fun <- colorRamp2(c(-2, 0, 2), c("#9bc1bc", "white", "#ed6a5a"))

file = filename_2
mat = matrix_data
width_image = 30
height_image = 15
width = unit(15, "cm")
height = unit(6, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)
rect_gp = gpar(col = "gray80", lwd = 0.5)

fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = here("Figures", fileimageheatmap_grouped), 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "L2FC",
                        col = col_fun, #color
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "white",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(0, "cm"),
                        row_split = NULL,
                        column_split = NULL,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(2, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height)

heatmap_plot = draw(heatmap_plot, 
     annotation_legend_side = "left", 
     heatmap_legend_side = "bottom")

dev.off()

```



### 8.2.6. Heatmap: Gene counts per sample
```{r}
# Required files
ImmuneGO_Annotated_Genes = readRDS(here("VaxGO gene sets","ImmuneGO_Annotated_Genes_2024-03-26.rds"))

genes_rf = read_csv("Machine learning/vipgenes_tidymodels_All_coviddisease_vac.csv")
df_samples_l2fc_vipgenes_covid = all_samples_l2fc %>% 
  filter(genes %in% genes_rf$genes)

ann_vaccines_samples <- read_csv(here("Annotations and metadata", "ann_vaccines_samples.csv"))


df_annotated = df_samples_l2fc_vipgenes_covid %>% 
  distinct() %>% 
  inner_join(ann_vaccines_samples %>% select(-condition, -participant_id), by = "sample") %>% 
  distinct() %>% 
  filter(condition != "BNT-MO (V1, D0)",
         condition != "BNT-MO (V1, D6)") %>% 
  mutate(disease_vac = if_else(disease_vac == "Healthy", "H", disease_vac)) %>% 
  mutate(disease_vac = fct_relevel(disease_vac, "H", "I", "V"),
           type = fct_relevel(type, "I", "RNA", "VV", "IN", "SU")) %>% 
  inner_join(ann_vaccines_conditions %>% select(condition, samples), by = "condition") %>% 
  mutate(condition = factor(condition, levels = c(unique(condition[order(condition)]))),
         condition = paste0(condition, " (n=", samples, ")"))
  

df_annotated_2 = df_annotated %>% 
  mutate(condition = fct_relevel(condition, 
                                 df_annotated %>% 
                                   filter(str_detect(condition, "^H \\(D0\\)")) %>% 
                                   select(condition) %>% 
                                   distinct() %>% 
                                   pull(condition), 
                                 df_annotated %>% 
                                   filter(str_detect(condition, "^I")) %>% 
                                   filter(!str_detect(condition, "^I-I")) %>% 
                                   select(condition) %>% 
                                   arrange(condition) %>% 
                                   distinct() %>% 
                                   pull(condition),
                                 df_annotated %>% 
                                   filter(disease_vac == "I") %>% 
                                   filter(str_detect(condition, "^BNT-I")) %>% 
                                    filter(!str_detect(condition, "^BNT-I \\(D\\d+\\)")) %>% 
                                    arrange(day, condition) %>%
                                   select(condition) %>% 
                                    distinct() %>% 
                                    pull(condition),
                                 df_annotated %>% 
                                    filter(str_detect(condition, "^BNT-I \\(D\\d+\\)")) %>% 
                                    arrange(day, condition) %>%
                                   select(condition) %>% 
                                    distinct() %>% 
                                    pull(condition),
                                 df_annotated %>% 
                                   filter(disease_vac == "V",
                                          str_detect(condition, "^BNT \\(V1, D\\d+\\)")) %>% 
                                   arrange(day, condition) %>% 
                                   select(condition) %>% 
                                   distinct() %>% 
                                   pull(condition),
                                 df_annotated %>% 
                                   filter(disease_vac == "V",
                                          !str_detect(condition, "^BNT \\(V1, D\\d+\\)"),
                                          !str_detect(condition, "BBIBP"),
                                          !str_detect(condition, "ZF2001")) %>% 
                                   arrange(condition) %>% 
                                   select(condition) %>% 
                                   distinct() %>% 
                                   pull(condition),
                                 df_annotated %>% 
                                   filter(str_detect(condition, "BBIBP")) %>% 
                                   select(condition) %>% 
                                   arrange(condition) %>% 
                                   distinct() %>% 
                                   pull(condition), 
                                 df_annotated %>% 
                                   filter(str_detect(condition, "ZF2001")) %>% 
                                   select(condition) %>% 
                                   arrange(condition) %>% 
                                   distinct() %>% 
                                   pull(condition))) %>%
  mutate(type = if_else(type == "H", "I", type),
         disease_vac = if_else(disease_vac == "H", "I", disease_vac)) 


```

```{r}
df_annotated_2 %>% 
  filter(day != 0) %>% 
  filter(genes == "ITGAM") %>% 
  ggplot() +
  aes(x = condition, y = log2fc, fill = type) +  
  geom_hline(yintercept = 0, linetype = 2) +
  geom_jitter(aes(color = type),
              alpha = 0.3, size = 0.1) +
  geom_boxplot(outliers = F) +
  theme_few() +
  scale_fill_manual(values = c(ann_vaxsig_colors$type)) +
    scale_color_manual(values = c(ann_vaxsig_colors$type)) +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1,
                                   vjust = 1),
        plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.margin = margin(0, 0, 0, 2, "cm"),
        panel.grid.major = element_line(size = 0.05),
        panel.grid.minor = element_line(size = 0.05)) +
  labs(y = "L2FC",
       x="",
       fill = "Type") +
  guides(color = "none") +
  facet_wrap(~disease_vac, scales = "free_x")
```

Generate boxplots for all genes
```{r fig.height=6, fig.width=12}
#Function to create boxplots
create_boxplots_vipgenes <- function(result_df) {
  
  unique_processes <- unique(result_df$genes)
  
  purrr::map(unique_processes, function(process_name) {
    cellmarker_boxplot <- result_df %>% 
      filter(day != 0) %>% 
  filter(genes == process_name) %>% 
  ggplot() +
  aes(x = condition, y = log2fc, fill = type) +  
  geom_hline(yintercept = 0, linetype = 2) +
  geom_jitter(aes(color = type),
              alpha = 0.3, size = 0.1) +
  geom_boxplot(outliers = F) +
  theme_few() +
  scale_fill_manual(values = c(ann_vaxsig_colors$type)) +
    scale_color_manual(values = c(ann_vaxsig_colors$type)) +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1,
                                   vjust = 1),
        plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.margin = margin(0, 0, 0, 2, "cm"),
        panel.grid.major = element_line(size = 0.05),
        panel.grid.minor = element_line(size = 0.05)) +
  labs(y = "L2FC",
       x="",
       title = process_name,
       subtitle = "VIPgenes - COVID-19 infection vs. Vaccination",
       fill = "Type") +
  guides(color = "none") +
  facet_wrap(~disease_vac, scales = "free_x")

    ggsave(cellmarker_boxplot, 
           file = here("Figures", paste0("MachineLearning_VIPGenes_COVID_VAC_boxplot_", process_name, ".png")),
           width = 12, height = 6)
  })
}

# Apply to all processes
create_boxplots_vipgenes(df_annotated_2)


df_annotated_2$genes %>% unique()
```





```{r}
#Inputs
ImmuneGO_Annotated_Genes_all = ImmuneGO_Annotated_Genes %>% 
  filter(!process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE"))

ImmuneGO_Genes = df %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% 
               select(genes, process) %>% 
               distinct() %>% 
               select(genes),
               by = "genes") %>% 
  distinct() %>% 
  select(genes, sample, log2fc) %>% 
  pivot_wider(names_from = sample, values_from = log2fc)


sample_correct =final_res_preds %>% 
  rownames_to_column("sample") %>%  
  inner_join(ann_vaccines_samples %>% 
               select(condition, sample), by = "sample") %>% 
  select(sample, correct) 

# Matrix
l2fc_imps = ImmuneGO_Genes %>% 
  column_to_rownames("genes") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0)

####### INPUT
data_2 = l2fc_imps
filename_2 = paste0("RandomForest_ImmuneGO_Genes_Samples_", outcomevar)

######## Matrix
matrix = ImmuneGO_Genes

######## Annotations
ann_vaccines_covid_other_2 = ImmuneGO_Genes %>% 
  column_to_rownames("genes") %>% 
  colnames() %>% 
  as.data.frame() %>% 
  select(sample = ".") %>% 
  inner_join(ann_vaccines_samples, by = "sample") %>% 
  distinct() %>% 
  select(sample, disease_vac, type, week, day) %>% 
  arrange(week, day) %>% 
  mutate(week = fct_relevel(as.factor(week), sort(levels(week))),
         day = fct_relevel(as.factor(day), sort(levels(day)))) %>% 
  inner_join(sample_correct, by = "sample")
  

#Columns
ann_cols_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(sample = '.') %>% 
  inner_join(ann_vaccines_covid_other_2, by = "sample") %>% 
  distinct() %>% 
  arrange(sample) %>% 
  column_to_rownames("sample")

matrix_data = matrix %>% 
  column_to_rownames("genes") %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "sample") %>% 
  inner_join(ann_cols_heatmap %>% rownames_to_column("sample"), by = "sample") %>% 
  select(!c(disease_vac:day, correct)) %>% 
  arrange(sample) %>% 
  column_to_rownames("sample") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>%
  as.matrix()  %>% 
  replace(is.na(.), 0)

#Rows Immune ----
ann_rows_immune = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  left_join(ImmuneGO_Annotated_Genes %>% filter(go_term == "Manual"), by = "genes") %>%
  select(genes, process) %>%
  distinct() %>%
  group_by(genes) %>%
  arrange(genes, factor(process, levels = c("INNATE IMMUNE SYSTEM", "ADAPTIVE IMMUNE SYSTEM")), .by_group = TRUE) %>%
  mutate(i_process = row_number()) %>%
  pivot_wider(., names_from = "i_process", values_from = "process") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("index") %>%
  mutate(index = as.numeric(index)) %>%
  arrange(desc(index)) %>%
  column_to_rownames("index") %>%
  t() %>%
  as.data.frame() %>%
  replace(is.na(.), ".") %>% 
  mutate(`1` = if_else(`1` == ".", "INNATE IMMUNE SYSTEM", `1`)) %>% 
  rownames_to_column("genes") %>% 
  mutate(genes = rownames(matrix_data)) %>% 
  column_to_rownames("genes")

#Verificar dimensões do dataset
dim(matrix_data)
dim(ann_cols_heatmap)
dim(ann_rows_immune)
```

```{r}
################# Immune 
#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "right")

row_ha = HeatmapAnnotation(df = ann_rows_immune,
                       col = col_process_immune,
                       which= "row",
                       show_annotation_name = F,
                       show_legend = F,
                       simple_anno_size = unit(1, "mm"))
min(matrix_data)

max(matrix_data)
# Values colors
col_fun <- colorRamp2(c(-20, 0, 20), c("#9bc1bc", "white", "#ed6a5a"))

file = filename_2
mat = matrix_data
width_image = 60
height_image = 40
width = unit(50, "cm")
height = unit(30, "cm")
column_names_gp = gpar(fontsize = 8)
row_names_gp = gpar(fontsize = 10)
rect_gp = gpar(col = "gray80", lwd = 0.5)

fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = here("Figures", fileimageheatmap_grouped), 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "Log10 (raw counts)",
                        col = col_fun, #color
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "white",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(0, "cm"),
                        row_split = NULL,
                        column_split = NULL,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(2, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height)

heatmap_plot = draw(heatmap_plot, 
     annotation_legend_side = "left", 
     heatmap_legend_side = "bottom")

dev.off()

```

## 8.2. COVID-19 vaccines vs infection (Log2fold_change values)

```{r}
ImmuneGO_Annotated_Genes = readRDS(here("VaxGO gene sets","ImmuneGO_Annotated_Genes_2024-03-26.rds"))
df_samples_l2fc_vipgenes_covid = all_samples_l2fc 
ann_vaccines_samples <- read_csv(here("Annotations and metadata", "ann_vaccines_samples.csv"))


# Input data ----
filename = "ImmuneGO_Genes_Type_including_Infection_L2FCvalues_"
df = df_samples_l2fc_vipgenes_covid

## Vaccination types
outcomevar = "disease_vac"

ann_vaccines_samples_filtered = ann_vaccines_samples %>% 
  mutate(outcomevar = disease_vac) %>% 
  filter(type != "H")

#How many samples by level?
count_levels = ann_vaccines_samples_filtered %>% 
  dplyr::count(outcomevar)

count_levels

#How many levels?
levels = nrow(count_levels)
order_levels = c("I", #TRUE
                 "V") #FALSE
```

### 8.2.1. Train and test

Step_corr:
- threshold = 0.9 -> From 963 genes to 894


```{r fig.height=10, fig.width=10}
# Prepare data ------

df_input <- df %>%
  inner_join(ImmuneGO_Annotated_Genes %>% select(genes) %>% distinct(), by = "genes") %>%
  select(genes, sample, log2fc) %>% 
  pivot_wider(names_from = genes,
              values_from = log2fc) %>% 
  inner_join(ann_vaccines_samples_filtered %>% filter(day != 0) %>% 
               select(sample, outcomevar = disease_vac), #Outcome
             by = "sample") %>%
  select(sample,
         outcomevar,
         everything()) %>%
  column_to_rownames("sample") %>%
  mutate_if(is.character, factor) %>% 
  mutate(outcomevar = fct_relevel(outcomevar, order_levels)) %>% 
  replace(is.na(.), 0)

# glimpse(df_input)

# Split data
set.seed(123)  
split <- initial_split(df_input, prop = 0.6, strata = outcomevar)
trees_train <- training(split)
trees_test <- testing(split)

# Create recipe
tree_rec <- recipe(outcomevar ~ ., data = trees_train) %>% #OUTCOME
  step_dummy(all_nominal(), -all_outcomes()) %>%
  step_corr(all_numeric_predictors(), threshold = 0.9) %>% 
  step_upsample(outcomevar) #Upsample unbalanced data

tree_prep <- prep(tree_rec)

juiced <- juice(tree_prep)

# Set random forest hyper parameters
tune_spec <- rand_forest(
  mtry = tune(),
  trees = 2000,
  min_n = tune()
) %>%
  set_mode("classification") %>% 
  set_engine("ranger")

# Create workflow
tune_wf <- workflow() %>%
  add_recipe(tree_rec) %>%
  add_model(tune_spec)

#Cross validation
set.seed(234)
trees_folds <- vfold_cv(trees_train)

#Define performance metrics
mer_metrics <- metric_set(yardstick::recall,
                          yardstick::specificity,
                          yardstick::accuracy,
                          yardstick::precision,
                          yardstick::roc_auc,
                          yardstick::pr_auc)

# Parallel computing 
doParallel::registerDoParallel()

set.seed(345)
tune_res <- tune_grid(
  tune_wf,
  metrics = mer_metrics,
  resamples = trees_folds,
  grid = 20
)
```

### 8.2.2. Assess metrics

```{r fig.height=10, fig.width=10}
# Assess data ----

#Metricss
metrics_tuneres = tune_res %>%
  collect_metrics() %>%
  select(mean, min_n, mtry, .metric) %>%
  pivot_longer(min_n:mtry,
    values_to = "value",
    names_to = "parameter") %>%
  ggplot()+
  aes(x = value, y = mean, colour = .metric, label = value) +
  geom_line() +
  geom_label() +
  scale_color_npg()+
  theme_few() +
  theme(axis.text.x = element_text(color = "black", size = 12)) +
  facet_grid(vars(.metric), vars(parameter), scales = "free")

metrics_tuneres

metrics_tuneres %>% ggsave(file = here("Figures",
                                       paste0(filename, 
                                              outcomevar,
                                              "_tuneres_metrics.png")),
                                        width = 10,
                                        height = 10)

min_n_selec = 6 #Observations by node)
mtry_selec = 23 #Features/genes by tree)
```

### 8.2.3. Hyperparameter tuning

```{r}
# Tune hyperparameters ----
rf_grid <- grid_regular(
  min_n(range = c(6, 6)),
  mtry(range = c(23, 23)),
  levels = levels
)

set.seed(456)
regular_res <- tune_grid(
  tune_wf,
  metrics = mer_metrics,
  resamples = trees_folds,
  grid = rf_grid
)

# Assess performance -----
regular_res %>%
  collect_metrics()

regular_res %>%
  collect_metrics() %>% 
  write_csv(file = here("Machine learning", paste("metrics_finalmodel_", filename, outcomevar, ".csv")))

#Metrics
regular_res_metrics = regular_res %>%
  collect_metrics() %>%
  select(mean, min_n, mtry, .metric) %>%
  pivot_longer(min_n:mtry,
    values_to = "value",
    names_to = "parameter") %>%
  ggplot()+
  aes(x = value, y = mean, colour = .metric, label = value) +
  geom_line() +
  geom_label(size = 3) +
  scale_color_npg()+
  theme_minimal() +
  facet_grid(vars(.metric), vars(parameter), scales = "free")

regular_res_metrics

# ggsave(regular_res_metrics, file = here("Figures", 
#                                         paste(filename, outcomevar, "metrics", today(), ".png")), 
#        width = 10, height = 10)

# Select best model -----
best_auc <- select_best(regular_res, metric = "accuracy")
final_rf <- finalize_model(
  tune_spec,
  best_auc
)
```

### 8.2.4. Important features

```{r fig.height=3, fig.width=5}
final = final_rf %>%
  set_engine("ranger", importance = "permutation") %>%
  fit(outcomevar ~ .,
    data = juice(tree_prep)) %>% 
  vip()

genes_rf = final$data
genes_rf = genes_rf %>% select(genes = Variable, importance = Importance)
genes_rf %>% write_csv(file = here("Figures", paste0("vipgenes_tidymodels_", filename, outcomevar, ".csv")))

#Importance plot
importance_plot = ggplot(genes_rf) +
  aes(x = reorder(genes, importance),
    y = importance,
    fill = importance,
      weight = importance) +
  geom_col() +
  theme_few() +
  xlab("Genes") + 
  ylab("importance") +
  ylim(0, 0.035) +
  geom_text(aes(label = round(importance, 4), y = importance),
            hjust = -0.2, 
            size = 4,
            angle = 0,
            color = "black")+
  scale_fill_gradient(low = "#4DBBD5FF", high = "#DC0000FF") +
  theme(legend.position = "right",
        plot.subtitle = element_text(hjust = 0),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5, size = 12, color = "black"),
        axis.text.y = element_text(size = 12, angle = 0, color = "black"),
        panel.grid.minor.y = element_blank(),
        legend.text = element_text(size=12),
        legend.title = element_text(size = 12, face = "bold")) +
    coord_flip() +
  labs(title = "VIP genes",
       subtitle = "Random forest classification model for \nVaccination vs. Infection",
       x = "",
       y = "Importance",
       color = "Importance")

ggsave(importance_plot,
        file = here("Figures",
                    paste0("vipgenes_tidymodels_", filename, outcomevar,  ".png")),
        width = 5,
        height = 3)

importance_plot

```

### 8.2.5. Train final model with tuned hyperparameters

```{r}
# Train final model with tuned hyperparameters
final_wf <- workflow() %>%
  add_recipe(tree_rec) %>%
  add_model(final_rf)

final_res <- final_wf %>%
  last_fit(split)

final_res_preds = final_res %>%
  collect_predictions() %>%
  mutate(correct = case_when(
    outcomevar == .pred_class ~ "Correct",
    TRUE ~ "Incorrect"
  )) %>%
  bind_cols(trees_test)


#Confusion matrix
res_conf_mat = conf_mat(final_res_preds, truth = outcomevar...6,
         estimate = .pred_class)

#Accuracy
res_acc = accuracy(final_res_preds, truth = outcomevar...6,
         estimate = .pred_class)

#Specificity
res_spec = spec(final_res_preds, truth = outcomevar...6,
         estimate = .pred_class)

#Precision
res_prec = precision(final_res_preds, truth = outcomevar...6,
         estimate = .pred_class)

#Recall
res_recall = recall(final_res_preds, truth = outcomevar...6,
         estimate = .pred_class)
#Precision recall AUC
res_pr_auc = pr_auc(final_res_preds, outcomevar...6, .pred_I)


#Unite results
final_res_metrics = bind_rows(res_acc,
                         res_recall,
                         res_prec,
                         res_pr_auc,
                         res_spec) %>% 
  select(-".estimator")


final_res_metrics_conf = list(res_conf_mat, 
                         final_res_metrics,
                         final_res_preds)

final_res_metrics_conf

final_res_metrics_conf %>% 
  saveRDS(file = here("Machine learning", paste0("final_res_metrics", filename, outcomevar, ".rds")))


#Plot
final_model_metrics = final_res_metrics %>% 
  rename(metric = .metric,
         estimate = .estimate) %>% 
  mutate(metric = fct_relevel(metric, final_res_metrics$.metric)) %>% 
  ggplot() +
  aes(x = estimate,
    y = fct_rev(metric),
    fill = estimate,
    weight = estimate) +
  geom_col() +
  theme_few() +
  geom_text(aes(label = round(estimate, 3), y = metric),
            hjust = -0.2, 
            size = 4,
            angle = 0,
            color = "black") +
  xlim(0, 1.2) +
  scale_fill_gradient(low = "#4DBBD5FF", high = "#DC0000FF") +
  theme(legend.position = "right",
        plot.subtitle = element_text(hjust = 0),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5, size = 12, color = "black"),
        axis.text.y = element_text(size = 12, angle = 0, color = "black"),
        panel.grid.minor.y = element_blank(),
        legend.text = element_text(size=12),
        legend.title = element_text(size = 12, face = "bold")) +
  labs(title = "Model assessment",
       subtitle = "Random forest classification model for \nVaccination vs. Infection",
       x = "Estimate",
       y = "",
       fill = "Estimate")

ggsave(final_model_metrics,
        file = here("Figures",
                    paste0("final_model_metrics_", filename, outcomevar,  ".png")),
        width = 5,
        height = 3)


#Which are the incorrect?
final_res_preds %>% rownames_to_column("sample") %>%  
  inner_join(ann_vaccines_samples %>% 
               select(condition, sample), by = "sample") %>% 
  filter(correct == "Incorrect") %>% 
  select(sample, condition, everything())
```
#### Precision recall curve
```{r}
# Precision recall
pr_curve_res = pr_curve(final_res_preds, outcomevar...6, .pred_I) %>% 
  ggplot(aes(x = recall, y = precision)) +
  geom_path(color = "#DC0000FF",
            size = 2) +
  coord_equal() +
  theme_few() +
  labs(title = "Precision-Recall curve",
       subtitle = "Random forest classification \nmodel for Infection vs. Vaccination",
       x = "Recall",
       y = "Precision") 


pr_curve_res %>% 
  ggsave(file = here("Figures",
                    paste0("PR_Curve_tidymodels_", filename, outcomevar,  ".png")),
         width = 4,
         height = 3)

pr_curve_res

```

Multi ROC
```{r fig.height=5, fig.width=5}
roc_plot = final_res_preds %>% 
  roc_curve(outcomevar...9, .pred_I) %>%
  ggplot(aes(1 - specificity, sensitivity)) +
  geom_abline(lty = 2, color = "gray80", size = 0.5) +
  geom_path(show.legend = FALSE, alpha = 0.6, size = 1.2) +
  theme_few() +
    theme(axis.text = element_text(size = 6, color = "black")) +
  labs(title ="Receiver-operator curve",
       subtitle = "Multiclass classification, Randomforest",
       x = "1-Specificity",
       y = "Sensitivity") +
  scale_colour_manual(values = c(ann_vaxsig_colors$type[names(ann_vaxsig_colors$type) != "H"], 
                                 H = "black"))
```

Confusion matrix
```{r fig.height=5, fig.width=5}
conf_matrix_heat = final_res_preds %>% 
  conf_mat(outcomevar...9, .pred_class) %>%
  autoplot(type = "heatmap") +
  scale_fill_gradient(low = "white", high = "#DC0000FF") +
  labs(title ="Confusion matrix",
       subtitle = "Multiclass classification, Randomforest",
       x = "Truth",
       y = "Prediction")

patch = conf_matrix_heat / 
  roc_plot

patch %>% 
  ggsave(file = here("Figures",
                    paste0("ROC_ConfusionMatrix_tidymodels_", filename, outcomevar,  ".png")),
         width = 5,
         height = 5)
  
```



```{r}
#Matrix counts of VIP genes
all_matrices_counts_genesRF = df %>% 
  inner_join(genes_rf, by = "genes")
```


#### Relative effects

Function
```{r fig.height=5, fig.width=7}
REffect <- function(data, dep_vars, indep_var, n_boot = 1000, 
                    plot = TRUE, plot_colors = c("red", "darkblue"), 
                    plot_labels = list(y = "Relative effect", x = "Genes"), 
                    plot_theme = theme_few(), plot_legend_position = "top", 
                    plot_legend_labels = c("Vaccination", "Infection")) {
  
  library(npmv)
  library(ggplot2)
  library(reshape2)
  
  if(!all(data[[indep_var]] %in% c(0, 1))) {
    stop("A variável independente precisa conter apenas 0 e 1 (dois grupos).")
  }
  
  n_aab <- nrow(data)
  list_boot_aab <- list()
  
  # Loop de Bootstrap
  for (i in 0:n_boot) {
    if (i == 0) {
      df_sample <- 1:n_aab
    } else {
      df_sample <- sample(1:n_aab, n_aab, replace = TRUE)
    }
    
    formula_str <- paste(dep_vars, collapse = " | ")
    formula <- as.formula(paste(formula_str, "~", indep_var))
    
    manova_aab <- nonpartest(formula, data = data[df_sample, ], permtest = FALSE, plots = FALSE,
                             permreps = 1000, tests = c(1, 0, 0, 0))
    
    if (i == 0) obs_aab <- manova_aab
    
    list_boot_aab[[i + 1]] <- manova_aab
    
    cat("ANOVA/ boot/ aab/ i = ", i, "\n")
  }
  
  obs_manova <- list_boot_aab[[1]]$twogroupreleffects
  row_manova <- rownames(obs_manova)
  
  releffects <- lapply(list_boot_aab[-1], "[[", 2)
  
  df_perc_boot <- lapply(seq_len(nrow(obs_manova)), function(i) {
    q <- sapply(seq_len(ncol(obs_manova)), function(j) {
      v <- sapply(releffects, function(r) {
        row <- rownames(r)
        if(row[1] != row_manova[1]) r <- r[2:1,]
        r[i, j]
      })
      quantile(v, probs = c(0.025, 0.975))
    })
    colnames(q) <- colnames(obs_manova)
    df <- data.frame(Var2 = colnames(q), t(q),
                     group = ifelse(i == 1, row_manova[1], row_manova[2]))
    df$Var2 <- factor(df$Var2, levels = sort(unique(df$Var2)), ordered = TRUE)
    return(df)
  })
  
  names(df_perc_boot) <- row_manova
  
  df <- reshape2::melt(
    cbind(obs_manova, group = row_manova),
    id.vars = "group"
  )
  df$Var1 <- "point_est"
  df <- df[, c(4, 2, 3, 1)]
  colnames(df)[2] <- "Var2"
  
  df <- dplyr::arrange(df, group, desc(value), Var2)
  df$Var2 <- as.character(df$Var2)
  df$Var2 <- factor(df$Var2, levels = unique(df$Var2), ordered = TRUE)
  
  for (k in seq_len(2)) {
    df_perc_boot[[k]]$Var2 <- factor(df_perc_boot[[k]]$Var2, levels = levels(df$Var2), ordered = TRUE)
  }
  
  if (plot) {
    p <- ggplot(data = df, aes(x = Var2, y = value, group = group, color = group)) +
      geom_ribbon(inherit.aes = FALSE, data = df_perc_boot[[1]],
                  aes(x = Var2, ymin = X2.5., ymax = X97.5., group = group), fill = plot_colors[1],
                  alpha = 0.3) +
      geom_ribbon(inherit.aes = FALSE, data = df_perc_boot[[2]],
                  aes(x = Var2, ymin = X2.5., ymax = X97.5., group = group), fill = plot_colors[2],
                  alpha = 0.3) +
      geom_line() +
      geom_point(aes(size = value)) +
      scale_colour_manual("", values = c("1" = plot_colors[2], "0" = plot_colors[1]),
                          labels = plot_legend_labels) +
      plot_theme +
      theme(
        legend.text = element_text(size = 12),
        axis.text.x = element_text(size = 12, angle = 90),
        axis.text.y = element_text(size = 12),
        axis.line.y = element_blank(),
        axis.title = element_text(size = 15),
        panel.grid.major = element_line(),
        legend.position = plot_legend_position,
        legend.box.background = element_rect()
      ) +
      labs(y = plot_labels$y, x = plot_labels$x)
    
    print(p)
  }
  
  return(list(obs_manova = obs_manova, df_perc_boot = df_perc_boot, plot = p))
}
```

Plot
```{r fig.height=5, fig.width=7, message=FALSE, warning=FALSE}
head(all_matrices_counts_genesRF)

covid_vac_releff = all_matrices_counts_genesRF %>% 
  select(genes, sample, log2fc) %>% 
  pivot_wider(names_from = "genes",
              values_from = "log2fc") %>% 
  inner_join(ann_vaccines_samples %>% 
               select(sample, disease_vac), by = "sample") %>% 
  mutate(disease_vac = if_else(disease_vac == "I", 1, 0))


releffect_disease_vac = REffect(covid_vac_releff, dep_vars = colnames(covid_vac_releff %>% 
                                              select(-disease_vac, -sample)),
        indep_var = "disease_vac", plot_colors = c("red", "#4DBBD5FF"), 
        n_boot=1000)


plot = releffect_disease_vac$plot +
  scale_colour_manual(values = c("1" = "#DC0000FF", 
                                 "0" = "#4DBBD5FF"),
                      labels = plot_legend_labels) +
  geom_ribbon(inherit.aes = FALSE, data = releffect_disease_vac$df_perc_boot[[1]],
                  aes(x = Var2, ymin = X2.5., ymax = X97.5., group = group), fill = "#4DBBD5FF",
                  alpha = 0.3) +
      geom_ribbon(inherit.aes = FALSE, data = releffect_disease_vac$df_perc_boot[[2]],
                  aes(x = Var2, ymin = X2.5., ymax = X97.5., group = group), fill = "#DC0000FF",
                  alpha = 0.3) +
  theme(
        legend.text = element_text(size = 12),
        axis.text.x = element_text(size = 12, angle = 45, hjust = 1, vjust = 1, color = "black"),
        axis.text.y = element_text(size = 12, color = "black"),
        axis.line.y = element_blank(),
        axis.title = element_text(size = 15),
        panel.grid.major = element_line(),
        legend.position = "top",
        plot.title = element_text(hjust = 0.5, size = 20),
        plot.subtitle = element_text(hjust = 0.5, size = 15),
        legend.box.background = element_blank()
      ) +
      labs(y = "Relative effect", x = "Genes",
           title = "Relative effects of VIP genes",
           subtitle = "Infection vs. Vaccination",
           color = "") +
  ylim(0, 1)

plot

```

#### Butterfly plot
```{r}
##### Butterfly plot
all_degs_p_05_vac_infected = read_csv("DGE analysis/all_degs_p_05_vac_infected_19_12_23.csv")
df_aggregated = 

df_wide = all_degs_p_05_vac_infected |>
  inner_join(ImmuneGO_Genes %>% select(genes) %>% distinct(), by = "genes") %>% 
  group_by(genes, disease_vac) |>
  summarise(avg_log2FC = mean(log2fold_change), .groups = 'drop') |>
  pivot_wider(names_from = disease_vac, values_from = avg_log2FC) |>
  mutate(Regulation = case_when(V >= 0 & I <= 0 ~ "no",
                               V >= 0 & I >= 0 ~ "up",
                               V <= 0 & I <= 0 ~ "down",
                               TRUE ~ "ns"))   

butterfly_plot = ggplot(df_wide, aes(x = V, y = I, color = Regulation)) +
  geom_point(aes(size = abs(V),
                 label = genes)) +
  geom_label_repel(data = df_wide %>% filter(V > 2.5 & I > 0 | 
                                               V < -1 & I < -2), aes(label = genes)) +
  theme_minimal() +
  scale_color_manual(values = c("no" = "gray",
                                "ns" = "gray",
                                "down" = "royalblue",
                                "up" = "red")) +
  theme_bw() +
  labs(x = "Vaccination",
       y = "Infection",
       size = "Abs(L2FC)",
       title = "Mean Log2FC")
butterfly_plot
ggplotly(butterfly_plot)

```


## ggheatmap
```{r fig.height=10, fig.width=10}

all_matrices_counts <- readRDS(here("DGE analysis", "all_matrices_counts.rds"))
all_matrices_counts_long = all_matrices_counts %>% 
  pivot_longer(cols = -genes,
               names_to = "sample", 
               values_to = "counts")
head(all_matrices_counts)
all_matrices_counts_long_annotated = all_matrices_counts_long %>% 
  inner_join(ann_vaccines_samples,
             by = "sample")

all_matrices_counts_long_annotated %>% saveRDS(here("DGE analysis", "all_matrices_counts_long_annotated.rds"))

control_counts_gse206023 = all_matrices_counts_long_annotated %>% 
  filter(gse_id == "GSE206023") %>% 
  select(genes, sample, counts, condition, vaccine, day) %>% 
  filter(day == 0) %>% 
  group_by(day, genes) %>% 
  summarize(control_counts_mean = mean(counts)) %>% 
  select(genes, control_counts_mean) %>% 
  inner_join()
  
```



```{r fig.height=10, fig.width=10}
pred_genes_counts = final_res_preds %>% 
  select(pred_class = .pred_class,
         pred_I = .pred_I,
         pred_V = .pred_V,
         truth = outcomevar...6,
         correct, 
         ACE:ZNF683) %>% 
  pivot_longer(cols = ACE:ZNF683, 
               names_to = "genes",
               values_to = "values") %>% 
  inner_join(genes_rf, by = "genes") %>% 
  inner_join(normalized_counts_long, by = "genes")
  
pred_genes_counts %>% 
  filter(disease_vac != "H",
         disease_vac != "Healthy") %>% 
  ggplot() +
  aes(y = sample,
      x = genes,
      fill = expression) +
  geom_tile() +
  facet_wrap(~disease_vac~type,scales = "free_y")
```


### 8.2.6. Heatmap: Gene L2FC per condition

```{r}
# Required files
ImmuneGO_Annotated_Genes = readRDS(here("VaxGO gene sets","ImmuneGO_Annotated_Genes_2024-03-26.rds"))
df = normalized_counts
ann_vaccines <- read_csv(here("Annotations and metadata", "ann_vaccines_conditions.csv"))
ann_vaccines_samples <- read_csv(here("Annotations and metadata", "ann_vaccines_samples.csv"))


#Inputs
ImmuneGO_Annotated_Genes_all = ImmuneGO_Annotated_Genes %>% 
  filter(!process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE"))

ImmuneGO_Genes = all_degs_p_05_vac_infected %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% 
               select(genes, process) %>% 
               distinct() %>% 
               select(genes),
               by = "genes") %>% 
  distinct()

# Matrix
l2fc_imps = genes_rf %>% 
  select(genes, importance) %>% 
  inner_join(ImmuneGO_Genes, by = "genes") %>%
  select(genes, condition, log2fold_change) %>% 
  pivot_wider(names_from = condition, values_from = log2fold_change) %>% 
  column_to_rownames("genes") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0)

```

```{r}

#Which VIP genes?

vip_genes = genes_rf
outcomevar = "_Type_"

rf_genes = vip_genes %>% 
  clean_names() %>% 
  select(genes, importance)

ImmuneGO_Genes = all_degs_p_05_vac_infected %>% 
  inner_join(rf_genes %>% 
               select(genes) %>% 
               distinct() %>% 
               select(genes),
               by = "genes") %>% 
  distinct()

####### INPUT
data_2 = ImmuneGO_Genes
filename_2 = paste0("RandomForest_ImmuneGO_Genes", outcomevar, today())

######## Matrix
matrix = data_2 %>% 
  select(genes, condition, log2fold_change) %>%
  pivot_wider(names_from = "condition", 
              values_from = "log2fold_change", 
              values_fn = mean) %>% 
  replace(is.na(.), 0) %>%
  arrange(genes) %>% 
  column_to_rownames(var="genes") %>% 
  as.matrix()

######## Annotations
ann_vaccines_covid_other_2 = data_2 %>% 
  select(condition) %>% 
  inner_join(ann_vaccines, by = "condition") %>% 
  distinct() %>% 
  select(condition, disease_vac, type, week, day) %>% 
  arrange(week, day) %>% 
  mutate(week = fct_relevel(as.factor(week), sort(levels(week))),
         day = fct_relevel(as.factor(day), sort(levels(day))))

#Columns
ann_cols_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  inner_join(ann_vaccines_covid_other_2, by = "condition") %>% 
  distinct() %>% 
  arrange(condition) %>% 
  column_to_rownames("condition")

matrix_data = matrix %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  inner_join(ann_cols_heatmap %>% rownames_to_column("condition"), by = "condition") %>% 
  select(!c(disease_vac:day)) %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>%
  as.matrix() 

#Rows Immune ----
ann_rows_immune = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  left_join(ImmuneGO_Annotated_Genes %>% filter(go_term == "Manual"), by = "genes") %>%
  select(genes, process) %>%
  distinct() %>%
  group_by(genes) %>%
  arrange(genes, factor(process, levels = c("INNATE IMMUNE SYSTEM", "ADAPTIVE IMMUNE SYSTEM")), .by_group = TRUE) %>%
  mutate(i_process = row_number()) %>%
  pivot_wider(., names_from = "i_process", values_from = "process") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("index") %>%
  mutate(index = as.numeric(index)) %>%
  arrange(desc(index)) %>%
  column_to_rownames("index") %>%
  t() %>%
  as.data.frame() %>%
  replace(is.na(.), ".") %>% 
  mutate(`1` = if_else(`1` == ".", "INNATE IMMUNE SYSTEM", `1`)) 

#Verificar dimensões do dataset
dim(matrix)
dim(matrix_data)
dim(ann_cols_heatmap)
dim(ann_rows_immune)
```

```{r}
################# Immune 
#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "right")

row_ha = HeatmapAnnotation(df = ann_rows_immune,
                       col = col_process_immune,
                       which= "row",
                       show_annotation_name = F,
                       show_legend = F,
                       simple_anno_size = unit(2, "mm"))

# Values colors
col_fun <- colorRamp2(c(-2, 0, 2), c("#9bc1bc", "white", "#ed6a5a"))

file = filename_2
mat = matrix_data
width_image = 30
height_image = 15
width = unit(15, "cm")
height = unit(5, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)
rect_gp = gpar(col = "gray80", lwd = 0.5)

fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = fileimageheatmap_grouped, 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "vertical"),
                        name = "L2FC",
                        col = col_fun, #color
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "white",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(0, "cm"),
                        row_split = NULL,
                        column_split = NULL,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(2, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height)

heatmap_plot = draw(heatmap_plot, 
     annotation_legend_side = "left", 
     heatmap_legend_side = "left")

dev.off()

```

### 8.2.7. Boxplot: VIP gene expression by condition
Import tables
```{r fig.height=10, fig.width=10}
genes_rf = read_csv("Machine learning/vipgenes_tidymodels_ImmuneGO_Genes_Type_including_Infection_type2024-06-27.csv") 
ann_vaccines_conditions = read_csv(here("Annotations and metadata", "ann_vaccines_conditions.csv"))

all_matrices_counts_long_annotated <- readRDS("DGE analysis", "all_matrices_counts_long_annotated.rds"))

all_samples_l2fc = read_rds(here("DGE analysis", "all_samples_l2fc.rds"))

all_matrices_counts_genesRF = all_matrices_counts_long_annotated %>% 
  filter(genes %in% genes_rf$Variable) 

all_matrices_counts_genesRF %>% 
  saveRDS(here("Machine learning", "all_matrices_counts_genesRF.rds"))
```


```{r fig.height=10, fig.width=10}
df = all_samples_l2fc
table = df %>% 
  select(-condition) %>% 
  filter(genes == "IL10") %>% 
  #filter(genes %in% genes_rf$Variable) %>% 
  inner_join(ann_vaccines_samples, by = "sample") %>% 
  mutate(disease_vac = if_else(disease_vac == "Healthy", "H", disease_vac)) %>% 
  mutate(disease_vac = fct_relevel(disease_vac, "H", "I", "V"),
           type = fct_relevel(type, "I", "RNA", "VV", "IN", "SU")) %>% 
  arrange(disease_vac,type, condition) %>% 
  inner_join(ann_vaccines_conditions %>% select(condition, samples), by = "condition") %>% 
  mutate(condition = factor(condition, levels = c(unique(condition[order(condition)]))),
         condition = paste0(condition, " (n=", samples, ")")) 
  # mutate(genes = fct_relevel(genes, genes_rf$Variable))

table_ready = table %>% 
  mutate(condition = fct_relevel(condition, 
                                 table %>% 
                                   filter(str_detect(condition, "^H \\(D0\\)")) %>% 
                                   select(condition) %>% 
                                   distinct() %>% 
                                   pull(condition), 
                                 table %>% 
                                   filter(str_detect(condition, "^I")) %>% 
                                   filter(!str_detect(condition, "^I-I")) %>% 
                                   select(condition) %>% 
                                   arrange(condition) %>% 
                                   distinct() %>% 
                                   pull(condition),
                                 table %>% 
                                   filter(disease_vac == "I") %>% 
                                   filter(str_detect(condition, "^BNT-I")) %>% 
                                    filter(!str_detect(condition, "^BNT-I \\(D\\d+\\)")) %>% 
                                    arrange(day, condition) %>%
                                   select(condition) %>% 
                                    distinct() %>% 
                                    pull(condition),
                                 table %>% 
                                    filter(str_detect(condition, "^BNT-I \\(D\\d+\\)")) %>% 
                                    arrange(day, condition) %>%
                                   select(condition) %>% 
                                    distinct() %>% 
                                    pull(condition),
                                 table %>% 
                                   filter(disease_vac == "V",
                                          str_detect(condition, "^BNT \\(V1, D\\d+\\)")) %>% 
                                   arrange(day, condition) %>% 
                                   select(condition) %>% 
                                   distinct() %>% 
                                   pull(condition),
                                 table %>% 
                                   filter(disease_vac == "V",
                                          !str_detect(condition, "^BNT \\(V1, D\\d+\\)"),
                                          !str_detect(condition, "BBIBP"),
                                          !str_detect(condition, "ZF2001")) %>% 
                                   arrange(condition) %>% 
                                   select(condition) %>% 
                                   distinct() %>% 
                                   pull(condition),
                                 table %>% 
                                   filter(str_detect(condition, "BBIBP")) %>% 
                                   select(condition) %>% 
                                   arrange(condition) %>% 
                                   distinct() %>% 
                                   pull(condition), 
                                 table %>% 
                                   filter(str_detect(condition, "ZF2001")) %>% 
                                   select(condition) %>% 
                                   arrange(condition) %>% 
                                   distinct() %>% 
                                   pull(condition))) %>%
  mutate(type = if_else(type == "H", "I", type),
         disease_vac = if_else(disease_vac == "H", "I", disease_vac))
```


```{r fig.height=10, fig.width=10}
#Base value -----
median_h = table_ready %>% 
  select(genes, sample, log2fc, disease_vac) %>% 
  filter(disease_vac == "H") %>% 
  distinct() %>% 
  group_by(genes, disease_vac) %>% 
  summarize(median = median(counts), .groups = 'drop')

median_i = table_ready %>% 
  select(genes, sample, counts, disease_vac) %>% 
  filter(disease_vac == "H") %>% 
  distinct() %>% 
  group_by(genes, disease_vac) %>% 
  summarize(median = median(counts), .groups = 'drop') %>% 
  mutate(disease_vac = "I")

median_v = table_ready %>% 
  select(genes, sample, counts, disease_vac) %>% 
  filter(disease_vac == "H") %>% 
  distinct() %>% 
  group_by(genes, disease_vac) %>% 
  summarize(median = median(counts), .groups = 'drop') %>% 
  mutate(disease_vac = "V")

median = bind_rows(median_i, median_v)
```


```{r fig.height=5, fig.width=12, message=TRUE, warning=FALSE}
#Plots -----

disease_vac_boxplot_samples_VIP = table_ready %>% 
  # filter(genes == "GZMM") %>% 
  ggplot() +
  aes(x = condition, y = log2fc, fill = if_else(day == 0, "Day 0", type)) +  
  geom_hline(yintercept = 0, linetype = 2) +
  scale_y_log10()+
  geom_jitter(aes(color = if_else(day == 0, "Day 0", type)),
              alpha = 0.3, size = 0.1) +
  geom_boxplot(outliers = F) +
  theme_few() +
  scale_fill_manual(values = c("Day 0" = "white", 
                               ann_vaxsig_colors$type)) +
  scale_color_manual(values = c("Day 0" = "gray80", 
                               ann_vaxsig_colors$type)) +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1,
                                   size = 8,
                                   vjust = 1),
        plot.title = element_text(hjust = 0, face = "bold"),
        plot.margin = margin(0, 0, 0, 2, "cm"),
        strip.text.y = element_text(angle = 0),
        panel.grid.major = element_line(size = 0.05),
        panel.grid.minor = element_line(size = 0.05)) +
  labs(y = "Log2 fold-change",
       title = "VIP genes",
       subtitle = "Random forest classification model for Infection vs. Vaccination \n
       Log2FC calculated comparing each sample with their control (D0)",
       x="",
       fill = "Type") +
  guides(color = "none") +
  facet_grid(~genes~disease_vac, scales = "free")

disease_vac_boxplot_samples_VIP %>% 
  ggsave(file = here("Figures" , "ML_infec_vs_vac_boxplot_vipgenes.png"), 
         width = 10,
         height = 5)
```


```{r fig.height=10, fig.width=10}
#Type
vip_genes_boxplot_type = table %>% 
  filter(disease_vac != "H") %>% 
  ggplot() +
  aes(x = type, y = counts, fill = week_fac) +
  geom_boxplot() +
  geom_hline(data = median, aes(yintercept = median), linetype = "dashed", alpha = 0.5) +
  scale_fill_viridis_d(option = "cividis", direction = -1) +
  scale_y_continuous(trans = "log10") +
  labs(
    x = "Type",
    y = "Normalized counts",
    title = "Gene expression of the 5 most important genes",
    fill = "Week"
  ) +
  theme_linedraw() +
  theme(axis.text.y = element_text(hjust = 0.1),
        legend.position = "top") +
  facet_grid(~genes~disease_vac, scales = "free")

vip_genes_boxplot_type 

vip_genes_boxplot_type %>% 
  ggsave(file = here("Figures", paste0("vip_genes_boxplot_type", filename, outcomevar, today(), ".png")), 
                                  width = 10, height = 15)

#Sex
vip_genes_boxplot_type_sex = table %>% 
  mutate(type_sex = paste0(type, "_", sex),
         type_sex = fct_relevel(type_sex, "IN_M/F", "SU_M/F")) %>% 
  filter(disease_vac != "H",
         !type %in% c("IN", "SU")) %>% 
  ggplot() +
  aes(x = type_sex, y = counts, fill = week_fac) +
  geom_boxplot() +
  geom_hline(data = median, aes(yintercept = median), linetype = "dashed", alpha = 0.5) +
  scale_fill_viridis_d(option = "cividis", direction = -1) +
  scale_y_continuous(trans = "log10") +
  labs(
    x = "Type",
    y = "Normalized counts",
    title = "Gene expression of the 5 most important genes",
    fill = "Week"
  ) +
  theme_linedraw() +
  theme(axis.text.y = element_text(hjust = 0.1),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  facet_grid(~genes~disease_vac, scales = "free")

vip_genes_boxplot_type_sex 


```


#### PCA
**Input**

```{r}
#INPUT
data_genes = all_matrices_counts_genesRF 
data_annotation = ann_vaccines_samples
filename = "RandomforestGenes_COVID_Infec_Vac"
```

```{r}
#Convert long to wide table format.
#Dataframe with sample annotation

ann_vaccines_pca_matrix = data_genes %>% 
  select(sample, genes, counts) %>% 
  pivot_wider(., names_from = "sample", 
                     values_from = "counts") %>% 
  replace(is.na(.), 0) %>%
  column_to_rownames("genes") %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column("sample") %>% 
  inner_join(data_annotation %>% 
               select(sample, condition, disease_vac, gse_id, vaccine, day, week, dose, infection, type), by = "sample") 

# Convert dataframe to matrix without annotation columns
ann_vaccines_pca_matrix_ready = ann_vaccines_pca_matrix %>% 
  column_to_rownames("sample") %>% 
  select(!condition:type) %>% 
  as.matrix()

```

## 6.3. PCA

```{r}
# Delete columns with near 0 variance
nearZeroVarCols <- nearZeroVar(ann_vaccines_pca_matrix_ready, saveMetrics = TRUE)
ann_vaccines_pca_matrix_ready <- ann_vaccines_pca_matrix_ready[, !nearZeroVarCols$nzv]
pca_res <- prcomp(ann_vaccines_pca_matrix_ready, scale. = T)

# Correlation plot ----
corr_matrix = cor(ann_vaccines_pca_matrix_ready %>% scale()) 
var <- get_pca_var(pca_res)

# corrplot = ggcorrplot(corr_matrix, hc.order = TRUE) + 
#   theme(axis.text.x = element_text(angle = 90, size = 5), 
#         axis.text.y = element_text(size = 5))
# #Salvar
# ggsave(corrplot, file = paste0(filename, "_corrplot.png"), 
#        width = 20, #Grande 20, pequeno 10
#        height= 20) #Grande 20, pequeno 10
# print(corrplot)

#PCA ----
data.pca = prcomp(corr_matrix) #PCA
summary(corr_matrix) #Retornar PCs

#Scree plot ----
scree_plot = fviz_eig(data.pca, 
                      addlabels = TRUE,
                      ylim = c(0, 70)) +
  geom_col(color = "#00AFBB", fill = "#00AFBB") +
  theme_classic()

#Save
ggsave(scree_plot, file = here("Figures", paste0(filename, "_screeplot.png")), width = 10, height = 3) 
print(scree_plot)

```

## 6.3.1. Loadings plot

```{r}
# Loadings plot ----
options(ggrepel.max.overlaps = Inf)

circle_contrib = fviz_pca_var(pca_res, col.var = "cos2",
                              gradient.cols = c("black", "#DC0000FF"),
                              select.var= list(cos2 = 20), 
                              repel = T, 
                              labelsize = 4,
                              col.circle = NA) +
  xlab("") + 
  ylab("") +
  theme_minimal() +
theme(panel.grid = element_blank(),  # Remover linhas de grade
        axis.text = element_blank(),   # Remover rótulos de texto dos eixos
        axis.ticks = element_blank()) 

#Save
ggsave(circle_contrib, file = here("Figures", paste0(filename, "_circle_contrib_wide.png")), width = 10, height = 5)

circle_contrib
```

## 6.3.2. KNN

```{r}
#KNN classification -----
#Use the screeplot generated % of explained variance for each dimension
scree_plot #Dim 1 = 68.2%, Dim 2 = 15.9%


# PC1-PC2 ------
#Determine the number of clusters
pca_scores <- data.frame(pca_res$x[, 1:2])
fviz_nbclust(pca_scores,  
                     FUNcluster = kmeans,
                     method = "wss")

pcas = "PC1-PC2"

set.seed(666) # Set seed for randomization
cluster_model <- kmeans(pca_res$x[, 1:2], centers = 3)  #Set the number of clusters

ann_vaccines_pca_matrix$cluster <- as.factor(cluster_model$cluster)
```

## 6.3.3. Plot

```{r fig.height=7, fig.width=10, paged.print=FALSE}
# Condition with density plot ------
pca_plot_knn_cluster = autoplot(pca_res, 
        data = ann_vaccines_pca_matrix,
        colour = "gse_id")  +
  stat_ellipse(aes(color = cluster, fill = cluster), 
               geom = "polygon", 
               alpha = 0.2, 
               linetype = 1,
               size = 0.3,
               type = "t") +
  labs(title=paste0(filename, "_bycondition")) + 
  xlab("PC1 (68.2%)") +
  ylab("PC2 (15.9%)") +
    geom_hline(yintercept = 0, size = 0.3, color = "gray50", linetype = 4) +
  geom_vline(xintercept = 0, size = 0.3, color = "gray50", linetype = 4) +
  geom_point(aes(fill = type,
                 color = type),
             stroke = 0.2) +
   scale_color_manual(values = c("1" = "#8491B4FF", 
                                "2" = "#4DBBD5FF", 
                                "3" = "#DC0000FF",
                                ann_vaxsig_colors$type), 
                     guide = "none") +
  scale_fill_manual(values = c("1" = "#8491B4FF", 
                               "2" = "#4DBBD5FF", 
                               "3" = "#DC0000FF",
                               ann_vaxsig_colors$type),
                    guide = "none") + 
  guides(col="none") +
  theme_few() +
  theme(panel.grid.minor = element_blank(),
        text = element_text(color = "black"),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black")) +
  geom_text_repel(aes(label = condition,
                      segment.colour="gray70"),
                  box.padding = 0.3,
                  size = 3) +
  xlim(-0.4, 0.6)
pca_plot_knn_cluster

ggsave(pca_plot_knn_cluster, 
       file = here( "Figures", paste0(filename, pcas, "_KNN_Clustered_labels.png")), width = 10, height = 7)
pca_plot_knn_cluster
# pca_plot_knn_cluster_marginal = ggMarginal(
#   pca_plot_knn_cluster,
#   type = "histogram",
#   groupFill = T,
#   groupColour = T,
#   xparams = list(binwidth = 0.1, size = 0.1),
#   yparams = list(binwidth = 0.1, size = 0.1)
# )
# 
# ggsave(
#   pca_plot_knn_cluster_marginal,
#   file = here(paste0(filename, pcas, "_KNN_Clustered_labels_Marginal.png"), "Figures"),
#   width = 8,
#   height = 5
# )


```


### 8.2.6. Heatmap: Gene L2FC per condition

```{r}
# Required files
ImmuneGO_Annotated_Genes = readRDS(here("VaxGO gene sets","ImmuneGO_Annotated_Genes_2024-03-26.rds"))
all_degs_p_05_vac_infected = read_csv(here("DGE analysis", "all_degs_p_05_vac_infected_19_12_23.csv"))
ann_vaccines <- read_csv(here("Annotations and metadata", "ann_vaccines_conditions.csv"))
df = read_csv("Machine Learning/vipgenes_tidymodels_ImmuneGO_Genes_Type_including_Infection_disease_vac.csv")
#Inputs
ImmuneGO_Annotated_Genes_all = ImmuneGO_Annotated_Genes %>% 
  filter(!process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE"))

ImmuneGO_Genes = all_degs_p_05_vac_infected %>% 
  filter(genes%in% df$genes) %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% 
               select(genes, process) %>% 
               distinct() %>% 
               select(genes),
               by = "genes") %>% 
  distinct() %>% 
  select(genes, condition, log2fold_change) %>% 
  pivot_wider(names_from = condition, values_from = log2fold_change)

# Matrix
l2fc_imps = ImmuneGO_Genes %>% 
  column_to_rownames("genes") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0)

outcomevar = "Infection_Vaccine"
####### INPUT
filename_2 = paste0("RandomForest_ImmuneGO_Genes_Conditions_", outcomevar)

######## Matrix
matrix = ImmuneGO_Genes

######## Annotations
ann_vaccines_covid_other_2 = ImmuneGO_Genes %>% 
  column_to_rownames("genes") %>% 
  colnames() %>% 
  as.data.frame() %>% 
  select(condition = ".") %>% 
  inner_join(ann_vaccines, by = "condition") %>% 
  distinct() %>% 
  select(condition, disease_vac, type, week, day) %>% 
  arrange(week, day) %>% 
  mutate(week = fct_relevel(as.factor(week), sort(levels(week))),
         day = fct_relevel(as.factor(day), sort(levels(day)))) 

```


```{r}
#Columns
ann_cols_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  inner_join(ann_vaccines_covid_other_2, by = "condition") %>% 
  distinct() %>% 
  arrange(condition) %>% 
  column_to_rownames("condition")

matrix_data = matrix %>% 
  column_to_rownames("genes") %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  inner_join(ann_cols_heatmap %>% rownames_to_column("condition"), by = "condition") %>% 
  select(!c(disease_vac:day)) %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>%
  as.matrix()  %>% 
  replace(is.na(.), 0)

#Rows Immune ----
ann_rows_immune = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  left_join(ImmuneGO_Annotated_Genes %>% filter(go_term == "Manual"), by = "genes") %>%
  select(genes, process) %>%
  distinct() %>%
  group_by(genes) %>%
  arrange(genes, factor(process, levels = c("INNATE IMMUNE SYSTEM", "ADAPTIVE IMMUNE SYSTEM")), .by_group = TRUE) %>%
  mutate(i_process = row_number()) %>%
  pivot_wider(., names_from = "i_process", values_from = "process") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("index") %>%
  mutate(index = as.numeric(index)) %>%
  arrange(desc(index)) %>%
  column_to_rownames("index") %>%
  t() %>%
  as.data.frame() %>%
  replace(is.na(.), ".") %>% 
  mutate(`1` = if_else(`1` == ".", "INNATE IMMUNE SYSTEM", `1`)) %>% 
  rownames_to_column("genes") %>% 
  mutate(genes = rownames(matrix_data)) %>% 
  column_to_rownames("genes")

#Verificar dimensões do dataset
dim(matrix)
dim(matrix_data)
dim(ann_cols_heatmap)
dim(ann_rows_immune)
```

```{r}
################# Immune 
#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "right")

row_ha = HeatmapAnnotation(df = ann_rows_immune,
                       col = col_process_immune,
                       which= "row",
                       show_annotation_name = F,
                       show_legend = F,
                       simple_anno_size = unit(1, "mm"))

# Values colors
col_fun <- colorRamp2(c(-2, 0, 2), c("#9bc1bc", "white", "#ed6a5a"))

file = filename_2
mat = matrix_data
width_image = 30
height_image = 15
width = unit(15, "cm")
height = unit(6, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)
rect_gp = gpar(col = "gray80", lwd = 0.5)

fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = here("Figures", fileimageheatmap_grouped), 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "L2FC",
                        col = col_fun, #color
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "white",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(0, "cm"),
                        row_split = NULL,
                        column_split = NULL,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(2, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height)

heatmap_plot = draw(heatmap_plot, 
     annotation_legend_side = "left", 
     heatmap_legend_side = "bottom")

dev.off()

```



### 8.2.6. Heatmap: Gene counts per sample
```{r}
# Required files
ImmuneGO_Annotated_Genes = readRDS(here("VaxGO gene sets","ImmuneGO_Annotated_Genes_2024-03-26.rds"))

genes_rf = read_csv("Machine learning/vipgenes_tidymodels_All_coviddisease_vac.csv")
df_samples_l2fc_vipgenes_covid = all_samples_l2fc %>% 
  filter(genes %in% genes_rf$genes)

ann_vaccines_samples <- read_csv(here("Annotations and metadata", "ann_vaccines_samples.csv"))


df_annotated = df_samples_l2fc_vipgenes_covid %>% 
  distinct() %>% 
  inner_join(ann_vaccines_samples %>% select(-condition, -participant_id), by = "sample") %>% 
  distinct() %>% 
  filter(condition != "BNT-MO (V1, D0)",
         condition != "BNT-MO (V1, D6)") %>% 
  mutate(disease_vac = if_else(disease_vac == "Healthy", "H", disease_vac)) %>% 
  mutate(disease_vac = fct_relevel(disease_vac, "H", "I", "V"),
           type = fct_relevel(type, "I", "RNA", "VV", "IN", "SU")) %>% 
  inner_join(ann_vaccines_conditions %>% select(condition, samples), by = "condition") %>% 
  mutate(condition = factor(condition, levels = c(unique(condition[order(condition)]))),
         condition = paste0(condition, " (n=", samples, ")"))
  

df_annotated_2 = df_annotated %>% 
  mutate(condition = fct_relevel(condition, 
                                 df_annotated %>% 
                                   filter(str_detect(condition, "^H \\(D0\\)")) %>% 
                                   select(condition) %>% 
                                   distinct() %>% 
                                   pull(condition), 
                                 df_annotated %>% 
                                   filter(str_detect(condition, "^I")) %>% 
                                   filter(!str_detect(condition, "^I-I")) %>% 
                                   select(condition) %>% 
                                   arrange(condition) %>% 
                                   distinct() %>% 
                                   pull(condition),
                                 df_annotated %>% 
                                   filter(disease_vac == "I") %>% 
                                   filter(str_detect(condition, "^BNT-I")) %>% 
                                    filter(!str_detect(condition, "^BNT-I \\(D\\d+\\)")) %>% 
                                    arrange(day, condition) %>%
                                   select(condition) %>% 
                                    distinct() %>% 
                                    pull(condition),
                                 df_annotated %>% 
                                    filter(str_detect(condition, "^BNT-I \\(D\\d+\\)")) %>% 
                                    arrange(day, condition) %>%
                                   select(condition) %>% 
                                    distinct() %>% 
                                    pull(condition),
                                 df_annotated %>% 
                                   filter(disease_vac == "V",
                                          str_detect(condition, "^BNT \\(V1, D\\d+\\)")) %>% 
                                   arrange(day, condition) %>% 
                                   select(condition) %>% 
                                   distinct() %>% 
                                   pull(condition),
                                 df_annotated %>% 
                                   filter(disease_vac == "V",
                                          !str_detect(condition, "^BNT \\(V1, D\\d+\\)"),
                                          !str_detect(condition, "BBIBP"),
                                          !str_detect(condition, "ZF2001")) %>% 
                                   arrange(condition) %>% 
                                   select(condition) %>% 
                                   distinct() %>% 
                                   pull(condition),
                                 df_annotated %>% 
                                   filter(str_detect(condition, "BBIBP")) %>% 
                                   select(condition) %>% 
                                   arrange(condition) %>% 
                                   distinct() %>% 
                                   pull(condition), 
                                 df_annotated %>% 
                                   filter(str_detect(condition, "ZF2001")) %>% 
                                   select(condition) %>% 
                                   arrange(condition) %>% 
                                   distinct() %>% 
                                   pull(condition))) %>%
  mutate(type = if_else(type == "H", "I", type),
         disease_vac = if_else(disease_vac == "H", "I", disease_vac)) 


```

```{r}
df_annotated_2 %>% 
  filter(day != 0) %>% 
  filter(genes == "ITGAM") %>% 
  ggplot() +
  aes(x = condition, y = log2fc, fill = type) +  
  geom_hline(yintercept = 0, linetype = 2) +
  geom_jitter(aes(color = type),
              alpha = 0.3, size = 0.1) +
  geom_boxplot(outliers = F) +
  theme_few() +
  scale_fill_manual(values = c(ann_vaxsig_colors$type)) +
    scale_color_manual(values = c(ann_vaxsig_colors$type)) +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1,
                                   vjust = 1),
        plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.margin = margin(0, 0, 0, 2, "cm"),
        panel.grid.major = element_line(size = 0.05),
        panel.grid.minor = element_line(size = 0.05)) +
  labs(y = "L2FC",
       x="",
       fill = "Type") +
  guides(color = "none") +
  facet_wrap(~disease_vac, scales = "free_x")
```

Generate boxplots for all genes
```{r fig.height=6, fig.width=12}
#Function to create boxplots
create_boxplots_vipgenes <- function(result_df) {
  
  unique_processes <- unique(result_df$genes)
  
  purrr::map(unique_processes, function(process_name) {
    cellmarker_boxplot <- result_df %>% 
      filter(day != 0) %>% 
  filter(genes == process_name) %>% 
  ggplot() +
  aes(x = condition, y = log2fc, fill = type) +  
  geom_hline(yintercept = 0, linetype = 2) +
  geom_jitter(aes(color = type),
              alpha = 0.3, size = 0.1) +
  geom_boxplot(outliers = F) +
  theme_few() +
  scale_fill_manual(values = c(ann_vaxsig_colors$type)) +
    scale_color_manual(values = c(ann_vaxsig_colors$type)) +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1,
                                   vjust = 1),
        plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.margin = margin(0, 0, 0, 2, "cm"),
        panel.grid.major = element_line(size = 0.05),
        panel.grid.minor = element_line(size = 0.05)) +
  labs(y = "L2FC",
       x="",
       title = process_name,
       subtitle = "VIPgenes - COVID-19 infection vs. Vaccination",
       fill = "Type") +
  guides(color = "none") +
  facet_wrap(~disease_vac, scales = "free_x")

    ggsave(cellmarker_boxplot, 
           file = here("Figures", paste0("MachineLearning_VIPGenes_COVID_VAC_boxplot_", process_name, ".png")),
           width = 12, height = 6)
  })
}

# Apply to all processes
create_boxplots_vipgenes(df_annotated_2)


df_annotated_2$genes %>% unique()
```





```{r}
#Inputs
ImmuneGO_Annotated_Genes_all = ImmuneGO_Annotated_Genes %>% 
  filter(!process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE"))

ImmuneGO_Genes = df %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% 
               select(genes, process) %>% 
               distinct() %>% 
               select(genes),
               by = "genes") %>% 
  distinct() %>% 
  select(genes, sample, log2fc) %>% 
  pivot_wider(names_from = sample, values_from = log2fc)


sample_correct =final_res_preds %>% 
  rownames_to_column("sample") %>%  
  inner_join(ann_vaccines_samples %>% 
               select(condition, sample), by = "sample") %>% 
  select(sample, correct) 

# Matrix
l2fc_imps = ImmuneGO_Genes %>% 
  column_to_rownames("genes") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0)

####### INPUT
data_2 = l2fc_imps
filename_2 = paste0("RandomForest_ImmuneGO_Genes_Samples_", outcomevar)

######## Matrix
matrix = ImmuneGO_Genes

######## Annotations
ann_vaccines_covid_other_2 = ImmuneGO_Genes %>% 
  column_to_rownames("genes") %>% 
  colnames() %>% 
  as.data.frame() %>% 
  select(sample = ".") %>% 
  inner_join(ann_vaccines_samples, by = "sample") %>% 
  distinct() %>% 
  select(sample, disease_vac, type, week, day) %>% 
  arrange(week, day) %>% 
  mutate(week = fct_relevel(as.factor(week), sort(levels(week))),
         day = fct_relevel(as.factor(day), sort(levels(day)))) %>% 
  inner_join(sample_correct, by = "sample")
  

#Columns
ann_cols_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(sample = '.') %>% 
  inner_join(ann_vaccines_covid_other_2, by = "sample") %>% 
  distinct() %>% 
  arrange(sample) %>% 
  column_to_rownames("sample")

matrix_data = matrix %>% 
  column_to_rownames("genes") %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "sample") %>% 
  inner_join(ann_cols_heatmap %>% rownames_to_column("sample"), by = "sample") %>% 
  select(!c(disease_vac:day, correct)) %>% 
  arrange(sample) %>% 
  column_to_rownames("sample") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>%
  as.matrix()  %>% 
  replace(is.na(.), 0)

#Rows Immune ----
ann_rows_immune = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  left_join(ImmuneGO_Annotated_Genes %>% filter(go_term == "Manual"), by = "genes") %>%
  select(genes, process) %>%
  distinct() %>%
  group_by(genes) %>%
  arrange(genes, factor(process, levels = c("INNATE IMMUNE SYSTEM", "ADAPTIVE IMMUNE SYSTEM")), .by_group = TRUE) %>%
  mutate(i_process = row_number()) %>%
  pivot_wider(., names_from = "i_process", values_from = "process") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("index") %>%
  mutate(index = as.numeric(index)) %>%
  arrange(desc(index)) %>%
  column_to_rownames("index") %>%
  t() %>%
  as.data.frame() %>%
  replace(is.na(.), ".") %>% 
  mutate(`1` = if_else(`1` == ".", "INNATE IMMUNE SYSTEM", `1`)) %>% 
  rownames_to_column("genes") %>% 
  mutate(genes = rownames(matrix_data)) %>% 
  column_to_rownames("genes")

#Verificar dimensões do dataset
dim(matrix_data)
dim(ann_cols_heatmap)
dim(ann_rows_immune)
```

```{r}
################# Immune 
#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "right")

row_ha = HeatmapAnnotation(df = ann_rows_immune,
                       col = col_process_immune,
                       which= "row",
                       show_annotation_name = F,
                       show_legend = F,
                       simple_anno_size = unit(1, "mm"))
min(matrix_data)

max(matrix_data)
# Values colors
col_fun <- colorRamp2(c(-20, 0, 20), c("#9bc1bc", "white", "#ed6a5a"))

file = filename_2
mat = matrix_data
width_image = 60
height_image = 40
width = unit(50, "cm")
height = unit(30, "cm")
column_names_gp = gpar(fontsize = 8)
row_names_gp = gpar(fontsize = 10)
rect_gp = gpar(col = "gray80", lwd = 0.5)

fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = here("Figures", fileimageheatmap_grouped), 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "Log10 (raw counts)",
                        col = col_fun, #color
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "white",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(0, "cm"),
                        row_split = NULL,
                        column_split = NULL,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(2, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height)

heatmap_plot = draw(heatmap_plot, 
     annotation_legend_side = "left", 
     heatmap_legend_side = "bottom")

dev.off()

```







## 8.2. COVID-19 vaccines types

### All types + Healthy
```{r}
# Input data ----
filename = "ImmuneGO_Genes_Types_"
df = all_matrices_normalized_counts

## Vaccination types
outcomevar = "type"

ann_vaccines_samples_filtered = ann_vaccines_samples %>% 
  mutate(outcomevar = type) %>%
  mutate(type = if_else(day == 0, "H", type)) %>% 
  filter(type != "I") %>% 
  mutate(type = fct_relevel(type, "H"))

#How many samples by level?
count_levels = ann_vaccines_samples_filtered %>% 
  dplyr::count(outcomevar)

count_levels 

#How many levels?
levels = nrow(count_levels)


#Select only important genes
PC1_2 = PC_1_2_cos2
```

### 8.2.1. Train and test

```{r fig.height=10, fig.width=10}
# Prepare data ------

df_input <- df %>%
  rownames_to_column("genes") %>%
  inner_join(PC1_2 %>% select(genes) %>% distinct(), by = "genes") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("sample") %>%
  inner_join(ann_vaccines_samples_filtered %>% select(sample,
                                                      outcomevar), #Outcome
             by = "sample") %>%
  select(sample,
         outcomevar,
         everything()) %>%
  column_to_rownames("sample") %>%
  mutate_if(is.character, factor) %>% 
  mutate(outcomevar = fct_relevel(outcomevar, order_levels))

# glimpse(df_input)

# Split data
set.seed(123)  
split <- initial_split(df_input, prop = 0.6, strata = outcomevar)
trees_train <- training(split)
trees_test <- testing(split)

# Create recipe
tree_rec <- recipe(outcomevar ~ ., data = trees_train) %>% #OUTCOME
  step_dummy(all_nominal(), -all_outcomes()) %>%
  #step_corr(all_numeric_predictors()) %>% 
  step_upsample(outcomevar) #Upsample unbalanced data

tree_prep <- prep(tree_rec)

juiced <- juice(tree_prep)

# Set random forest hyper parameters
tune_spec <- rand_forest(
  mtry = tune(),
  trees = 2000,
  min_n = tune()
) %>%
  set_mode("classification") %>% 
  set_engine("ranger")

# Create workflow
tune_wf <- workflow() %>%
  add_recipe(tree_rec) %>%
  add_model(tune_spec)

#Cross validation
set.seed(234)
trees_folds <- vfold_cv(trees_train)

#Define performance metrics
mer_metrics <- metric_set(yardstick::recall,
                          yardstick::specificity,
                          yardstick::accuracy,
                          yardstick::precision,
                          yardstick::roc_auc,
                          yardstick::pr_auc)

# Parallel computing 
doParallel::registerDoParallel()

set.seed(345)
tune_res <- tune_grid(
  tune_wf,
  metrics = mer_metrics,
  resamples = trees_folds,
  grid = 20
)
```

### 8.2.2. Assess metrics

```{r fig.height=10, fig.width=10}
# Assess data ----

#Metricss
metrics_tuneres = tune_res %>%
  collect_metrics() %>%
  select(mean, min_n, mtry, .metric) %>%
  pivot_longer(min_n:mtry,
    values_to = "value",
    names_to = "parameter") %>%
  ggplot()+
  aes(x = value, y = mean, colour = .metric, label = value) +
  geom_line() +
  geom_label() +
  scale_color_npg()+
  theme_few() +
  theme(axis.text.x = element_text(color = "black", size = 12)) +
  facet_grid(vars(.metric), vars(parameter), scales = "free")

metrics_tuneres

metrics_tuneres %>% ggsave(file = here("Figures",
                                       paste0(filename, 
                                              outcomevar,
                                              "_tuneres_metrics.png")),
                                        width = 10,
                                        height = 10)

min_n_selec = c(3:5) #Observations by node)
mtry_selec = 68:70 #Features/genes by tree)
```

### 8.2.3. Hyperparameter tuning

```{r}
# Tune hyperparameters ----
rf_grid <- grid_regular(
  min_n(range = c(3, 5)),
  mtry(range = c(68, 70)),
  levels = levels
)

set.seed(456)
regular_res <- tune_grid(
  tune_wf,
  metrics = mer_metrics,
  resamples = trees_folds,
  grid = rf_grid
)

# Assess performance -----
regular_res %>%
  collect_metrics()

regular_res %>%
  collect_metrics() %>% 
  write_csv(file = here("Machine learning", paste("metrics_finalmodel_", filename, outcomevar, ".csv")))

#Metrics
regular_res_metrics = regular_res %>%
  collect_metrics() %>%
  select(mean, min_n, mtry, .metric) %>%
  pivot_longer(min_n:mtry,
    values_to = "value",
    names_to = "parameter") %>%
  ggplot()+
  aes(x = value, y = mean, colour = .metric, label = value) +
  geom_line() +
  geom_label(size = 3) +
  scale_color_npg()+
  theme_minimal() +
  facet_grid(vars(.metric), vars(parameter), scales = "free")

regular_res_metrics

# ggsave(regular_res_metrics, file = here("Figures", 
#                                         paste(filename, outcomevar, "metrics", today(), ".png")), 
#        width = 10, height = 10)
```
```{r}
regular_res %>%
  collect_metrics() %>% 
  group_by(id) %>%
  roc_curve(outcomevar...9, .pred_H:.pred_VV) %>%
  ggplot(aes(1 - specificity, sensitivity, color = id)) +
  geom_abline(lty = 2, color = "gray80", size = 1.5) +
  geom_path(show.legend = FALSE, alpha = 0.6, size = 1.2) +
  facet_wrap(~.level, ncol = 5) +
  coord_equal()
```


```{r}
# Select best model -----
best_auc <- select_best(regular_res, metric = "pr_auc")
final_rf <- finalize_model(
  tune_spec,
  best_auc
)
```

### 8.2.4. Important features

```{r fig.height=3, fig.width=5}
final = final_rf %>%
  set_engine("ranger", importance = "permutation") %>%
  fit(outcomevar ~ .,
    data = juice(tree_prep)) %>% 
  vip(num_features = 70)

genes_rf = final$data
genes_rf = genes_rf %>% select(genes = Variable, importance = Importance)
genes_rf %>% write_csv(file = here("Figures", paste0("vipgenes_tidymodels_", filename, outcomevar, ".csv")))


genes_rf_10 = genes_rf %>% 
  arrange(-importance) %>% 
  slice_head(n = 10)
#Importance plot
importance_plot = ggplot(genes_rf_10) +
  aes(x = reorder(genes, importance),
    y = importance,
    fill = importance,
      weight = importance) +
  geom_col() +
  theme_few() +
  xlab("Genes") + 
  ylab("importance") +
  ylim(0, 0.1) +
  geom_text(aes(label = round(importance, 4), y = importance),
            hjust = -0.2, 
            size = 4,
            angle = 0,
            color = "black")+
  scale_fill_gradient(low = "#4DBBD5FF", high = "#DC0000FF") +
  theme(legend.position = "right",
        plot.subtitle = element_text(hjust = 0),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5, size = 12, color = "black"),
        axis.text.y = element_text(size = 12, angle = 0, color = "black"),
        panel.grid.minor.y = element_blank(),
        legend.text = element_text(size=12),
        legend.title = element_text(size = 12, face = "bold")) +
    coord_flip() +
  labs(title = "Top 10 VIP genes",
       subtitle = "Random forest classification model for \nVaccine types vs. Naive",
       x = "",
       y = "Importance",
       color = "Importance") 
importance_plot
ggsave(importance_plot,
        file = here("Figures",
                    paste0("vipgenes_tidymodels_", filename, outcomevar,  ".png")),
        width = 5,
        height = 3)

importance_plot

```

### 8.2.5. Train final model with tuned hyperparameters

```{r}
# Train final model with tuned hyperparameters
final_wf <- workflow() %>%
  add_recipe(tree_rec) %>%
  add_model(final_rf)

final_res <- final_wf %>%
  last_fit(split)

final_res_preds = final_res %>%
  collect_predictions() %>%
  mutate(correct = case_when(
    outcomevar == .pred_class ~ "Correct",
    TRUE ~ "Incorrect"
  )) %>%
  bind_cols(trees_test)


#Confusion matrix
res_conf_mat = conf_mat(final_res_preds, truth = outcomevar...9,
         estimate = .pred_class)

#Accuracy
res_acc = accuracy(final_res_preds, truth = outcomevar...9,
         estimate = .pred_class)

#Specificity
res_spec = spec(final_res_preds, truth = outcomevar...9,
         estimate = .pred_class)

#Precision
res_prec = precision(final_res_preds, truth = outcomevar...9,
         estimate = .pred_class)

#Recall
res_recall = recall(final_res_preds, truth = outcomevar...9,
         estimate = .pred_class)
#Precision recall AUC
res_pr_auc = pr_auc(final_res_preds, outcomevar...9, .pred_RNA)


#Unite results
final_res_metrics = bind_rows(res_acc,
                         res_recall,
                         res_prec,
                         res_pr_auc,
                         res_spec) %>% 
  select(-".estimator")


final_res_metrics_conf = list(res_conf_mat, 
                         final_res_metrics,
                         final_res_preds)

final_res_metrics_conf

final_res_metrics_conf %>% 
  saveRDS(file = here("Machine learning", paste0("final_res_metrics", filename, outcomevar, ".rds")))


#Plot
final_model_metrics = final_res_metrics %>% 
  rename(metric = .metric,
         estimate = .estimate) %>% 
  mutate(metric = fct_relevel(metric, final_res_metrics$.metric)) %>% 
  ggplot() +
  aes(x = estimate,
    y = fct_rev(metric),
    fill = estimate,
    weight = estimate) +
  geom_col() +
  theme_few() +
  geom_text(aes(label = round(estimate, 3), y = metric),
            hjust = -0.2, 
            size = 4,
            angle = 0,
            color = "black") +
  xlim(0, 1.2) +
  scale_fill_gradient(low = "#4DBBD5FF", high = "#DC0000FF") +
  theme(legend.position = "right",
        plot.subtitle = element_text(hjust = 0),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5, size = 12, color = "black"),
        axis.text.y = element_text(size = 12, angle = 0, color = "black"),
        panel.grid.minor.y = element_blank(),
        legend.text = element_text(size=12),
        legend.title = element_text(size = 12, face = "bold")) +
  labs(title = "Model assessment",
       subtitle = "Random forest classification model for \nVaccine types vs. Naive",
       x = "Estimate",
       y = "",
       fill = "Estimate")

ggsave(final_model_metrics,
        file = here("Figures",
                    paste0("final_model_metrics_", filename, outcomevar,  ".png")),
        width = 5,
        height = 3)


#Which are the incorrect?
final_res_preds %>% rownames_to_column("sample") %>%  
  inner_join(ann_vaccines_samples %>% 
               select(condition, sample), by = "sample") %>% 
  filter(correct == "Incorrect") %>% 
  select(sample, condition, everything()) %>% 
  view()
```

Multi ROC
```{r fig.height=5, fig.width=5}
multi_roc = final_res_preds %>% 
  group_by(id) %>%
  roc_curve(outcomevar...9, .pred_H:.pred_VV) %>%
  ggplot(aes(1 - specificity, sensitivity, color = .level)) +
  geom_abline(lty = 2, color = "gray80", size = 0.5) +
  geom_path(show.legend = FALSE, alpha = 0.6, size = 1.2) +
  facet_wrap(~.level, ncol = 3) +
  coord_equal() +
  theme_few() +
    theme(axis.text = element_text(size = 6, color = "black")) +
  labs(title ="Receiver-operator curve",
       subtitle = "Multiclass classification, Randomforest",
       x = "1-Specificity",
       y = "Sensitivity") +
  scale_colour_manual(values = c(ann_vaxsig_colors$type[names(ann_vaxsig_colors$type) != "H"], 
                                 H = "black"))
```

Confusion matrix
```{r fig.height=5, fig.width=5}
conf_matrix_heat = final_res_preds %>% 
  conf_mat(outcomevar...9, .pred_class) %>%
  autoplot(type = "heatmap") +
  scale_fill_gradient(low = "white", high = "#DC0000FF") +
  labs(title ="Confusion matrix",
       subtitle = "Multiclass classification, Randomforest",
       x = "Truth",
       y = "Prediction")

conf_matrix_heat / 
  multi_roc
  
```

Precision recall curve
```{r}
# Precision recall
pr_curve_res = pr_curve(final_res_preds, outcomevar...6, .pred_I) %>% 
  ggplot(aes(x = recall, y = precision)) +
  geom_path(color = "#DC0000FF",
            size = 2) +
  coord_equal() +
  theme_few() +
  labs(title = "Precision-Recall curve",
       subtitle = "Random forest classification \nmodel for Infection vs. Vaccination",
       x = "Recall",
       y = "Precision") 


pr_curve_res %>% 
  ggsave(file = here("Figures",
                    paste0("PR_Curve_tidymodels_", filename, outcomevar,  ".png")),
         width = 4,
         height = 3)
  
```

```{r}
#Matrix counts of VIP genes
all_matrices_counts_genesRF = all_matrices_counts_long_annotated %>% 
  inner_join(genes_rf %>% 
               select(genes = Variable), by = "genes")
```


Relative effects

Function
```{r fig.height=5, fig.width=7}
REffect <- function(data, dep_vars, indep_var, n_boot = 1000, 
                    plot = TRUE, plot_colors = c("red", "darkblue"), 
                    plot_labels = list(y = "Relative effect", x = "Genes"), 
                    plot_theme = theme_few(), plot_legend_position = "top", 
                    plot_legend_labels = c("Vaccination", "Infection")) {
  
  library(npmv)
  library(ggplot2)
  library(reshape2)
  
  if(!all(data[[indep_var]] %in% c(0, 1))) {
    stop("A variável independente precisa conter apenas 0 e 1 (dois grupos).")
  }
  
  n_aab <- nrow(data)
  list_boot_aab <- list()
  
  # Loop de Bootstrap
  for (i in 0:n_boot) {
    if (i == 0) {
      df_sample <- 1:n_aab
    } else {
      df_sample <- sample(1:n_aab, n_aab, replace = TRUE)
    }
    
    formula_str <- paste(dep_vars, collapse = " | ")
    formula <- as.formula(paste(formula_str, "~", indep_var))
    
    manova_aab <- nonpartest(formula, data = data[df_sample, ], permtest = FALSE, plots = FALSE,
                             permreps = 1000, tests = c(1, 0, 0, 0))
    
    if (i == 0) obs_aab <- manova_aab
    
    list_boot_aab[[i + 1]] <- manova_aab
    
    cat("ANOVA/ boot/ aab/ i = ", i, "\n")
  }
  
  obs_manova <- list_boot_aab[[1]]$twogroupreleffects
  row_manova <- rownames(obs_manova)
  
  releffects <- lapply(list_boot_aab[-1], "[[", 2)
  
  df_perc_boot <- lapply(seq_len(nrow(obs_manova)), function(i) {
    q <- sapply(seq_len(ncol(obs_manova)), function(j) {
      v <- sapply(releffects, function(r) {
        row <- rownames(r)
        if(row[1] != row_manova[1]) r <- r[2:1,]
        r[i, j]
      })
      quantile(v, probs = c(0.025, 0.975))
    })
    colnames(q) <- colnames(obs_manova)
    df <- data.frame(Var2 = colnames(q), t(q),
                     group = ifelse(i == 1, row_manova[1], row_manova[2]))
    df$Var2 <- factor(df$Var2, levels = sort(unique(df$Var2)), ordered = TRUE)
    return(df)
  })
  
  names(df_perc_boot) <- row_manova
  
  df <- reshape2::melt(
    cbind(obs_manova, group = row_manova),
    id.vars = "group"
  )
  df$Var1 <- "point_est"
  df <- df[, c(4, 2, 3, 1)]
  colnames(df)[2] <- "Var2"
  
  df <- dplyr::arrange(df, group, desc(value), Var2)
  df$Var2 <- as.character(df$Var2)
  df$Var2 <- factor(df$Var2, levels = unique(df$Var2), ordered = TRUE)
  
  for (k in seq_len(2)) {
    df_perc_boot[[k]]$Var2 <- factor(df_perc_boot[[k]]$Var2, levels = levels(df$Var2), ordered = TRUE)
  }
  
  if (plot) {
    p <- ggplot(data = df, aes(x = Var2, y = value, group = group, color = group)) +
      geom_ribbon(inherit.aes = FALSE, data = df_perc_boot[[1]],
                  aes(x = Var2, ymin = X2.5., ymax = X97.5., group = group), fill = plot_colors[1],
                  alpha = 0.3) +
      geom_ribbon(inherit.aes = FALSE, data = df_perc_boot[[2]],
                  aes(x = Var2, ymin = X2.5., ymax = X97.5., group = group), fill = plot_colors[2],
                  alpha = 0.3) +
      geom_line() +
      geom_point(aes(size = value)) +
      scale_colour_manual("", values = c("1" = plot_colors[2], "0" = plot_colors[1]),
                          labels = plot_legend_labels) +
      plot_theme +
      theme(
        legend.text = element_text(size = 12),
        axis.text.x = element_text(size = 12, angle = 90),
        axis.text.y = element_text(size = 12),
        axis.line.y = element_blank(),
        axis.title = element_text(size = 15),
        panel.grid.major = element_line(),
        legend.position = plot_legend_position,
        legend.box.background = element_rect()
      ) +
      labs(y = plot_labels$y, x = plot_labels$x)
    
    print(p)
  }
  
  return(list(obs_manova = obs_manova, df_perc_boot = df_perc_boot, plot = p))
}
```

Plot
```{r fig.height=5, fig.width=7, message=FALSE, warning=FALSE}
head(all_matrices_counts_genesRF)

covid_vac_releff = all_matrices_counts_genesRF %>% 
  select(genes, sample, counts) %>% 
  pivot_wider(names_from = "genes",
              values_from = "counts") %>% 
  inner_join(all_matrices_counts_genesRF %>% 
               select(sample, disease_vac), by = "sample") %>% 
  mutate(disease_vac = if_else(disease_vac == "I", 1, 0))


releffect_disease_vac = REffect(covid_vac_releff, dep_vars = colnames(covid_vac_releff %>% 
                                              select(-disease_vac, -sample)),
        indep_var = "disease_vac", plot_colors = c("red", "#4DBBD5FF"), 
        n_boot=1000)


plot = releffect_disease_vac$plot +
  scale_colour_manual(values = c("1" = "#DC0000FF", 
                                 "0" = "#4DBBD5FF"),
                      labels = plot_legend_labels) +
  geom_ribbon(inherit.aes = FALSE, data = releffect_disease_vac$df_perc_boot[[1]],
                  aes(x = Var2, ymin = X2.5., ymax = X97.5., group = group), fill = "#4DBBD5FF",
                  alpha = 0.3) +
      geom_ribbon(inherit.aes = FALSE, data = releffect_disease_vac$df_perc_boot[[2]],
                  aes(x = Var2, ymin = X2.5., ymax = X97.5., group = group), fill = "#DC0000FF",
                  alpha = 0.3) +
  theme(
        legend.text = element_text(size = 12),
        axis.text.x = element_text(size = 12, angle = 45, hjust = 1, vjust = 1, color = "black"),
        axis.text.y = element_text(size = 12, color = "black"),
        axis.line.y = element_blank(),
        axis.title = element_text(size = 15),
        panel.grid.major = element_line(),
        legend.position = "top",
        plot.title = element_text(hjust = 0.5, size = 20),
        plot.subtitle = element_text(hjust = 0.5, size = 15),
        legend.box.background = element_blank()
      ) +
      labs(y = "Relative effect", x = "Genes",
           title = "Relative effects of VIP genes",
           subtitle = "Infection vs. Vaccination",
           color = "") +
  ylim(0, 1)

plot

```


### 8.2.6. Heatmap: Gene L2FC per condition

```{r}
# Required files
ImmuneGO_Annotated_Genes = readRDS(here("VaxGO gene sets","ImmuneGO_Annotated_Genes_2024-03-26.rds"))
all_degs_p_05_vac_infected = read_csv(here("DGE analysis", "all_degs_p_05_vac_infected_19_12_23.csv"))
ann_vaccines <- read_csv(here("Annotations and metadata", "ann_vaccines_conditions.csv"))
df = read_csv("Figures/vipgenes_tidymodels_ImmuneGO_Genes_Types_type.csv") %>% 
  slice_head(n=10)
#Inputs
ImmuneGO_Annotated_Genes_all = ImmuneGO_Annotated_Genes %>% 
  filter(!process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE"))

ImmuneGO_Genes = all_degs_p_05_vac_infected %>% 
  filter(disease_vac != "I") %>% 
  filter(genes%in% df$genes) %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% 
               select(genes, process) %>% 
               distinct() %>% 
               select(genes),
               by = "genes") %>% 
  distinct() %>% 
  select(genes, condition, log2fold_change) %>% 
  pivot_wider(names_from = condition, values_from = log2fold_change)

# Matrix
l2fc_imps = ImmuneGO_Genes %>% 
  column_to_rownames("genes") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0)


####### INPUT
data_2 = l2fc_imps
outcomevar = "VaccineType_excludingInfection"
filename_2 = paste0("RandomForest_ImmuneGO_Genes_Conditions_", outcomevar)

######## Matrix
matrix = ImmuneGO_Genes

######## Annotations
ann_vaccines_covid_other_2 = ImmuneGO_Genes %>% 
  column_to_rownames("genes") %>% 
  colnames() %>% 
  as.data.frame() %>% 
  select(condition = ".") %>% 
  inner_join(ann_vaccines, by = "condition") %>% 
  distinct() %>% 
  select(condition, disease_vac, type, week, day) %>% 
  arrange(week, day) %>% 
  mutate(week = fct_relevel(as.factor(week), sort(levels(week))),
         day = fct_relevel(as.factor(day), sort(levels(day)))) 

```


```{r}
#Columns
ann_cols_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  inner_join(ann_vaccines_covid_other_2, by = "condition") %>% 
  distinct() %>% 
  arrange(condition) %>% 
  column_to_rownames("condition")

matrix_data = matrix %>% 
  column_to_rownames("genes") %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  inner_join(ann_cols_heatmap %>% rownames_to_column("condition"), by = "condition") %>% 
  select(!c(disease_vac:day)) %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>%
  as.matrix()  %>% 
  replace(is.na(.), 0)

#Rows Immune ----
ann_rows_immune = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  left_join(ImmuneGO_Annotated_Genes %>% filter(go_term == "Manual"), by = "genes") %>%
  select(genes, process) %>%
  distinct() %>%
  group_by(genes) %>%
  arrange(genes, factor(process, levels = c("INNATE IMMUNE SYSTEM", "ADAPTIVE IMMUNE SYSTEM")), .by_group = TRUE) %>%
  mutate(i_process = row_number()) %>%
  pivot_wider(., names_from = "i_process", values_from = "process") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("index") %>%
  mutate(index = as.numeric(index)) %>%
  arrange(desc(index)) %>%
  column_to_rownames("index") %>%
  t() %>%
  as.data.frame() %>%
  replace(is.na(.), ".") %>% 
  mutate(`1` = if_else(`1` == ".", "INNATE IMMUNE SYSTEM", `1`)) %>% 
  rownames_to_column("genes") %>% 
  mutate(genes = rownames(matrix_data)) %>% 
  column_to_rownames("genes")

#Verificar dimensões do dataset
dim(matrix)
dim(matrix_data)
dim(ann_cols_heatmap)
dim(ann_rows_immune)
```

```{r}
################# Immune 
#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "right")

row_ha = HeatmapAnnotation(df = ann_rows_immune,
                       col = col_process_immune,
                       which= "row",
                       show_annotation_name = F,
                       show_legend = F,
                       simple_anno_size = unit(1, "mm"))

# Values colors
col_fun <- colorRamp2(c(-1, 0, 1), c("#9bc1bc", "white", "#ed6a5a"))

file = filename_2
mat = matrix_data
width_image = 30
height_image = 15
width = unit(15, "cm")
height = unit(5, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)
rect_gp = gpar(col = "gray80", lwd = 0.5)

fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = here("Figures", fileimageheatmap_grouped), 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "L2FC",
                        col = col_fun, #color
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "white",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(0, "cm"),
                        row_split = NULL,
                        column_split = NULL,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(2, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height)

heatmap_plot = draw(heatmap_plot, 
     annotation_legend_side = "left", 
     heatmap_legend_side = "bottom")

dev.off()

```
### 8.2.6. Heatmap: Gene counts per sample

```{r}
# Required files
ImmuneGO_Annotated_Genes = readRDS(here("VaxGO gene sets","ImmuneGO_Annotated_Genes_2024-03-26.rds"))
#df = all_matrices_counts_genesRF
df = all_samples_l2fc %>% 
  filter(genes %in% genes_rf$Variable)

ann_vaccines_samples <- read_csv(here("Annotations and metadata", "ann_vaccines_samples.csv")) %>% 
  mutate(disease_vac = if_else(disease_vac == "Healthy", "H", disease_vac)) %>% 
  filter(disease_vac != "I")
```


```{r}
#Inputs
ImmuneGO_Annotated_Genes_all = ImmuneGO_Annotated_Genes %>% 
  filter(!process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE"))

ImmuneGO_Genes = df %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% 
               select(genes, process) %>% 
               distinct() %>% 
               select(genes),
               by = "genes") %>% 
  distinct() %>% 
  select(genes, sample, log2fc) %>% 
  pivot_wider(names_from = sample, values_from = log2fc)


sample_correct =final_res_preds %>% 
  rownames_to_column("sample") %>%  
  inner_join(ann_vaccines_samples %>% 
               select(condition, sample), by = "sample") %>% 
  select(sample, correct) 

# Matrix
l2fc_imps = ImmuneGO_Genes %>% 
  column_to_rownames("genes") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0)

####### INPUT
data_2 = l2fc_imps
filename_2 = paste0("RandomForest_ImmuneGO_Genes_Samples_", outcomevar)

######## Matrix
matrix = ImmuneGO_Genes

######## Annotations
ann_vaccines_covid_other_2 = ImmuneGO_Genes %>% 
  column_to_rownames("genes") %>% 
  colnames() %>% 
  as.data.frame() %>% 
  select(sample = ".") %>% 
  inner_join(ann_vaccines_samples, by = "sample") %>% 
  distinct() %>% 
  select(sample, disease_vac, type, week, day) %>% 
  arrange(week, day) %>% 
  mutate(week = fct_relevel(as.factor(week), sort(levels(week))),
         day = fct_relevel(as.factor(day), sort(levels(day)))) %>% 
  inner_join(sample_correct, by = "sample")
  

#Columns
ann_cols_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(sample = '.') %>% 
  inner_join(ann_vaccines_covid_other_2, by = "sample") %>% 
  distinct() %>% 
  arrange(sample) %>% 
  column_to_rownames("sample")

matrix_data = matrix %>% 
  column_to_rownames("genes") %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "sample") %>% 
  inner_join(ann_cols_heatmap %>% rownames_to_column("sample"), by = "sample") %>% 
  select(!c(disease_vac:day, correct)) %>% 
  arrange(sample) %>% 
  column_to_rownames("sample") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>%
  as.matrix()  %>% 
  replace(is.na(.), 0)

#Rows Immune ----
ann_rows_immune = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  left_join(ImmuneGO_Annotated_Genes %>% filter(go_term == "Manual"), by = "genes") %>%
  select(genes, process) %>%
  distinct() %>%
  group_by(genes) %>%
  arrange(genes, factor(process, levels = c("INNATE IMMUNE SYSTEM", "ADAPTIVE IMMUNE SYSTEM")), .by_group = TRUE) %>%
  mutate(i_process = row_number()) %>%
  pivot_wider(., names_from = "i_process", values_from = "process") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("index") %>%
  mutate(index = as.numeric(index)) %>%
  arrange(desc(index)) %>%
  column_to_rownames("index") %>%
  t() %>%
  as.data.frame() %>%
  replace(is.na(.), ".") %>% 
  mutate(`1` = if_else(`1` == ".", "INNATE IMMUNE SYSTEM", `1`)) %>% 
  rownames_to_column("genes") %>% 
  mutate(genes = rownames(matrix_data)) %>% 
  column_to_rownames("genes")

#Verificar dimensões do dataset
dim(matrix_data)
dim(ann_cols_heatmap)
dim(ann_rows_immune)
```

```{r}
################# Immune 
#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "right")

row_ha = HeatmapAnnotation(df = ann_rows_immune,
                       col = col_process_immune,
                       which= "row",
                       show_annotation_name = F,
                       show_legend = F,
                       simple_anno_size = unit(1, "mm"))
min(matrix_data)

max(matrix_data)
# Values colors
col_fun <- colorRamp2(c(-20, 0, 20), c("#9bc1bc", "white", "#ed6a5a"))

file = filename_2
mat = matrix_data
width_image = 60
height_image = 40
width = unit(50, "cm")
height = unit(30, "cm")
column_names_gp = gpar(fontsize = 8)
row_names_gp = gpar(fontsize = 10)
rect_gp = gpar(col = "gray80", lwd = 0.5)

fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = here("Figures", fileimageheatmap_grouped), 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "Log10 (raw counts)",
                        col = col_fun, #color
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "white",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(0, "cm"),
                        row_split = NULL,
                        column_split = NULL,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(2, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height)

heatmap_plot = draw(heatmap_plot, 
     annotation_legend_side = "left", 
     heatmap_legend_side = "bottom")

dev.off()

```


## 8.6. COVID-19 and others: up and down

```{r}
# Input data ----
filename = "COVID_Others_ImmuneGO_Genes_Type_including_Infection_"
degs_covid_vax = readRDS("~/Desktop/Github - Covid Atlas/VaxGO gene sets/degs_covid_vaxsig_up_down_immune.rds")
data_annotation = read_csv(here("Annotations and metadata", "ann_vaccines_vaxsig_covid.csv")) %>% 
  select(condition, target_pathogen_disease, type, week)

df = degs_covid_vax %>% 
  select(condition, genes, regulation_numeric) %>% 
  distinct() %>% 
  pivot_wider(names_from = genes,
              values_from = regulation_numeric,
              values_fn = mean) %>% 
  inner_join(data_annotation , by = "condition")

## Vaccination types
outcomevar = "type"

ann_vaccines_samples_filtered = df %>% 
  mutate(outcomevar = type) %>% 
  select(-type) %>% 
  select(target_pathogen_disease, week, outcomevar, condition, everything())
  #filter(!outcomevar %in% c("CONJ", "VLP", "SU", "I")) #Remove classes with few rows

#How many samples by level?
count_levels = ann_vaccines_samples_filtered %>% 
  count(outcomevar)

count_levels

#How many levels?
levels = nrow(count_levels)
```

### 8.6.1. Train and test

```{r}
# Prepare data ------

df_input <- ann_vaccines_samples_filtered %>% 
  distinct() %>% 
  column_to_rownames("condition") %>%
  mutate_if(is.character, factor) %>% 
  mutate(week = as.factor(week),
         week = fct_relevel(week, -week)) %>% 
  replace(is.na(.), 0)

glimpse(df_input)

# Split data
set.seed(123)  
split <- initial_split(df_input, prop = 0.6, strata = outcomevar)
train <- training(split)
test <- testing(split)

# Create recipe
base_rec <- recipe(outcomevar ~ ., data = train) %>%
  step_dummy(all_nominal(), -all_outcomes())

base_rec <- prep(base_rec)
juiced <- juice(base_rec)
juiced %>% 
  glimpse()

#Cross validation
set.seed(764)
cv_folds <- vfold_cv(
  data = train, 
  v = 5
  ) 
```

### 8.6.2. Workflowsets

```{r}
#Recipe
base_rec <- recipe(outcomevar ~ ., data = train) %>%
  step_dummy(all_nominal(), -all_outcomes()) %>%
  step_upsample(outcomevar)

# Definir os modelos
glm_model <- logistic_reg() %>%
  set_engine("glm")

rf_model <- rand_forest(trees = tune(), 
                        min_n = tune(), 
                        mtry = tune()) %>%
  set_engine("ranger") %>%
  set_mode("classification")

tree_model <- decision_tree() %>%
  set_engine("rpart") %>%
  set_mode("classification")

knn_model <- nearest_neighbor(neighbors = tune()) %>%
  set_engine("kknn") %>%
  set_mode("classification")

nn_model <- mlp(hidden_units = tune(), 
                penalty = tune()) %>%
  set_engine("nnet") %>%
  set_mode("classification")

# Criar os workflows
glm_wf <- workflow() %>%
  add_model(glm_model) %>%
  add_recipe(base_rec)

rf_wf <- workflow() %>%
  add_model(rf_model) %>%
  add_recipe(base_rec)

tree_wf <- workflow() %>%
  add_model(tree_model) %>%
  add_recipe(base_rec)

knn_wf <- workflow() %>%
  add_model(knn_model) %>%
  add_recipe(base_rec)

nn_wf <- workflow() %>%
  add_model(nn_model) %>%
  add_recipe(base_rec)

# Criar o conjunto de workflows
wf_set <- workflow_set(
  preproc = list(base_rec),
  models = list(glm = glm_model, 
                rf = rf_model, 
                tree = tree_model, 
                knn = knn_model, 
                nn = nn_model)
)

#Tuning
doParallel::registerDoParallel(cores = 10)
 
tic()
 
fit_wf <- wf_set %>%  
  workflow_map(
    seed = 44, 
    fn = "tune_grid",
    grid = 10,           ## parameters to pass to tune grid
    resamples = cv_folds
  )
 
toc()
 
doParallel::stopImplicitCluster()
 
fit_wf

#Evaluate
## plot each of the model's performance and ROC
autoplot(fit_wf)
 
## Look at the model metrics for each of the models
collect_metrics(fit_wf) 
 
## Rank the results based on model accuracy
rank_results(fit_wf, rank_metric = "accuracy", select_best = TRUE)

```

## 8.7. (FAZER) COVID-19 and others: 13 Vaccines atlas dataset

# 9. Heatmaps - Genes - ImmuneGO

Import files

```{r }
############## Import files

# ImmuneGO 
ImmuneGO_Annotated_GO = read_csv(here("VaxGO gene sets", "ImmuneGO_Annotated_GO_2024_03_26.csv"))
ImmuneGO_Annotated_Genes = readRDS(here("VaxGO gene sets",  "ImmuneGO_Annotated_Genes_2024-03-26.rds"))

# Informations about gene sets
ImmuneGO = ImmuneGO_Annotated_GO %>% 
  select(process:immune_tissue, set_size) %>% 
  distinct()

# Filter only manual annotated gene sets
immunego_genes = ImmuneGO_Annotated_Genes %>%
  filter(go_term == "Manual") %>% 
  select(process,genes)
ann_vaccines = read_csv(here("Annotations and metadata", "ann_vaccines_conditions.csv")) %>% 
  mutate(week = fct_reorder(as.factor(week), week),
         day = fct_reorder(as.factor(day), day),
         dose = fct_reorder(as.factor(dose), dose))

# DEGs table
data.immunego = read_csv(here("DGE analysis", "all_degs_p_05_vac_infected_19_12_23.csv")) %>% 
  select(condition:padj)

#Colors
ann_colors = ann_vaxsig_colors 
```

Process data

```{r }
############## Process data

# All gene sets
Immune_GO_genes_All = data.immunego %>% 
  merge(immunego_genes, by = "genes", all.x = F, all.y=F) %>% 
  merge(ann_vaccines, by = "condition", all.y=F) %>% 
  clean_names()

###### Other immune gene sets
Immune_GO_genes_general = Immune_GO_genes_All %>%
  filter(process == "GENERAL")
Immune_GO_genes_antimicrobial = Immune_GO_genes_All %>%
  filter(process == "ANTIMICROBIAL")
Immune_GO_genes_Innate = Immune_GO_genes_All %>%
 filter(process == "INNATE IMMUNE SYSTEM")
Immune_GO_genes_Adaptive = Immune_GO_genes_All %>%
 filter(process == "ADAPTIVE IMMUNE SYSTEM")

# Innate immune system
Immune_GO_genes_Inflammation = Immune_GO_genes_All %>%
  filter(process == "INFLAMMATION")
Immune_GO_genes_ARPP = Immune_GO_genes_All %>%
  filter(process == "ARPP")
Immune_GO_genes_IFN = Immune_GO_genes_All %>%
  filter(process == "ANTIVIRAL & IFN")
Immune_GO_genes_Neutrophil = Immune_GO_genes_All %>%
  filter(process == "NEUTROPHIL")
Immune_GO_genes_Eosinophil = Immune_GO_genes_All %>%
  filter(process == "EOSINOPHIL")
Immune_GO_genes_Complement = Immune_GO_genes_All %>%
  filter(process == "COMPLEMENT")
Immune_GO_genes_Monocytes = Immune_GO_genes_All %>%
  filter(process == "MONOCYTE")
Immune_GO_genes_DC = Immune_GO_genes_All %>%
  filter(process == "DENDRITIC CELL")
Immune_GO_genes_Macro = Immune_GO_genes_All %>%
  filter(process == "MACROPHAGE")
Immune_GO_genes_NK = Immune_GO_genes_All %>%
  filter(process == "NK CELL")
Immune_GO_genes_Mast = Immune_GO_genes_All %>%
  filter(process == "MAST CELL") %>%
  distinct()

# Adaptive immune system
Immune_GO_genes_Cellular = Immune_GO_genes_All %>%
  filter(process == "CELLULAR ADAPTIVE IMMUNE SYSTEM")
Immune_GO_genes_Humoral = Immune_GO_genes_All %>%
  filter(process == "HUMORAL ADAPTIVE IMMUNE SYSTEM")
Immune_GO_genes_Tcells = Immune_GO_genes_All %>%
  filter(process == "T CELL")
Immune_GO_genes_Th = Immune_GO_genes_All %>%
  filter(process == "T HELPER CELLS")
Immune_GO_genes_Bcells = Immune_GO_genes_All %>%
  filter(process == "B CELL")
Immune_GO_genes_Ig = Immune_GO_genes_All %>%
  filter(process == "IMMUNOGLOBULIN MEDIATED RESPONSE") %>%
  distinct()

```

### Interactive heatmap version - All immmune genes

```{r}
library(InteractiveComplexHeatmap)

####### Input
heatmap_data = Immune_GO_genes_All
file = "Immune_GO_genes_All"

###### Process data

heatmap_data_l2fc= heatmap_data %>% 
  filter(condition != "NA", 
         process != "NA") %>% 
  select(genes, condition, log2fold_change)

# Convert to wide table
matrix_data <- dcast(heatmap_data_l2fc, 
                         genes ~ condition, 
                         value.var = "log2fold_change", 
                         fun.aggregate = mean) %>% 
  column_to_rownames('genes') %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0)

matrix_data_ready =  matrix_data %>% 
  round(2)

# Check if all vaccines are in the matrix and join annotations
ann_vaccines_complex = heatmap_data %>% 
  select(condition) %>% 
  distinct() %>% 
  inner_join(ann_vaccines %>% select(condition, disease_vac, type, week), by = "condition")

# Join annotations
ann_vaccines_heatmap = matrix_data %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  merge(ann_vaccines_complex, by = "condition", all.x = TRUE) %>% 
  arrange(condition) %>% 
  column_to_rownames(var= "condition") 


#Rows Immune ----
ann_rows_immune = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  left_join(ImmuneGO_Annotated_Genes %>%
              filter(go_term == "Manual",
                     !process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE")), by = "genes") %>%
  select(genes, process) %>%
  distinct() %>%
  group_by(genes) %>%
  arrange(genes, factor(process, levels = c("INNATE IMMUNE SYSTEM", "ADAPTIVE IMMUNE SYSTEM")), .by_group = TRUE) %>%
  mutate(i_process = row_number()) %>%
  pivot_wider(., names_from = "i_process", values_from = "process") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("index") %>%
  mutate(index = as.numeric(index)) %>%
  arrange(desc(index)) %>%
  column_to_rownames("index") %>%
  t() %>%
  as.data.frame() %>%
  replace(is.na(.), ".")

# Reorder columns (same order as lines in the annotation table)
matrix_data_ordered = matrix_data %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  merge(ann_vaccines_complex, by.y = "condition", all.x=TRUE) %>% 
  arrange(condition) %>% 
  select(!c(disease_vac, type, week)) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0) %>% 
  as.matrix() 


#Check dimensions
dim(matrix_data_ordered) 
dim(ann_vaccines_heatmap) 
dim(ann_rows_immune)
```


```{r}
#Create heatmap annotation
ha = HeatmapAnnotation(df = ann_vaccines_heatmap, 
                       col = ann_colors, 
                       annotation_name_side = "left")

row_ha = HeatmapAnnotation(df = ann_rows_immune,
                       col = col_process_immune,
                       which= "row",
                       show_annotation_name = F,
                       show_legend = F)

col_fun <- colorRamp2(c(-2, 0, 2), 
                      c("#9bc1bc", "white", "#ed6a5a"))

#Parameters
mat = matrix_data_ordered
width_image = 40
height_image = 40
width = unit(30, "cm")
height = unit(50, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)


#Plot and save
fileimageheatmap_ungrouped= here("Figures", paste0(file, sep ="_", "Ungrouped_Complexheatmap.png"))

png(file = fileimageheatmap_ungrouped, width=width_image, height=height_image,units="cm",res=800)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "vertical"),
                        name = "L2FC", #Legend
                        col = col_fun,
                        show_row_dend = F,
                        row_split = 2, #Split group clusters
                        show_row_names = F,
                        column_names_gp = column_names_gp,
                        row_names_gp = row_names_gp)

ht_list = draw(heatmap_plot_all, 
               annotation_legend_side = "right", 
               heatmap_legend_side = "right")


draw(heatmap_plot_all, annotation_legend_side = "right", heatmap_legend_side = "right")

dev.off()
```

Interactive
```{r}
#Parameters
mat = matrix_data_ordered
width_image = 40
height_image = 90
width = unit(30, "cm")
height = unit(80, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "vertical"),
                        name = "L2FC", #Legend
                        col = col_fun,
                        show_row_dend = F,
                        row_split = 2, #Split group clusters
                        show_row_names = F,
                        column_names_gp = column_names_gp,
                        row_names_gp = row_names_gp)

ht_list = draw(heatmap_plot_all, 
               annotation_legend_side = "right", 
               heatmap_legend_side = "right")
htShiny(ht_list)

htShiny(ht_list, save = "Interactive_CovidOnly_Heatmap")

```

### 9.1. General

```{r}
####### Input
heatmap_data = Immune_GO_genes_general
file = "Immune_GO_genes_general"

###### Process data

heatmap_data_l2fc= heatmap_data %>% 
  filter(condition != "NA", 
         process != "NA") %>% 
  select(genes, condition, log2fold_change)

# Convert to wide table
matrix_data <- dcast(heatmap_data_l2fc, 
                         genes ~ condition, 
                         value.var = "log2fold_change", 
                         fun.aggregate = mean) %>% 
  column_to_rownames('genes') %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0)

matrix_data_ready =  matrix_data %>% 
  round(2)

# Check if all vaccines are in the matrix and join annotations
ann_vaccines_complex = heatmap_data %>% 
  select(condition) %>% 
  distinct() %>% 
  inner_join(ann_vaccines %>% select(condition, disease_vac, type, week), by = "condition")

# Join annotations
ann_vaccines_heatmap = matrix_data %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  merge(ann_vaccines_complex, by = "condition", all.x = TRUE) %>% 
  arrange(condition) %>% 
  column_to_rownames(var= "condition") 

# Reorder columns (same order as lines in the annotation table)
matrix_data_ordered = matrix_data %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  merge(ann_vaccines_complex, by.y = "condition", all.x=TRUE) %>% 
  arrange(condition) %>% 
  select(!c(disease_vac, type, week)) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0) %>% 
  as.matrix() 

#Check dimensions
dim(matrix_data_ordered) 
dim(ann_vaccines_heatmap) 


#Create heatmap annotation
ha = HeatmapAnnotation(df = ann_vaccines_heatmap, 
                       col = ann_colors, 
                       annotation_name_side = "left")


col_fun <- colorRamp2(c(-2, 0, 2), 
                      c("#9bc1bc", "white", "#ed6a5a"))


#Parameters
mat = matrix_data_ordered
width_image = 40
height_image = 90
width = unit(30, "cm")
height = unit(80, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 3)


#Plot and save
fileimageheatmap_ungrouped= here("Figures", paste0(file, sep ="_", "Ungrouped_Complexheatmap.png"))

png(file = fileimageheatmap_ungrouped, width=width_image, height=height_image,units="cm",res=800)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = ha,
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "L2FC", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = gpar(fontsize = 10),
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_split = NULL, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        #column_split = 2, #Split group clusters
                        #column_km = 2,
                        column_gap = unit(8, "mm"),
                        show_column_dend = TRUE,
                        show_row_dend = TRUE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = width, 
                        height = height
)

draw(heatmap_plot_all, annotation_legend_side = "right", heatmap_legend_side = "right")

dev.off()
```

### 9.2. Antimicrobial

```{r}
####### Input

heatmap_data = Immune_GO_genes_antimicrobial
file = "Immune_GO_genes_antimicrobial"

heatmap_data_l2fc= heatmap_data %>% 
  filter(condition != "NA", 
         process != "NA") %>% 
  select(genes, condition, log2fold_change)

matrix_data <- dcast(heatmap_data_l2fc, 
                         genes ~ condition, 
                         value.var = "log2fold_change", 
                         fun.aggregate = mean) %>% 
  column_to_rownames('genes') %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0)

matrix_data_ready =  matrix_data %>% 
  round(2)

ann_vaccines_complex = heatmap_data %>% 
  select(condition) %>% 
  distinct() %>% 
  inner_join(ann_vaccines %>% select(condition, disease_vac, type, week), by = "condition")

ann_vaccines_heatmap = matrix_data %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  merge(ann_vaccines_complex, by = "condition", all.x = TRUE) %>% 
  arrange(condition) %>% 
  column_to_rownames(var= "condition") 

matrix_data_ordered = matrix_data %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  merge(ann_vaccines_complex, by.y = "condition", all.x=TRUE) %>% 
  arrange(condition) %>% 
  select(!c(disease_vac, type, week)) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0) %>% 
  as.matrix() 

dim(matrix_data_ordered)
dim(ann_vaccines_heatmap)

ha = HeatmapAnnotation(df = ann_vaccines_heatmap, 
                       col = ann_colors, 
                       annotation_name_side = "left")


col_fun <- colorRamp2(c(-2, 0, 2), 
                      c("#9bc1bc", "white", "#ed6a5a"))

mat = matrix_data_ordered
width = unit(30, "cm")
height = unit(20, "cm")
width_image = 40
height_image = 30
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)

fileimageheatmap_ungrouped = here("Figures", paste0(file, sep ="_", "Ungrouped_Complexheatmap.png"))
png(file = fileimageheatmap_ungrouped, width=width_image, height=height_image,units="cm",res=800)
heatmap_plot_all = Heatmap(mat,
                        top_annotation = ha,
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "L2FC", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = gpar(fontsize = 10),
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_split = NULL, 
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(8, "mm"),
                        show_column_dend = TRUE,
                        show_row_dend = TRUE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = width, 
                        height = height
)

draw(heatmap_plot_all, annotation_legend_side = "right", heatmap_legend_side = "right")

dev.off()
```

### 9.3. Complement

```{r}
heatmap_data = Immune_GO_genes_Complement
file = "Immune_GO_genes_Complement"

heatmap_data_l2fc= heatmap_data %>% 
  filter(condition != "NA", 
         process != "NA") %>% 
  select(genes, condition, log2fold_change)

matrix_data <- dcast(heatmap_data_l2fc, 
                         genes ~ condition, 
                         value.var = "log2fold_change", 
                         fun.aggregate = mean) %>% 
  column_to_rownames('genes') %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0)

matrix_data_ready =  matrix_data %>% 
  round(2)

ann_vaccines_complex = heatmap_data %>% 
  select(condition) %>% 
  distinct() %>% 
  inner_join(ann_vaccines %>% select(condition, disease_vac, type, week), by = "condition")

ann_vaccines_heatmap = matrix_data %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  merge(ann_vaccines_complex, by = "condition", all.x = TRUE) %>% 
  arrange(condition) %>% 
  column_to_rownames(var= "condition") 

matrix_data_ordered = matrix_data %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  merge(ann_vaccines_complex, by.y = "condition", all.x=TRUE) %>% 
  arrange(condition) %>% 
  select(!c(disease_vac, type, week)) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0) %>% 
  as.matrix() 

dim(matrix_data_ordered)
dim(ann_vaccines_heatmap)


ha = HeatmapAnnotation(df = ann_vaccines_heatmap, 
                       col = ann_colors, 
                       annotation_name_side = "left")


col_fun <- colorRamp2(c(-2, 0, 2), c("#9bc1bc", "white", "#ed6a5a"))


mat = matrix_data_ordered
width = unit(30, "cm")
height = unit(15, "cm")
width_image = 40
height_image = 25
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)

fileimageheatmap_ungrouped= here("Figures", paste0(file, sep ="_", "Ungrouped_Complexheatmap.png"))
png(file = fileimageheatmap_ungrouped, width=width_image, height=height_image,units="cm",res=800)
heatmap_plot_all = Heatmap(mat,
                        top_annotation = ha,
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "L2FC", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = gpar(fontsize = 10),
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_split = NULL, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_split = 2, #Split group clusters
                        #column_km = 2,
                        column_gap = unit(8, "mm"),
                        show_column_dend = TRUE,
                        show_row_dend = TRUE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = width, 
                        height = height
)

draw(heatmap_plot_all, annotation_legend_side = "right", heatmap_legend_side = "right")

dev.off()
```

### 9.4. Inflammation

```{r}
heatmap_data = Immune_GO_genes_Inflammation
file = "Immune_GO_genes_Inflammation"
heatmap_data_l2fc= heatmap_data %>% 
  filter(condition != "NA", 
         process != "NA") %>% 
  select(genes, condition, log2fold_change)

matrix_data <- dcast(heatmap_data_l2fc, 
                         genes ~ condition, 
                         value.var = "log2fold_change", 
                         fun.aggregate = mean) %>% 
  column_to_rownames('genes') %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0)

matrix_data_ready =  matrix_data %>% 
  round(2)

ann_vaccines_complex = heatmap_data %>% 
  select(condition) %>% 
  distinct() %>% 
  inner_join(ann_vaccines %>% select(condition, disease_vac, type, week), by = "condition")

ann_vaccines_heatmap = matrix_data %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  merge(ann_vaccines_complex, by = "condition", all.x = TRUE) %>% 
  arrange(condition) %>% 
  column_to_rownames(var= "condition") 

matrix_data_ordered = matrix_data %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  merge(ann_vaccines_complex, by.y = "condition", all.x=TRUE) %>% 
  arrange(condition) %>% 
  select(!c(disease_vac, type, week)) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0) %>% 
  as.matrix() 

dim(matrix_data_ordered) 
dim(ann_vaccines_heatmap)

ha = HeatmapAnnotation(df = ann_vaccines_heatmap, 
                       col = ann_colors, 
                       annotation_name_side = "left")


col_fun <- colorRamp2(c(-2, 0, 2), 
                      c("#9bc1bc", "white", "#ed6a5a"))

mat = matrix_data_ordered
width_image = 40
height_image = 20
width = unit(30, "cm")
height = unit(10, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)

fileimageheatmap_ungrouped= here("Figures", paste0(file, sep ="_", "Ungrouped_Complexheatmap.png"))

png(file = fileimageheatmap_ungrouped, width=width_image, height=height_image,units="cm",res=800)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = ha,
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "L2FC", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_split = NULL, 
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(8, "mm"),
                        show_column_dend = TRUE,
                        show_row_dend = TRUE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = width, 
                        height = height
)

draw(heatmap_plot_all, annotation_legend_side = "right", heatmap_legend_side = "right")

dev.off()
```

### 9.5. ARPP

```{r}
####### Input
#Troque pelo geneset de interesse

heatmap_data = Immune_GO_genes_ARPP
file = "Immune_GO_genes_ARPP"

########## Processar dados e criar matriz

#Excluir linhas com Target ou Source == NA
heatmap_data_l2fc= heatmap_data %>% 
  filter(condition != "NA", 
         process != "NA") %>% 
  select(genes, condition, log2fold_change)

# Converter para wide table
matrix_data <- dcast(heatmap_data_l2fc, 
                         genes ~ condition, 
                         value.var = "log2fold_change", 
                         fun.aggregate = mean) %>% 
  column_to_rownames('genes') %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0)

#Arredondar valores para facilitar visualização
matrix_data_ready =  matrix_data %>% 
  round(2)

# Verificar se todas as vacinas da anotação estão na matriz e unir as tabelas
ann_vaccines_complex = heatmap_data %>% 
  select(condition) %>% 
  distinct() %>% 
  inner_join(ann_vaccines %>% select(condition, disease_vac, type, week), by = "condition")

# Unir tabela de anotações
ann_vaccines_heatmap = matrix_data %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  merge(ann_vaccines_complex, by = "condition", all.x = TRUE) %>% 
  arrange(condition) %>% 
  column_to_rownames(var= "condition") 

# Ordenar colunas da matriz para a mesma ordem das linhas da tabela de anotações
matrix_data_ordered = matrix_data %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  merge(ann_vaccines_complex, by.y = "condition", all.x=TRUE) %>% 
  arrange(condition) %>% #Trocar a variável pela qual deseja ordenar (Vaccine, Day, Condition, etc.)
  select(!c(disease_vac, type, week)) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>% #Converter em numéricos
  replace(is.na(.), 0) %>% 
  as.matrix() 

#Verificar se as linhas sao iguais
dim(matrix_data_ordered) #Usar se for ordenar por colunas
dim(ann_vaccines_heatmap) #Anotações sobre as colunas


#Criar heatmap annotation
ha = HeatmapAnnotation(df = ann_vaccines_heatmap, 
                       col = ann_colors, 
                       annotation_name_side = "left")


col_fun <- colorRamp2(c(-2, 0, 2), c("#9bc1bc", "white", "#ed6a5a"))


#Parameters
mat = matrix_data_ordered
width = unit(30, "cm")
height = unit(50, "cm")
width_image = 40
height_image = 60
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)


#Plotar e salvar imagem
fileimageheatmap_ungrouped= here("Figures", paste0(file, sep ="_", "Ungrouped_Complexheatmap.png"))

png(file = fileimageheatmap_ungrouped, width=width_image, height=height_image,units="cm",res=800)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = ha,
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "L2FC", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_split = NULL, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        # column_split = 2, #Split group clusters
                        #column_km = 2,
                        column_gap = unit(8, "mm"),
                        show_column_dend = TRUE,
                        show_row_dend = TRUE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = width, 
                        height = height
)

draw(heatmap_plot_all, annotation_legend_side = "right", heatmap_legend_side = "right")

dev.off()
```

### 9.6. AV and IFN

```{r}
####### Input
#Troque pelo geneset de interesse

heatmap_data = Immune_GO_genes_IFN
file = "Immune_GO_genes_IFN"

########## Processar dados e criar matriz

#Excluir linhas com Target ou Source == NA
heatmap_data_l2fc= heatmap_data %>% 
  filter(condition != "NA", 
         process != "NA") %>% 
  select(genes, condition, log2fold_change)

# Converter para wide table
matrix_data <- dcast(heatmap_data_l2fc, 
                         genes ~ condition, 
                         value.var = "log2fold_change", 
                         fun.aggregate = mean) %>% 
  column_to_rownames('genes') %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0)

#Arredondar valores para facilitar visualização
matrix_data_ready =  matrix_data %>% 
  round(2)

# Verificar se todas as vacinas da anotação estão na matriz e unir as tabelas
ann_vaccines_complex = heatmap_data %>% 
  select(condition) %>% 
  distinct() %>% 
  inner_join(ann_vaccines %>% select(condition, disease_vac, type, week), by = "condition")

# Unir tabela de anotações
ann_vaccines_heatmap = matrix_data %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  merge(ann_vaccines_complex, by = "condition", all.x = TRUE) %>% 
  arrange(condition) %>% 
  column_to_rownames(var= "condition") 

# Ordenar colunas da matriz para a mesma ordem das linhas da tabela de anotações
matrix_data_ordered = matrix_data %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  merge(ann_vaccines_complex, by.y = "condition", all.x=TRUE) %>% 
  arrange(condition) %>% #Trocar a variável pela qual deseja ordenar (Vaccine, Day, Condition, etc.)
  select(!c(disease_vac, type, week)) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>% #Converter em numéricos
  replace(is.na(.), 0) %>% 
  as.matrix() 

#Verificar se as linhas sao iguais
dim(matrix_data_ordered) #Usar se for ordenar por colunas
dim(ann_vaccines_heatmap) #Anotações sobre as colunas


#Criar heatmap annotation
ha = HeatmapAnnotation(df = ann_vaccines_heatmap, 
                       col = ann_colors, 
                       annotation_name_side = "left")


col_fun <- colorRamp2(c(-2, 0, 2), c("#9bc1bc", "white", "#ed6a5a"))


#Parameters
mat = matrix_data_ordered
width = unit(30, "cm")
height = unit(50, "cm")
width_image = 40
height_image = 60
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)


#Plotar e salvar imagem
fileimageheatmap_ungrouped= here("Figures", paste0(file, sep ="_", "Ungrouped_Complexheatmap.png"))

png(file = fileimageheatmap_ungrouped, width=width_image, height=height_image,units="cm",res=800)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = ha,
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "L2FC", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_split = NULL, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        # column_split = 2, #Split group clusters
                        #column_km = 2,
                        column_gap = unit(8, "mm"),
                        show_column_dend = TRUE,
                        show_row_dend = TRUE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = width, 
                        height = height
)

draw(heatmap_plot_all, annotation_legend_side = "right", heatmap_legend_side = "right")

dev.off()
```

### 9.7. Neutrophil

```{r}
####### Input
#Troque pelo geneset de interesse

heatmap_data = Immune_GO_genes_Neutrophil
file = "Immune_GO_genes_Neutrophil"

########## Processar dados e criar matriz

#Excluir linhas com Target ou Source == NA
heatmap_data_l2fc= heatmap_data %>% 
  filter(condition != "NA", 
         process != "NA") %>% 
  select(genes, condition, log2fold_change)

# Converter para wide table
matrix_data <- dcast(heatmap_data_l2fc, 
                         genes ~ condition, 
                         value.var = "log2fold_change", 
                         fun.aggregate = mean) %>% 
  column_to_rownames('genes') %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0)

#Arredondar valores para facilitar visualização
matrix_data_ready =  matrix_data %>% 
  round(2)

# Verificar se todas as vacinas da anotação estão na matriz e unir as tabelas
ann_vaccines_complex = heatmap_data %>% 
  select(condition) %>% 
  distinct() %>% 
  inner_join(ann_vaccines %>% select(condition, disease_vac, type, week), by = "condition")

# Unir tabela de anotações
ann_vaccines_heatmap = matrix_data %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  merge(ann_vaccines_complex, by = "condition", all.x = TRUE) %>% 
  arrange(condition) %>% 
  column_to_rownames(var= "condition") 

# Ordenar colunas da matriz para a mesma ordem das linhas da tabela de anotações
matrix_data_ordered = matrix_data %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  merge(ann_vaccines_complex, by.y = "condition", all.x=TRUE) %>% 
  arrange(condition) %>% #Trocar a variável pela qual deseja ordenar (Vaccine, Day, Condition, etc.)
  select(!c(disease_vac, type, week)) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>% #Converter em numéricos
  replace(is.na(.), 0) %>% 
  as.matrix() 

#Verificar se as linhas sao iguais
dim(matrix_data_ordered) #Usar se for ordenar por colunas
dim(ann_vaccines_heatmap) #Anotações sobre as colunas


#Criar heatmap annotation
ha = HeatmapAnnotation(df = ann_vaccines_heatmap, 
                       col = ann_colors, 
                       annotation_name_side = "left")


col_fun <- colorRamp2(c(-2, 0, 2), c("#9bc1bc", "white", "#ed6a5a"))


#Parameters
mat = matrix_data_ordered
width = unit(30, "cm")
height = unit(40, "cm")
width_image = 40
height_image = 50
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)


#Plotar e salvar imagem
fileimageheatmap_ungrouped = here("Figures", paste0(file, sep ="_", "Ungrouped_Complexheatmap.png"))

png(file = fileimageheatmap_ungrouped, width=width_image, height=height_image,units="cm",res=800)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = ha,
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "L2FC", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_split = NULL, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        # column_split = 2, #Split group clusters
                        #column_km = 2,
                        column_gap = unit(8, "mm"),
                        show_column_dend = TRUE,
                        show_row_dend = TRUE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = width, 
                        height = height
)

draw(heatmap_plot_all, annotation_legend_side = "right", heatmap_legend_side = "right")

dev.off()
```

### 9.8. Eosinophil

```{r}
####### Input
#Troque pelo geneset de interesse

heatmap_data = Immune_GO_genes_Eosinophil
file = "Immune_GO_genes_Eosinophil"

########## Processar dados e criar matriz

#Excluir linhas com Target ou Source == NA
heatmap_data_l2fc= heatmap_data %>% 
  filter(condition != "NA", 
         process != "NA") %>% 
  select(genes, condition, log2fold_change)

# Converter para wide table
matrix_data <- dcast(heatmap_data_l2fc, 
                         genes ~ condition, 
                         value.var = "log2fold_change", 
                         fun.aggregate = mean) %>% 
  column_to_rownames('genes') %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0)

#Arredondar valores para facilitar visualização
matrix_data_ready =  matrix_data %>% 
  round(2)

# Verificar se todas as vacinas da anotação estão na matriz e unir as tabelas
ann_vaccines_complex = heatmap_data %>% 
  select(condition) %>% 
  distinct() %>% 
  inner_join(ann_vaccines %>% select(condition, disease_vac, type, week), by = "condition")

# Unir tabela de anotações
ann_vaccines_heatmap = matrix_data %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  merge(ann_vaccines_complex, by = "condition", all.x = TRUE) %>% 
  arrange(condition) %>% 
  column_to_rownames(var= "condition") 

# Ordenar colunas da matriz para a mesma ordem das linhas da tabela de anotações
matrix_data_ordered = matrix_data %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  merge(ann_vaccines_complex, by.y = "condition", all.x=TRUE) %>% 
  arrange(condition) %>% #Trocar a variável pela qual deseja ordenar (Vaccine, Day, Condition, etc.)
  select(!c(disease_vac, type, week)) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>% #Converter em numéricos
  replace(is.na(.), 0) %>% 
  as.matrix() 

#Verificar se as linhas sao iguais
dim(matrix_data_ordered) #Usar se for ordenar por colunas
dim(ann_vaccines_heatmap) #Anotações sobre as colunas


#Criar heatmap annotation
ha = HeatmapAnnotation(df = ann_vaccines_heatmap, 
                       col = ann_colors, 
                       annotation_name_side = "left")


col_fun <- colorRamp2(c(-2, 0, 2), c("#9bc1bc", "white", "#ed6a5a"))


#Parameters
mat = matrix_data_ordered
width = unit(30, "cm")
height = unit(10, "cm")
width_image = 40
height_image = 20
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)


#Plotar e salvar imagem
fileimageheatmap_ungrouped= here("Figures", paste0(file, sep ="_", "Ungrouped_Complexheatmap.png"))

png(file = fileimageheatmap_ungrouped, width=width_image, height=height_image,units="cm",res=800)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = ha,
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "L2FC", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_split = NULL, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        # column_split = 2, #Split group clusters
                        #column_km = 2,
                        column_gap = unit(8, "mm"),
                        show_column_dend = TRUE,
                        show_row_dend = TRUE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = width, 
                        height = height
)

draw(heatmap_plot_all, annotation_legend_side = "right", heatmap_legend_side = "right")

dev.off()
```

### 9.9. Monocyte

```{r}
####### Input
#Troque pelo geneset de interesse

heatmap_data = Immune_GO_genes_Monocytes
file = "Immune_GO_genes_Monocytes"

########## Processar dados e criar matriz

#Excluir linhas com Target ou Source == NA
heatmap_data_l2fc= heatmap_data %>% 
  filter(condition != "NA", 
         process != "NA") %>% 
  select(genes, condition, log2fold_change)

# Converter para wide table
matrix_data <- dcast(heatmap_data_l2fc, 
                         genes ~ condition, 
                         value.var = "log2fold_change", 
                         fun.aggregate = mean) %>% 
  column_to_rownames('genes') %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0)

#Arredondar valores para facilitar visualização
matrix_data_ready =  matrix_data %>% 
  round(2)

# Verificar se todas as vacinas da anotação estão na matriz e unir as tabelas
ann_vaccines_complex = heatmap_data %>% 
  select(condition) %>% 
  distinct() %>% 
  inner_join(ann_vaccines %>% select(condition, disease_vac, type, week), by = "condition")

# Unir tabela de anotações
ann_vaccines_heatmap = matrix_data %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  merge(ann_vaccines_complex, by = "condition", all.x = TRUE) %>% 
  arrange(condition) %>% 
  column_to_rownames(var= "condition") 

# Ordenar colunas da matriz para a mesma ordem das linhas da tabela de anotações
matrix_data_ordered = matrix_data %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  merge(ann_vaccines_complex, by.y = "condition", all.x=TRUE) %>% 
  arrange(condition) %>% #Trocar a variável pela qual deseja ordenar (Vaccine, Day, Condition, etc.)
  select(!c(disease_vac, type, week)) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>% #Converter em numéricos
  replace(is.na(.), 0) %>% 
  as.matrix() 

#Verificar se as linhas sao iguais
dim(matrix_data_ordered) #Usar se for ordenar por colunas
dim(ann_vaccines_heatmap) #Anotações sobre as colunas


#Criar heatmap annotation
ha = HeatmapAnnotation(df = ann_vaccines_heatmap, 
                       col = ann_colors, 
                       annotation_name_side = "left")


col_fun <- colorRamp2(c(-2, 0, 2), c("#9bc1bc", "white", "#ed6a5a"))


#Parameters
mat = matrix_data_ordered
width = unit(30, "cm")
height = unit(15, "cm")
width_image = 40
height_image = 25
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)


#Plotar e salvar imagem
fileimageheatmap_ungrouped= here("Figures", paste0(file, sep ="_", "Ungrouped_Complexheatmap.png"))

png(file = fileimageheatmap_ungrouped, width=width_image, height=height_image,units="cm",res=800)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = ha,
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "L2FC", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_split = NULL, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        #column_split = 2, #Split group clusters
                        #column_km = 2,
                        column_gap = unit(8, "mm"),
                        show_column_dend = TRUE,
                        show_row_dend = TRUE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = width, 
                        height = height
)

draw(heatmap_plot_all, annotation_legend_side = "right", heatmap_legend_side = "right")

dev.off()
```

### 9.10. Dendritic cells

```{r}
####### Input
#Troque pelo geneset de interesse

heatmap_data = Immune_GO_genes_DC
file = "Immune_GO_genes_DC"

########## Processar dados e criar matriz

#Excluir linhas com Target ou Source == NA
heatmap_data_l2fc= heatmap_data %>% 
  filter(condition != "NA", 
         process != "NA") %>% 
  select(genes, condition, log2fold_change)

# Converter para wide table
matrix_data <- dcast(heatmap_data_l2fc, 
                         genes ~ condition, 
                         value.var = "log2fold_change", 
                         fun.aggregate = mean) %>% 
  column_to_rownames('genes') %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0)

#Arredondar valores para facilitar visualização
matrix_data_ready =  matrix_data %>% 
  round(2)

# Verificar se todas as vacinas da anotação estão na matriz e unir as tabelas
ann_vaccines_complex = heatmap_data %>% 
  select(condition) %>% 
  distinct() %>% 
  inner_join(ann_vaccines %>% select(condition, disease_vac, type, week), by = "condition")

# Unir tabela de anotações
ann_vaccines_heatmap = matrix_data %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  merge(ann_vaccines_complex, by = "condition", all.x = TRUE) %>% 
  arrange(condition) %>% 
  column_to_rownames(var= "condition") 

# Ordenar colunas da matriz para a mesma ordem das linhas da tabela de anotações
matrix_data_ordered = matrix_data %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  merge(ann_vaccines_complex, by.y = "condition", all.x=TRUE) %>% 
  arrange(condition) %>% #Trocar a variável pela qual deseja ordenar (Vaccine, Day, Condition, etc.)
  select(!c(disease_vac, type, week)) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>% #Converter em numéricos
  replace(is.na(.), 0) %>% 
  as.matrix() 

#Verificar se as linhas sao iguais
dim(matrix_data_ordered) #Usar se for ordenar por colunas
dim(ann_vaccines_heatmap) #Anotações sobre as colunas


#Criar heatmap annotation
ha = HeatmapAnnotation(df = ann_vaccines_heatmap, 
                       col = ann_colors, 
                       annotation_name_side = "left")


col_fun <- colorRamp2(c(-2, 0, 2), c("#9bc1bc", "white", "#ed6a5a"))


#Parameters
mat = matrix_data_ordered
width = unit(30, "cm")
height = unit(15, "cm")
width_image = 40
height_image = 25
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)


#Plotar e salvar imagem
fileimageheatmap_ungrouped= here("Figures", paste0(file, sep ="_", "Ungrouped_Complexheatmap.png"))

png(file = fileimageheatmap_ungrouped, width=width_image, height=height_image,units="cm",res=800)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = ha,
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "L2FC", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = gpar(fontsize = 10),
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_split = NULL, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        #column_split = 2, #Split group clusters
                        #column_km = 2,
                        column_gap = unit(8, "mm"),
                        show_column_dend = TRUE,
                        show_row_dend = TRUE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = width, 
                        height = height
)

draw(heatmap_plot_all, annotation_legend_side = "right", heatmap_legend_side = "right")

dev.off()
```

### 9.11. Macrophage

```{r}
####### Input
#Troque pelo geneset de interesse

heatmap_data = Immune_GO_genes_Macro
file = "Immune_GO_genes_Macro"

########## Processar dados e criar matriz

#Excluir linhas com Target ou Source == NA
heatmap_data_l2fc= heatmap_data %>% 
  filter(condition != "NA", 
         process != "NA") %>% 
  select(genes, condition, log2fold_change)

# Converter para wide table
matrix_data <- dcast(heatmap_data_l2fc, 
                         genes ~ condition, 
                         value.var = "log2fold_change", 
                         fun.aggregate = mean) %>% 
  column_to_rownames('genes') %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0)

#Arredondar valores para facilitar visualização
matrix_data_ready =  matrix_data %>% 
  round(2)

# Verificar se todas as vacinas da anotação estão na matriz e unir as tabelas
ann_vaccines_complex = heatmap_data %>% 
  select(condition) %>% 
  distinct() %>% 
  inner_join(ann_vaccines %>% select(condition, disease_vac, type, week), by = "condition")

# Unir tabela de anotações
ann_vaccines_heatmap = matrix_data %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  merge(ann_vaccines_complex, by = "condition", all.x = TRUE) %>% 
  arrange(condition) %>% 
  column_to_rownames(var= "condition") 

# Ordenar colunas da matriz para a mesma ordem das linhas da tabela de anotações
matrix_data_ordered = matrix_data %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  merge(ann_vaccines_complex, by.y = "condition", all.x=TRUE) %>% 
  arrange(condition) %>% #Trocar a variável pela qual deseja ordenar (Vaccine, Day, Condition, etc.)
  select(!c(disease_vac, type, week)) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>% #Converter em numéricos
  replace(is.na(.), 0) %>% 
  as.matrix() 

#Verificar se as linhas sao iguais
dim(matrix_data_ordered) #Usar se for ordenar por colunas
dim(ann_vaccines_heatmap) #Anotações sobre as colunas


#Criar heatmap annotation
ha = HeatmapAnnotation(df = ann_vaccines_heatmap, 
                       col = ann_colors, 
                       annotation_name_side = "left")


col_fun <- colorRamp2(c(-2, 0, 2), c("#9bc1bc", "white", "#ed6a5a"))


#Parameters
mat = matrix_data_ordered
width = unit(30, "cm")
height = unit(15, "cm")
width_image = 40
height_image = 25
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)


#Plotar e salvar imagem
fileimageheatmap_ungrouped= here("Figures", paste0(file, sep ="_", "Ungrouped_Complexheatmap.png"))

png(file = fileimageheatmap_ungrouped, width=width_image, height=height_image,units="cm",res=800)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = ha,
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "L2FC", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = gpar(fontsize = 10),
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_split = NULL, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        #column_split = 2, #Split group clusters
                        #column_km = 2,
                        column_gap = unit(8, "mm"),
                        show_column_dend = TRUE,
                        show_row_dend = TRUE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = width, 
                        height = height
)

draw(heatmap_plot_all, annotation_legend_side = "right", heatmap_legend_side = "right")

dev.off()
```

### 9.12. NK

```{r}
####### Input
#Troque pelo geneset de interesse

heatmap_data = Immune_GO_genes_NK
file = "Immune_GO_genes_NK"

########## Processar dados e criar matriz

#Excluir linhas com Target ou Source == NA
heatmap_data_l2fc= heatmap_data %>% 
  filter(condition != "NA", 
         process != "NA") %>% 
  select(genes, condition, log2fold_change)

# Converter para wide table
matrix_data <- dcast(heatmap_data_l2fc, 
                         genes ~ condition, 
                         value.var = "log2fold_change", 
                         fun.aggregate = mean) %>% 
  column_to_rownames('genes') %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0)

#Arredondar valores para facilitar visualização
matrix_data_ready =  matrix_data %>% 
  round(2)

# Verificar se todas as vacinas da anotação estão na matriz e unir as tabelas
ann_vaccines_complex = heatmap_data %>% 
  select(condition) %>% 
  distinct() %>% 
  inner_join(ann_vaccines %>% select(condition, disease_vac, type, week), by = "condition")

# Unir tabela de anotações
ann_vaccines_heatmap = matrix_data %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  merge(ann_vaccines_complex, by = "condition", all.x = TRUE) %>% 
  arrange(condition) %>% 
  column_to_rownames(var= "condition") 

# Ordenar colunas da matriz para a mesma ordem das linhas da tabela de anotações
matrix_data_ordered = matrix_data %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  merge(ann_vaccines_complex, by.y = "condition", all.x=TRUE) %>% 
  arrange(condition) %>% #Trocar a variável pela qual deseja ordenar (Vaccine, Day, Condition, etc.)
  select(!c(disease_vac, type, week)) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>% #Converter em numéricos
  replace(is.na(.), 0) %>% 
  as.matrix() 

#Verificar se as linhas sao iguais
dim(matrix_data_ordered) #Usar se for ordenar por colunas
dim(ann_vaccines_heatmap) #Anotações sobre as colunas


#Criar heatmap annotation
ha = HeatmapAnnotation(df = ann_vaccines_heatmap, 
                       col = ann_colors, 
                       annotation_name_side = "left")


col_fun <- colorRamp2(c(-2, 0, 2), c("#9bc1bc", "white", "#ed6a5a"))


#Parameters
mat = matrix_data_ordered
width = unit(30, "cm")
height = unit(15, "cm")
width_image = 40
height_image = 25
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)


#Plotar e salvar imagem
fileimageheatmap_ungrouped= here("Figures", paste0(file, sep ="_", "Ungrouped_Complexheatmap.png"))

png(file = fileimageheatmap_ungrouped, width=width_image, height=height_image,units="cm",res=800)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = ha,
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "L2FC", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = gpar(fontsize = 10),
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_split = NULL, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        #column_split = 2, #Split group clusters
                        #column_km = 2,
                        column_gap = unit(8, "mm"),
                        show_column_dend = TRUE,
                        show_row_dend = TRUE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = width, 
                        height = height
)

draw(heatmap_plot_all, annotation_legend_side = "right", heatmap_legend_side = "right")

dev.off()
```

### 9.13. Mast cell

```{r}
####### Input
#Troque pelo geneset de interesse

heatmap_data = Immune_GO_genes_Mast
file = "Immune_GO_genes_Mast"

########## Processar dados e criar matriz

#Excluir linhas com Target ou Source == NA
heatmap_data_l2fc= heatmap_data %>% 
  filter(condition != "NA", 
         process != "NA") %>% 
  select(genes, condition, log2fold_change)

# Converter para wide table
matrix_data <- dcast(heatmap_data_l2fc, 
                         genes ~ condition, 
                         value.var = "log2fold_change", 
                         fun.aggregate = mean) %>% 
  column_to_rownames('genes') %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0)

#Arredondar valores para facilitar visualização
matrix_data_ready =  matrix_data %>% 
  round(2)

# Verificar se todas as vacinas da anotação estão na matriz e unir as tabelas
ann_vaccines_complex = heatmap_data %>% 
  select(condition) %>% 
  distinct() %>% 
  inner_join(ann_vaccines %>% select(condition, disease_vac, type, week), by = "condition")

# Unir tabela de anotações
ann_vaccines_heatmap = matrix_data %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  merge(ann_vaccines_complex, by = "condition", all.x = TRUE) %>% 
  arrange(condition) %>% 
  column_to_rownames(var= "condition") 

# Ordenar colunas da matriz para a mesma ordem das linhas da tabela de anotações
matrix_data_ordered = matrix_data %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  merge(ann_vaccines_complex, by.y = "condition", all.x=TRUE) %>% 
  arrange(condition) %>% #Trocar a variável pela qual deseja ordenar (Vaccine, Day, Condition, etc.)
  select(!c(disease_vac, type, week)) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>% #Converter em numéricos
  replace(is.na(.), 0) %>% 
  as.matrix() 

#Verificar se as linhas sao iguais
dim(matrix_data_ordered) #Usar se for ordenar por colunas
dim(ann_vaccines_heatmap) #Anotações sobre as colunas


#Criar heatmap annotation
ha = HeatmapAnnotation(df = ann_vaccines_heatmap, 
                       col = ann_colors, 
                       annotation_name_side = "left")


col_fun <- colorRamp2(c(-2, 0, 2), c("#9bc1bc", "white", "#ed6a5a"))


#Parameters
mat = matrix_data_ordered
width = unit(30, "cm")
height = unit(10, "cm")
width_image = 40
height_image = 20
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)


#Plotar e salvar imagem
fileimageheatmap_ungrouped= here("Figures", paste0(file, sep ="_", "Ungrouped_Complexheatmap.png"))

png(file = fileimageheatmap_ungrouped, width=width_image, height=height_image,units="cm",res=800)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = ha,
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "L2FC", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = gpar(fontsize = 10),
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_split = NULL, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        #column_split = 2, #Split group clusters
                        #column_km = 2,
                        column_gap = unit(8, "mm"),
                        show_column_dend = TRUE,
                        show_row_dend = TRUE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = width, 
                        height = height
)

draw(heatmap_plot_all, annotation_legend_side = "right", heatmap_legend_side = "right")

dev.off()
```

### 9.14. Cellular adaptive immune system

```{r}
####### Input
#Troque pelo geneset de interesse

heatmap_data = Immune_GO_genes_Cellular
file = "Immune_GO_genes_Cellular"

########## Processar dados e criar matriz

#Excluir linhas com Target ou Source == NA
heatmap_data_l2fc= heatmap_data %>% 
  filter(condition != "NA", 
         process != "NA") %>% 
  select(genes, condition, log2fold_change)

# Converter para wide table
matrix_data <- dcast(heatmap_data_l2fc, 
                         genes ~ condition, 
                         value.var = "log2fold_change", 
                         fun.aggregate = mean) %>% 
  column_to_rownames('genes') %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0)

#Arredondar valores para facilitar visualização
matrix_data_ready =  matrix_data %>% 
  round(2)

# Verificar se todas as vacinas da anotação estão na matriz e unir as tabelas
ann_vaccines_complex = heatmap_data %>% 
  select(condition) %>% 
  distinct() %>% 
  inner_join(ann_vaccines %>% select(condition, disease_vac, type, week), by = "condition")

# Unir tabela de anotações
ann_vaccines_heatmap = matrix_data %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  merge(ann_vaccines_complex, by = "condition", all.x = TRUE) %>% 
  arrange(condition) %>% 
  column_to_rownames(var= "condition") 

# Ordenar colunas da matriz para a mesma ordem das linhas da tabela de anotações
matrix_data_ordered = matrix_data %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  merge(ann_vaccines_complex, by.y = "condition", all.x=TRUE) %>% 
  arrange(condition) %>% #Trocar a variável pela qual deseja ordenar (Vaccine, Day, Condition, etc.)
  select(!c(disease_vac, type, week)) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>% #Converter em numéricos
  replace(is.na(.), 0) %>% 
  as.matrix() 

#Verificar se as linhas sao iguais
dim(matrix_data_ordered) #Usar se for ordenar por colunas
dim(ann_vaccines_heatmap) #Anotações sobre as colunas


#Criar heatmap annotation
ha = HeatmapAnnotation(df = ann_vaccines_heatmap, 
                       col = ann_colors, 
                       annotation_name_side = "left")


col_fun <- colorRamp2(c(-2, 0, 2), c("#9bc1bc", "white", "#ed6a5a"))


#Parameters
mat = matrix_data_ordered
width = unit(30, "cm")
height = unit(70, "cm")
width_image = 40
height_image = 80
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 5)


#Plotar e salvar imagem
fileimageheatmap_ungrouped= here("Figures", paste0(file, sep ="_", "Ungrouped_Complexheatmap.png"))

png(file = fileimageheatmap_ungrouped, width=width_image, height=height_image,units="cm",res=800)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = ha,
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "L2FC", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = gpar(fontsize = 10),
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_split = NULL, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        #column_split = 2, #Split group clusters
                        #column_km = 2,
                        column_gap = unit(8, "mm"),
                        show_column_dend = TRUE,
                        show_row_dend = TRUE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = width, 
                        height = height
)

draw(heatmap_plot_all, annotation_legend_side = "right", heatmap_legend_side = "right")

dev.off()
```

### 9.15. T Cell

```{r}
####### Input
#Troque pelo geneset de interesse

heatmap_data = Immune_GO_genes_Tcells
file = "Immune_GO_genes_Tcells"

########## Processar dados e criar matriz

#Excluir linhas com Target ou Source == NA
heatmap_data_l2fc= heatmap_data %>% 
  filter(condition != "NA", 
         process != "NA") %>% 
  select(genes, condition, log2fold_change)

# Converter para wide table
matrix_data <- dcast(heatmap_data_l2fc, 
                         genes ~ condition, 
                         value.var = "log2fold_change", 
                         fun.aggregate = mean) %>% 
  column_to_rownames('genes') %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0)

#Arredondar valores para facilitar visualização
matrix_data_ready =  matrix_data %>% 
  round(2)

# Verificar se todas as vacinas da anotação estão na matriz e unir as tabelas
ann_vaccines_complex = heatmap_data %>% 
  select(condition) %>% 
  distinct() %>% 
  inner_join(ann_vaccines %>% select(condition, disease_vac, type, week), by = "condition")

# Unir tabela de anotações
ann_vaccines_heatmap = matrix_data %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  merge(ann_vaccines_complex, by = "condition", all.x = TRUE) %>% 
  arrange(condition) %>% 
  column_to_rownames(var= "condition") 

# Ordenar colunas da matriz para a mesma ordem das linhas da tabela de anotações
matrix_data_ordered = matrix_data %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  merge(ann_vaccines_complex, by.y = "condition", all.x=TRUE) %>% 
  arrange(condition) %>% #Trocar a variável pela qual deseja ordenar (Vaccine, Day, Condition, etc.)
  select(!c(disease_vac, type, week)) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>% #Converter em numéricos
  replace(is.na(.), 0) %>% 
  as.matrix() 

#Verificar se as linhas sao iguais
dim(matrix_data_ordered) #Usar se for ordenar por colunas
dim(ann_vaccines_heatmap) #Anotações sobre as colunas


#Criar heatmap annotation
ha = HeatmapAnnotation(df = ann_vaccines_heatmap, 
                       col = ann_colors, 
                       annotation_name_side = "left")


col_fun <- colorRamp2(c(-2, 0, 2), c("#9bc1bc", "white", "#ed6a5a"))


#Parameters
mat = matrix_data_ordered
width = unit(30, "cm")
height = unit(80, "cm")
width_image = 40
height_image = 90
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)


#Plotar e salvar imagem
fileimageheatmap_ungrouped= here("Figures", paste0(file, sep ="_", "Ungrouped_Complexheatmap.png"))

png(file = fileimageheatmap_ungrouped, width=width_image, height=height_image,units="cm",res=800)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = ha,
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "L2FC", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = gpar(fontsize = 10),
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_split = NULL, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        #column_split = 2, #Split group clusters
                        #column_km = 2,
                        column_gap = unit(8, "mm"),
                        show_column_dend = TRUE,
                        show_row_dend = TRUE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = width, 
                        height = height
)

draw(heatmap_plot_all, annotation_legend_side = "right", heatmap_legend_side = "right")

dev.off()
```

### 9.16. Th Cell

```{r}
####### Input
#Troque pelo geneset de interesse

heatmap_data = Immune_GO_genes_Th
file = "Immune_GO_genes_Th"

########## Processar dados e criar matriz

#Excluir linhas com Target ou Source == NA
heatmap_data_l2fc= heatmap_data %>% 
  filter(condition != "NA", 
         process != "NA") %>% 
  select(genes, condition, log2fold_change)

# Converter para wide table
matrix_data <- dcast(heatmap_data_l2fc, 
                         genes ~ condition, 
                         value.var = "log2fold_change", 
                         fun.aggregate = mean) %>% 
  column_to_rownames('genes') %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0)

#Arredondar valores para facilitar visualização
matrix_data_ready =  matrix_data %>% 
  round(2)

# Verificar se todas as vacinas da anotação estão na matriz e unir as tabelas
ann_vaccines_complex = heatmap_data %>% 
  select(condition) %>% 
  distinct() %>% 
  inner_join(ann_vaccines %>% select(condition, disease_vac, type, week), by = "condition")

# Unir tabela de anotações
ann_vaccines_heatmap = matrix_data %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  merge(ann_vaccines_complex, by = "condition", all.x = TRUE) %>% 
  arrange(condition) %>% 
  column_to_rownames(var= "condition") 

# Ordenar colunas da matriz para a mesma ordem das linhas da tabela de anotações
matrix_data_ordered = matrix_data %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  merge(ann_vaccines_complex, by.y = "condition", all.x=TRUE) %>% 
  arrange(condition) %>% #Trocar a variável pela qual deseja ordenar (Vaccine, Day, Condition, etc.)
  select(!c(disease_vac, type, week)) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>% #Converter em numéricos
  replace(is.na(.), 0) %>% 
  as.matrix() 

#Verificar se as linhas sao iguais
dim(matrix_data_ordered) #Usar se for ordenar por colunas
dim(ann_vaccines_heatmap) #Anotações sobre as colunas


#Criar heatmap annotation
ha = HeatmapAnnotation(df = ann_vaccines_heatmap, 
                       col = ann_colors, 
                       annotation_name_side = "left")


col_fun <- colorRamp2(c(-2, 0, 2), c("#9bc1bc", "white", "#ed6a5a"))


#Parameters
mat = matrix_data_ordered
width = unit(30, "cm")
height = unit(10, "cm")
width_image = 40
height_image = 20
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)


#Plotar e salvar imagem
fileimageheatmap_ungrouped= here("Figures", paste0(file, sep ="_", "Ungrouped_Complexheatmap.png"))

png(file = fileimageheatmap_ungrouped, width=width_image, height=height_image,units="cm",res=800)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = ha,
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "L2FC", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = gpar(fontsize = 10),
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_split = NULL, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        #column_split = 2, #Split group clusters
                        #column_km = 2,
                        column_gap = unit(8, "mm"),
                        show_column_dend = TRUE,
                        show_row_dend = TRUE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = width, 
                        height = height
)

draw(heatmap_plot_all, annotation_legend_side = "right", heatmap_legend_side = "right")

dev.off()
```

### 9.17. Humoral adaptive immune system

```{r}
####### Input
#Troque pelo geneset de interesse

heatmap_data = Immune_GO_genes_Humoral
file = "Immune_GO_genes_Humoral"

########## Processar dados e criar matriz

#Excluir linhas com Target ou Source == NA
heatmap_data_l2fc= heatmap_data %>% 
  filter(condition != "NA", 
         process != "NA") %>% 
  select(genes, condition, log2fold_change)

# Converter para wide table
matrix_data <- dcast(heatmap_data_l2fc, 
                         genes ~ condition, 
                         value.var = "log2fold_change", 
                         fun.aggregate = mean) %>% 
  column_to_rownames('genes') %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0)

#Arredondar valores para facilitar visualização
matrix_data_ready =  matrix_data %>% 
  round(2)

# Verificar se todas as vacinas da anotação estão na matriz e unir as tabelas
ann_vaccines_complex = heatmap_data %>% 
  select(condition) %>% 
  distinct() %>% 
  inner_join(ann_vaccines %>% select(condition, disease_vac, type, week), by = "condition")

# Unir tabela de anotações
ann_vaccines_heatmap = matrix_data %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  merge(ann_vaccines_complex, by = "condition", all.x = TRUE) %>% 
  arrange(condition) %>% 
  column_to_rownames(var= "condition") 

# Ordenar colunas da matriz para a mesma ordem das linhas da tabela de anotações
matrix_data_ordered = matrix_data %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  merge(ann_vaccines_complex, by.y = "condition", all.x=TRUE) %>% 
  arrange(condition) %>% #Trocar a variável pela qual deseja ordenar (Vaccine, Day, Condition, etc.)
  select(!c(disease_vac, type, week)) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>% #Converter em numéricos
  replace(is.na(.), 0) %>% 
  as.matrix() 

#Verificar se as linhas sao iguais
dim(matrix_data_ordered) #Usar se for ordenar por colunas
dim(ann_vaccines_heatmap) #Anotações sobre as colunas


#Criar heatmap annotation
ha = HeatmapAnnotation(df = ann_vaccines_heatmap, 
                       col = ann_colors, 
                       annotation_name_side = "left")


col_fun <- colorRamp2(c(-2, 0, 2), c("#9bc1bc", "white", "#ed6a5a"))


#Parameters
mat = matrix_data_ordered
width = unit(30, "cm")
height = unit(70, "cm")
width_image = 40
height_image = 80
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)


#Plotar e salvar imagem
fileimageheatmap_ungrouped= here("Figures", paste0(file, sep ="_", "Ungrouped_Complexheatmap.png"))

png(file = fileimageheatmap_ungrouped, width=width_image, height=height_image,units="cm",res=800)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = ha,
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "L2FC", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = gpar(fontsize = 10),
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_split = NULL, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        #column_split = 2, #Split group clusters
                        #column_km = 2,
                        column_gap = unit(8, "mm"),
                        show_column_dend = TRUE,
                        show_row_dend = TRUE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = width, 
                        height = height
)

draw(heatmap_plot_all, annotation_legend_side = "right", heatmap_legend_side = "right")

dev.off()
```

### 9.18. B cells

```{r}
####### Input
#Troque pelo geneset de interesse

heatmap_data = Immune_GO_genes_Bcells
file = "Immune_GO_genes_Bcells"

########## Processar dados e criar matriz

#Excluir linhas com Target ou Source == NA
heatmap_data_l2fc= heatmap_data %>% 
  filter(condition != "NA", 
         process != "NA") %>% 
  select(genes, condition, log2fold_change)

# Converter para wide table
matrix_data <- dcast(heatmap_data_l2fc, 
                         genes ~ condition, 
                         value.var = "log2fold_change", 
                         fun.aggregate = mean) %>% 
  column_to_rownames('genes') %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0)

#Arredondar valores para facilitar visualização
matrix_data_ready =  matrix_data %>% 
  round(2)

# Verificar se todas as vacinas da anotação estão na matriz e unir as tabelas
ann_vaccines_complex = heatmap_data %>% 
  select(condition) %>% 
  distinct() %>% 
  inner_join(ann_vaccines %>% select(condition, disease_vac, type, week), by = "condition")

# Unir tabela de anotações
ann_vaccines_heatmap = matrix_data %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  merge(ann_vaccines_complex, by = "condition", all.x = TRUE) %>% 
  arrange(condition) %>% 
  column_to_rownames(var= "condition") 

# Ordenar colunas da matriz para a mesma ordem das linhas da tabela de anotações
matrix_data_ordered = matrix_data %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  merge(ann_vaccines_complex, by.y = "condition", all.x=TRUE) %>% 
  arrange(condition) %>% #Trocar a variável pela qual deseja ordenar (Vaccine, Day, Condition, etc.)
  select(!c(disease_vac, type, week)) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>% #Converter em numéricos
  replace(is.na(.), 0) %>% 
  as.matrix() 

#Verificar se as linhas sao iguais
dim(matrix_data_ordered) #Usar se for ordenar por colunas
dim(ann_vaccines_heatmap) #Anotações sobre as colunas


#Criar heatmap annotation
ha = HeatmapAnnotation(df = ann_vaccines_heatmap, 
                       col = ann_colors, 
                       annotation_name_side = "left")


col_fun <- colorRamp2(c(-2, 0, 2), c("#9bc1bc", "white", "#ed6a5a"))


#Parameters
mat = matrix_data_ordered
width = unit(30, "cm")
height = unit(50, "cm")
width_image = 40
height_image = 60
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)


#Plotar e salvar imagem
fileimageheatmap_ungrouped= here("Figures", paste0(file, sep ="_", "Ungrouped_Complexheatmap.png"))

png(file = fileimageheatmap_ungrouped, width=width_image, height=height_image,units="cm",res=800)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = ha,
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "L2FC", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = gpar(fontsize = 10),
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_split = NULL, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        #column_split = 2, #Split group clusters
                        #column_km = 2,
                        column_gap = unit(8, "mm"),
                        show_column_dend = TRUE,
                        show_row_dend = TRUE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = width, 
                        height = height
)

draw(heatmap_plot_all, annotation_legend_side = "right", heatmap_legend_side = "right")

dev.off()
```

### 9.19. Ig mediated response

```{r}
####### Input
#Troque pelo geneset de interesse

heatmap_data = Immune_GO_genes_Ig
file = "Immune_GO_genes_Ig"

########## Processar dados e criar matriz

#Excluir linhas com Target ou Source == NA
heatmap_data_l2fc= heatmap_data %>% 
  filter(condition != "NA", 
         process != "NA") %>% 
  select(genes, condition, log2fold_change)

# Converter para wide table
matrix_data <- dcast(heatmap_data_l2fc, 
                         genes ~ condition, 
                         value.var = "log2fold_change", 
                         fun.aggregate = mean) %>% 
  column_to_rownames('genes') %>% 
  mutate_if(is.character, as.numeric) %>% 
  replace(is.na(.), 0)

#Arredondar valores para facilitar visualização
matrix_data_ready =  matrix_data %>% 
  round(2)

# Verificar se todas as vacinas da anotação estão na matriz e unir as tabelas
ann_vaccines_complex = heatmap_data %>% 
  select(condition) %>% 
  distinct() %>% 
  inner_join(ann_vaccines %>% select(condition, disease_vac, type, week), by = "condition")

# Unir tabela de anotações
ann_vaccines_heatmap = matrix_data %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  merge(ann_vaccines_complex, by = "condition", all.x = TRUE) %>% 
  arrange(condition) %>% 
  column_to_rownames(var= "condition") 

# Ordenar colunas da matriz para a mesma ordem das linhas da tabela de anotações
matrix_data_ordered = matrix_data %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  merge(ann_vaccines_complex, by.y = "condition", all.x=TRUE) %>% 
  arrange(condition) %>% #Trocar a variável pela qual deseja ordenar (Vaccine, Day, Condition, etc.)
  select(!c(disease_vac, type, week)) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>% #Converter em numéricos
  replace(is.na(.), 0) %>% 
  as.matrix() 

#Verificar se as linhas sao iguais
dim(matrix_data_ordered) #Usar se for ordenar por colunas
dim(ann_vaccines_heatmap) #Anotações sobre as colunas


#Criar heatmap annotation
ha = HeatmapAnnotation(df = ann_vaccines_heatmap, 
                       col = ann_colors, 
                       annotation_name_side = "left")


col_fun <- colorRamp2(c(-2, 0, 2), c("#9bc1bc", "white", "#ed6a5a"))


#Parameters
mat = matrix_data_ordered
width = unit(30, "cm")
height = unit(50, "cm")
width_image = 40
height_image = 60
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)


#Plotar e salvar imagem
fileimageheatmap_ungrouped= here("Figures", paste0(file, sep ="_", "Ungrouped_Complexheatmap.png"))

png(file = fileimageheatmap_ungrouped, width=width_image, height=height_image,units="cm",res=800)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = ha,
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "L2FC", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = gpar(fontsize = 10),
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_split = NULL, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        #column_split = 2, #Split group clusters
                        #column_km = 2,
                        column_gap = unit(8, "mm"),
                        show_column_dend = TRUE,
                        show_row_dend = TRUE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = width, 
                        height = height
)

draw(heatmap_plot_all, annotation_legend_side = "right", heatmap_legend_side = "right")

dev.off()
```

# 10. Gene networks

```{r}
ImmuneGO_Annotated_Genes = readRDS(here("VaxGO gene sets", "ImmuneGO_Annotated_Genes_2024-03-26.rds"))
OtherGOs_Annotated_Genes = read_csv(here("VaxGO gene sets", "OtherGOs_Annotated_Genes.csv")) %>% 
  rename(genes = symbol)
  
degs_all_updown = read_csv(here("DGE analysis", "degs_updown_filtered_p_05_vac_infected.csv")) %>% 
  filter(direction != "NEUTRAL")
```

## 10.1. COVID immune genes

### 10.1.1. Chord diagram

Input
```{r}
All_covid_sharedgenes_Fisher_Jaccard <- read_csv("DGE analysis/All_covid_sharedgenes_Fisher_Jaccard.csv")

shared_genes_df_mirror = All_covid_sharedgenes_Fisher_Jaccard
```


####  10.1.1.1. Shared
```{r}
#Filters 
filter_shared = 1
filter_pvalue = 0.10

library(chorddiag)

matrix_vaccines <- shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  dplyr::select(Cond1, Cond2, Shared) %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

types = shared_genes_df_mirror %>% 
  dplyr::select(condition = Cond1) %>% 
  distinct() %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(condition, type), by = "condition") %>% 
  dplyr::select(type)

colors = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(condition, type), by = "type") %>% 
  inner_join(matrix_vaccines %>% 
               as.data.frame() %>% 
               colnames() %>% as.data.frame() %>% rename(condition = "."),
             by = "condition") %>% 
  pull(color)

# Build the chord diagram:
all_shared = chorddiag(matrix_vaccines,
          groupColors = colors,
          type = "directional",
          width = NULL,
          height = NULL,
          margin = 100,
          showGroupnames = TRUE,
          groupThickness = 0.1,
          groupPadding = 2,
          groupnamePadding = 1,
          groupnameFontsize = 10,
          groupedgeColor = NULL,
          chordedgeColor = NULL,
          categoryNames = NULL,
          categorynamePadding = 100,
          categorynameFontsize = 28,
          showTicks = TRUE,
          tickInterval = NULL,
          ticklabelFontsize = 10,
          fadeLevel = 0.1,
          showTooltips = TRUE,
          showZeroTooltips = TRUE,
          tooltipNames = NULL,
          tooltipUnit = NULL,
          tooltipFontsize = 12,
          tooltipGroupConnector = " &#x25B6; ",
          precision = NULL,
          clickAction = NULL,
          clickGroupAction = NULL
)
all_shared
```

```{r}
matrix_vaccines_week1 <- shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 1) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 1) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, Shared) %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

types = shared_genes_df_mirror %>% 
  dplyr::select(condition = Cond1) %>% 
  distinct() %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(condition, type), by = "condition") %>% 
  dplyr::select(type)

colors = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(condition, type), by = "type") %>% 
  inner_join(matrix_vaccines_week1 %>% 
               as.data.frame() %>% 
               colnames() %>% as.data.frame() %>% rename(condition = "."),
             by = "condition") %>% 
  pull(color)

# Build the chord diagram:
week1 = chorddiag(matrix_vaccines_week1,
          groupColors = colors,
          type = "directional",
          width = NULL,
          height = NULL,
          margin = 100,
          showGroupnames = TRUE,
          groupThickness = 0.1,
          groupPadding = 2,
          groupnamePadding = 1,
          groupnameFontsize = 10,
          groupedgeColor = NULL,
          chordedgeColor = NULL,
          categoryNames = NULL,
          categorynamePadding = 100,
          categorynameFontsize = 28,
          showTicks = TRUE,
          tickInterval = NULL,
          ticklabelFontsize = 10,
          fadeLevel = 0.1,
          showTooltips = TRUE,
          showZeroTooltips = TRUE,
          tooltipNames = NULL,
          tooltipUnit = NULL,
          tooltipFontsize = 12,
          tooltipGroupConnector = " &#x25B6; ",
          precision = NULL,
          clickAction = NULL,
          clickGroupAction = NULL
)
week1
```


###### 10.1.1.1.1. Weeks
Prepare tables
```{r fig.height=5, fig.width=5}
#Week 1 ------
links_df_W1 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 1) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 1) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, Shared)

mat_week1 = links_df_W1 %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()
grid.col_w1 = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W1,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)
group_w1 = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W1,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)


#Week 2 ------
links_df_W2 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 2) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 2) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, Shared)

mat_week2 = links_df_W2 %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_w2 = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W2,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_w2 = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W2,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)


#Week 4 ------
links_df_W4 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 4) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 4) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, Shared)

mat_week4 = links_df_W4 %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_w4 = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W4,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_w4 = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W4,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

#Week 8 ------
links_df_W8 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 8) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 8) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, Shared)

mat_week8 = links_df_W8 %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_w8 = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W8,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_w8 = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W8,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

```
Plot
```{r fig.height= 5, fig.width=10}
#Plot
png(filename = here("Figures","ChordDiagram_Covid19_Weeks_1-2-4-7.png"), 
    width = 12, height = 14, units = "in", res = 300)

par(mfrow = c(2, 2))
#WEEK 1
chordDiagram(mat_week1, 
             grid.col = grid.col_w1, 
             annotationTrack = "grid", 
             directional = -1,
             big.gap = 6,
             transparency = 0,
             small.gap = 3,
             link.zindex = rank(mat_week1),
             h.ratio = 0.7, 
             group = group_w1,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week1))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Week 1")

# WEEK 2
chordDiagram(mat_week2, grid.col = grid.col_w2, 
             annotationTrack = "grid", 
            big.gap = 50,
             group = group_w2,
             small.gap = 3,
             link.zindex = rank(mat_week2),
             h.ratio = 0.7, 
             directional = -1,
             transparency = 0,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week2))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},
  bg.border = NA)

title("Week 2")


# WEEK 4
chordDiagram(mat_week4, grid.col = grid.col_w4, 
             annotationTrack = "grid", 
            big.gap = 50,
             group = group_w4,
             small.gap = 3,
             link.zindex = rank(mat_week4),
             h.ratio = 0.7, 
             directional = -1,
             transparency = 0,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week4))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},
  bg.border = NA)

title("Week 4")

# WEEK 8
chordDiagram(mat_week8, grid.col = grid.col_w8, 
             annotationTrack = "grid", 
            big.gap = 50,
             group = group_w8,
             small.gap = 3,
             link.zindex = rank(mat_week8),
             h.ratio = 0.7, 
             directional = -1,
             transparency = 0,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week8))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},
  bg.border = NA)

title("Week 8")

dev.off()
circos.clear()

```

##### 10.1.1.1.2. Types
Prepare tables
```{r fig.height= 10, fig.width=10}
#Types
###### All -----
links_df = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  dplyr::select(Cond1, Cond2, Shared)

mat_types = links_df %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_types = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_types = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

# Vaccination only -------
links_df_vac = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(disease_vac == "V") %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(disease_vac == "V") %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, Shared)

mat_types_vac = links_df_vac %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_types_vac = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_vac,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_types_vac = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_vac,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

#Infection only
links_df_inf = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(disease_vac == "I") %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(disease_vac == "I") %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, Shared)

mat_types_inf = links_df_inf %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_types_inf = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_inf,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_types_inf = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_inf,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)
```

Plot
All conditions and stats
```{r fig.height= 5, fig.width=5}
#Plot

#Types

png(filename = here("Figures","ChordDiagram_Covid19_Types_All.png"), 
    width = 5, height = 5, units = "in", res = 300)

#Infection and vaccination
chordDiagram(mat_types, grid.col = grid.col_types,
             annotationTrack = "grid",  transparency = 0,
             big.gap = 10,
             small.gap = 3,
             directional = -1, 
             group = group_types,
             link.zindex = rank(mat_types),
              h.ratio = 0.7, 
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_types))))))

circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.5, #Label size
      font = 0.1
      )},
  bg.border = NA)
title("Infection and Vaccination")

dev.off()
circos.clear()
```

By state
```{r fig.height= 5, fig.width=15}

png(filename = here("Figures","ChordDiagram_Covid19_Types_Inf_Vac.png"), 
    width = 6, height = 12, units = "in", res = 300)

par(mfrow = c(2, 1))
#Vaccination
chordDiagram(mat_types_vac, grid.col = grid.col_types_vac, 
             annotationTrack = "grid", transparency = 0,
             big.gap = 6,
             small.gap = 3,
                          directional = -1,
             group = group_types,
             link.zindex = rank(mat_types_vac),
             h.ratio = 0.7, 
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_types_vac))))))

circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.5, #Label size
      font = 0.1
      )},
  bg.border = NA) 
title("Vaccination only")

#Infection
chordDiagram(mat_types_inf, grid.col = grid.col_types_inf, 
             annotationTrack = "grid", transparency = 0,
             big.gap = 50,
             small.gap = 3,
            directional = -1,
             group = group_types,
             h.ratio = 0.7, 
             link.zindex = rank(mat_types_inf),
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_types_inf))))))

circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.5, #Label size
      font = 0.1
      )},
  bg.border = NA) 
title("Infection only")
circos.clear()
dev.off()
```


#### 10.1.1.2. Jaccard distance
##### 10.1.1.2.1. Interactive
```{r}

matrix_vaccines <- shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance) %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

types = shared_genes_df_mirror %>% 
  dplyr::select(condition = Cond1) %>% 
  distinct() %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(condition, type), by = "condition") %>% 
  dplyr::select(type)

colors = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(condition, type), by = "type") %>% 
  inner_join(matrix_vaccines %>% 
               as.data.frame() %>% 
               colnames() %>% as.data.frame() %>% rename(condition = "."),
             by = "condition") %>% 
  pull(color)

# Build the chord diagram:
chorddiag(matrix_vaccines,
          groupColors = colors,
          type = "directional",
          width = NULL,
          height = NULL,
          margin = 100,
          showGroupnames = TRUE,
          groupThickness = 0.1,
          groupPadding = 2,
          groupnamePadding = 1,
          groupnameFontsize = 10,
          groupedgeColor = NULL,
          chordedgeColor = NULL,
          categoryNames = NULL,
          categorynamePadding = 100,
          categorynameFontsize = 28,
          showTicks = TRUE,
          tickInterval = NULL,
          ticklabelFontsize = 10,
          fadeLevel = 0.1,
          showTooltips = TRUE,
          showZeroTooltips = TRUE,
          tooltipNames = NULL,
          tooltipUnit = NULL,
          tooltipFontsize = 12,
          tooltipGroupConnector = " &#x25B6; ",
          precision = NULL,
          clickAction = NULL,
          clickGroupAction = NULL
)
```

##### 10.1.1.2.2.Static
Prepare tables
```{r fig.height=5, fig.width=5}
#Week 1 ------
links_df_W1 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 1) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 1) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance)

mat_week1 = links_df_W1 %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()
grid.col_w1 = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W1,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)
group_w1 = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W1,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)


#Week 2 ------
links_df_W2 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 2) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 2) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance)

mat_week2 = links_df_W2 %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_w2 = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W2,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_w2 = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W2,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)


#Week 4 ------
links_df_W4 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 4) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 4) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance)

mat_week4 = links_df_W4 %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_w4 = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W4,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_w4 = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W4,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

#Week 8 ------
links_df_W8 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 8) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 8) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance)

mat_week8 = links_df_W8 %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_w8 = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W8,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_w8 = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W8,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

```
Plot
```{r fig.height= 5, fig.width=10}
#Plot
png(filename = here("Figures","ChordDiagram_Covid19_Weeks_1-2-4-7_jaccard.png"), 
    width = 12, height = 14, units = "in", res = 300)

par(mfrow = c(2, 2))
#WEEK 1
chordDiagram(mat_week1, 
             grid.col = grid.col_w1, 
             annotationTrack = "grid", 
             directional = -1,
             big.gap = 6,
             transparency = 0,
             small.gap = 3,
             link.zindex = rank(mat_week1),
             h.ratio = 0.7, 
             group = group_w1,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week1))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Week 1")

# WEEK 2
chordDiagram(mat_week2, grid.col = grid.col_w2, 
             annotationTrack = "grid", 
            big.gap = 50,
             group = group_w2,
             small.gap = 3,
             link.zindex = rank(mat_week2),
             h.ratio = 0.7, 
             directional = -1,
             transparency = 0,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week2))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},
  bg.border = NA)

title("Week 2")


# WEEK 4
chordDiagram(mat_week4, grid.col = grid.col_w4, 
             annotationTrack = "grid", 
            big.gap = 50,
             group = group_w4,
             small.gap = 3,
             link.zindex = rank(mat_week4),
             h.ratio = 0.7, 
             directional = -1,
             transparency = 0,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week4))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},
  bg.border = NA)

title("Week 4")

# WEEK 8
chordDiagram(mat_week8, grid.col = grid.col_w8, 
             annotationTrack = "grid", 
            big.gap = 50,
             group = group_w8,
             small.gap = 3,
             link.zindex = rank(mat_week8),
             h.ratio = 0.7, 
             directional = -1,
             transparency = 0,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week8))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},
  bg.border = NA)

title("Week 8")

dev.off()
circos.clear()

```

##### 10.1.1.2.3. Types
Prepare tables
```{r fig.height= 10, fig.width=10}
#Types
###### All -----
links_df = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance)

mat_types = links_df %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(jaccard_distance = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_types = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_types = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

# Vaccination only -------
links_df_vac = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(disease_vac == "V") %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(disease_vac == "V") %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance)

mat_types_vac = links_df_vac %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(jaccard_distance = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_types_vac = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_vac,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_types_vac = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_vac,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

#Infection only
links_df_inf = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(disease_vac == "I") %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(disease_vac == "I") %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance)

mat_types_inf = links_df_inf %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(jaccard_distance = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_types_inf = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_inf,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_types_inf = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_inf,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)
```

Plot
All conditions and stats
```{r fig.height= 5, fig.width=5}
#Plot

#Types

png(filename = here("Figures","ChordDiagram_Covid19_Types_All_jaccard_distance.png"), 
    width = 5, height = 5, units = "in", res = 300)

#Infection and vaccination
chordDiagram(mat_types, grid.col = grid.col_types,
             annotationTrack = "grid",  transparency = 0,
             big.gap = 10,
             small.gap = 3,
             directional = -1, 
             group = group_types,
             link.zindex = rank(mat_types),
              h.ratio = 0.7, 
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_types))))))

circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.5, #Label size
      font = 0.1
      )},
  bg.border = NA)
title("Infection and Vaccination")

dev.off()
circos.clear()
```

By state
```{r fig.height= 5, fig.width=15}

png(filename = here("Figures","ChordDiagram_Covid19_Types_Inf_Vac_jaccard_distance.png"), 
    width = 6, height = 12, units = "in", res = 300)

par(mfrow = c(2, 1))
#Vaccination
chordDiagram(mat_types_vac, grid.col = grid.col_types_vac, 
             annotationTrack = "grid", transparency = 0,
             big.gap = 6,
             small.gap = 3,
                          directional = -1,
             group = group_types,
             link.zindex = rank(mat_types_vac),
             h.ratio = 0.7, 
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_types_vac))))))

circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.5, #Label size
      font = 0.1
      )},
  bg.border = NA) 
title("Vaccination only")

#Infection
chordDiagram(mat_types_inf, grid.col = grid.col_types_inf, 
             annotationTrack = "grid", transparency = 0,
             big.gap = 50,
             small.gap = 3,
            directional = -1,
             group = group_types,
             h.ratio = 0.7, 
             link.zindex = rank(mat_types_inf),
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_types_inf))))))

circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.5, #Label size
      font = 0.1
      )},
  bg.border = NA) 
title("Infection only")
circos.clear()
dev.off()
```
## 10.2. COVID and other Vaccines - immune genes

### 10.2.1. Chord diagram

Input
```{r}
degs_all_updown_covid_other_immune_shared <- read_csv("VaxGO gene sets/degs_all_updown_covid_other_immune_shared.csv")

All_covid_sharedgenes_Fisher_Jaccard = degs_all_updown_covid_other_immune_shared

shared_genes_df_mirror = All_covid_sharedgenes_Fisher_Jaccard
```


##### 10.2.1.1. Shared
```{r}
#Filters 
filter_shared = 1
filter_pvalue = 0.10

library(chorddiag)

matrix_vaccines <- shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  dplyr::select(Cond1, Cond2, Shared) %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

types = shared_genes_df_mirror %>% 
  dplyr::select(condition = Cond1) %>% 
  distinct() %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(condition, type), by = "condition") %>% 
  dplyr::select(type)

colors = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(condition, type), by = "type") %>% 
  inner_join(matrix_vaccines %>% 
               as.data.frame() %>% 
               colnames() %>% as.data.frame() %>% rename(condition = "."),
             by = "condition") %>% 
  pull(color)

# Build the chord diagram:
all_shared = chorddiag(matrix_vaccines,
          groupColors = colors,
          type = "directional",
          width = NULL,
          height = NULL,
          margin = 100,
          showGroupnames = TRUE,
          groupThickness = 0.1,
          groupPadding = 2,
          groupnamePadding = 1,
          groupnameFontsize = 10,
          groupedgeColor = NULL,
          chordedgeColor = NULL,
          categoryNames = NULL,
          categorynamePadding = 100,
          categorynameFontsize = 28,
          showTicks = TRUE,
          tickInterval = NULL,
          ticklabelFontsize = 10,
          fadeLevel = 0.1,
          showTooltips = TRUE,
          showZeroTooltips = TRUE,
          tooltipNames = NULL,
          tooltipUnit = NULL,
          tooltipFontsize = 12,
          tooltipGroupConnector = " &#x25B6; ",
          precision = NULL,
          clickAction = NULL,
          clickGroupAction = NULL
)
all_shared
```

```{r}
matrix_vaccines_week1 <- shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 1) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 1) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, Shared) %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

types = shared_genes_df_mirror %>% 
  dplyr::select(condition = Cond1) %>% 
  distinct() %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(condition, type), by = "condition") %>% 
  dplyr::select(type)

colors = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(condition, type), by = "type") %>% 
  inner_join(matrix_vaccines_week1 %>% 
               as.data.frame() %>% 
               colnames() %>% as.data.frame() %>% rename(condition = "."),
             by = "condition") %>% 
  pull(color)

# Build the chord diagram:
week1 = chorddiag(matrix_vaccines_week1,
          groupColors = colors,
          type = "directional",
          width = NULL,
          height = NULL,
          margin = 100,
          showGroupnames = TRUE,
          groupThickness = 0.1,
          groupPadding = 2,
          groupnamePadding = 1,
          groupnameFontsize = 10,
          groupedgeColor = NULL,
          chordedgeColor = NULL,
          categoryNames = NULL,
          categorynamePadding = 100,
          categorynameFontsize = 28,
          showTicks = TRUE,
          tickInterval = NULL,
          ticklabelFontsize = 10,
          fadeLevel = 0.1,
          showTooltips = TRUE,
          showZeroTooltips = TRUE,
          tooltipNames = NULL,
          tooltipUnit = NULL,
          tooltipFontsize = 12,
          tooltipGroupConnector = " &#x25B6; ",
          precision = NULL,
          clickAction = NULL,
          clickGroupAction = NULL
)
week1
```


###### 10.2.1.2. Weeks
Prepare tables
```{r fig.height=5, fig.width=5}
#Week 1 ------
links_df_W1 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 1) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 1) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, Shared)

mat_week1 = links_df_W1 %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()
grid.col_w1 = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W1,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)
group_w1 = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W1,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)


#Week 2 ------
links_df_W2 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 2) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 2) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, Shared)

mat_week2 = links_df_W2 %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_w2 = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W2,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_w2 = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W2,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)


#Week 4 ------
links_df_W4 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 4) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 4) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, Shared)

mat_week4 = links_df_W4 %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_w4 = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W4,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_w4 = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W4,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

#Week 8 ------
links_df_W8 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 8) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 8) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, Shared)

mat_week8 = links_df_W8 %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_w8 = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W8,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_w8 = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W8,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

```
Plot
```{r fig.height= 5, fig.width=10}
#Plot
png(filename = here("Figures","ChordDiagram_Covid19_Weeks_1-2-4-7.png"), 
    width = 12, height = 14, units = "in", res = 300)

par(mfrow = c(2, 2))
#WEEK 1
chordDiagram(mat_week1, 
             grid.col = grid.col_w1, 
             annotationTrack = "grid", 
             directional = -1,
             big.gap = 6,
             transparency = 0,
             small.gap = 3,
             link.zindex = rank(mat_week1),
             h.ratio = 0.7, 
             group = group_w1,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week1))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Week 1")

# WEEK 2
chordDiagram(mat_week2, grid.col = grid.col_w2, 
             annotationTrack = "grid", 
            big.gap = 50,
             group = group_w2,
             small.gap = 3,
             link.zindex = rank(mat_week2),
             h.ratio = 0.7, 
             directional = -1,
             transparency = 0,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week2))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},
  bg.border = NA)

title("Week 2")


# WEEK 4
chordDiagram(mat_week4, grid.col = grid.col_w4, 
             annotationTrack = "grid", 
            big.gap = 50,
             group = group_w4,
             small.gap = 3,
             link.zindex = rank(mat_week4),
             h.ratio = 0.7, 
             directional = -1,
             transparency = 0,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week4))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},
  bg.border = NA)

title("Week 4")

# WEEK 8
chordDiagram(mat_week8, grid.col = grid.col_w8, 
             annotationTrack = "grid", 
            big.gap = 50,
             group = group_w8,
             small.gap = 3,
             link.zindex = rank(mat_week8),
             h.ratio = 0.7, 
             directional = -1,
             transparency = 0,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week8))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},
  bg.border = NA)

title("Week 8")

dev.off()
circos.clear()

```

###### 10.2.2.2. Types
Prepare tables
```{r fig.height= 10, fig.width=10}
#Types
###### All -----
links_df = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  dplyr::select(Cond1, Cond2, Shared)

mat_types = links_df %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_types = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_types = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

# Vaccination only -------
links_df_vac = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(disease_vac == "V") %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(disease_vac == "V") %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, Shared)

mat_types_vac = links_df_vac %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_types_vac = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_vac,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_types_vac = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_vac,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

#Infection only
links_df_inf = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(disease_vac == "I") %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(disease_vac == "I") %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, Shared)

mat_types_inf = links_df_inf %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_types_inf = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_inf,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_types_inf = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_inf,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)
```

Plot
All conditions and stats
```{r fig.height= 5, fig.width=5}
#Plot

#Types

png(filename = here("Figures","ChordDiagram_Covid19_Types_All.png"), 
    width = 5, height = 5, units = "in", res = 300)

#Infection and vaccination
chordDiagram(mat_types, grid.col = grid.col_types,
             annotationTrack = "grid",  transparency = 0,
             big.gap = 10,
             small.gap = 3,
             directional = -1, 
             group = group_types,
             link.zindex = rank(mat_types),
              h.ratio = 0.7, 
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_types))))))

circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.5, #Label size
      font = 0.1
      )},
  bg.border = NA)
title("Infection and Vaccination")

dev.off()
circos.clear()
```

By state
```{r fig.height= 5, fig.width=15}

png(filename = here("Figures","ChordDiagram_Covid19_Types_Inf_Vac.png"), 
    width = 6, height = 12, units = "in", res = 300)

par(mfrow = c(2, 1))
#Vaccination
chordDiagram(mat_types_vac, grid.col = grid.col_types_vac, 
             annotationTrack = "grid", transparency = 0,
             big.gap = 6,
             small.gap = 3,
                          directional = -1,
             group = group_types,
             link.zindex = rank(mat_types_vac),
             h.ratio = 0.7, 
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_types_vac))))))

circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.5, #Label size
      font = 0.1
      )},
  bg.border = NA) 
title("Vaccination only")

#Infection
chordDiagram(mat_types_inf, grid.col = grid.col_types_inf, 
             annotationTrack = "grid", transparency = 0,
             big.gap = 50,
             small.gap = 3,
            directional = -1,
             group = group_types,
             h.ratio = 0.7, 
             link.zindex = rank(mat_types_inf),
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_types_inf))))))

circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.5, #Label size
      font = 0.1
      )},
  bg.border = NA) 
title("Infection only")
circos.clear()
dev.off()
```


#### 10.2.2. Jaccard distance
##### 10.2.2.1. Interactive
```{r}

matrix_vaccines <- shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance) %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

types = shared_genes_df_mirror %>% 
  dplyr::select(condition = Cond1) %>% 
  distinct() %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(condition, type), by = "condition") %>% 
  dplyr::select(type)

colors = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(condition, type), by = "type") %>% 
  inner_join(matrix_vaccines %>% 
               as.data.frame() %>% 
               colnames() %>% as.data.frame() %>% rename(condition = "."),
             by = "condition") %>% 
  pull(color)

# Build the chord diagram:
chorddiag(matrix_vaccines,
          groupColors = colors,
          type = "directional",
          width = NULL,
          height = NULL,
          margin = 100,
          showGroupnames = TRUE,
          groupThickness = 0.1,
          groupPadding = 2,
          groupnamePadding = 1,
          groupnameFontsize = 10,
          groupedgeColor = NULL,
          chordedgeColor = NULL,
          categoryNames = NULL,
          categorynamePadding = 100,
          categorynameFontsize = 28,
          showTicks = TRUE,
          tickInterval = NULL,
          ticklabelFontsize = 10,
          fadeLevel = 0.1,
          showTooltips = TRUE,
          showZeroTooltips = TRUE,
          tooltipNames = NULL,
          tooltipUnit = NULL,
          tooltipFontsize = 12,
          tooltipGroupConnector = " &#x25B6; ",
          precision = NULL,
          clickAction = NULL,
          clickGroupAction = NULL
)
```

##### 10.2.2.2. Static
Prepare tables
```{r fig.height=5, fig.width=5}
#Week 1 ------
links_df_W1 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 1) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 1) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance)

mat_week1 = links_df_W1 %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()
grid.col_w1 = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W1,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)
group_w1 = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W1,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)


#Week 2 ------
links_df_W2 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 2) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 2) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance)

mat_week2 = links_df_W2 %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_w2 = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W2,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_w2 = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W2,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)


#Week 4 ------
links_df_W4 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 4) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 4) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance)

mat_week4 = links_df_W4 %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_w4 = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W4,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_w4 = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W4,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

#Week 8 ------
links_df_W8 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 8) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 8) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance)

mat_week8 = links_df_W8 %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_w8 = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W8,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_w8 = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W8,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

```
Plot
```{r fig.height= 5, fig.width=10}
#Plot
png(filename = here("Figures","ChordDiagram_Covid19_Weeks_1-2-4-7_jaccard.png"), 
    width = 12, height = 14, units = "in", res = 300)

par(mfrow = c(2, 2))
#WEEK 1
chordDiagram(mat_week1, 
             grid.col = grid.col_w1, 
             annotationTrack = "grid", 
             directional = -1,
             big.gap = 6,
             transparency = 0,
             small.gap = 3,
             link.zindex = rank(mat_week1),
             h.ratio = 0.7, 
             group = group_w1,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week1))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Week 1")

# WEEK 2
chordDiagram(mat_week2, grid.col = grid.col_w2, 
             annotationTrack = "grid", 
            big.gap = 50,
             group = group_w2,
             small.gap = 3,
             link.zindex = rank(mat_week2),
             h.ratio = 0.7, 
             directional = -1,
             transparency = 0,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week2))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},
  bg.border = NA)

title("Week 2")


# WEEK 4
chordDiagram(mat_week4, grid.col = grid.col_w4, 
             annotationTrack = "grid", 
            big.gap = 50,
             group = group_w4,
             small.gap = 3,
             link.zindex = rank(mat_week4),
             h.ratio = 0.7, 
             directional = -1,
             transparency = 0,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week4))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},
  bg.border = NA)

title("Week 4")

# WEEK 8
chordDiagram(mat_week8, grid.col = grid.col_w8, 
             annotationTrack = "grid", 
            big.gap = 50,
             group = group_w8,
             small.gap = 3,
             link.zindex = rank(mat_week8),
             h.ratio = 0.7, 
             directional = -1,
             transparency = 0,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week8))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},
  bg.border = NA)

title("Week 8")

dev.off()
circos.clear()

```

##### 10.2.2.3. Types
Prepare tables
```{r fig.height= 10, fig.width=10}
#Types
###### All -----
links_df = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance)

mat_types = links_df %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(jaccard_distance = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_types = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_types = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

# Vaccination only -------
links_df_vac = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(disease_vac == "V") %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(disease_vac == "V") %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance)

mat_types_vac = links_df_vac %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(jaccard_distance = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_types_vac = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_vac,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_types_vac = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_vac,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

#Infection only
links_df_inf = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(disease_vac == "I") %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(disease_vac == "I") %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance)

mat_types_inf = links_df_inf %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(jaccard_distance = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_types_inf = ann_vaxsig_colors$type %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_inf,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_types_inf = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_inf,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)
```

Plot
All conditions and stats
```{r fig.height= 5, fig.width=5}
#Plot

#Types

png(filename = here("Figures","ChordDiagram_Covid19_Types_All_jaccard_distance.png"), 
    width = 5, height = 5, units = "in", res = 300)

#Infection and vaccination
chordDiagram(mat_types, grid.col = grid.col_types,
             annotationTrack = "grid",  transparency = 0,
             big.gap = 10,
             small.gap = 3,
             directional = -1, 
             group = group_types,
             link.zindex = rank(mat_types),
              h.ratio = 0.7, 
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_types))))))

circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.5, #Label size
      font = 0.1
      )},
  bg.border = NA)
title("Infection and Vaccination")

dev.off()
circos.clear()
```

By state
```{r fig.height= 5, fig.width=15}

png(filename = here("Figures","ChordDiagram_Covid19_Types_Inf_Vac_jaccard_distance.png"), 
    width = 6, height = 12, units = "in", res = 300)

par(mfrow = c(2, 1))
#Vaccination
chordDiagram(mat_types_vac, grid.col = grid.col_types_vac, 
             annotationTrack = "grid", transparency = 0,
             big.gap = 6,
             small.gap = 3,
                          directional = -1,
             group = group_types,
             link.zindex = rank(mat_types_vac),
             h.ratio = 0.7, 
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_types_vac))))))

circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.5, #Label size
      font = 0.1
      )},
  bg.border = NA) 
title("Vaccination only")

#Infection
chordDiagram(mat_types_inf, grid.col = grid.col_types_inf, 
             annotationTrack = "grid", transparency = 0,
             big.gap = 50,
             small.gap = 3,
            directional = -1,
             group = group_types,
             h.ratio = 0.7, 
             link.zindex = rank(mat_types_inf),
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_types_inf))))))

circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.5, #Label size
      font = 0.1
      )},
  bg.border = NA) 
title("Infection only")
circos.clear()
dev.off()
```


## 10.3. Cytoscape - COVID-19 non-immune genes

```{r}
ImmuneGO_Annotated_Genes
OtherGOs_Annotated_Genes
degs_all_updown
filename = "covid_vaccines_infection_NonImmune"


##### Table source - target - annotations ------

# Not immune
degs_all_updown_covid_notimmune = degs_all_updown %>% 
  as.data.frame() %>% 
  select(condition:direction) %>% 
  inner_join(ann_vaccines, by = "condition") %>% 
  inner_join(OtherGOs_Annotated_Genes %>% select(genes) %>% distinct(), by = "genes") %>% 
  distinct() %>% 
  select(condition, genes, regulation = direction)  %>% 
  distinct() %>% 
    filter(regulation %in% c("UP", "DOWN")) %>% 
  mutate(regulation_numeric = case_when(
    regulation %in% c("UP") ~ 1,
    regulation %in% c("DOWN") ~ -1,
    TRUE ~ as.numeric(regulation)
  )) %>% 
  distinct()


# Not immune genes
notimmune_source1 = degs_all_updown_covid_notimmune %>% 
  inner_join(OtherGOs_Annotated_Genes %>% filter(annotation == "Major process", term != "Immune system"), by = "genes") %>% 
  select(source = condition, target = genes, value = regulation_numeric) %>% 
  distinct() %>% 
  left_join(ann_vaccines_covid_other %>% rename(source = condition), by = "source") %>% 
    mutate(covid_other = if_else(is.na(covid_other), "OTHER", covid_other),
           annotation = paste0("Condition", covid_other))

notimmune_source2 = degs_all_updown_covid_notimmune %>% 
  inner_join(OtherGOs_Annotated_Genes %>% filter(annotation == "Major process", term != "Immune system"), by = "genes") %>% 
  select(source = term, target = genes, value = regulation_numeric) %>% 
  distinct() %>% 
  mutate(value = 0, 
         annotation = "Other processes")

not_immune = bind_rows(notimmune_source1, notimmune_source2) %>% mutate(id = source)

write.csv(not_immune, file = paste0(filename, "Network.csv"), row.names = F)

##### Tables nodes and edges ------

edges = not_immune %>% 
  select(source, target, value) %>% 
  mutate(type = "Directed")

nodes = not_immune %>% 
  select(source, annotation, vaccine:infection) %>% 
  distinct() %>% 
  mutate(id = source)

write.csv(edges, file = paste0(filename, "Network_edges.csv"), row.names = F)
write.csv(nodes, file = paste0(filename, "Network_nodes.csv"), row.names = F)

```

## 10.4. Cytoscape -  COVID immune and non immune genes

```{r}
ImmuneGO_Annotated_Genes
OtherGOs_Annotated_Genes
degs_all_updown
filename = "covid_vaccines_infection_Immune_Notimmune"


##### Table source - target - annotations ------

#Immune
degs_all_updown_covid_immune = degs_all_updown %>% 
  as.data.frame() %>% 
  select(condition:direction) %>% 
  inner_join(ann_vaccines, by = "condition") %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% select(genes) %>% distinct(), by = "genes") %>% 
  distinct() %>% 
  select(condition, genes, regulation = direction)  %>% 
  distinct() %>% 
  filter(regulation %in% c("UP", "DOWN")) %>% 
  mutate(regulation_numeric = case_when(
    regulation %in% c("UP") ~ 1,
    regulation %in% c("DOWN") ~ -1,
    TRUE ~ as.numeric(regulation)
  )) %>% 
  distinct()

# Not immune
degs_all_updown_covid_notimmune = degs_all_updown %>% 
  as.data.frame() %>% 
  select(condition:direction) %>% 
  inner_join(ann_vaccines, by = "condition") %>% 
  inner_join(OtherGOs_Annotated_Genes %>% filter(term != "Immune system") %>% select(genes) %>% distinct(), by = "genes") %>% 
  distinct() %>% 
  select(condition, genes, regulation = direction)  %>% 
  distinct() %>% 
    filter(regulation %in% c("UP", "DOWN")) %>% 
  mutate(regulation_numeric = case_when(
    regulation %in% c("UP") ~ 1,
    regulation %in% c("DOWN") ~ -1,
    TRUE ~ as.numeric(regulation)
  )) %>% 
  distinct()

# Immune
immune_source1 = degs_all_updown_covid_immune %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% filter(go_term == "Manual", 
                                                 !(process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE"))), 
             by = "genes") %>% 
  select(source = condition, target = genes, value = regulation_numeric) %>% 
  distinct() %>% 
  left_join(ann_vaccines_covid_other %>% rename(source = condition), by = "source") %>% 
  mutate(covid_other = if_else(is.na(covid_other), "OTHER", covid_other),
         annotation = paste0("Condition", covid_other))

immune_source2 = degs_all_updown_covid_immune %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% filter(go_term == "Manual", 
                                                 !(process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE"))), 
             by = "genes") %>% 
  select(source = process, target = genes) %>% 
  distinct() %>% 
  mutate(value = 0, 
         annotation = "Immune system")

immune = bind_rows(immune_source1, immune_source2) %>% mutate(id = source)


# Not immune genes
notimmune_source1 = degs_all_updown_covid_notimmune %>% 
  inner_join(OtherGOs_Annotated_Genes %>% filter(annotation == "Major process", term != "Immune system"), by = "genes") %>% 
  select(source = condition, target = genes, value = regulation_numeric) %>% 
  distinct() %>% 
  left_join(ann_vaccines_covid_other %>% rename(source = condition), by = "source") %>% 
    mutate(covid_other = if_else(is.na(covid_other), "OTHER", covid_other),
           annotation = paste0("Condition", covid_other))

notimmune_source2 = degs_all_updown_covid_notimmune %>% 
  inner_join(OtherGOs_Annotated_Genes %>% filter(annotation == "Major process", term != "Immune system"), by = "genes") %>% 
  select(source = term, target = genes, value = regulation_numeric) %>% 
  distinct() %>% 
  mutate(value = 0, 
         annotation = "Other processes")

not_immune = bind_rows(notimmune_source1, notimmune_source2) %>% mutate(id = source)
immune_notimmune = bind_rows(not_immune, immune)
write.csv(immune_notimmune, file = paste0(filename, "Network_immune_notimmune.csv"), row.names = F)

##### Tables nodes and edges ------

edges = immune_notimmune %>% 
  select(source, target, value) %>% 
  mutate(type = "Directed")

nodes = immune_notimmune %>% 
  select(source, annotation, vaccine:infection) %>% 
  distinct() %>% 
  mutate(id = source)

write.csv(edges, file = paste0(filename, "Network_immune_notimmune_edges.csv"), row.names = F)
write.csv(nodes, file = paste0(filename, "Network_immune_notimmune_nodes.csv"), row.names = F)

```

### 10.4.1. COVID-COVID Network by statistics only (TOTAL = UP AND DOWN)

```{r}
# Vaccines and infection -----
ann_vaccines_covid_other

degs_all_updown_covid_other_immune_shared
degs_all_updown_covid_other_nonimmune_shared

filename = "degs_all_updown_covid-covid_immune_shared"

edges = degs_all_updown_covid_other_immune_shared %>% 
  select(-"...1") %>% 
  inner_join(ann_vaccines_covid_other %>% filter(covid_other == "COVID"), by = join_by(Cond1 == condition)) %>% 
  inner_join(ann_vaccines_covid_other %>% filter(covid_other == "COVID") %>% select(condition), by = join_by(Cond2 == condition)) %>% 
  clean_names()

edges_mirror = edges %>% 
  select(cond1:qvalue) %>% 
  rename(cond2.1 = cond1, cond1.2 = cond2) %>% 
  rename(cond2 = cond2.1, cond1 = cond1.2) %>% 
  select(cond1, cond2, everything()) %>% 
  inner_join(ann_vaccines_covid_other %>% filter(covid_other == "COVID"), by = join_by(cond1 == condition))

edges_flourish = bind_rows(edges, edges_mirror)

nodes = ann_vaccines_covid_other 
edges_nodes = edges


my_colors <- ann_vaccines_covid_other %>% 
 mutate(color = case_when(
    type == "VLP" ~ "#7E6148FF",
    type == "LA" ~ "#E64B35FF",
    type == "CONJ" ~ "#F39B7FFF",
    type == "IN" ~ "#00A087FF",
    type == "VV" ~ "#3C5488FF",
    type == "RNA" ~ "#4DBBD5FF",
    type == "SU" ~ "#8491B4FF",
    type == "I" ~ "#DC0000FF",
    TRUE ~ NA_character_),
    color_covid_other = if_else(covid_other == "COVID", "#56cfe1", "#343a40"))

my_colors %>% select(condition, color, color_covid_other) %>% 
  write_tsv("covid_others_colors.tsv")


write_tsv(edges_nodes, file = paste0(filename, "Network_Covid_Other_sharedgenes_edges_and_nodes.tsv"))
write_tsv(edges_flourish, file = paste0(filename, "Network_Covid_Other_sharedgenes_edges.tsv"))
write.csv(edges_flourish, file = paste0(filename, "Network_Covid_Other_sharedgenes_edges.csv"), row.names = F)
write_tsv(nodes, file = paste0(filename, "Network_Covid_Other_sharedgenes_nodes.tsv"))

# Only Covid vaccination (previous or no previous infection) vs other vaccines-----
ann_vaccines_covid_other

edges = degs_all_updown_covid_other_immune_shared %>% 
  select(-"...1") %>% 
  inner_join(ann_vaccines_covid_other %>% filter(covid_other == "COVID", !regimen %in% c("I", "I-I")), by = join_by(Cond1 == condition)) %>% 
  inner_join(ann_vaccines_covid_other %>% filter(covid_other == "OTHER") %>% select(condition), by = join_by(Cond2 == condition)) %>% 
  clean_names()

edges_mirror = edges %>% 
  select(cond1:qvalue) %>% 
  rename(cond2.1 = cond1, cond1.2 = cond2) %>% 
  rename(cond2 = cond2.1, cond1 = cond1.2) %>% 
  select(cond1, cond2, everything()) %>% 
  inner_join(ann_vaccines_covid_other %>% filter(covid_other == "OTHER"), by = join_by(cond1 == condition))

edges_flourish = bind_rows(edges, edges_mirror)

nodes = ann_vaccines_covid_other 
my_colors <- ann_vaccines_covid_other %>% 
 mutate(color = case_when(
    type == "VLP" ~ "#D7B0EE",
    type == "LA" ~ "#ffb703",
    type == "CONJ" ~ "#015BA0",
    type == "IN" ~ "#76c893",
    type == "VV" ~ "#5e60ce",
    type == "RNA" ~ "#56cfe1",
    type == "SU" ~ "#b5e48c",
    type == "I" ~ "#f72585",
    TRUE ~ NA_character_),
    color_covid_other = if_else(covid_other == "COVID", "#56cfe1", "#343a40"))

my_colors %>% select(condition, color, color_covid_other) %>% 
  write_tsv("covid_others_colors.tsv")

write_tsv(edges_flourish, file = paste0(filename, "Network_Covid_Other_Vaccinesonly_sharedgenes_edges.tsv"))
write.csv(edges_flourish, file = paste0(filename, "Network_Covid_Other_Vaccinesonly_sharedgenes_edges.csv"), row.names = F)
write_tsv(nodes, file = paste0(filename, "Network_Covid_Other_sharedgenes_nodes.tsv"))

```

### 10.4.2. COVID-COVID Network (UP + DOWN)

```{r}
# Vaccines and infection -----
ann_vaccines_covid_other

degs_all_updown_covid_immune

filename = "degs_all_updown_covid-covid_immune_shared_UPandDOWN_"

edges 

degs_all_updown_covid_immune %>% 
  inner_join(degs_all_updown_covid_immune %>% select(target = condition, genes, regulation), by = "genes") %>% 
  select(source = condition, genes, regulation)
  inner_join(ann_vaccines_covid_other %>% filter(covid_other == "COVID"), by = join_by(Cond1 == condition)) %>% 
  inner_join(ann_vaccines_covid_other %>% filter(covid_other == "COVID") %>% select(condition), by = join_by(Cond2 == condition)) %>% 
  clean_names()
```

```{r}
edges_mirror = edges %>% 
  select(cond1:qvalue) %>% 
  rename(cond2.1 = cond1, cond1.2 = cond2) %>% 
  rename(cond2 = cond2.1, cond1 = cond1.2) %>% 
  select(cond1, cond2, everything()) %>% 
  inner_join(ann_vaccines_covid_other %>% filter(covid_other == "COVID"), by = join_by(cond1 == condition))

edges_flourish = bind_rows(edges, edges_mirror)

nodes = ann_vaccines_covid_other 
edges_nodes = edges


my_colors <- ann_vaccines_covid_other %>% 
 mutate(color = case_when(
    type == "VLP" ~ "#7E6148FF",
    type == "LA" ~ "#E64B35FF",
    type == "CONJ" ~ "#F39B7FFF",
    type == "IN" ~ "#00A087FF",
    type == "VV" ~ "#3C5488FF",
    type == "RNA" ~ "#4DBBD5FF",
    type == "SU" ~ "#8491B4FF",
    type == "I" ~ "#DC0000FF",
    TRUE ~ NA_character_),
    color_covid_other = if_else(covid_other == "COVID", "#56cfe1", "#343a40"))

my_colors %>% select(condition, color, color_covid_other) %>% 
  write_tsv("covid_others_colors.tsv")


write_tsv(edges_nodes, file = paste0(filename, "Network_Covid_Other_sharedgenes_edges_and_nodes.tsv"))
write_tsv(edges_flourish, file = paste0(filename, "Network_Covid_Other_sharedgenes_edges.tsv"))
write.csv(edges_flourish, file = paste0(filename, "Network_Covid_Other_sharedgenes_edges.csv"), row.names = F)
write_tsv(nodes, file = paste0(filename, "Network_Covid_Other_sharedgenes_nodes.tsv"))

# Only Covid vaccination (previous or no previous infection) vs other vaccines-----
ann_vaccines_covid_other

edges = degs_all_updown_covid_other_immune_shared %>% 
  select(-"...1") %>% 
  inner_join(ann_vaccines_covid_other %>% filter(covid_other == "COVID", !regimen %in% c("I", "I-I")), by = join_by(Cond1 == condition)) %>% 
  inner_join(ann_vaccines_covid_other %>% filter(covid_other == "OTHER") %>% select(condition), by = join_by(Cond2 == condition)) %>% 
  clean_names()

edges_mirror = edges %>% 
  select(cond1:qvalue) %>% 
  rename(cond2.1 = cond1, cond1.2 = cond2) %>% 
  rename(cond2 = cond2.1, cond1 = cond1.2) %>% 
  select(cond1, cond2, everything()) %>% 
  inner_join(ann_vaccines_covid_other %>% filter(covid_other == "OTHER"), by = join_by(cond1 == condition))

edges_flourish = bind_rows(edges, edges_mirror)

nodes = ann_vaccines_covid_other 
my_colors <- ann_vaccines_covid_other %>% 
 mutate(color = case_when(
    type == "VLP" ~ "#D7B0EE",
    type == "LA" ~ "#ffb703",
    type == "CONJ" ~ "#015BA0",
    type == "IN" ~ "#76c893",
    type == "VV" ~ "#5e60ce",
    type == "RNA" ~ "#56cfe1",
    type == "SU" ~ "#b5e48c",
    type == "I" ~ "#f72585",
    TRUE ~ NA_character_),
    color_covid_other = if_else(covid_other == "COVID", "#56cfe1", "#343a40"))

my_colors %>% select(condition, color, color_covid_other) %>% 
  write_tsv("covid_others_colors.tsv")

write_tsv(edges_flourish, file = paste0(filename, "Network_Covid_Other_Vaccinesonly_sharedgenes_edges.tsv"))
write.csv(edges_flourish, file = paste0(filename, "Network_Covid_Other_Vaccinesonly_sharedgenes_edges.csv"), row.names = F)
write_tsv(nodes, file = paste0(filename, "Network_Covid_Other_sharedgenes_nodes.tsv"))

```

COVID and other vaccines

```{r}

ImmuneGO_Annotated_Genes
OtherGOs_Annotated_Genes


##### Table source - target - annotations ------


# Immune
immune_source1 = covid_other_immunego_genes %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% filter(go_term == "Manual", 
                                                 !(process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE"))), 
             by = "genes") %>% 
  select(source = condition, target = genes, value = regulation_numeric) %>% 
  distinct() %>% 
  left_join(ann_vaccines_covid_other %>% rename(source = condition), by = "source") %>% 
  mutate(covid_other = if_else(is.na(covid_other), "OTHER", covid_other),
         annotation = paste0("Condition", covid_other))

immune_source2 = covid_other_immunego_genes %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% filter(go_term == "Manual", 
                                                 !(process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE"))), 
             by = "genes") %>% 
  select(source = process, target = genes) %>% 
  distinct() %>% 
  mutate(value = 0, 
         annotation = "Immune system")

immune = bind_rows(immune_source1, immune_source2) %>% mutate(id = source)


# Not immune genes
notimmune_source1 = covid_other_notimmune_genes %>% 
  inner_join(OtherGOs_Annotated_Genes %>% filter(annotation == "Major process"), by = "genes") %>% 
  select(source = condition, target = genes, value = regulation_numeric) %>% 
  distinct() %>% 
  left_join(ann_vaccines_covid_other %>% rename(source = condition), by = "source") %>% 
    mutate(covid_other = if_else(is.na(covid_other), "OTHER", covid_other),
           annotation = paste0("Condition", covid_other))

notimmune_source2 = covid_other_notimmune_genes %>% 
  inner_join(OtherGOs_Annotated_Genes %>% filter(annotation == "Major process") , by = "genes") %>% 
  select(source = term, target = genes, value = regulation_numeric) %>% 
  distinct() %>% 
  mutate(value = 0, 
         annotation = "Other processes")

not_immune = bind_rows(notimmune_source1, notimmune_source2) %>% mutate(id = source)
immune_notimmune = bind_rows(not_immune, immune)
view(immune_notimmune)
write.csv(immune_notimmune, file = "Network_immune_notimmune.csv", row.names = F)

##### Tables nodes and edges ------

edges = immune_notimmune %>% 
  select(source, target, value) %>% 
  mutate(type = "Directed")

nodes = immune_notimmune %>% 
  select(source, annotation, vaccine:infection) %>% 
  distinct() %>% 
  mutate(id = source)

write.csv(edges, file = "Network_immune_notimmune_edges.csv", row.names = F)
write.csv(nodes, file = "Network_immune_notimmune_nodes.csv", row.names = F)
```

## 10.5. Chord plot

### 10.5.1 COVID-19 - All conditions
#### 10.5.1.1. Genes shared by process
```{r}

all_covid_vax_atlas =  readRDS(here("DGE analysis", "all_studies_degs_weighted.rds"))

degs_all_updown_covid_vax_other = read_csv(here("VaxGO gene sets","degs_all_updown_covid_vax_other.csv")) %>% 
  select(-"...1")

ann_vaccines_vaxsig_covid <- read_csv(here("Annotations and metadata", "ann_vaccines_vaxsig_covid.csv"))

annotation_conditions = read_csv(here("Annotations and metadata", "ann_vaccines_conditions.csv"), 
    col_types = cols(...1 = col_skip()))

ImmuneGO_Annotated_GO = read_rds(here("VaxGO gene sets", "ImmuneGO_Annotated_Genes_2024-03-26.rds"))

OtherGOs_Annotated_Genes <- read_csv(here("VaxGO gene sets", "OtherGOs_Annotated_Genes.csv")) %>% 
  select(process = term, genes = symbol) %>% 
  filter(process %in% c("Cellular",
                        "Immune system",
                        "Metabolism"))

ImmuneGO_genes_selected = OtherGOs_Annotated_Genes


# ImmuneGO_genes_selected = ImmuneGO_Annotated_GO %>%
#   filter(go_term == "Manual",
#          process %in% c("ADAPTIVE IMMUNE SYSTEM",
#                         "INNATE IMMUNE SYSTEM",
#                         "ANTIMICROBIAL",
#                         "GENERAL",
#                         "COMPLEMENT")) %>%
#   separate_rows(genes,sep = ",")

conflicted::conflicts_prefer(dplyr::count)
immune_genes_covid = all_covid_vax_atlas  %>% 
  inner_join(ImmuneGO_genes_selected %>% 
               select(genes), by = "genes") %>% 
  inner_join(annotation_conditions %>% 
               select( condition),
             by = "condition") %>% 
    select(condition1 = condition, genes)

immune_genes_covid_shared_process = immune_genes_covid %>% 
  rename(condition2 = condition1) %>% 
  inner_join(immune_genes_covid %>% 
               select(condition1, genes), by = "genes") %>% 
    filter(condition1 != condition2) %>% 
  inner_join(ImmuneGO_genes_selected %>% 
               select(genes, process), by = "genes") %>% 
  distinct() %>% 
  group_by(condition1, condition2, process) %>% 
  summarise(n = n())

```


```{r}
df_vaccines <- immune_genes_covid_shared_process %>% 
  dplyr::select(Cond1 = condition1, 
                Cond2 = condition2, 
                Shared = n, 
                process)

group_types = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(df_vaccines,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

types = df_vaccines %>% 
  dplyr::select(condition = Cond1) %>% 
  distinct() %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(condition, type), by = "condition") %>% 
  dplyr::select(type)

colors = ann_vaxsig_colors$Platform %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(condition, type), by = "type") %>% 
  select(condition, color)

colors_grid = df_vaccines %>%
  rename(condition = Cond1) %>% 
 inner_join(colors, by = "condition") %>% 
 pull(color, condition)

col_links = df_vaccines %>% 
  inner_join(col_immune %>% 
  as.data.frame() %>% 
  rownames_to_column("process") %>% 
  rename("color" = "."), by = "process") %>% 
  pull(color)
```

Select links
```{r}
###### Select links

# Week 1
selected_links_W1 = df_vaccines %>% 
  ungroup() %>% 
  select(Cond1, Cond2) %>% 
  inner_join(annotation_conditions %>% 
              select(Cond1 = condition, week) %>% 
               filter(week == 1),
             by = "Cond1") %>% 
  select(Cond1) %>% 
  mutate(selected_Cond1 = Cond1) %>% 
  distinct()

df_vaccines_selected_W1 = df_vaccines %>% 
  left_join(selected_links_W1 %>% 
              rename(Cond2 = Cond1,
                     selected_Cond2 = selected_Cond1),
             by = "Cond2") %>% 
  left_join(selected_links_W1,
             by = "Cond1") %>% 
  mutate(selected_TF = if_else(!is.na(selected_Cond1), T, F),
         Shared = if_else(!is.na(selected_Cond2), Shared, 0))

selected_links_vector_W1 = df_vaccines_selected_W1 %>% 
  pull(selected_TF)

df_W1 = df_vaccines_selected_W1 %>% 
  select(Cond1:Shared)

# Week 2

selected_links_W2 = df_vaccines %>% 
  ungroup() %>% 
  select(Cond1, Cond2) %>% 
  inner_join(annotation_conditions %>% 
              select(Cond1 = condition, week) %>% 
               filter(week == 2),
             by = "Cond1") %>% 
  select(Cond1) %>% 
  mutate(selected_Cond1 = Cond1) %>% 
  distinct()

df_vaccines_selected_W2 = df_vaccines %>% 
  left_join(selected_links_W2 %>% 
              rename(Cond2 = Cond1,
                     selected_Cond2 = selected_Cond1),
             by = "Cond2") %>% 
  left_join(selected_links_W2,
             by = "Cond1") %>% 
  mutate(selected_TF = if_else(!is.na(selected_Cond1), T, F),
         Shared = if_else(!is.na(selected_Cond2), Shared, 0))

selected_links_vector_W2 = df_vaccines_selected_W2 %>% 
  pull(selected_TF)

df_W2 = df_vaccines_selected_W2 %>% 
  select(Cond1:Shared)

# Week 4

selected_links_W4 = df_vaccines %>% 
  ungroup() %>% 
  select(Cond1, Cond2) %>% 
  inner_join(annotation_conditions %>% 
              select(Cond1 = condition, week) %>% 
               filter(week == 4),
             by = "Cond1") %>% 
  select(Cond1) %>% 
  mutate(selected_Cond1 = Cond1) %>% 
  distinct()

df_vaccines_selected_W4 = df_vaccines %>% 
  left_join(selected_links_W4 %>% 
              rename(Cond2 = Cond1,
                     selected_Cond2 = selected_Cond1),
             by = "Cond2") %>% 
  left_join(selected_links_W4,
             by = "Cond1") %>% 
  mutate(selected_TF = if_else(!is.na(selected_Cond1), T, F),
         Shared = if_else(!is.na(selected_Cond2), Shared, 0))

selected_links_vector_W4 = df_vaccines_selected_W4 %>% 
  pull(selected_TF)

df_W4 = df_vaccines_selected_W4 %>% 
  select(Cond1:Shared)

# Week 7

selected_links_W7 = df_vaccines %>% 
  ungroup() %>% 
  select(Cond1, Cond2) %>% 
  inner_join(annotation_conditions %>% 
              select(Cond1 = condition, week) %>% 
               filter(week == 7),
             by = "Cond1") %>% 
  select(Cond1) %>% 
  mutate(selected_Cond1 = Cond1) %>% 
  distinct()

df_vaccines_selected_W7 = df_vaccines %>% 
  left_join(selected_links_W7 %>% 
              rename(Cond2 = Cond1,
                     selected_Cond2 = selected_Cond1),
             by = "Cond2") %>% 
  left_join(selected_links_W7,
             by = "Cond1") %>% 
  mutate(selected_TF = if_else(!is.na(selected_Cond1), T, F),
         Shared = if_else(!is.na(selected_Cond2), Shared, 0))

selected_links_vector_W7 = df_vaccines_selected_W7 %>% 
  pull(selected_TF)

df_W7 = df_vaccines_selected_W7 %>% 
  select(Cond1:Shared)
```


#### 10.5.1.2. By week


Weeks 1-7
```{r fig.height=10, fig.width=10}
col_immune = c("ADAPTIVE IMMUNE SYSTEM" = "#6817c5",
          "COMPLEMENT" = "#2a9d8f",
          "INNATE IMMUNE SYSTEM" = "#0099ff",
          "GENERAL" = "#435804",
          "ANTIMICROBIAL" = "#38b000",
          
          #General processes
          "Immune system" = "black",
          "Cellular" = "yellow",
          "Metabolism" = "#DC0000FF")

#Plot
pdf(file = here("Figures","ChordDiagram_Covid19_AllCovid_By_Process_Weeks_Immune.pdf"), 
    width = 20, 
    height = 5)

par(mfrow = c(1, 4))
#Week 1
chordDiagram(df_W1, 
             grid.col = colors_grid, 
             col = col_links,
             link.sort = TRUE,
             link.decreasing = TRUE,
             annotationTrack = "grid", 
             directional = 0,
             scale = TRUE,
             big.gap = 3,
             transparency = 0.3,
             small.gap = 0.5,
             h.ratio = 0.7,
             link.visible = selected_links_vector_W1,
             group = group_types,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(unique(df_vaccines$Cond1)))))
             )
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Week 1")


#Week 2
chordDiagram(df_W2, 
             grid.col = colors_grid, 
             col = col_links,
             link.sort = TRUE,
             link.decreasing = TRUE,
             scale = TRUE,
             annotationTrack = "grid", 
             directional = 0,
             big.gap = 3,
             transparency = 0,
             small.gap = 0.5,
             h.ratio = 0.7,
             link.visible = selected_links_vector_W2,
             group = group_types,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(unique(df_vaccines$Cond1)))))
             )
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Week 2")

#Week 4
chordDiagram(df_W4, 
             grid.col = colors_grid, 
             col = col_links,
             link.sort = TRUE,
             link.decreasing = TRUE,
             scale = TRUE,
             annotationTrack = "grid", 
             directional = 0,
             big.gap = 3,
             transparency = 0,
             small.gap = 0.5,
             h.ratio = 0.7,
             link.visible = selected_links_vector_W4,
             group = group_types,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(unique(df_vaccines$Cond1)))))
             )
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Week 4")


#Week 7
chordDiagram(df_W7, 
             grid.col = colors_grid, 
             col = col_links,
             # link.sort = TRUE, 
             # link.decreasing = TRUE,
             annotationTrack = "grid", 
             scale = TRUE,
             directional = 0,
             big.gap = 3,
             transparency = 0,
             small.gap = 0.5,
             h.ratio = 0.7,
             link.visible = selected_links_vector_W7,
             group = group_types,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(unique(df_vaccines$Cond1)))))
             )
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Week 7")

dev.off()
circos.clear()
```


#### 10.5.1.3. By day
```{r}

# Days 1-2
selected_links_D1 = df_vaccines %>% 
  ungroup() %>% 
  select(Cond1, Cond2) %>% 
  inner_join(annotation_conditions %>% 
              select(Cond1 = condition, day) %>% 
               filter(day == c(1, 2)),
             by = "Cond1") %>% 
  select(Cond1) %>% 
  mutate(selected_Cond1 = Cond1) %>% 
  distinct()

df_vaccines_selected_D1 = df_vaccines %>% 
  left_join(selected_links_D1 %>% 
              rename(Cond2 = Cond1,
                     selected_Cond2 = selected_Cond1),
             by = "Cond2") %>% 
  left_join(selected_links_D1,
             by = "Cond1") %>% 
  mutate(selected_TF = if_else(!is.na(selected_Cond1), T, F),
         Shared = if_else(!is.na(selected_Cond2), Shared, 0))

selected_links_vector_D1 = df_vaccines_selected_D1 %>% 
  pull(selected_TF)

df_D1 = df_vaccines_selected_D1 %>% 
  select(Cond1:Shared)


# Days 3, 4, 5
selected_links_D3 = df_vaccines %>% 
  ungroup() %>% 
  select(Cond1, Cond2) %>% 
  inner_join(annotation_conditions %>% 
              select(Cond1 = condition, day) %>% 
               filter(day == c(3,4,5)),
             by = "Cond1") %>% 
  select(Cond1) %>% 
  mutate(selected_Cond1 = Cond1) %>% 
  distinct()

df_vaccines_selected_D3 = df_vaccines %>% 
  left_join(selected_links_D3 %>% 
              rename(Cond2 = Cond1,
                     selected_Cond2 = selected_Cond1),
             by = "Cond2") %>% 
  left_join(selected_links_D3,
             by = "Cond1") %>% 
  mutate(selected_TF = if_else(!is.na(selected_Cond1), T, F),
         Shared = if_else(!is.na(selected_Cond2), Shared, 0))

selected_links_vector_D3 = df_vaccines_selected_D3 %>% 
  pull(selected_TF)

df_D3 = df_vaccines_selected_D3 %>% 
  select(Cond1:Shared)


# Days 6-7
selected_links_D6 = df_vaccines %>% 
  ungroup() %>% 
  select(Cond1, Cond2) %>% 
  inner_join(annotation_conditions %>% 
              select(Cond1 = condition, day) %>% 
               filter(day == c(6,7)),
             by = "Cond1") %>% 
  select(Cond1) %>% 
  mutate(selected_Cond1 = Cond1) %>% 
  distinct()

df_vaccines_selected_D6 = df_vaccines %>% 
  left_join(selected_links_D6 %>% 
              rename(Cond2 = Cond1,
                     selected_Cond2 = selected_Cond1),
             by = "Cond2") %>% 
  left_join(selected_links_D6,
             by = "Cond1") %>% 
  mutate(selected_TF = if_else(!is.na(selected_Cond1), T, F),
         Shared = if_else(!is.na(selected_Cond2), Shared, 0))

selected_links_vector_D6 = df_vaccines_selected_D6 %>% 
  pull(selected_TF)

df_D6 = df_vaccines_selected_D6 %>% 
  select(Cond1:Shared)


```
```{r}
#Plot
pdf(file = here("Figures","ChordDiagram_Covid19_AllCovid_By_Process_Days_Weeks_Immune_Other.pdf"),
    width = 15, height = 10)

par(mfrow = c(2, 3))
#Days 1
chordDiagram(df_D1, 
             grid.col = colors_grid, 
             col = col_links,
             link.sort = TRUE,
             link.decreasing = TRUE,
             annotationTrack = "grid", 
             directional = 0,
             scale = TRUE,
             big.gap = 3,
             transparency = 0.3,
             small.gap = 0.5,
             h.ratio = 0.7,
             link.visible = selected_links_vector_D1,
             group = group_types,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(unique(df_vaccines$Cond1)))))
             )
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Days 1-2")


#Days 3-4-5
chordDiagram(df_D3, 
             grid.col = colors_grid, 
             col = col_links,
             link.sort = TRUE,
             link.decreasing = TRUE,
             scale = TRUE,
             annotationTrack = "grid", 
             directional = 0,
             big.gap = 3,
             transparency = 0,
             small.gap = 0.5,
             h.ratio = 0.7,
             link.visible = selected_links_vector_D3,
             group = group_types,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(unique(df_vaccines$Cond1)))))
             )
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Days 3-4-5")

#Days 6-7
chordDiagram(df_D6, 
             grid.col = colors_grid, 
             col = col_links,
             link.sort = TRUE,
             link.decreasing = TRUE,
             scale = TRUE,
             annotationTrack = "grid", 
             directional = 0,
             big.gap = 3,
             transparency = 0,
             small.gap = 0.5,
             h.ratio = 0.7,
             link.visible = selected_links_vector_D6,
             group = group_types,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(unique(df_vaccines$Cond1)))))
             )
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Days 6-7")


#Week 2
chordDiagram(df_W2, 
             grid.col = colors_grid, 
             col = col_links,
             link.sort = TRUE,
             link.decreasing = TRUE,
             scale = TRUE,
             annotationTrack = "grid", 
             directional = 0,
             big.gap = 3,
             transparency = 0,
             small.gap = 0.5,
             h.ratio = 0.7,
             link.visible = selected_links_vector_W2,
             group = group_types,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(unique(df_vaccines$Cond1)))))
             )
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Week 2")

#Week 4
chordDiagram(df_W4, 
             grid.col = colors_grid, 
             col = col_links,
             link.sort = TRUE,
             link.decreasing = TRUE,
             scale = TRUE,
             annotationTrack = "grid", 
             directional = 0,
             big.gap = 3,
             transparency = 0,
             small.gap = 0.5,
             h.ratio = 0.7,
             link.visible = selected_links_vector_W4,
             group = group_types,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(unique(df_vaccines$Cond1)))))
             )
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Week 4")


#Week 7
chordDiagram(df_W7, 
             grid.col = colors_grid, 
             col = col_links,
             # link.sort = TRUE, 
             # link.decreasing = TRUE,
             annotationTrack = "grid", 
             scale = TRUE,
             directional = 0,
             big.gap = 3,
             transparency = 0,
             small.gap = 0.5,
             h.ratio = 0.7,
             link.visible = selected_links_vector_W7,
             group = group_types,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(unique(df_vaccines$Cond1)))))
             )
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Week 7")

dev.off()
circos.clear()
```

### 10.5.2. COVID-19 - Vaccine only 

#### 10.5.2.1. Genes shared by process
```{r}

all_covid_vax_atlas =  read_csv(here("Example","all_degs_p_05_vac_infected_19_12_23.csv"))
degs_all_updown_covid_vax_other = read_csv("Example/degs_all_updown_covid_vax_other.csv") %>% 
  select(-"...1")
ann_vaccines_vaxsig_covid <- read_csv("Example/ann_vaccines_vaxsig_covid.csv")

annotation_conditions = read_csv(here("Example", "ann_vaccines_conditions.csv"), 
    col_types = cols(...1 = col_skip())) %>% 
  filter(disease_vac == "V")

OtherGOs_Annotated_Genes <- read_csv("Tables/OtherGOs_Annotated_Genes.csv") %>% 
  select(process = term, genes = symbol) %>% 
  filter(process %in% c("Cellular",
                        "Immune system",
                        "Metabolism"))

ImmuneGO_genes_selected = OtherGOs_Annotated_Genes


ImmuneGO_genes_selected = ImmuneGO_Annotated_GO %>%
  filter(go_term == "Manual",
         process %in% c("ADAPTIVE IMMUNE SYSTEM",
                        "INNATE IMMUNE SYSTEM",
                        "ANTIMICROBIAL",
                        "GENERAL",
                        "COMPLEMENT")) %>%
  separate_rows(genes,sep = ",") %>%
  bind_rows(ImmuneGO_genes_selected) %>% 
  filter(process != "Immune system")


immune_genes_covid = all_covid_vax_atlas  %>% 
  inner_join(ImmuneGO_genes_selected %>% 
               select(genes), by = "genes") %>% 
  inner_join(annotation_conditions %>% 
               select( condition),
             by = "condition") %>% 
    select(condition1 = condition, genes)

immune_genes_covid_shared_process = immune_genes_covid %>% 
  rename(condition2 = condition1) %>% 
  inner_join(immune_genes_covid %>% 
               select(condition1, genes), by = "genes") %>% 
    filter(condition1 != condition2) %>% 
  inner_join(ImmuneGO_genes_selected %>% 
               select(genes, process), by = "genes") %>% 
  distinct() %>% 
  group_by(condition1, condition2, process) %>% 
  summarise(n = n())

```

```{r}
col_immune = c("ADAPTIVE IMMUNE SYSTEM" = "#6817c5",
          "COMPLEMENT" = "#2a9d8f",
          "INNATE IMMUNE SYSTEM" = "#0099ff",
          "GENERAL" = "#435804",
          "ANTIMICROBIAL" = "#38b000",
          
          #General processes
          "Immune system" = "#0099ff",
          "Cellular" = "#6817c5",
          "Metabolism" = "#DC0000FF")

```


```{r}
df_vaccines <- immune_genes_covid_shared_process %>% 
  dplyr::select(Cond1 = condition1, 
                Cond2 = condition2, 
                Shared = n, 
                process) %>% 
  mutate(Shared = Shared*100)

group_types = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(df_vaccines,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

types = df_vaccines %>% 
  dplyr::select(condition = Cond1) %>% 
  distinct() %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(condition, type), by = "condition") %>% 
  dplyr::select(type)

colors = ann_vaxsig_colors$Platform %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(condition, type), by = "type") %>% 
  select(condition, color)

colors_grid = df_vaccines %>%
  rename(condition = Cond1) %>% 
 inner_join(colors, by = "condition") %>% 
 pull(color, condition)

col_links = df_vaccines %>% 
  inner_join(col_immune %>% 
  as.data.frame() %>% 
  rownames_to_column("process") %>% 
  rename("color" = "."), by = "process") %>% 
  pull(color)

###### Select links

# Week 1

selected_links_W1 = df_vaccines %>% 
  ungroup() %>% 
  select(Cond1, Cond2) %>% 
  inner_join(annotation_conditions %>% 
              select(Cond1 = condition, week) %>% 
               filter(week == 1),
             by = "Cond1") %>% 
  select(Cond1) %>% 
  mutate(selected_Cond1 = Cond1) %>% 
  distinct()

df_vaccines_selected_W1 = df_vaccines %>% 
  left_join(selected_links_W1 %>% 
              rename(Cond2 = Cond1,
                     selected_Cond2 = selected_Cond1),
             by = "Cond2") %>% 
  left_join(selected_links_W1,
             by = "Cond1") %>% 
  mutate(selected_TF = if_else(!is.na(selected_Cond1), T, F),
         Shared = if_else(!is.na(selected_Cond2), Shared, 0))

selected_links_vector_W1 = df_vaccines_selected_W1 %>% 
  pull(selected_TF)

df_W1 = df_vaccines_selected_W1 %>% 
  select(Cond1:Shared)

# Week 2

selected_links_W2 = df_vaccines %>% 
  ungroup() %>% 
  select(Cond1, Cond2) %>% 
  inner_join(annotation_conditions %>% 
              select(Cond1 = condition, week) %>% 
               filter(week == 2),
             by = "Cond1") %>% 
  select(Cond1) %>% 
  mutate(selected_Cond1 = Cond1) %>% 
  distinct()

df_vaccines_selected_W2 = df_vaccines %>% 
  left_join(selected_links_W2 %>% 
              rename(Cond2 = Cond1,
                     selected_Cond2 = selected_Cond1),
             by = "Cond2") %>% 
  left_join(selected_links_W2,
             by = "Cond1") %>% 
  mutate(selected_TF = if_else(!is.na(selected_Cond1), T, F),
         Shared = if_else(!is.na(selected_Cond2), Shared, 0))

selected_links_vector_W2 = df_vaccines_selected_W2 %>% 
  pull(selected_TF)

df_W2 = df_vaccines_selected_W2 %>% 
  select(Cond1:Shared)

# Week 4

selected_links_W4 = df_vaccines %>% 
  ungroup() %>% 
  select(Cond1, Cond2) %>% 
  inner_join(annotation_conditions %>% 
              select(Cond1 = condition, week) %>% 
               filter(week == 4),
             by = "Cond1") %>% 
  select(Cond1) %>% 
  mutate(selected_Cond1 = Cond1) %>% 
  distinct()

df_vaccines_selected_W4 = df_vaccines %>% 
  left_join(selected_links_W4 %>% 
              rename(Cond2 = Cond1,
                     selected_Cond2 = selected_Cond1),
             by = "Cond2") %>% 
  left_join(selected_links_W4,
             by = "Cond1") %>% 
  mutate(selected_TF = if_else(!is.na(selected_Cond1), T, F),
         Shared = if_else(!is.na(selected_Cond2), Shared, 0))

selected_links_vector_W4 = df_vaccines_selected_W4 %>% 
  pull(selected_TF)

df_W4 = df_vaccines_selected_W4 %>% 
  select(Cond1:Shared)

# Week 7

selected_links_W7 = df_vaccines %>% 
  ungroup() %>% 
  select(Cond1, Cond2) %>% 
  inner_join(annotation_conditions %>% 
              select(Cond1 = condition, week) %>% 
               filter(week == 7),
             by = "Cond1") %>% 
  select(Cond1) %>% 
  mutate(selected_Cond1 = Cond1) %>% 
  distinct()

df_vaccines_selected_W7 = df_vaccines %>% 
  left_join(selected_links_W7 %>% 
              rename(Cond2 = Cond1,
                     selected_Cond2 = selected_Cond1),
             by = "Cond2") %>% 
  left_join(selected_links_W7,
             by = "Cond1") %>% 
  mutate(selected_TF = if_else(!is.na(selected_Cond1), T, F),
         Shared = if_else(!is.na(selected_Cond2), Shared, 0))

selected_links_vector_W7 = df_vaccines_selected_W7 %>% 
  pull(selected_TF)

df_W7 = df_vaccines_selected_W7 %>% 
  select(Cond1:Shared)
```


#### 10.5.2.2. By week


Weeks 1-7
```{r fig.height=10, fig.width=10}


#Plot
pdf(file = here("Figures","ChordDiagram_Covid19_AllCovid_By_Process_Weeks_Immune_VACCINESONLY.pdf"), 
    width = 15, 
    height = 5)

par(mfrow = c(1, 3))
#Week 1
chordDiagram(df_W1, 
             grid.col = colors_grid, 
             col = col_links,
             link.sort = TRUE,
             link.decreasing = TRUE,
             annotationTrack = "grid", 
             directional = 0,
             scale = TRUE,
             big.gap = 3,
             transparency = 0.3,
             small.gap = 0.5,
             h.ratio = 0.7,
             link.visible = selected_links_vector_W1,
             group = group_types,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(unique(df_vaccines$Cond1)))))
             )
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Week 1")


#Week 2
chordDiagram(df_W2, 
             grid.col = colors_grid, 
             col = col_links,
             link.sort = TRUE,
             link.decreasing = TRUE,
             scale = TRUE,
             annotationTrack = "grid", 
             directional = 0,
             big.gap = 3,
             transparency = 0,
             small.gap = 0.5,
             h.ratio = 0.7,
             link.visible = selected_links_vector_W2,
             group = group_types,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(unique(df_vaccines$Cond1)))))
             )
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Week 2")

#Week 4
chordDiagram(df_W4, 
             grid.col = colors_grid, 
             col = col_links,
             link.sort = TRUE,
             link.decreasing = TRUE,
             scale = TRUE,
             annotationTrack = "grid", 
             directional = 0,
             big.gap = 3,
             transparency = 0,
             small.gap = 0.5,
             h.ratio = 0.7,
             link.visible = selected_links_vector_W4,
             group = group_types,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(unique(df_vaccines$Cond1)))))
             )
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Week 4")

dev.off()
circos.clear()
```

### 10.5.3. COVID-19 - Infection only 

#### 10.5.3.1. Genes shared by process
```{r}

all_covid_vax_atlas =  read_csv(here("Example","all_degs_p_05_vac_infected_19_12_23.csv"))
degs_all_updown_covid_vax_other = read_csv("Example/degs_all_updown_covid_vax_other.csv") %>% 
  select(-"...1")
ann_vaccines_vaxsig_covid <- read_csv("Example/ann_vaccines_vaxsig_covid.csv")

annotation_conditions = read_csv(here("Example", "ann_vaccines_conditions.csv"), 
    col_types = cols(...1 = col_skip())) %>% 
  filter(disease_vac == "I")

OtherGOs_Annotated_Genes <- read_csv("Tables/OtherGOs_Annotated_Genes.csv") %>% 
  select(process = term, genes = symbol) %>% 
  filter(process %in% c("Cellular",
                        "Immune system",
                        "Metabolism"))

ImmuneGO_genes_selected = OtherGOs_Annotated_Genes


ImmuneGO_genes_selected = ImmuneGO_Annotated_GO %>%
  filter(go_term == "Manual",
         process %in% c("ADAPTIVE IMMUNE SYSTEM",
                        "INNATE IMMUNE SYSTEM",
                        "ANTIMICROBIAL",
                        "GENERAL",
                        "COMPLEMENT")) %>%
  separate_rows(genes,sep = ",") %>%
  bind_rows(ImmuneGO_genes_selected) %>% 
  filter(process != "Immune system")


immune_genes_covid = all_covid_vax_atlas  %>% 
  inner_join(ImmuneGO_genes_selected %>% 
               select(genes), by = "genes") %>% 
  inner_join(annotation_conditions %>% 
               select( condition),
             by = "condition") %>% 
    select(condition1 = condition, genes)

immune_genes_covid_shared_process = immune_genes_covid %>% 
  rename(condition2 = condition1) %>% 
  inner_join(immune_genes_covid %>% 
               select(condition1, genes), by = "genes") %>% 
    filter(condition1 != condition2) %>% 
  inner_join(ImmuneGO_genes_selected %>% 
               select(genes, process), by = "genes") %>% 
  distinct() %>% 
  group_by(condition1, condition2, process) %>% 
  summarise(n = n())

```

```{r}
col_immune = c("ADAPTIVE IMMUNE SYSTEM" = "#6817c5",
          "COMPLEMENT" = "#2a9d8f",
          "INNATE IMMUNE SYSTEM" = "#0099ff",
          "GENERAL" = "#435804",
          "ANTIMICROBIAL" = "#38b000",
          
          #General processes
          "Immune system" = "#0099ff",
          "Cellular" = "#6817c5",
          "Metabolism" = "#DC0000FF")

```


```{r}
df_vaccines <- immune_genes_covid_shared_process %>% 
  dplyr::select(Cond1 = condition1, 
                Cond2 = condition2, 
                Shared = n, 
                process)

group_types = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(df_vaccines,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

types = df_vaccines %>% 
  dplyr::select(condition = Cond1) %>% 
  distinct() %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(condition, type), by = "condition") %>% 
  dplyr::select(type)

colors = ann_vaxsig_colors$Platform %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(condition, type), by = "type") %>% 
  select(condition, color)

colors_grid = df_vaccines %>%
  rename(condition = Cond1) %>% 
 inner_join(colors, by = "condition") %>% 
 pull(color, condition)

col_links = df_vaccines %>% 
  inner_join(col_immune %>% 
  as.data.frame() %>% 
  rownames_to_column("process") %>% 
  rename("color" = "."), by = "process") %>% 
  pull(color)

###### Select links

# Week 1

selected_links_W1 = df_vaccines %>% 
  ungroup() %>% 
  select(Cond1, Cond2) %>% 
  inner_join(annotation_conditions %>% 
              select(Cond1 = condition, week) %>% 
               filter(week == 1),
             by = "Cond1") %>% 
  select(Cond1) %>% 
  mutate(selected_Cond1 = Cond1) %>% 
  distinct()

df_vaccines_selected_W1 = df_vaccines %>% 
  left_join(selected_links_W1 %>% 
              rename(Cond2 = Cond1,
                     selected_Cond2 = selected_Cond1),
             by = "Cond2") %>% 
  left_join(selected_links_W1,
             by = "Cond1") %>% 
  mutate(selected_TF = if_else(!is.na(selected_Cond1), T, F),
         Shared = if_else(!is.na(selected_Cond2), Shared, 0))

selected_links_vector_W1 = df_vaccines_selected_W1 %>% 
  pull(selected_TF)

df_W1 = df_vaccines_selected_W1 %>% 
  select(Cond1:Shared)

# Week 2

selected_links_W2 = df_vaccines %>% 
  ungroup() %>% 
  select(Cond1, Cond2) %>% 
  inner_join(annotation_conditions %>% 
              select(Cond1 = condition, week) %>% 
               filter(week == 2),
             by = "Cond1") %>% 
  select(Cond1) %>% 
  mutate(selected_Cond1 = Cond1) %>% 
  distinct()

df_vaccines_selected_W2 = df_vaccines %>% 
  left_join(selected_links_W2 %>% 
              rename(Cond2 = Cond1,
                     selected_Cond2 = selected_Cond1),
             by = "Cond2") %>% 
  left_join(selected_links_W2,
             by = "Cond1") %>% 
  mutate(selected_TF = if_else(!is.na(selected_Cond1), T, F),
         Shared = if_else(!is.na(selected_Cond2), Shared, 0))

selected_links_vector_W2 = df_vaccines_selected_W2 %>% 
  pull(selected_TF)

df_W2 = df_vaccines_selected_W2 %>% 
  select(Cond1:Shared)

# Week 4

selected_links_W4 = df_vaccines %>% 
  ungroup() %>% 
  select(Cond1, Cond2) %>% 
  inner_join(annotation_conditions %>% 
              select(Cond1 = condition, week) %>% 
               filter(week == 4),
             by = "Cond1") %>% 
  select(Cond1) %>% 
  mutate(selected_Cond1 = Cond1) %>% 
  distinct()

df_vaccines_selected_W4 = df_vaccines %>% 
  left_join(selected_links_W4 %>% 
              rename(Cond2 = Cond1,
                     selected_Cond2 = selected_Cond1),
             by = "Cond2") %>% 
  left_join(selected_links_W4,
             by = "Cond1") %>% 
  mutate(selected_TF = if_else(!is.na(selected_Cond1), T, F),
         Shared = if_else(!is.na(selected_Cond2), Shared, 0))

selected_links_vector_W4 = df_vaccines_selected_W4 %>% 
  pull(selected_TF)

df_W4 = df_vaccines_selected_W4 %>% 
  select(Cond1:Shared)

# Week 7

selected_links_W7 = df_vaccines %>% 
  ungroup() %>% 
  select(Cond1, Cond2) %>% 
  inner_join(annotation_conditions %>% 
              select(Cond1 = condition, week) %>% 
               filter(week == 7),
             by = "Cond1") %>% 
  select(Cond1) %>% 
  mutate(selected_Cond1 = Cond1) %>% 
  distinct()

df_vaccines_selected_W7 = df_vaccines %>% 
  left_join(selected_links_W7 %>% 
              rename(Cond2 = Cond1,
                     selected_Cond2 = selected_Cond1),
             by = "Cond2") %>% 
  left_join(selected_links_W7,
             by = "Cond1") %>% 
  mutate(selected_TF = if_else(!is.na(selected_Cond1), T, F),
         Shared = if_else(!is.na(selected_Cond2), Shared, 0))

selected_links_vector_W7 = df_vaccines_selected_W7 %>% 
  pull(selected_TF)

df_W7 = df_vaccines_selected_W7 %>% 
  select(Cond1:Shared)
```


#### 10.5.3.2. By week


Weeks 1-7
```{r fig.height=10, fig.width=10}


#Plot
pdf(file = here("Figures","ChordDiagram_Covid19_AllCovid_By_Process_Weeks_Immune_INFECTINOONLY.pdf"), 
    width = 20, 
    height = 5)

par(mfrow = c(1, 4))
#Week 1
chordDiagram(df_W1, 
             grid.col = colors_grid, 
             col = col_links,
             link.sort = TRUE,
             link.decreasing = TRUE,
             annotationTrack = "grid", 
             directional = 0,
             scale = TRUE,
             big.gap = 3,
             transparency = 0.3,
             small.gap = 0.5,
             h.ratio = 0.7,
             link.visible = selected_links_vector_W1,
             group = group_types,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(unique(df_vaccines$Cond1)))))
             )
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Week 1")


#Week 2
chordDiagram(df_W2, 
             grid.col = colors_grid, 
             col = col_links,
             link.sort = TRUE,
             link.decreasing = TRUE,
             scale = TRUE,
             annotationTrack = "grid", 
             directional = 0,
             big.gap = 3,
             transparency = 0,
             small.gap = 0.5,
             h.ratio = 0.7,
             link.visible = selected_links_vector_W2,
             group = group_types,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(unique(df_vaccines$Cond1)))))
             )
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Week 2")

#Week 4
chordDiagram(df_W4, 
             grid.col = colors_grid, 
             col = col_links,
             link.sort = TRUE,
             link.decreasing = TRUE,
             scale = TRUE,
             annotationTrack = "grid", 
             directional = 0,
             big.gap = 3,
             transparency = 0,
             small.gap = 0.5,
             h.ratio = 0.7,
             link.visible = selected_links_vector_W4,
             group = group_types,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(unique(df_vaccines$Cond1)))))
             )
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Week 4")


#Week 7
chordDiagram(df_W7, 
             grid.col = colors_grid, 
             col = col_links,
             link.sort = TRUE,
             link.decreasing = TRUE,
             scale = TRUE,
             annotationTrack = "grid", 
             directional = 0,
             big.gap = 3,
             transparency = 0,
             small.gap = 0.5,
             h.ratio = 0.7,
             link.visible = selected_links_vector_W7,
             group = group_types,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(unique(df_vaccines$Cond1)))))
             )
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Week 7")

dev.off()
circos.clear()
```

### 10.5.4. COVID-19 VS OTHER 

#### 10.5.4.1. Genes shared by process
```{r}
degs_all_updown_covid_vax_other = read_csv("Example/degs_all_updown_covid_vax_other.csv") %>% 
  select(-"...1")
ann_vaccines_vaxsig_covid <- read_csv("Example/ann_vaccines_vaxsig_covid.csv") %>% 
  filter(disease_vac != "I")

degs_all_updown_covid_vax_other = degs_all_updown_covid_vax_other %>% 
  inner_join(ann_vaccines_vaxsig_covid %>% 
               select(condition),
             by = "condition") 

ImmuneGO_genes_selected = ImmuneGO_Annotated_GO %>% 
  filter(go_term == "Manual",
         process %in% c("ADAPTIVE IMMUNE SYSTEM",
                        "INNATE IMMUNE SYSTEM",
                        "ANTIMICROBIAL",
                        "GENERAL",
                        "COMPLEMENT")) %>% 
  separate_rows(genes,sep = ",")


immune_genes_covid = degs_all_updown_covid_vax_other  %>% 
  inner_join(ImmuneGO_genes_selected %>% 
               select(genes), by = "genes") %>% 
  select(condition1 = condition, genes)

immune_genes_covid_shared_process = immune_genes_covid %>% 
  rename(condition2 = condition1) %>% 
  inner_join(immune_genes_covid %>% 
               select(condition1, genes), by = "genes") %>% 
    filter(condition1 != condition2) %>% 
  inner_join(ImmuneGO_genes_selected %>% 
               select(genes, process), by = "genes") %>% 
  distinct() %>% 
  group_by(condition1, condition2, process) %>% 
  summarise(n = n())
```


```{r}
df_vaccines <- immune_genes_covid_shared_process %>% 
  dplyr::select(Cond1 = condition1, 
                Cond2 = condition2, 
                Shared = n, 
                process) 

group_types = ann_vaccines_vaxsig_covid %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(df_vaccines,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

types = df_vaccines %>% 
  dplyr::select(condition = Cond1) %>% 
  distinct() %>% 
  inner_join(ann_vaccines_vaxsig_covid %>% 
 dplyr::select(condition, type), by = "condition") %>% 
  dplyr::select(type)

colors = ann_vaxsig_colors$Platform %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(ann_vaccines_vaxsig_covid %>% 
 dplyr::select(condition, type), by = "type") %>% 
  select(condition, color)

colors_grid = df_vaccines %>%
  rename(condition = Cond1) %>% 
 inner_join(colors, by = "condition") %>% 
 pull(color, condition)

col_links = df_vaccines %>% 
  inner_join(col_immune %>% 
  as.data.frame() %>% 
  rownames_to_column("process") %>% 
  rename("color" = "."), by = "process") %>% 
  pull(color)
```

All

```{r fig.height=10, fig.width=10}

#Plot
png(filename = here("Figures","ChordDiagram_Covid19_Other_By_Process.png"),
    width = 10, height = 10, units = "in", res = 300)

chordDiagram(df_vaccines, 
             grid.col = colors_grid, 
             col = col_links, scale = TRUE,
             # link.sort = TRUE, 
             # link.decreasing = TRUE,
             annotationTrack = "grid", 
             directional = 1,
             big.gap = 2,
             transparency = 0,
             small.gap = 0.5,
             h.ratio = 0.7,
             link.sort = TRUE, 
             link.decreasing = TRUE,
             group = group_types,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(unique(df_vaccines$Cond1)))))
             )
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("All")

dev.off()
circos.clear()
```


Select links
```{r}
###### Select links

# Week 1

selected_links_W1 = df_vaccines %>% 
  ungroup() %>% 
  select(Cond1, Cond2) %>% 
  inner_join(annotation_conditions %>% 
              select(Cond1 = condition, week) %>% 
               filter(week == 1),
             by = "Cond1") %>% 
  select(Cond1) %>% 
  mutate(selected_Cond1 = Cond1) %>% 
  distinct()

df_vaccines_selected_W1 = df_vaccines %>% 
  left_join(selected_links_W1 %>% 
              rename(Cond2 = Cond1,
                     selected_Cond2 = selected_Cond1),
             by = "Cond2") %>% 
  left_join(selected_links_W1,
             by = "Cond1") %>% 
  mutate(selected_TF = if_else(!is.na(selected_Cond1), T, F),
         Shared = if_else(!is.na(selected_Cond2), Shared, 0))

selected_links_vector_W1 = df_vaccines_selected_W1 %>% 
  pull(selected_TF)

df_W1 = df_vaccines_selected_W1 %>% 
  select(Cond1:Shared)

# Week 2

selected_links_W2 = df_vaccines %>% 
  ungroup() %>% 
  select(Cond1, Cond2) %>% 
  inner_join(annotation_conditions %>% 
              select(Cond1 = condition, week) %>% 
               filter(week == 2),
             by = "Cond1") %>% 
  select(Cond1) %>% 
  mutate(selected_Cond1 = Cond1) %>% 
  distinct()

df_vaccines_selected_W2 = df_vaccines %>% 
  left_join(selected_links_W2 %>% 
              rename(Cond2 = Cond1,
                     selected_Cond2 = selected_Cond1),
             by = "Cond2") %>% 
  left_join(selected_links_W2,
             by = "Cond1") %>% 
  mutate(selected_TF = if_else(!is.na(selected_Cond1), T, F),
         Shared = if_else(!is.na(selected_Cond2), Shared, 0))

selected_links_vector_W2 = df_vaccines_selected_W2 %>% 
  pull(selected_TF)

df_W2 = df_vaccines_selected_W2 %>% 
  select(Cond1:Shared)

# Week 4

selected_links_W4 = df_vaccines %>% 
  ungroup() %>% 
  select(Cond1, Cond2) %>% 
  inner_join(annotation_conditions %>% 
              select(Cond1 = condition, week) %>% 
               filter(week == 4),
             by = "Cond1") %>% 
  select(Cond1) %>% 
  mutate(selected_Cond1 = Cond1) %>% 
  distinct()

df_vaccines_selected_W4 = df_vaccines %>% 
  left_join(selected_links_W4 %>% 
              rename(Cond2 = Cond1,
                     selected_Cond2 = selected_Cond1),
             by = "Cond2") %>% 
  left_join(selected_links_W4,
             by = "Cond1") %>% 
  mutate(selected_TF = if_else(!is.na(selected_Cond1), T, F),
         Shared = if_else(!is.na(selected_Cond2), Shared, 0))

selected_links_vector_W4 = df_vaccines_selected_W4 %>% 
  pull(selected_TF)

df_W4 = df_vaccines_selected_W4 %>% 
  select(Cond1:Shared)

# Week 7

selected_links_W7 = df_vaccines %>% 
  ungroup() %>% 
  select(Cond1, Cond2) %>% 
  inner_join(annotation_conditions %>% 
              select(Cond1 = condition, week) %>% 
               filter(week == 7),
             by = "Cond1") %>% 
  select(Cond1) %>% 
  mutate(selected_Cond1 = Cond1) %>% 
  distinct()

df_vaccines_selected_W7 = df_vaccines %>% 
  left_join(selected_links_W7 %>% 
              rename(Cond2 = Cond1,
                     selected_Cond2 = selected_Cond1),
             by = "Cond2") %>% 
  left_join(selected_links_W7,
             by = "Cond1") %>% 
  mutate(selected_TF = if_else(!is.na(selected_Cond1), T, F),
         Shared = if_else(!is.na(selected_Cond2), Shared, 0))

selected_links_vector_W7 = df_vaccines_selected_W7 %>% 
  pull(selected_TF)

df_W7 = df_vaccines_selected_W7 %>% 
  select(Cond1:Shared)
```


By week

```{r fig.height=10, fig.width=10}

#Plot
png(filename = here("Figures","ChordDiagram_Covid19_Other_By_Process.png"),
    width = 20, height = 20, units = "in", res = 600)

# par(mfrow = c(2, 2))
#Week 1
chordDiagram(df_W1, 
             grid.col = colors_grid, 
             col = col_links,
             # link.sort = TRUE, 
             # link.decreasing = TRUE,
             annotationTrack = "grid", 
             directional = 1,
             big.gap = 6,
             transparency = 0,
             small.gap = 3,
             h.ratio = 0.7,
             link.visible = selected_links_vector_W1,
             group = group_types,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(unique(df_vaccines$Cond1)))))
             )
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 1),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Week 1")


#Week 2
chordDiagram(df_W2, 
             grid.col = colors_grid, 
             col = col_links,
             # link.sort = TRUE, 
             # link.decreasing = TRUE,
             annotationTrack = "grid", 
             directional = 1,
             big.gap = 6,
             transparency = 0,
             small.gap = 3,
             h.ratio = 0.7,
             link.visible = selected_links_vector_W2,
             group = group_types,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(unique(df_vaccines$Cond1)))))
             )
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 1),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Week 2")

#Week 4
chordDiagram(df_W4, 
             grid.col = colors_grid, 
             col = col_links,
             # link.sort = TRUE,
             # link.decreasing = TRUE,
             annotationTrack = "grid", 
             directional = 1,
             big.gap = 6,
             transparency = 0,
             small.gap = 3,
             h.ratio = 0.7,
             link.visible = selected_links_vector_W4,
             group = group_types,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(unique(df_vaccines$Cond1)))))
             )
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 1),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Week 4")


#Week 7
chordDiagram(df_W7, 
             grid.col = colors_grid, 
             col = col_links,
             # link.sort = TRUE, 
             # link.decreasing = TRUE,
             annotationTrack = "grid", 
             directional = 1,
             big.gap = 6,
             transparency = 0,
             small.gap = 3,
             h.ratio = 0.7,
             link.visible = selected_links_vector_W7,
             group = group_types,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(unique(df_vaccines$Cond1)))))
             )
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 1),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Week 7")

dev.off()
circos.clear()
```


#### 10.5.4.2. Jaccard distance
```{r}
ann_vaccines_vaxsig_covid <- read_csv("Example/ann_vaccines_vaxsig_covid.csv")

VAXSigDB_sharedgenes <- read_csv(file = here("Example", "degs_all_updown_covid_vax_other_sharedgenes_Fisher_Jaccard.csv"))

annotation_conditions = ann_vaccines_vaxsig_covid %>% 
  filter(disease_vac != "I")
```

##### 10.5.4.2.1. Types
Prepare tables
```{r fig.height= 10, fig.width=10}
#Types
###### All -----
links_df = shared_genes_df_mirror %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance) %>% 
  inner_join(annotation_conditions %>% 
               select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               select(Cond2 = condition),
             by = "Cond2") 

mat_types = links_df %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(jaccard_distance = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix() %>% 
  replace(is.na(.), 0)

grid.col_types = ann_vaxsig_colors$Platform %>%
  as.data.frame() %>%
  rownames_to_column(color_flourish) %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df %>% 
               select(Cond1) %>% 
               distinct(),
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_types = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

```

Plot
All conditions and stats
```{r fig.height= 5, fig.width=5}
#Plot

#Types

png(filename = here("Figures","ChordDiagram_Covid19_Other_Vaccines_Types_All_jaccard_distance.png"), 
    width = 10, height = 10, units = "in", res = 600)

#All
chordDiagram(mat_types, 
             grid.col = grid.col_types,
             annotationTrack = "grid",  
             transparency = 0,
             link.sort = TRUE, link.decreasing = TRUE,
             scale=TRUE,
             big.gap = 3,
             small.gap = 0.5,
             directional = -1, 
             group = group_types,
             link.zindex = rank(mat_types),
             h.ratio = 0.7, 
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_types))))))

circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.5, #Label size
      font = 0.1
      )},
  bg.border = NA)
title("Vax MsigDB collection - Jaccard distance")

dev.off()
circos.clear()
```

#### 10.5.4.3. Shared total genes
```{r, cache = TRUE}
ann_vaccines_vaxsig_covid <- read_csv("Example/ann_vaccines_vaxsig_covid.csv")

VAXSigDB_sharedgenes <- read_csv(file = here("Example", "degs_all_updown_covid_vax_other_sharedgenes_Fisher_Jaccard.csv"))

annotation_conditions = ann_vaccines_vaxsig_covid %>% 
  filter(disease_vac != "I")
```

##### 10.5.4.3.1. Types
Prepare tables
```{r fig.height= 10, fig.width=10, cache = TRUE}
#Types
###### All -----
links_df = shared_genes_df_mirror %>% 
  dplyr::select(Cond1, Cond2, Shared) %>% 
  inner_join(annotation_conditions %>% 
               select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               select(Cond2 = condition),
             by = "Cond2") 

mat_types = links_df %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(jaccard_distance = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix() %>% 
  replace(is.na(.), 0)

grid.col_types = ann_vaxsig_colors$Platform %>%
  as.data.frame() %>%
  rownames_to_column(color_flourish) %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df %>% 
               select(Cond1) %>% 
               distinct(),
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_types = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

```

Plot
All conditions and stats
```{r fig.height= 5, fig.width=5, cache = TRUE}
#Plot

#Types

png(filename = here("Figures","ChordDiagram_Covid19_Other_Vaccines_Types_All_SharedTotal.png"), 
    width = 10, height = 10, units = "in", res = 600)

#All
chordDiagram(mat_types, 
             grid.col = grid.col_types,
             annotationTrack = "grid",  
             transparency = 0,
             link.sort = TRUE, link.decreasing = TRUE,
             scale=TRUE,
             big.gap = 3,
             small.gap = 0.5,
             directional = -1, 
             group = group_types,
             link.zindex = rank(mat_types),
             h.ratio = 0.7, 
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_types))))))

circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.5, #Label size
      font = 0.1
      )},
  bg.border = NA)
title("Vax MsigDB collection - Shared total")

dev.off()
circos.clear()
```




### 10.5.5. Shared genes (Cytoscape and Flourish)

```{r cache = TRUE}
# Vaccines and infection -----
ann_vaccines_covid_other

degs_all_updown_covid_other_immune_shared
degs_all_updown_covid_other_nonimmune_shared

filename = "degs_all_updown_covid_other_immune_shared"

edges = degs_all_updown_covid_other_immune_shared %>% 
  select(-"...1") %>% 
  inner_join(ann_vaccines_covid_other %>% filter(covid_other == "COVID"), by = join_by(Cond1 == condition)) %>% 
  inner_join(ann_vaccines_covid_other %>% filter(covid_other == "OTHER") %>% select(condition), by = join_by(Cond2 == condition)) %>% 
  clean_names()

edges_mirror = edges %>% 
  select(cond1:qvalue) %>% 
  rename(cond2.1 = cond1, cond1.2 = cond2) %>% 
  rename(cond2 = cond2.1, cond1 = cond1.2) %>% 
  select(cond1, cond2, everything()) %>% 
  inner_join(ann_vaccines_covid_other %>% filter(covid_other == "OTHER"), by = join_by(cond1 == condition))

edges_flourish = bind_rows(edges, edges_mirror)

nodes = ann_vaccines_covid_other 
edges_nodes = edges


my_colors <- ann_vaccines_covid_other %>% 
 mutate(color = case_when(
    type == "VLP" ~ "#7E6148FF",
    type == "LA" ~ "#E64B35FF",
    type == "CONJ" ~ "#F39B7FFF",
    type == "IN" ~ "#00A087FF",
    type == "VV" ~ "#3C5488FF",
    type == "RNA" ~ "#4DBBD5FF",
    type == "SU" ~ "#8491B4FF",
    type == "I" ~ "#DC0000FF",
    TRUE ~ NA_character_),
    color_covid_other = if_else(covid_other == "COVID", "#56cfe1", "#343a40"))

my_colors %>% select(condition, color, color_covid_other) %>% 
  write_tsv("covid_others_colors.tsv")


write_tsv(edges_nodes, file = paste0(filename, "Network_Covid_Other_sharedgenes_edges_and_nodes.tsv"))
write_tsv(edges_flourish, file = paste0(filename, "Network_Covid_Other_sharedgenes_edges.tsv"))
write.csv(edges_flourish, file = paste0(filename, "Network_Covid_Other_sharedgenes_edges.csv"), row.names = F)
write_tsv(nodes, file = paste0(filename, "Network_Covid_Other_sharedgenes_nodes.tsv"))

# Only Covid vaccination (previous or no previous infection) vs other vaccines-----
ann_vaccines_covid_other

edges = degs_all_updown_covid_other_immune_shared %>% 
  select(-"...1") %>% 
  inner_join(ann_vaccines_covid_other %>% filter(covid_other == "COVID", !regimen %in% c("I", "I-I")), by = join_by(Cond1 == condition)) %>% 
  inner_join(ann_vaccines_covid_other %>% filter(covid_other == "OTHER") %>% select(condition), by = join_by(Cond2 == condition)) %>% 
  clean_names()

edges_mirror = edges %>% 
  select(cond1:qvalue) %>% 
  rename(cond2.1 = cond1, cond1.2 = cond2) %>% 
  rename(cond2 = cond2.1, cond1 = cond1.2) %>% 
  select(cond1, cond2, everything()) %>% 
  inner_join(ann_vaccines_covid_other %>% filter(covid_other == "OTHER"), by = join_by(cond1 == condition))

edges_flourish = bind_rows(edges, edges_mirror)

nodes = ann_vaccines_covid_other 
my_colors <- ann_vaccines_covid_other %>% 
 mutate(color = case_when(
    type == "VLP" ~ "#7E6148FF",
    type == "LA" ~ "#c8b6ff",
    type == "CONJ" ~ "#F39B7FFF",
    type == "IN" ~ "#00A087FF",
    type == "VV" ~ "#3C5488FF",
    type == "RNA" ~ "#4DBBD5FF",
    type == "SU" ~ "#8491B4FF",
    type == "I" ~ "#DC0000FF",
    TRUE ~ NA_character_),
    color_covid_other = if_else(covid_other == "COVID", "#56cfe1", "#343a40"))

my_colors %>% select(condition, color, color_covid_other) %>% 
  write_tsv("covid_others_colors.tsv")

#Copiar e colar direto no flourish
my_colors %>% select(condition, color) %>% mutate(combined = paste(condition, color, sep = ": ")) %>% select(combined)

write_tsv(edges_flourish, file = paste0(filename, "Network_Covid_Other_Vaccinesonly_sharedgenes_edges.tsv"))
write.csv(edges_flourish, file = paste0(filename, "Network_Covid_Other_Vaccinesonly_sharedgenes_edges.csv"), row.names = F)
write_tsv(nodes, file = paste0(filename, "Network_Covid_Other_sharedgenes_nodes.tsv"))


```



















