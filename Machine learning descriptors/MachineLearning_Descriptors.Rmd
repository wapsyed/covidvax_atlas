---
title: "Machine Learning Descriptors"
author: "Wasim Syed"
date: "2024-03-20"
output: html_document
---

# Libraries
```{r message=FALSE, warning=FALSE}
# install.packages("randomForest")
# install.packages("caret")
# install.packages("rpart")
# install.packages("rpart.plot")
# install.packages("tidymodels")
# install.packages("reticulate")
# install.packages("themis")
# install.packages("ranger")
# install.packages("workflowsets")
# install.packages("glmnet")
# install.packages("kknn")
# install.packages("nnet")
# install.packages("tictoc")

library(tidymodels)
tidymodels_prefer()
library(randomForest)
library(ranger)
library(caret)
library(reticulate)
library(themis)
library(tidyverse)
library(rpart)
library(rpart.plot)
library(here)
library(ggrepel)
library(ComplexHeatmap)
library(janitor)
library(ggsci)
library(vip)
library(here)
library(circlize)
library(workflowsets)
library(glmnet)
library(kknn)
library(nnet)
library(tictoc)
library(ggthemes)

```

## Import files
```{r}
all_matrices_normalized_counts <- readRDS(here("DGE analysis", "all_matrices_normalized_counts.rds"))
ann_vaccines_samples = read_csv(here("Annotations and metadata", "ann_vaccines_samples.csv"))
PC_1_2_cos2 = read_csv(here("PCA", "PC_1_2_cos2.csv"))
```


#COVID-19 vaccines and infection: Random forest
```{r}
# Input data ----

filename = "ImmuneGO_Genes_Type_including_Infection_"
df = all_matrices_normalized_counts

## Vaccination types
outcomevar = "type"

ann_vaccines_samples_filtered = ann_vaccines_samples %>% 
  mutate(outcomevar = type) %>% 
  filter(type != "H")

#How many samples by level?
count_levels = ann_vaccines_samples_filtered %>% 
  count(outcomevar)

#How many levels?
levels = nrow(count_levels)

#Select only important genes
PC1_2 = PC_1_2_cos2
```

### Train and test

```{r fig.height=10, fig.width=10}
# Prepare data ------

df_input <- df %>%
  rownames_to_column("genes") %>%
  inner_join(PC1_2 %>% select(genes) %>% distinct(), by = "genes") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("sample") %>%
  inner_join(ann_vaccines_samples_filtered %>% select(sample,
                                                      outcomevar), #Outcome
             by = "sample") %>%
  select(sample,
         outcomevar,
         everything()) %>%
  column_to_rownames("sample") %>%
  mutate_if(is.character, factor)

glimpse(df_input)

# Split data
set.seed(123)  
split <- initial_split(df_input, prop = 0.7, strata = outcomevar)
trees_train <- training(split)
trees_test <- testing(split)

# Create recipe
tree_rec <- recipe(outcomevar ~ ., data = trees_train) %>% #OUTCOME
  step_dummy(all_nominal(), -all_outcomes()) %>%
  step_upsample(outcomevar) #Upsample unbalanced data (OUTCOME)

tree_prep <- prep(tree_rec)

juiced <- juice(tree_prep)

# Set random forest hyper parameters
tune_spec <- rand_forest(
  mtry = tune(),
  trees = 2000,
  min_n = tune()
) %>%
  set_mode("classification") %>% 
  set_engine("ranger")

# Create workflow
tune_wf <- workflow() %>%
  add_recipe(tree_rec) %>%
  add_model(tune_spec)

#Cross validation
set.seed(234)
trees_folds <- vfold_cv(trees_train)


#Define performance metrics
mer_metrics <- metric_set(yardstick::recall,
                          yardstick::specificity,
                          yardstick::accuracy,
                          yardstick::precision,
                          yardstick::roc_auc,
                          yardstick::pr_auc)

# Parallel computing 
doParallel::registerDoParallel()

set.seed(345)
tune_res <- tune_grid(
  tune_wf,
  metrics = mer_metrics,
  resamples = trees_folds,
  grid = 20
)

# Assess data ----

# recall
metrics_tuneres_recall = tune_res %>%
  collect_metrics() %>%
  filter(.metric == "recall") %>%
  select(mean, min_n, mtry) %>%
  pivot_longer(min_n:mtry,
    values_to = "value",
    names_to = "parameter"
  ) %>%
  ggplot(aes(value, mean, color = parameter)) +
  geom_line() +
  geom_point(show.legend = FALSE) +
  geom_text_repel(aes(label = value))+
  facet_wrap(~parameter, scales = "free_x") +
  labs(x = NULL, y = "recall")

metrics_tuneres_recall

#Accuracy
metrics_tuneres = tune_res %>%
  collect_metrics() %>%
  select(mean, min_n, mtry, .metric) %>%
  pivot_longer(min_n:mtry,
    values_to = "value",
    names_to = "parameter") %>%
  ggplot()+
  aes(x = value, y = mean, colour = .metric, label = value) +
  geom_line() +
  geom_label() +
  scale_color_npg()+
  theme_minimal() +
  facet_grid(vars(.metric), vars(parameter), scales = "free")

metrics_tuneres

metrics_tuneres %>% ggsave(file = here("Figures",
                                       paste0(filename, 
                                              outcomevar, today(),
                                              "_tuneres_metrics.png")),
                                        width = 10,
                                        height = 10)

#Min_n = 6,8
#mtry = 6,14
```


```{r}
# Tune hyperparameters ----
rf_grid <- grid_regular(
  mtry(range = c(6, 14)),
  min_n(range = c(6, 8)),
  levels = levels
)

set.seed(456)
regular_res <- tune_grid(
  tune_wf,
  metrics = mer_metrics,
  resamples = trees_folds,
  grid = rf_grid
)

# Assess performance -----
regular_res %>%
  collect_metrics()

regular_res %>%
  collect_metrics() %>% 
  write.csv(file = paste("metrics_finalmodel_", filename, outcomevar, today(), ".csv"), row.names = F)

#Metrics
regular_res_metrics = regular_res %>%
  collect_metrics() %>%
  select(mean, min_n, mtry, .metric) %>%
  pivot_longer(min_n:mtry,
    values_to = "value",
    names_to = "parameter") %>%
  ggplot()+
  aes(x = value, y = mean, colour = .metric, label = value) +
  geom_line() +
  geom_label(size = 3) +
  scale_color_npg()+
  theme_minimal() +
  facet_grid(vars(.metric), vars(parameter), scales = "free")

regular_res_metrics

ggsave(regular_res_metrics, file = here("Figures", 
                                        paste(filename, outcomevar, "metrics", today(), ".png")), 
       width = 10, height = 10)

# Select best model -----
best_auc <- select_best(regular_res, metric = "pr_auc")
final_rf <- finalize_model(
  tune_spec,
  best_auc
)
```

Important features
```{r}
final = final_rf %>%
  set_engine("ranger", importance = "permutation") %>%
  fit(outcomevar ~ .,
    data = juice(tree_prep)
  ) %>% 
  vip(num_features = 10)
final
final %>% ggsave(file = paste0("vipgenes_tidymodels_", filename, outcomevar, today(), ".png"))

genes_rf = final$data
genes_rf = genes_rf %>% select(genes = Variable, importance = Importance)
genes_rf %>% write.csv(file = paste0("vipgenes_tidymodels_", filename, outcomevar, today(), ".csv"), row.names = F)

#Importance plot
importance_plot = ggplot(genes_rf) +
  aes(x = reorder(Variable, Importance),
    y = Importance,
    color = Importance,
      weight = Importance) +
  geom_segment(aes(x=Variable, xend=Variable, y=0, yend=Importance)) +
  geom_point(shape = "circle", size = 5) +
  theme_minimal() +
  xlab("Genes") + 
  ylab("Importance") +
  ylim(0, 0.05) +
  geom_text(aes(label = round(Importance, 4), y = Importance),
            hjust = -0.5, 
            size = 4,
            angle = 0,
            color = "black")+
  scale_color_gradient(low = "#4DBBD5FF", high = "#DC0000FF") +
  theme(legend.position = "right",
        axis.text.x = element_text(angle = 90, vjust = 1, hjust=1, size = 12, color = "black"),
        axis.text.y = element_text(size = 12, angle = 0, color = "black"),
        panel.grid.minor.y = element_blank(),
        legend.text = element_text(size=12),
        legend.title = element_text(size = 12, face = "bold")) +
    coord_flip()
importance_plot


ggsave(importance_plot,
        file = here("Figures",
                    paste0("vipgenes_tidymodels_", filename, outcomevar, today(), ".png")),
        width = 8,
        height = 5)

importance_plot

```

Train final model with tuned hyperparameters
```{r}
# Train final model with tuned hyperparameters
final_wf <- workflow() %>%
  add_recipe(tree_rec) %>%
  add_model(final_rf)

final_res <- final_wf %>%
  last_fit(split)

final_res_preds = final_res %>%
  collect_predictions() %>%
  mutate(correct = case_when(
    outcomevar == .pred_class ~ "Correct",
    TRUE ~ "Incorrect"
  )) %>%
  bind_cols(trees_test)

#Confusion matrix
res_conf_mat = conf_mat(final_res_preds, truth = outcomevar...12,
         estimate = .pred_class)

#Accuracy
res_acc = accuracy(final_res_preds, truth = outcomevar...12,
         estimate = .pred_class)

#Sensitivity
res_sens = sens(final_res_preds, truth = outcomevar...12,
         estimate = .pred_class)

#Specificity
res_spec = spec(final_res_preds, truth = outcomevar...12,
         estimate = .pred_class)

#Precision
res_prec = precision(final_res_preds, truth = outcomevar...12,
         estimate = .pred_class)

#Recall
res_recall = recall(final_res_preds, truth = outcomevar...12,
         estimate = .pred_class)

final_res_metrics = bind_rows(res_acc,
                         res_recall,
                         res_prec,
                         res_spec,
                         res_sens)


final_res_metrics_conf = list(res_conf_mat, 
                         final_res_metrics)

final_res_metrics_conf

final_res_metrics_conf %>% 
  saveRDS(file = paste0("final_res_metrics", filename, outcomevar, today(), ".rds"))

```

### Heatmap: Gene L2FC per condition
```{r}
# Required files
ImmuneGO_Annotated_Genes = readRDS(here("VaxGO gene sets","ImmuneGO_Annotated_Genes_2024-03-26.rds"))
all_degs_p_05_vac_infected_19_12_23 = read_csv(here("DGE analysis", "all_degs_p_05_vac_infected_19_12_23.csv"))
ann_vaccines <- read_csv(here("Annotations and metadata", "ann_vaccines_19-1-24.csv"))

#Inputs
ImmuneGO_Annotated_Genes_all = ImmuneGO_Annotated_Genes %>% 
  filter(!process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE"))

ImmuneGO_Genes = all_degs_p_05_vac_infected_19_12_23 %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% 
               select(genes, process) %>% 
               distinct() %>% 
               select(genes),
               by = "genes") %>% 
  distinct()

# Matrix
l2fc_imps = genes_rf %>% 
  select(genes = Variable, importance = Importance) %>% 
  inner_join(ImmuneGO_Genes, by = "genes") %>%
  select(genes, condition, log2fold_change) %>% 
  pivot_wider(names_from = condition, values_from = log2fold_change) %>% 
  column_to_rownames("genes") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0)

```


```{r}

#Which VIP genes?
#vipgenes_tidymodels_disease_vac2024_04_24 <- read_csv("vipgenes_tidymodels_disease_vac2024-04-24.csv")
vipgenes_tidymodels_type <- read_csv("vipgenes_tidymodels_type2024-06-21.csv")

vip_genes = vipgenes_tidymodels_type
outcomevar = "_Type_"

rf_genes = vip_genes %>% 
  clean_names() %>% 
  select(genes = variable, importance)

ImmuneGO_Genes = all_degs_p_05_vac_infected_19_12_23 %>% 
  inner_join(rf_genes %>% 
               select(genes) %>% 
               distinct() %>% 
               select(genes),
               by = "genes") %>% 
  distinct()

####### INPUT
data_2 = ImmuneGO_Genes
filename_2 = paste0("RandomForest_ImmuneGO_Genes", outcomevar, today())

######## Matrix
matrix = data_2 %>% 
  select(genes, condition, log2fold_change) %>%
  pivot_wider(names_from = "condition", 
              values_from = "log2fold_change", 
              values_fn = mean) %>% 
  replace(is.na(.), 0) %>%
  arrange(genes) %>% 
  column_to_rownames(var="genes") %>% 
  as.matrix()

######## Annotations
ann_vaccines_covid_other_2 = data_2 %>% 
  select(condition) %>% 
  inner_join(ann_vaccines, by = "condition") %>% 
  distinct() %>% 
  select(condition, disease_vac, type, week, day) %>% 
  arrange(week, day) %>% 
  mutate(week = fct_relevel(as.factor(week), sort(levels(week))),
         day = fct_relevel(as.factor(day), sort(levels(day))))

#Columns
ann_cols_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  inner_join(ann_vaccines_covid_other_2, by = "condition") %>% 
  distinct() %>% 
  arrange(condition) %>% 
  column_to_rownames("condition")

matrix_data = matrix %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  inner_join(ann_cols_heatmap %>% rownames_to_column("condition"), by = "condition") %>% 
  select(!c(disease_vac:day)) %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>%
  as.matrix() 

#Rows Immune ----
ann_rows_immune = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  left_join(ImmuneGO_Annotated_Genes %>% filter(go_term == "Manual"), by = "genes") %>%
  select(genes, process) %>%
  distinct() %>%
  group_by(genes) %>%
  arrange(genes, factor(process, levels = c("INNATE IMMUNE SYSTEM", "ADAPTIVE IMMUNE SYSTEM")), .by_group = TRUE) %>%
  mutate(i_process = row_number()) %>%
  pivot_wider(., names_from = "i_process", values_from = "process") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("index") %>%
  mutate(index = as.numeric(index)) %>%
  arrange(desc(index)) %>%
  column_to_rownames("index") %>%
  t() %>%
  as.data.frame() %>%
  replace(is.na(.), ".") %>% 
  mutate(`1` = if_else(`1` == ".", "INNATE IMMUNE SYSTEM", `1`)) 

#Verificar dimensões do dataset
dim(matrix)
dim(matrix_data)
dim(ann_cols_heatmap)
dim(ann_rows_immune)
```


```{r}
################# Immune 
#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "right")

row_ha = HeatmapAnnotation(df = ann_rows_immune,
                       col = col_process_immune,
                       which= "row",
                       show_annotation_name = F,
                       show_legend = F,
                       simple_anno_size = unit(2, "mm"))

# Values colors
col_fun <- colorRamp2(c(-2, 0, 2), c("#9bc1bc", "white", "#ed6a5a"))

file = filename_2
mat = matrix_data
width_image = 30
height_image = 15
width = unit(15, "cm")
height = unit(5, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)
rect_gp = gpar(col = "gray80", lwd = 0.5)

fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = fileimageheatmap_grouped, 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "vertical"),
                        name = "L2FC",
                        col = col_fun, #color
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "white",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(0, "cm"),
                        row_split = NULL,
                        column_split = NULL,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(2, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height)

heatmap_plot = draw(heatmap_plot, 
     annotation_legend_side = "left", 
     heatmap_legend_side = "left")

dev.off()

```

## Boxplot: VIP gene expression by condition

```{r fig.height=10, fig.width=10}

table = df %>% 
  rownames_to_column("genes") %>% 
  pivot_longer(cols = -genes,
               names_to = "sample",
               values_to = "counts") %>% 
  filter(genes %in% c("GATA3", "ZNF3", "KMT2A", "ASXL1", "SP100", "GZMM","ITGAM", "ACTG1", "LGALS3", "STAT5B")) %>% 
  inner_join(ann_vaccines_samples_4_12_23, by = "sample") %>% 
  mutate(week_fac = as_factor(week),
         week_fac = fct_reorder(week_fac, week),
         type = fct_relevel(type, "H",  "I","RNA", "VV", "IN", "SU"))


#Base value -----
median_h = table %>% 
  select(genes, sample, counts, disease_vac) %>% 
  filter(disease_vac == "H") %>% 
  distinct() %>% 
  group_by(genes, disease_vac) %>% 
  summarize(median = median(counts), .groups = 'drop')

median_i = table %>% 
  select(genes, sample, counts, disease_vac) %>% 
  filter(disease_vac == "H") %>% 
  distinct() %>% 
  group_by(genes, disease_vac) %>% 
  summarize(median = median(counts), .groups = 'drop') %>% 
  mutate(disease_vac = "I")

median_v = table %>% 
  select(genes, sample, counts, disease_vac) %>% 
  filter(disease_vac == "H") %>% 
  distinct() %>% 
  group_by(genes, disease_vac) %>% 
  summarize(median = median(counts), .groups = 'drop') %>% 
  mutate(disease_vac = "V")

median = bind_rows(median_i, median_v)
  
  
  
#Plots -----

vip_genes_boxplot_week = table %>% 
  ggplot() +
  aes(x = week_fac, y = counts, fill = type,label = condition) +
  geom_boxplot() +
  scale_y_log10()+
  scale_fill_brewer(palette = "Set2", direction = 1) +
  scale_color_brewer(palette = "Set2", direction = 1) +
  theme_light() +
  facet_wrap(vars(genes), scales = "free", ncol = 1)


vip_genes_boxplot_type = table %>% 
  filter(disease_vac != "H") %>% 
  ggplot() +
  aes(x = type, y = counts, fill = week_fac) +
  geom_boxplot() +
  geom_hline(data = median, aes(yintercept = median), linetype = "dashed", alpha = 0.5) +
  scale_fill_viridis_d(option = "cividis", direction = -1) +
  scale_y_continuous(trans = "log10") +
  labs(
    x = "Type",
    y = "Normalized counts",
    title = "Gene expression of the 5 most important genes",
    fill = "Week"
  ) +
  theme_linedraw() +
  theme(axis.text.y = element_text(hjust = 0.1),
        legend.position = "top") +
  facet_grid(~genes~disease_vac, scales = "free")

vip_genes_boxplot_type 

vip_genes_boxplot_type %>% 
  ggsave(file = here("Figures", paste0("vip_genes_boxplot_type", filename, outcomevar, today(), ".png")), 
                                  width = 10, height = 15)



vip_genes_boxplot_type_sex = table %>% 
  mutate(type_sex = paste0(type, "_", sex),
         type_sex = fct_relevel(type_sex, "IN_M/F", "SU_M/F")) %>% 
  filter(disease_vac != "H") %>% 
  ggplot() +
  aes(x = type_sex, y = counts, fill = week_fac) +
  geom_boxplot() +
  geom_hline(data = median, aes(yintercept = median), linetype = "dashed", alpha = 0.5) +
  scale_fill_viridis_d(option = "cividis", direction = -1) +
  scale_y_continuous(trans = "log10") +
  labs(
    x = "Type",
    y = "Normalized counts",
    title = "Gene expression of the 5 most important genes",
    fill = "Week"
  ) +
  theme_linedraw() +
  theme(axis.text.y = element_text(hjust = 0.1),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  facet_grid(~genes~disease_vac, scales = "free")

vip_genes_boxplot_type_sex 


```


# COVID-19 and Infection - Time and dose adjusted
```{r}
# Input data ----

filename = "ImmuneGO_Genes_Type_including_Infection_"
df = all_matrices_normalized_counts

## Vaccination types
outcomevar = "type_dose_time"

ann_vaccines_samples_filtered = ann_vaccines_samples %>% 
  filter(type != "H") %>% 
  mutate(outcomevar = paste0(type, "_", dose, "_", week))

#How many samples by level?
count_levels = ann_vaccines_samples_filtered %>% 
  count(outcomevar)
count_levels
#How many levels?
levels = nrow(count_levels)
levels
#Select only important genes
PC1_2 = PC_1_2_cos2
```

### Train and test

```{r}
# Prepare data ------

#Filter genes with most importance in PCAs

df_input <- df %>%
  rownames_to_column("genes") %>%
  inner_join(PC1_2 %>% select(genes) %>% distinct(), by = "genes") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("sample") %>%
  inner_join(ann_vaccines_samples_filtered %>% 
               select(sample,
                      outcomevar), #Outcome
             by = "sample") %>%
  select(sample,
         outcomevar,
         everything()) %>%
  column_to_rownames("sample") %>%
  mutate_if(is.character, factor)

glimpse(df_input)

# Split data
set.seed(123)  
split <- initial_split(df_input, prop = 0.7, strata = outcomevar)
trees_train <- training(split)
trees_test <- testing(split)

# Create recipe
tree_rec <- recipe(outcomevar ~ ., data = trees_train) %>% #OUTCOME
  step_dummy(all_nominal(), -all_outcomes()) %>%
  step_corr(all_numeric_predictors()) %>% 
  step_upsample(outcomevar) #Upsample unbalanced data (OUTCOME)

tree_prep <- prep(tree_rec)

juiced <- juice(tree_prep)

# Set random forest hyper parameters
tune_spec <- rand_forest(
  mtry = tune(),
  trees = 2000,
  min_n = tune()
) %>%
  set_mode("classification") %>% 
  set_engine("ranger")

# Create workflow
tune_wf <- workflow() %>%
  add_recipe(tree_rec) %>%
  add_model(tune_spec)

#Cross validation
set.seed(234)
trees_folds <- vfold_cv(trees_train)


#Define performance metrics
mer_metrics <- metric_set(roc_auc, 
                          pr_auc,
                          yardstick::recall,
                          yardstick::accuracy)

# Parallel computing 
doParallel::registerDoParallel()

set.seed(345)
tune_res <- tune_grid(
  tune_wf,
  metrics = mer_metrics,
  resamples = trees_folds,
  grid = 20
)

# Assess data ----
# accuracy
metrics_tuneres = tune_res %>%
  collect_metrics() %>%
  filter(.metric == "accuracy") %>%
  select(mean, min_n, mtry) %>%
  pivot_longer(min_n:mtry,
    values_to = "value",
    names_to = "parameter"
  ) %>%
  ggplot(aes(value, mean, color = parameter)) +
  geom_line() +
  geom_point(show.legend = FALSE) +
  geom_text_repel(aes(label = value))+
  facet_wrap(~parameter, scales = "free_x") +
  labs(x = NULL, y = "accuracy")

metrics_tuneres

ggsave(metrics_tuneres, file = paste0(filename, outcomevar, "_tidymodels_tune_res.png"), width = 10, height = 6)
```

Tune hyperparameters
```{r}
# Tune hyperparameters ----
rf_grid <- grid_regular(
  mtry(range = c(44, 45)),
  min_n(range = c(16, 17)),
  levels = levels
)

set.seed(456)
regular_res <- tune_grid(
  tune_wf,
  metrics = mer_metrics,
  resamples = trees_folds,
  grid = rf_grid
)

# Assess performance -----
regular_res %>%
  collect_metrics()

regular_res %>%
  collect_metrics() %>% 
  write.csv(file = paste("metrics_finalmodel_", filename, outcomevar, today(), ".csv"), row.names = F)

#ROC AUC
roc_auc = regular_res %>%
  collect_metrics() %>%
  filter(.metric == "roc_auc") %>%
  mutate(min_n = factor(min_n)) %>%
  ggplot(aes(mtry, mean, color = min_n)) +
  geom_line(alpha = 0.5, size = 1.5) +
  geom_point() +
  labs(y = "AUC")

ggsave(roc_auc, file = paste("roc_auc_", filename, outcomevar, today(), ".png"), width = 10, height = 6)

# Select best model -----
best_auc <- select_best(regular_res, metric = "accuracy")
final_rf <- finalize_model(
  tune_spec,
  best_auc
)
```

Important features
```{r}
final = final_rf %>%
  set_engine("ranger", importance = "permutation") %>%
  fit(outcomevar ~ .,
    data = juice(tree_prep)
  ) %>% 
  vip()

final

final %>% ggsave(file = paste0("vipgenes_tidymodels_", outcomevar, today(), ".png"))

genes_rf = final$data
genes_rf
genes_rf %>% write.csv(file = paste0("vipgenes_tidymodels_", filename, outcomevar, today(), ".csv"), row.names = F)

importance_plot = ggplot(genes_rf) +
  aes(x = reorder(Variable, Importance),
    y = Importance,
    color = Importance,
      weight = Importance) +
  geom_segment(aes(x=Variable, xend=Variable, y=0, yend=Importance)) +
  geom_point(shape = "circle", size = 5) +
  theme_minimal() +
  xlab("Genes") + 
  ylab("Importance") +
  ylim(0.03, 0.06) +
  geom_text(aes(label = round(Importance, 4), y = Importance),
            hjust = -0.5, 
            size = 4,
            angle = 0,
            color = "black")+
  scale_color_gradient(low = "#4DBBD5FF", high = "#DC0000FF") +
  theme(legend.position = "right",
        axis.text.x = element_text(angle = 90, vjust = 1, hjust=1, size = 12, color = "black"),
        axis.text.y = element_text(size = 12, angle = 0, color = "black"),
        panel.grid.minor.y = element_blank(),
        legend.text = element_text(size=12),
        legend.title = element_text(size = 12, face = "bold")) +
    coord_flip()

ggsave(importance_plot, file = paste0("vipgenes_tidymodels_", filename, outcomevar, today(), ".png"), width = 8, height = 5)

importance_plot

```

Train final model with tuned hyperparameters
```{r}
# Train final model with tuned hyperparameters
final_wf <- workflow() %>%
  add_recipe(tree_rec) %>%
  add_model(final_rf)

final_res <- final_wf %>%
  last_fit(split)

final_res %>%
  collect_metrics()

final_res %>%
  collect_metrics() %>% 
write.csv(file = paste0("rf_metrics", filename, outcomevar, today(), ".csv"), row.names = F)

final_res_preds = final_res %>%
  collect_predictions() %>%
  mutate(correct = case_when(
    outcomevar == .pred_class ~ "Correct",
    TRUE ~ "Incorrect"
  )) %>%
  bind_cols(trees_test)

#Confusion matrix
conf_mat(final_res_preds, truth = fgr,
         estimate = .pred_class)

#Accuracy
accuracy(final_res_preds, truth = fgr,
         estimate = .pred_class)

#Sensitivity
sens(fgr_results, truth = fgr,
         estimate = .pred_class)

#Specificity
spec(fgr_results, truth = fgr,
         estimate = .pred_class)

#Precision
precision(fgr_results, truth = fgr,
         estimate = .pred_class)

#Recall
recall(fgr_results, truth = fgr,
         estimate = .pred_class)

#ROC AUC
roc_plot = final_res_preds %>%
  roc_curve(truth = fgr, .pred_1) %>%
  autoplot()


final_res_acc_values = final_res_preds %>% 
  rename(outcomevar = starts_with("outcomevar")) %>% 
  group_by(correct, outcomevar1) %>% 
  tabyl(correct, outcomevar1) %>% 
  as.data.frame() %>% 
  group_by(correct) %>% 
  pivot_longer(-correct, values_to = "value", names_to = "outcomevar") %>% 
  group_by(outcomevar) %>% 
  arrange(outcomevar) %>% 
  mutate(perc = round(value/sum(value) * 100, 0))

final_res_acc_values %>% 
  write.csv(file = paste0("accuracy", filename, outcomevar, today(), ".csv"), row.names = F)

```













#COVID-19 vaccines and infection: Workflowsets
```{r}
# Input data ----

filename = "ImmuneGO_Genes_Type_including_Infection_"
df = all_matrices_normalized_counts

## Vaccination types
outcomevar = "type"

ann_vaccines_samples_filtered = ann_vaccines_samples %>% 
  mutate(outcomevar = type) %>% 
  filter(type != "H") %>% 
  select(-type)

#How many samples by level?
count_levels = ann_vaccines_samples_filtered %>% 
  count(outcomevar)

count_levels

#How many levels?
levels = nrow(count_levels)

#Select only important genes
PC1_2 = PC_1_2_cos2

#Prepare data
df_input <- df %>%
  rownames_to_column("genes") %>%
  inner_join(PC1_2 %>% select(genes) %>% distinct(), by = "genes") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("sample") %>%
  inner_join(ann_vaccines_samples_filtered %>% select(sample,
                                                      outcomevar), #Outcome
             by = "sample") %>%
  select(sample,
         outcomevar,
         everything()) %>%
  column_to_rownames("sample") %>%
  mutate_if(is.character, factor) %>% 
  select(-"DOCK8", -"IL18BP")

glimpse(df_input)
```

### Train and test
```{r}
# Prepare data ------

# Split data
set.seed(123)  
split <- initial_split(df_input, prop = 0.7, strata = "outcomevar")
train <- training(split)
test <- testing(split)
cv_folds <- vfold_cv(data = train, v = 5) 

#Recipe
base_rec <- recipe(outcomevar ~ ., data = train) %>%
 step_dummy(all_nominal(), -all_outcomes())
  # step_upsample(outcomevar) 

#Prep
base_prep <- prep(base_rec)
juiced <- juice(base_prep)


# Definir os modelos ----
# glm_model <- logistic_reg() %>%
#   set_engine("glm")

rf_model <- rand_forest(trees = 2000, 
                        min_n = tune(), 
                        mtry = tune()) %>%
  set_engine("ranger") %>%
  set_mode("classification")

tree_model <- decision_tree(cost_complexity = tune(), 
                            min_n = tune()) %>% 
  set_engine("rpart") %>%
  set_mode("classification")

knn_model <-  nearest_neighbor(neighbors = tune(), 
                               dist_power = tune(), 
                               weight_func = tune()) %>% 
  set_engine("kknn") %>%
  set_mode("classification")

nn_model <- mlp(hidden_units = tune(), 
                penalty = tune()) %>%
  set_engine("nnet") %>%
  set_mode("classification")

xgb_spec <- 
   boost_tree(tree_depth = tune(), 
              learn_rate = tune(), 
              loss_reduction = tune(), 
              min_n = tune(), 
              sample_size = tune(), 
              trees = tune()) %>% 
   set_engine("xgboost") %>% 
   set_mode("classification")

rf_wf <- workflow() %>%
  add_model(rf_model) %>%
  add_recipe(base_rec)

tree_wf <- workflow() %>%
  add_model(tree_model) %>%
  add_recipe(base_rec)

knn_wf <- workflow() %>%
  add_model(knn_model) %>%
  add_recipe(base_rec)

nn_wf <- workflow() %>%
  add_model(nn_model) %>%
  add_recipe(base_rec)

# Workflowsets ----
# link{https://www.tmwr.org/workflow-sets}
wf_set <- workflow_set(
  preproc = list(base_rec),
  models = list(rf = rf_model, 
                tree = tree_model, 
                knn = knn_model, 
                nn = nn_model)
)

#Tuning
grid_ctrl <-
   control_grid(
      save_pred = TRUE,
      parallel_over = "everything",
      save_workflow = TRUE
   )

grid_results <-
   wf_set %>%
   workflow_map(
      seed = 1503,
      resamples = cv_folds,
      grid = 10,
      control = grid_ctrl
   )

#Evaluate
grid_results %>% 
   rank_results() %>% 
   filter(.metric == "accuracy") %>% 
   select(model, .config, accuracy, rank)



## plot each of the model's performance and ROC
autoplot(
   grid_results,
   rank_metric = "accuracy",  # <- how to order models
   metric = "accuracy",       # <- which metric to visualize
   select_best = TRUE     # <- one point per workflow
) +
   geom_text(aes(y = mean - 1/2, label = wflow_id), angle = 90, hjust = 1) +
   lims(y = c(3.5, 9.5)) +
   theme(legend.position = "none")

## Look at the model metrics for each of the models
collect_metrics(fit_wf) 
 
#Specific model
autoplot(grid_results, id = "rf", metric = "accuracy")
```


```{r}
# Tune hyperparameters ----
rf_grid <- grid_regular(
  mtry(range = c(2, 6)),
  min_n(range = c(6, 14)),
  levels = levels
)

set.seed(456)
regular_res <- tune_grid(
  tune_wf,
  resamples = trees_folds,
  grid = rf_grid
)

# Assess performance -----

regular_res %>%
  collect_metrics()

regular_res %>%
  collect_metrics() %>% 
  write.csv(file = paste("metrics_finalmodel_", filename, outcomevar, today(), ".csv"), row.names = F)

roc_auc = regular_res %>%
  collect_metrics() %>%
  filter(.metric == "roc_auc") %>%
  mutate(min_n = factor(min_n)) %>%
  ggplot(aes(mtry, mean, color = min_n)) +
  geom_line(alpha = 0.5, size = 1.5) +
  geom_point() +
  labs(y = "AUC") 
ggsave(roc_auc, file = paste("roc_auc_", filename, outcomevar, today(), ".png"), width = 10, height = 6)

# Select best model -----
best_auc <- select_best(regular_res, metric = "roc_auc")
final_rf <- finalize_model(
  tune_spec,
  best_auc
)
```

Important features
```{r}
final = final_rf %>%
  set_engine("ranger", importance = "permutation") %>%
  fit(outcomevar ~ .,
    data = juice(tree_prep)
  ) %>% 
  vip()

final

final %>% ggsave(file = paste0("vipgenes_tidymodels_", outcomevar, today(), ".png"))

genes_rf = final$data
genes_rf
genes_rf %>% write.csv(file = paste0("vipgenes_tidymodels_", filename, outcomevar, today(), ".csv"), row.names = F)

importance_plot = ggplot(genes_rf) +
  aes(x = reorder(Variable, Importance),
    y = Importance,
    color = Importance,
      weight = Importance) +
  geom_segment(aes(x=Variable, xend=Variable, y=0, yend=Importance)) +
  geom_point(shape = "circle", size = 5) +
  theme_minimal() +
  xlab("Genes") + 
  ylab("Importance") +
  geom_text(aes(label = round(Importance, 4), y = Importance),
            hjust = -0.5, 
            size = 4,
            angle = 0,
            color = "black")+
  scale_color_gradient(low = "#4DBBD5FF", high = "#DC0000FF") +
  theme(legend.position = "right",
        axis.text.x = element_text(angle = 90, vjust = 1, hjust=1, size = 12, color = "black"),
        axis.text.y = element_text(size = 12, angle = 0, color = "black"),
        panel.grid.minor.y = element_blank(),
        legend.text = element_text(size=12),
        legend.title = element_text(size = 12, face = "bold")) +
    coord_flip()

ggsave(importance_plot, file = paste0("vipgenes_tidymodels_", filename, outcomevar, today(), ".png"), width = 8, height = 5)

importance_plot

```

Train final model with tuned hyperparameters
```{r}
# Train final model with tuned hyperparameters
final_wf <- workflow() %>%
  add_recipe(tree_rec) %>%
  add_model(final_rf)

final_res <- final_wf %>%
  last_fit(split)

final_res %>%
  collect_metrics()

final_res %>%
  collect_metrics() %>% 
write.csv(file = paste0("rf_metrics", filename, outcomevar, today(), ".csv"), row.names = F)

final_res_preds = final_res %>%
  collect_predictions() %>%
  mutate(correct = case_when(
    outcomevar == .pred_class ~ "Correct",
    TRUE ~ "Incorrect"
  )) %>%
  bind_cols(trees_test)


final_res_acc_values = final_res_preds %>% 
  rename(outcomevar = starts_with("outcomevar")) %>% 
  group_by(correct, outcomevar1) %>% 
  tabyl(correct, outcomevar1) %>% 
  as.data.frame() %>% 
  group_by(correct) %>% 
  pivot_longer(-correct, values_to = "value", names_to = "outcomevar") %>% 
  group_by(outcomevar) %>% 
  arrange(outcomevar) %>% 
  mutate(perc = round(value/sum(value) * 100, 0))

final_res_acc_values %>% 
  write.csv(file = paste0("accuracy", filename, outcomevar, today(), ".csv"), row.names = F)

```

### Heatmap: Gene L2FC per condition
```{r}
# Required files
ImmuneGO_Annotated_Genes = readRDS(here("VaxGO gene sets","ImmuneGO_Annotated_Genes_2024-03-26.rds"))
all_degs_p_05_vac_infected_19_12_23 = read_csv(here("DGE analysis", "all_degs_p_05_vac_infected_19_12_23.csv"))
ann_vaccines <- read_csv(here("Annotations and metadata", "ann_vaccines_19-1-24.csv"))

#Inputs
ImmuneGO_Annotated_Genes_all = ImmuneGO_Annotated_Genes %>% 
  filter(!process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE"))

ImmuneGO_Genes = all_degs_p_05_vac_infected_19_12_23 %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% 
               select(genes, process) %>% 
               distinct() %>% 
               select(genes),
               by = "genes") %>% 
  distinct()

# Matrix
l2fc_imps = genes_rf %>% 
  select(genes = Variable, importance = Importance) %>% 
  inner_join(ImmuneGO_Genes, by = "genes") %>%
  select(genes, condition, log2fold_change) %>% 
  pivot_wider(names_from = condition, values_from = log2fold_change) %>% 
  column_to_rownames("genes") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0)

```


```{r}

#Which VIP genes?
#vipgenes_tidymodels_disease_vac2024_04_24 <- read_csv("vipgenes_tidymodels_disease_vac2024-04-24.csv")
vipgenes_tidymodels_type <- read_csv("vipgenes_tidymodels_type2024-06-21.csv")

vip_genes = vipgenes_tidymodels_type
outcomevar = "_Type_"

rf_genes = vip_genes %>% 
  clean_names() %>% 
  select(genes = variable, importance)

ImmuneGO_Genes = all_degs_p_05_vac_infected_19_12_23 %>% 
  inner_join(rf_genes %>% 
               select(genes) %>% 
               distinct() %>% 
               select(genes),
               by = "genes") %>% 
  distinct()

####### INPUT
data_2 = ImmuneGO_Genes
filename_2 = paste0("RandomForest_ImmuneGO_Genes", outcomevar, today())

######## Matrix
matrix = data_2 %>% 
  select(genes, condition, log2fold_change) %>%
  pivot_wider(names_from = "condition", 
              values_from = "log2fold_change", 
              values_fn = mean) %>% 
  replace(is.na(.), 0) %>%
  arrange(genes) %>% 
  column_to_rownames(var="genes") %>% 
  as.matrix()

######## Annotations
ann_vaccines_covid_other_2 = data_2 %>% 
  select(condition) %>% 
  inner_join(ann_vaccines, by = "condition") %>% 
  distinct() %>% 
  select(condition, disease_vac, type, week, day) %>% 
  arrange(week, day) %>% 
  mutate(week = fct_relevel(as.factor(week), sort(levels(week))),
         day = fct_relevel(as.factor(day), sort(levels(day))))

#Columns
ann_cols_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  inner_join(ann_vaccines_covid_other_2, by = "condition") %>% 
  distinct() %>% 
  arrange(condition) %>% 
  column_to_rownames("condition")

matrix_data = matrix %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  inner_join(ann_cols_heatmap %>% rownames_to_column("condition"), by = "condition") %>% 
  select(!c(disease_vac:day)) %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>%
  as.matrix() 

#Rows Immune ----
ann_rows_immune = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  left_join(ImmuneGO_Annotated_Genes %>% filter(go_term == "Manual"), by = "genes") %>%
  select(genes, process) %>%
  distinct() %>%
  group_by(genes) %>%
  arrange(genes, factor(process, levels = c("INNATE IMMUNE SYSTEM", "ADAPTIVE IMMUNE SYSTEM")), .by_group = TRUE) %>%
  mutate(i_process = row_number()) %>%
  pivot_wider(., names_from = "i_process", values_from = "process") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("index") %>%
  mutate(index = as.numeric(index)) %>%
  arrange(desc(index)) %>%
  column_to_rownames("index") %>%
  t() %>%
  as.data.frame() %>%
  replace(is.na(.), ".") %>% 
  mutate(`1` = if_else(`1` == ".", "INNATE IMMUNE SYSTEM", `1`)) 

#Verificar dimensões do dataset
dim(matrix)
dim(matrix_data)
dim(ann_cols_heatmap)
dim(ann_rows_immune)
```


```{r}
################# Immune 
#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "right")

row_ha = HeatmapAnnotation(df = ann_rows_immune,
                       col = col_process_immune,
                       which= "row",
                       show_annotation_name = F,
                       show_legend = F,
                       simple_anno_size = unit(2, "mm"))

# Values colors
col_fun <- colorRamp2(c(-2, 0, 2), c("#9bc1bc", "white", "#ed6a5a"))

file = filename_2
mat = matrix_data
width_image = 30
height_image = 15
width = unit(15, "cm")
height = unit(5, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)
rect_gp = gpar(col = "gray80", lwd = 0.5)

fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = fileimageheatmap_grouped, 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "vertical"),
                        name = "L2FC",
                        col = col_fun, #color
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "white",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(0, "cm"),
                        row_split = NULL,
                        column_split = NULL,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(2, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height)

heatmap_plot = draw(heatmap_plot, 
     annotation_legend_side = "left", 
     heatmap_legend_side = "left")

dev.off()

```

### Heatmap: Random forest genes in COVID and other vaccines

```{r}
covid_other_immunego_genes <- readRDS(here("VaxGO gene sets", "covid_other_immunego_genes.rds"))
ann_vaccines_covid_other = read_csv(here("Annotations and metadata", "ann_vaccines_vaxsig_covid.csv"))

####### INPUT
data_2 = covid_other_immunego_genes %>% 
  inner_join(rf_genes, by = "genes")
filename_2 = paste0("RF_Genes", "_VAX_COVID")
```


```{r}
######## Matrix
matrix = data_2 %>% 
  select(genes, condition, regulation_numeric) %>%
  pivot_wider(names_from = "condition", 
              values_from = "regulation_numeric", 
              values_fn = mean) %>% 
  replace(is.na(.), 0) %>%
  arrange(genes) %>% 
  column_to_rownames(var="genes") %>% 
  as.matrix()

######## Annotations
ann_vaccines_covid_other_2 = data_2 %>% 
  inner_join(ann_vaccines_covid_other, by = "condition") %>% 
  select(condition, covid_other, microbe_type, disease_vac, type, week) %>% 
  distinct()

#Columns
ann_cols_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  inner_join(ann_vaccines_covid_other_2, by = "condition") %>% 
  distinct() %>% 
  arrange(condition) %>% 
  column_to_rownames("condition")

matrix_data = matrix %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  inner_join(ann_cols_heatmap %>% rownames_to_column("condition"), by = "condition") %>% 
  select(!c(covid_other:week)) %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>%
  as.matrix() 

#Rows Immune ----
ann_rows_immune = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  left_join(ImmuneGO_Annotated_Genes %>%
              filter(go_term == "Manual",
                     !process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE")), by = "genes") %>%
  select(genes, process) %>%
  distinct() %>%
  group_by(genes) %>%
  arrange(genes, factor(process, levels = c("INNATE IMMUNE SYSTEM", "ADAPTIVE IMMUNE SYSTEM")), .by_group = TRUE) %>%
  mutate(i_process = row_number()) %>%
  pivot_wider(., names_from = "i_process", values_from = "process") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("index") %>%
  mutate(index = as.numeric(index)) %>%
  arrange(desc(index)) %>%
  column_to_rownames("index") %>%
  t() %>%
  as.data.frame() %>%
  replace(is.na(.), ".")

#Verificar dimensões do dataset
dim(matrix_data)
dim(ann_cols_heatmap)
dim(ann_rows_immune)

```

```{r}
#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "left")

row_ha = HeatmapAnnotation(df = ann_rows_immune,
                       col = col_process_immune,
                       which= "row",
                       show_annotation_name = F,
                       show_legend = F)

# Values colors
col_fun <- colorRamp2(c(-1, 0, 1), c("#9bc1bc", "white", "#ed6a5a"))

file = filename_2
mat = matrix_data
width_image = 30
height_image = 10
width = unit(5, "cm")
height = unit(2, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)
rect_gp = gpar(col = "gray80", lwd = 0)
row_split = NULL
column_split = NULL


fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = fileimageheatmap_grouped, 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        col = col_fun, #color
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "white",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(5, "cm"),
                        row_split = row_split,
                        column_split = column_split,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(8, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "right",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        clustering_distance_columns = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height,
                        use_raster = F)

heatmap_plot = draw(heatmap_plot)

dev.off()

```



# COVID-19: only up and down

```{r}
# Input data ----

filename = "ImmuneGO_Genes_Type_including_Infection_"
df = all_matrices_normalized_counts

## Disease vs Vaccination
# outcomevar = "disease_vac"
# levels = 2 

## Vaccination types
outcomevar = "type"

ann_vaccines_samples_filtered = ann_vaccines_samples %>% 
  mutate(outcomevar = type) %>% 
  filter(type != "H")

#Vaccine type, week, infection
  # mutate(outcomevar = paste0(if_else(disease_vac == "I", "Infection", "Vaccination"), "_", type, " (V", dose, ", W", week, ")")) %>% 

#How many samples by level?
count_levels = ann_vaccines_samples_filtered %>% 
  count(outcomevar)

#How many levels?
levels = nrow(count_levels)

#Select only important genes
PC1_2 = PC_1_2_cos2
```

### Train and test

```{r}
# Prepare data ------

df_input <- df %>%
  rownames_to_column("genes") %>%
  inner_join(PC1_2 %>% select(genes) %>% distinct(), by = "genes") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("sample") %>%
  inner_join(ann_vaccines_samples_filtered %>% select(sample,
                                                      outcomevar), #Outcome
             by = "sample") %>%
  select(sample,
         outcomevar,
         everything()) %>%
  column_to_rownames("sample") %>%
  mutate_if(is.character, factor)

glimpse(df_input)

# Split data
set.seed(123)  
split <- initial_split(df_input, prop = 0.7, strata = outcomevar)
trees_train <- training(split)
trees_test <- testing(split)

# Create recipe
tree_rec <- recipe(outcomevar ~ ., data = trees_train) %>% #OUTCOME
  step_dummy(all_nominal(), -all_outcomes()) %>%
  step_upsample(outcomevar) #Upsample unbalanced data (OUTCOME)

tree_prep <- prep(tree_rec)

juiced <- juice(tree_prep)

# Set random forest hyper parameters
tune_spec <- rand_forest(
  mtry = tune(),
  trees = 2000,
  min_n = tune()
) %>%
  set_mode("classification") %>% 
  set_engine("ranger")

# Create workflow
tune_wf <- workflow() %>%
  add_recipe(tree_rec) %>%
  add_model(tune_spec)

#Cross validation
set.seed(234)
trees_folds <- vfold_cv(trees_train)

# Parallel computing 
doParallel::registerDoParallel()

set.seed(345)
tune_res <- tune_grid(
  tune_wf,
  resamples = trees_folds,
  grid = 20
)

# Assess data ----
# AUC
metrics_tuneres = tune_res %>%
  collect_metrics() %>%
  filter(.metric == "roc_auc") %>%
  select(mean, min_n, mtry) %>%
  pivot_longer(min_n:mtry,
    values_to = "value",
    names_to = "parameter"
  ) %>%
  ggplot(aes(value, mean, color = parameter)) +
  geom_line() +
  geom_point(show.legend = FALSE) +
  geom_text_repel(aes(label = value))+
  facet_wrap(~parameter, scales = "free_x") +
  labs(x = NULL, y = "AUC")

metrics_tuneres

ggsave(metrics_tuneres, file = paste0(filename, outcomevar, "_tidymodels_tune_res.png"), width = 10, height = 6)
```


```{r}
# Tune hyperparameters ----
rf_grid <- grid_regular(
  mtry(range = c(2, 6)),
  min_n(range = c(6, 14)),
  levels = levels
)

set.seed(456)
regular_res <- tune_grid(
  tune_wf,
  resamples = trees_folds,
  grid = rf_grid
)

# Assess performance -----

regular_res %>%
  collect_metrics()

regular_res %>%
  collect_metrics() %>% 
  write.csv(file = paste("metrics_finalmodel_", filename, outcomevar, today(), ".csv"), row.names = F)

roc_auc = regular_res %>%
  collect_metrics() %>%
  filter(.metric == "roc_auc") %>%
  mutate(min_n = factor(min_n)) %>%
  ggplot(aes(mtry, mean, color = min_n)) +
  geom_line(alpha = 0.5, size = 1.5) +
  geom_point() +
  labs(y = "AUC") 
ggsave(roc_auc, file = paste("roc_auc_", filename, outcomevar, today(), ".png"), width = 10, height = 6)

# Select best model -----
best_auc <- select_best(regular_res, metric = "roc_auc")
final_rf <- finalize_model(
  tune_spec,
  best_auc
)
```

Important features
```{r}
final = final_rf %>%
  set_engine("ranger", importance = "permutation") %>%
  fit(outcomevar ~ .,
    data = juice(tree_prep)
  ) %>% 
  vip()

final

final %>% ggsave(file = paste0("vipgenes_tidymodels_", outcomevar, today(), ".png"))

genes_rf = final$data
genes_rf
genes_rf %>% write.csv(file = paste0("vipgenes_tidymodels_", outcomevar, today(), ".csv"), row.names = F)

importance_plot = ggplot(genes_rf) +
  aes(x = reorder(Variable, Importance),
    y = Importance,
    color = Importance,
      weight = Importance) +
  geom_segment(aes(x=Variable, xend=Variable, y=0, yend=Importance)) +
  geom_point(shape = "circle", size = 5) +
  theme_minimal() +
  xlab("Genes") + 
  ylab("Importance") +
  geom_text(aes(label = round(Importance, 4), y = Importance),
            hjust = -0.5, 
            size = 4,
            angle = 0,
            color = "black")+
  scale_color_gradient(low = "#4DBBD5FF", high = "#DC0000FF") +
  theme(legend.position = "right",
        axis.text.x = element_text(angle = 90, vjust = 1, hjust=1, size = 12, color = "black"),
        axis.text.y = element_text(size = 12, angle = 0, color = "black"),
        panel.grid.minor.y = element_blank(),
        legend.text = element_text(size=12),
        legend.title = element_text(size = 12, face = "bold")) +
    coord_flip()

ggsave(importance_plot, file = paste0("vipgenes_tidymodels_", filename, outcomevar, today(), ".png"), width = 8, height = 5)

importance_plot

```

Train final model with tuned hyperparameters
```{r}
# Train final model with tuned hyperparameters
final_wf <- workflow() %>%
  add_recipe(tree_rec) %>%
  add_model(final_rf)

final_res <- final_wf %>%
  last_fit(split)

final_res %>%
  collect_metrics()

final_res %>%
  collect_metrics() %>% 
write.csv(file = paste0("rf_metrics", filename, outcomevar, today(), ".csv"), row.names = F)

final_res_preds = final_res %>%
  collect_predictions() %>%
  mutate(correct = case_when(
    outcomevar == .pred_class ~ "Correct",
    TRUE ~ "Incorrect"
  )) %>%
  bind_cols(trees_test)


final_res_acc_values = final_res_preds %>% 
  rename(outcomevar = starts_with("outcomevar")) %>% 
  group_by(correct, outcomevar1) %>% 
  tabyl(correct, outcomevar1) %>% 
  as.data.frame() %>% 
  group_by(correct) %>% 
  pivot_longer(-correct, values_to = "value", names_to = "outcomevar") %>% 
  group_by(outcomevar) %>% 
  arrange(outcomevar) %>% 
  mutate(perc = round(value/sum(value) * 100, 0))

final_res_acc_values %>% 
  write.csv(file = paste0("accuracy",filename,  outcomevar, today(), ".csv"), row.names = F)

```

### Heatmap: Gene L2FC per condition
```{r}
# Required files
ImmuneGO_Annotated_Genes = readRDS(here("VaxGO gene sets","ImmuneGO_Annotated_Genes_2024-03-26.rds"))
all_degs_p_05_vac_infected_19_12_23 = read_csv(here("DGE analysis", "all_degs_p_05_vac_infected_19_12_23.csv"))
ann_vaccines <- read_csv(here("Annotations and metadata", "ann_vaccines_19-1-24.csv"))

#Inputs
ImmuneGO_Annotated_Genes_all = ImmuneGO_Annotated_Genes %>% 
  filter(!process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE"))

ImmuneGO_Genes = all_degs_p_05_vac_infected_19_12_23 %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% 
               select(genes, process) %>% 
               distinct() %>% 
               select(genes),
               by = "genes") %>% 
  distinct()

# Matrix
l2fc_imps = genes_rf %>% 
  select(genes = Variable, importance = Importance) %>% 
  inner_join(ImmuneGO_Genes, by = "genes") %>%
  select(genes, condition, log2fold_change) %>% 
  pivot_wider(names_from = condition, values_from = log2fold_change) %>% 
  column_to_rownames("genes") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0)

```


```{r}

#Which VIP genes?
#vipgenes_tidymodels_disease_vac2024_04_24 <- read_csv("vipgenes_tidymodels_disease_vac2024-04-24.csv")
vipgenes_tidymodels_type <- read_csv("vipgenes_tidymodels_type2024-06-21.csv")

vip_genes = vipgenes_tidymodels_type
outcomevar = "_Type_"

rf_genes = vip_genes %>% 
  clean_names() %>% 
  select(genes = variable, importance)

ImmuneGO_Genes = all_degs_p_05_vac_infected_19_12_23 %>% 
  inner_join(rf_genes %>% 
               select(genes) %>% 
               distinct() %>% 
               select(genes),
               by = "genes") %>% 
  distinct()

####### INPUT
data_2 = ImmuneGO_Genes
filename_2 = paste0("RandomForest_ImmuneGO_Genes", outcomevar, today())

######## Matrix
matrix = data_2 %>% 
  select(genes, condition, log2fold_change) %>%
  pivot_wider(names_from = "condition", 
              values_from = "log2fold_change", 
              values_fn = mean) %>% 
  replace(is.na(.), 0) %>%
  arrange(genes) %>% 
  column_to_rownames(var="genes") %>% 
  as.matrix()

######## Annotations
ann_vaccines_covid_other_2 = data_2 %>% 
  select(condition) %>% 
  inner_join(ann_vaccines, by = "condition") %>% 
  distinct() %>% 
  select(condition, disease_vac, type, week, day) %>% 
  arrange(week, day) %>% 
  mutate(week = fct_relevel(as.factor(week), sort(levels(week))),
         day = fct_relevel(as.factor(day), sort(levels(day))))

#Columns
ann_cols_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  inner_join(ann_vaccines_covid_other_2, by = "condition") %>% 
  distinct() %>% 
  arrange(condition) %>% 
  column_to_rownames("condition")

matrix_data = matrix %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  inner_join(ann_cols_heatmap %>% rownames_to_column("condition"), by = "condition") %>% 
  select(!c(disease_vac:day)) %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>%
  as.matrix() 

#Rows Immune ----
ann_rows_immune = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  left_join(ImmuneGO_Annotated_Genes %>% filter(go_term == "Manual"), by = "genes") %>%
  select(genes, process) %>%
  distinct() %>%
  group_by(genes) %>%
  arrange(genes, factor(process, levels = c("INNATE IMMUNE SYSTEM", "ADAPTIVE IMMUNE SYSTEM")), .by_group = TRUE) %>%
  mutate(i_process = row_number()) %>%
  pivot_wider(., names_from = "i_process", values_from = "process") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("index") %>%
  mutate(index = as.numeric(index)) %>%
  arrange(desc(index)) %>%
  column_to_rownames("index") %>%
  t() %>%
  as.data.frame() %>%
  replace(is.na(.), ".") %>% 
  mutate(`1` = if_else(`1` == ".", "INNATE IMMUNE SYSTEM", `1`)) 

#Verificar dimensões do dataset
dim(matrix)
dim(matrix_data)
dim(ann_cols_heatmap)
dim(ann_rows_immune)
```


```{r}
################# Immune 
#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "right")

row_ha = HeatmapAnnotation(df = ann_rows_immune,
                       col = col_process_immune,
                       which= "row",
                       show_annotation_name = F,
                       show_legend = F,
                       simple_anno_size = unit(2, "mm"))

# Values colors
col_fun <- colorRamp2(c(-2, 0, 2), c("#9bc1bc", "white", "#ed6a5a"))

file = filename_2
mat = matrix_data
width_image = 30
height_image = 15
width = unit(15, "cm")
height = unit(5, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)
rect_gp = gpar(col = "gray80", lwd = 0.5)

fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = fileimageheatmap_grouped, 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "vertical"),
                        name = "L2FC",
                        col = col_fun, #color
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "white",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(0, "cm"),
                        row_split = NULL,
                        column_split = NULL,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(2, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height)

heatmap_plot = draw(heatmap_plot, 
     annotation_legend_side = "left", 
     heatmap_legend_side = "left")

dev.off()

```

### Heatmap: Random forest genes in COVID and other vaccines

```{r}
covid_other_immunego_genes <- readRDS(here("VaxGO gene sets", "covid_other_immunego_genes.rds"))
ann_vaccines_covid_other = read_csv(here("Annotations and metadata", "ann_vaccines_vaxsig_covid.csv"))

####### INPUT
data_2 = covid_other_immunego_genes %>% 
  inner_join(rf_genes, by = "genes")
filename_2 = paste0("RF_Genes", "_VAX_COVID")
```


```{r}
######## Matrix
matrix = data_2 %>% 
  select(genes, condition, regulation_numeric) %>%
  pivot_wider(names_from = "condition", 
              values_from = "regulation_numeric", 
              values_fn = mean) %>% 
  replace(is.na(.), 0) %>%
  arrange(genes) %>% 
  column_to_rownames(var="genes") %>% 
  as.matrix()

######## Annotations
ann_vaccines_covid_other_2 = data_2 %>% 
  inner_join(ann_vaccines_covid_other, by = "condition") %>% 
  select(condition, covid_other, microbe_type, disease_vac, type, week) %>% 
  distinct()

#Columns
ann_cols_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  inner_join(ann_vaccines_covid_other_2, by = "condition") %>% 
  distinct() %>% 
  arrange(condition) %>% 
  column_to_rownames("condition")

matrix_data = matrix %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  inner_join(ann_cols_heatmap %>% rownames_to_column("condition"), by = "condition") %>% 
  select(!c(covid_other:week)) %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>%
  as.matrix() 

#Rows Immune ----
ann_rows_immune = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  left_join(ImmuneGO_Annotated_Genes %>%
              filter(go_term == "Manual",
                     !process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE")), by = "genes") %>%
  select(genes, process) %>%
  distinct() %>%
  group_by(genes) %>%
  arrange(genes, factor(process, levels = c("INNATE IMMUNE SYSTEM", "ADAPTIVE IMMUNE SYSTEM")), .by_group = TRUE) %>%
  mutate(i_process = row_number()) %>%
  pivot_wider(., names_from = "i_process", values_from = "process") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("index") %>%
  mutate(index = as.numeric(index)) %>%
  arrange(desc(index)) %>%
  column_to_rownames("index") %>%
  t() %>%
  as.data.frame() %>%
  replace(is.na(.), ".")

#Verificar dimensões do dataset
dim(matrix_data)
dim(ann_cols_heatmap)
dim(ann_rows_immune)

```

```{r}
#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "left")

row_ha = HeatmapAnnotation(df = ann_rows_immune,
                       col = col_process_immune,
                       which= "row",
                       show_annotation_name = F,
                       show_legend = F)

# Values colors
col_fun <- colorRamp2(c(-1, 0, 1), c("#9bc1bc", "white", "#ed6a5a"))

file = filename_2
mat = matrix_data
width_image = 30
height_image = 10
width = unit(5, "cm")
height = unit(2, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)
rect_gp = gpar(col = "gray80", lwd = 0)
row_split = NULL
column_split = NULL


fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = fileimageheatmap_grouped, 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        col = col_fun, #color
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "white",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(5, "cm"),
                        row_split = row_split,
                        column_split = column_split,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(8, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "right",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        clustering_distance_columns = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height,
                        use_raster = F)

heatmap_plot = draw(heatmap_plot)

dev.off()

```


# COVID-19 and others: up and down
```{r}
# Input data ----
filename = "COVID_Others_ImmuneGO_Genes_Type_including_Infection_"
degs_covid_vax = readRDS("~/Desktop/Github - Covid Atlas/VaxGO gene sets/degs_covid_vaxsig_up_down_immune.rds")
data_annotation = read_csv(here("Annotations and metadata", "ann_vaccines_vaxsig_covid.csv")) %>% 
  select(condition, target_pathogen_disease, type, week)

df = degs_covid_vax %>% 
  select(condition, genes, regulation_numeric) %>% 
  distinct() %>% 
  pivot_wider(names_from = genes,
              values_from = regulation_numeric,
              values_fn = mean) %>% 
  inner_join(data_annotation , by = "condition")

## Vaccination types
outcomevar = "type"

ann_vaccines_samples_filtered = df %>% 
  mutate(outcomevar = type) %>% 
  select(-type) %>% 
  select(target_pathogen_disease, week, outcomevar, condition, everything())
  #filter(!outcomevar %in% c("CONJ", "VLP", "SU", "I")) #Remove classes with few rows

#How many samples by level?
count_levels = ann_vaccines_samples_filtered %>% 
  count(outcomevar)

count_levels

#How many levels?
levels = nrow(count_levels)
```

### Train and test

```{r}
# Prepare data ------

df_input <- ann_vaccines_samples_filtered %>% 
  distinct() %>% 
  column_to_rownames("condition") %>%
  mutate_if(is.character, factor) %>% 
  mutate(week = as.factor(week),
         week = fct_relevel(week, -week)) %>% 
  replace(is.na(.), 0)

glimpse(df_input)

# Split data
set.seed(123)  
split <- initial_split(df_input, prop = 0.6, strata = outcomevar)
train <- training(split)
test <- testing(split)

# Create recipe
base_rec <- recipe(outcomevar ~ ., data = train) %>%
  step_dummy(all_nominal(), -all_outcomes())

base_rec <- prep(base_rec)
juiced <- juice(base_rec)
juiced %>% 
  glimpse()

#Cross validation
set.seed(764)
cv_folds <- vfold_cv(
  data = train, 
  v = 5
  ) 
```

Workflowsets
```{r}
#Recipe
base_rec <- recipe(outcomevar ~ ., data = train) %>%
  step_dummy(all_nominal(), -all_outcomes()) %>%
  step_upsample(outcomevar)

# Definir os modelos
glm_model <- logistic_reg() %>%
  set_engine("glm")

rf_model <- rand_forest(trees = tune(), 
                        min_n = tune(), 
                        mtry = tune()) %>%
  set_engine("ranger") %>%
  set_mode("classification")

tree_model <- decision_tree() %>%
  set_engine("rpart") %>%
  set_mode("classification")

knn_model <- nearest_neighbor(neighbors = tune()) %>%
  set_engine("kknn") %>%
  set_mode("classification")

nn_model <- mlp(hidden_units = tune(), 
                penalty = tune()) %>%
  set_engine("nnet") %>%
  set_mode("classification")

# Criar os workflows
glm_wf <- workflow() %>%
  add_model(glm_model) %>%
  add_recipe(base_rec)

rf_wf <- workflow() %>%
  add_model(rf_model) %>%
  add_recipe(base_rec)

tree_wf <- workflow() %>%
  add_model(tree_model) %>%
  add_recipe(base_rec)

knn_wf <- workflow() %>%
  add_model(knn_model) %>%
  add_recipe(base_rec)

nn_wf <- workflow() %>%
  add_model(nn_model) %>%
  add_recipe(base_rec)

# Criar o conjunto de workflows
wf_set <- workflow_set(
  preproc = list(base_rec),
  models = list(glm = glm_model, 
                rf = rf_model, 
                tree = tree_model, 
                knn = knn_model, 
                nn = nn_model)
)

#Tuning
doParallel::registerDoParallel(cores = 10)
 
tic()
 
fit_wf <- wf_set %>%  
  workflow_map(
    seed = 44, 
    fn = "tune_grid",
    grid = 10,           ## parameters to pass to tune grid
    resamples = cv_folds
  )
 
toc()
 
doParallel::stopImplicitCluster()
 
fit_wf

#Evaluate
## plot each of the model's performance and ROC
autoplot(fit_wf)
 
## Look at the model metrics for each of the models
collect_metrics(fit_wf) 
 
## Rank the results based on model accuracy
rank_results(fit_wf, rank_metric = "accuracy", select_best = TRUE)

```
