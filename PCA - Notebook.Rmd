
---
title: "PCA"
output: html_notebook
---

# PCA

Tutoriais
<https://www.datacamp.com/tutorial/pca-analysis-r> 
<https://rpkgs.datanovia.com/factoextra/index.html> <http://www.sthda.com/english/articles/31-principal-component-methods-in-r-practical-guide/114-mca-multiple-correspondence-analysis-in-r-essentials/>
<https://statisticsglobe.com/pca-before-k-means-clustering-r>>

Bibliotecas
```{r}
library(tidyverse)
library(ggrepel) #load before factoextra
library(factoextra)
library(caret)
library(stats)
library(ggfortify)
library(ggplot2)
library(corrplot)
library(cowplot)
library(ggcorrplot)
```



### By genes


Processar dados
```{r}
ImmuneGO_Annotated_Genes = ImmuneGO_Annotated_GO_8_1_24 %>% 
  select(-"...1") %>% 
  separate_rows(genes, sep = ",")

ImmuneGO_Genes = all_degs_p_05_vac_infected_19_12_23 %>% 
  select(-"...1", -"...12") %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% 
               select(genes, process) %>% 
               distinct(),
               by = "genes") %>% 
  distinct() %>% 
  filter(!process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE")) %>% 
  select(-process) %>% 
  distinct()


nonImmuneGO_Genes = all_degs_p_05_vac_infected_19_12_23 %>% 
  select(-"...1") %>% 
  anti_join(ImmuneGO_Annotated_Genes %>% 
               select(genes) %>% 
               distinct(),
               by = "genes") %>% 
  distinct()

all_non_ImmuneGO_Genes = all_degs_p_05_vac_infected_19_12_23 %>% 
  select(-"...1") %>% 
  distinct()

#INPUT
data_genes = ImmuneGO_Genes 
filename = "ImmuneGO_Genes"

data_annotation = ann_vaccines_19_1_24 %>% 
  mutate(day = as.factor(day),
         dose = as.factor(dose)) 

#Converter de long para wide

#Matriz com anotações
ann_vaccines_pca_matrix = data_genes %>% 
  mutate(log2fold_change = as.numeric(log2fold_change)) %>% 
  select(condition, genes, log2fold_change) %>% 
  pivot_wider(., names_from = "condition", 
                     values_from = "log2fold_change") %>% 
  replace(is.na(.), 0) %>%
  column_to_rownames("genes") %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column("condition") %>% 
  inner_join(data_annotation %>% 
               select(condition, disease_vac, vaccine, day, week, dose, infection, type), by = "condition") 

#Matriz para PCA
ann_vaccines_pca_matrix_ready = ann_vaccines_pca_matrix %>% 
  column_to_rownames("condition") %>% 
  select(!disease_vac:type) %>% 
  as.matrix()

# Verifique colunas com variancia baixa
nearZeroVarCols <- nearZeroVar(ann_vaccines_pca_matrix_ready, saveMetrics = TRUE)
ann_vaccines_pca_matrix_ready <- ann_vaccines_pca_matrix_ready[, !nearZeroVarCols$nzv]
pca_res <- prcomp(ann_vaccines_pca_matrix_ready, scale. = T)

########Correlation plot

corr_matrix = cor(ann_vaccines_pca_matrix_ready) 
var <- get_pca_var(pca_res)

### Contribuição dos genes principais para cada PC
# Comp1
var_ordenado_top20_dim1 <- var$cos2 %>%
  as.data.frame() %>%
  arrange(desc(.[, 1])) %>%   # Ordenar pela primeira coluna em ordem decrescente
  slice_head(n = 20) %>%      # Selecionar as primeiras 50 linhas
  select(1:1) %>%                  # Selecionar as primeiras 5 colunas
  as.matrix()

corplot_dim1 = {corrplot(var_ordenado_top20_dim1, 
         is.corr = T, tl.col = 'black', 
         tl.cex = 0.5, 
         addCoef.col = 'white',
         number.cex = 0.4,
         cl.pos = 'n', 
         col = COL1('Blues'),
         col.lim = c(min(var_ordenado_top20_dim1), max(var_ordenado_top20_dim1)))  ;
        # Call the recordPlot() function to record the plot
        recordPlot()
       }

#Comp2
var_ordenado_top20_dim2 <- var$cos2 %>%
  as.data.frame() %>%
  arrange(desc(.[, 2])) %>%   # Ordenar pela primeira coluna em ordem decrescente
  slice_head(n = 20) %>%      # Selecionar as primeiras 50 linhas
  select(2) %>%                  # Selecionar as primeiras 5 colunas
  as.matrix()

corplot_dim2 = {corrplot(var_ordenado_top20_dim2, 
         is.corr = T, 
         tl.col = 'black', 
         tl.cex = 0.5, 
         addCoef.col = 'white',
         number.cex = 0.4,
         cl.pos = 'n', 
         col = COL2('PiYG'),
         col.lim = c(min(var_ordenado_top20_dim2), max(var_ordenado_top20_dim2))) ;
        # Call the recordPlot() function to record the plot
        recordPlot()
       }

dim1_dim2_corrplot = plot_grid(corplot_dim1, corplot_dim2, 
          rel_widths = c(1, 0.5, 1), 
          align = "hv",
          labels = c("Dim1", "Dim2"), 
          nrow = 1)

ggsave(dim1_dim2_corrplot, file = "dim1_dim2_corrplot.png")

#Plot
corrplot = ggcorrplot(corr_matrix, hc.order = TRUE) + 
  theme(axis.text.x = element_text(angle = 90, size = 5), 
        axis.text.y = element_text(size = 5))
#Salvar
ggsave(corrplot, file = paste0(filename, "_corrplot.png"), 
       width = 20, #Grande 20, pequeno 10
       height= 20) #Grande 20, pequeno 10
print(corrplot)

#########Scree plot
data.pca = princomp(corr_matrix) #PCA
summary(data.pca) #Retornar PCs

#########Scree plot
scree_plot = fviz_eig(data.pca, 
                      addlabels = TRUE,
                      ylim = c(0, 70)) +
  geom_col(color = "#00AFBB", fill = "#00AFBB") +
  theme_classic()

#Salvar
ggsave(scree_plot, file = paste0(filename, "_screeplot.png"), width = 10, height = 3) 
print(scree_plot)

#Comp1-Comp2
loadings = data.frame(data.pca$loadings[, 1:3])
loadings$Genes = rownames(loadings)
loadings_1 = arrange(loadings, desc(Comp.1))
loadings_2 = arrange(loadings, desc(Comp.2))
loadings_3 = arrange(loadings, desc(Comp.3))

#Plot
loadings_1_plot = ggplot(loadings_1, aes(x = reorder(Genes, -Comp.1), y=Comp.1, fill = Comp.1)) + 
  ggtitle(paste0("Comp1-Comp2 Genes", filename)) + 
  ylab("Comp1") +
  xlab("Genes") +
  geom_bar(stat = "identity") + 
  theme_light() +
  theme(axis.text.x = element_text(vjust = 0.1, hjust = 1, angle = 90, size = 3), 
        axis.text.y = element_text(size = 5),
        plot.title = element_text(size = 15L, hjust = 0.5)) + 
  scale_fill_continuous(type = "viridis") #cores
  
#Salvar
ggsave(loadings_1_plot, 
       file = paste0(filename, "_genescomp1-2.png"), 
       width = 10, height = 5)

print(loadings_1_plot)

loadings_1 = arrange(loadings, desc(Comp.1)) %>% 
  rename(genes = Genes) %>% 
  inner_join(data_genes, by = "genes") %>% 
  select(log2fold_change, genes, condition) %>% 
  pivot_wider(., names_from = "condition", values_from = "log2fold_change") %>% 
  slice_head(n=20) %>% 
  pivot_longer(-genes, names_to = "condition", values_to = "log2fold_change") %>%
  filter(log2fold_change != "NA") %>% 
  ggplot() +
  aes(x = fct_reorder(condition, desc(condition)),
    fill = factor(sign(log2fold_change)),
    weight = log2fold_change
  ) +
  geom_bar() +
  scale_fill_manual(values = c("-1" = "#4CC9F0", "1" = "#F72585"),
                    name = "L2FC", 
                    labels = c("-1" = "<0", "1" = ">0")) +  
  ylab("L2FC")+
  xlab("Conditions")+
  coord_flip() +
  theme_minimal() +
  facet_grid(vars(), vars(genes), scales = "free_y", ) +
  theme(axis.text.y = element_text(face = "bold", color = "black", size = 10),
        axis.text.x = element_text(color = "black", angle = 90),
        strip.text = element_text(size = 12, face = "bold", color = "black")) +
  ggtitle("Top 20 genes in PC1")

ggsave(loadings_1, file = "loadings_PC1_top20Genes.png", width = 20, height = 5)

loadings_2 = arrange(loadings, desc(Comp.2)) %>% 
  rename(genes = Genes) %>% 
  inner_join(data_genes, by = "genes") %>% 
  select(log2fold_change, genes, condition) %>% 
  pivot_wider(., names_from = "condition", values_from = "log2fold_change") %>% 
  slice_head(n=20) %>% 
  pivot_longer(-genes, names_to = "condition", values_to = "log2fold_change") %>%
  filter(log2fold_change != "NA") %>% 
  ggplot() +
  aes(x = fct_reorder(condition, desc(condition)),
    fill = factor(sign(log2fold_change)),
    weight = log2fold_change
  ) +
  geom_bar() +
  scale_fill_manual(values = c("-1" = "#4CC9F0", "1" = "#F72585"),
                    name = "L2FC", 
                    labels = c("-1" = "<0", "1" = ">0")) +  
  ylab("L2FC")+
  xlab("Conditions")+
  coord_flip() +
  theme_minimal() +
  facet_grid(vars(), vars(genes), scales = "free_y", ) +
  theme(axis.text.y = element_text(face = "bold", color = "black", size = 10),
        axis.text.x = element_text(color = "black", angle = 90),
        strip.text = element_text(size = 12, face = "bold", color = "black")) +
  ggtitle("Top 20 genes in PC2")

ggsave(loadings_1, file = "loadings_PC2_top20Genes.png", width = 20, height = 5)


```


```{r}
# Graph of the variables
options(ggrepel.max.overlaps = Inf)

circle_contrib= fviz_pca_var(pca_res, col.var = "cos2",
                              gradient.cols = c("black", "#4CC9F0"),
                              select.var= list(cos2 = 20), 
                              repel = T, 
                              labelsize = 3,
                              col.circle = NA) +
  xlab("") + 
  ylab("") +
  theme_minimal() +
theme(panel.grid = element_blank(),  # Remover linhas de grade
        axis.text = element_blank(),   # Remover rótulos de texto dos eixos
        axis.ticks = element_blank()) 

ggsave(circle_contrib, file = "circle_contrib.png", width = 5, height = 5)
```

CORES
```{r}
condition_col = c(
                                "BBIBP (V3, D07)" = "gray50",
                                "BBIBP (V3, D14)" = "gray50",
                                "BBIBP (V3, D28)" = "gray50",
                                "BNT (V1, D6)" = "#56cfe1",
                                "BNT (V2, D1)" = "#56cfe1",
                                "BNT (V3, D1)" = "#56cfe1",
                                "BNT-I (D1)"= "#BF3100",
                                "BNT-I (D10, mild)"= "#BF3100",
                                "BNT-I (D10, severe)"= "#BF3100",
                                "BNT-I (D2)"= "#BF3100",
                                "BNT-I (D26, mild)"= "#BF3100",
                                "BNT-I (D26, severe)"= "#BF3100",
                                "BNT-I (D3)"= "#BF3100",
                                "BNT-I (D4)"= "#BF3100",
                                "BNT-I (D51, severe)"= "#BF3100",
                                "BNT-I-BNT (D51, mild)"= "#F5BB00",
                                "BNT-I-BNT (D51, severe)"= "#F5BB00",
                                "BNT-MO (V1, D6)"= "#D7B0EE",
                                "BNT-MO (V3, D1)"= "#D7B0EE",
                                "ChAd (V1, D3)"= "#5e60ce",
                                "ChAd (V1, D6)"= "#5e60ce",
                                "ChAd (V1, D7)"= "#5e60ce",
                                "ChAd (V2, D1)"= "#5e60ce",
                                "ChAd (V2, D3)"= "#5e60ce",
                                "ChAd (V2, D7)"= "#5e60ce",
                                "ChAd-BNT (V2, D0)"= "#7400b8",
                                "ChAd-BNT (V2, D3)"= "#7400b8",
                                "ChAd-BNT (V2, D7)"= "#7400b8",
                                "ChAd-BNT (V3, D1)"= "#7400b8",
                                "I (D1)"= "#ff4d6d",
                                "I (D10, moderate)"= "#ff4d6d",
                                "I (D10, severe)"= "#ff4d6d",
                                "I (D26, moderate)"= "#ff4d6d",
                                "I (D26, severe)"= "#ff4d6d",
                                "I (D51, moderate)"= "#ff4d6d",
                                "I (D51, severe)"= "#ff4d6d",
                                "I-BNT-I (D2)"= "#BF3100",
                                "I-BNT-I (D5)"= "#BF3100",
                                "I-I (D0)"= "#ff4d6d",
                                "I-I (D1)"= "#ff4d6d",
                                "I-I (D2)"= "#ff4d6d",
                                "I-I (D3)"= "#ff4d6d",
                                "I-I (D5)"= "#ff4d6d",
                                "ZF2001 (V3, D07)"= "#b5179e",
                                "ZF2001 (V3, D14)"= "#b5179e",
                                "ZF2001 (V3, D28)" = "#b5179e"
                              )
```

```{r}
############### KNN classification
#Use the screeplot generated % of explained variance for each dimension
scree_plot #Dim 1 = 68.2%, Dim 2 = 15.9%
#Determinar o número de clusters para KNN
pca_scores <- data.frame(pca_res$x[, 1:2])
fviz_nbclust(pca_scores,  
                     FUNcluster = kmeans,
                     method = "wss")

set.seed(666)                             # Set seed for randomization
cluster_model <- kmeans(pca_res$x[, 1:2], centers = 3)  # Ajuste o número de clusters conforme necessário
ann_vaccines_pca_matrix$cluster <- as.factor(cluster_model$cluster)


# Condition -------
pca_plot_knn_condition_lab = autoplot(pca_res, 
        data = ann_vaccines_pca_matrix, 
        colour = 'condition') + 
  stat_ellipse(aes(color = cluster, fill = cluster), 
               geom = "polygon", 
               alpha = 0.1, 
               linetype = 1,
               size = 0.3,
               type = "t") +
  geom_text_repel(data = ann_vaccines_pca_matrix,
                  aes(label = condition, color = condition_col),
                  box.padding = 0.3,
                  size = 2) +
  labs(title=paste0(filename, "_bycondition")) + 
  xlab("PC1 (68.2%)") + 
  ylab("PC2 (15.9%)") +
  scale_color_manual(values = c("1" = "#5e60ce", 
                                "2" = "#f72585", 
                                "3" = "#56cfe1", condition_col)) +  # Ellipse line colors
  scale_fill_manual(values = c("1" = "#5e60ce", 
                               "2" = "#f72585", 
                               "3" = "#56cfe1")) +  # Cluster fill colors
  theme_minimal() +
  guides(col="none") +
  theme(panel.grid = element_blank())

ggsave(pca_plot_knn_condition_lab, file = paste0(filename, "_KNN_Clustered_labels.png"), width = 7, height = 5)

```

