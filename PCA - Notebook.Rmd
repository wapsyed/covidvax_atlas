
---
title: "PCA"
output: html_notebook
---

# PCA

Tutoriais
<https://www.datacamp.com/tutorial/pca-analysis-r> 
<https://rpkgs.datanovia.com/factoextra/index.html> <http://www.sthda.com/english/articles/31-principal-component-methods-in-r-practical-guide/114-mca-multiple-correspondence-analysis-in-r-essentials/>
<https://statisticsglobe.com/pca-before-k-means-clustering-r>>

Bibliotecas
```{r}
library(tidyverse)
library(ggrepel) #load before factoextra
library(factoextra)
library(caret)
library(stats)
library(ggfortify)
library(ggplot2)
library(corrplot)
library(cowplot)
library(ggcorrplot)
library(ComplexHeatmap)
library(circlize)
```



### By genes


Processar dados
```{r}
ImmuneGO_Annotated_Genes = ImmuneGO_Annotated_Genes_26_2_24 %>% 
  anti_join(TCR_BCR_repertoire_genes, by = "genes")

ImmuneGO_Manual = ImmuneGO_Annotated_Genes %>% 
  filter(go_term == "Manual") %>% 
  select(genes) %>% distinct()

ImmuneGO_Other = 
  %>% anti_join(ImmuneGO_Annotated_Genes_26_2_24 %>% distinct(), ImmuneGO_Manual) %>% 
  group_by(process) %>%
  summarize(genes = paste(genes, collapse = ",")) %>% 
  mutate(gene_set_short = process, 
         process = if_else(str_detect(process, "(?i)MICROBIAL|FUNGAL|BACTERIAL"), 
                           "ANTIMICROBIAL RESPONSE", 
                           "OTHER")) %>% 
   group_by(process) %>%
  summarize(genes = paste(genes, collapse = ", ")) %>% 
  mutate(go_term = "Manual",
         immune_system = "General",
         immune_sub_system = "Undefined")

ImmuneGO_Annotated_GO_8_2_24 = bind_rows(ImmuneGO_Other, ImmuneGO_Annotated_GO_8_1_24) %>% 
  select(-"...1")
write.csv(ImmuneGO_Annotated_GO_8_2_24, file = "ImmuneGO_Annotated_GO_8_2_24.csv")

ImmuneGO_Annotated_Genes = ImmuneGO_Annotated_GO_8_2_24 %>% 
  separate_rows(genes, sep = ",")
```


```{r}
ImmuneGO_Genes = all_degs_p_05_vac_infected_19_12_23 %>% 
  select(-"...1", -"...12") %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% 
               select(genes, process) %>% 
               distinct() %>% 
               select(genes),
               by = "genes") %>% 
  distinct()

nonImmuneGO_Genes = all_degs_p_05_vac_infected_19_12_23 %>% 
  select(-"...1") %>% 
  anti_join(ImmuneGO_Annotated_Genes %>% 
               select(genes) %>% 
               distinct(),
               by = "genes") %>% 
  distinct()

#INPUT
data_genes = ImmuneGO_Genes 
filename = "ImmuneGO_Genes"

data_annotation = ann_vaccines %>% 
  mutate(day = as.factor(day),
         dose = as.factor(dose)) 

#Converter de long para wide

#Matriz com anotações
ann_vaccines_pca_matrix = data_genes %>% 
  mutate(log2fold_change = as.numeric(log2fold_change)) %>% 
  select(condition, genes, log2fold_change) %>% 
  pivot_wider(., names_from = "condition", 
                     values_from = "log2fold_change") %>% 
  replace(is.na(.), 0) %>%
  column_to_rownames("genes") %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column("condition") %>% 
  inner_join(data_annotation %>% 
               select(condition, disease_vac, vaccine, day, week, dose, infection, type), by = "condition") 

#Matriz para PCA
ann_vaccines_pca_matrix_ready = ann_vaccines_pca_matrix %>% 
  column_to_rownames("condition") %>% 
  select(!disease_vac:type) %>% 
  as.matrix()

# Verifique colunas com variancia baixa
nearZeroVarCols <- nearZeroVar(ann_vaccines_pca_matrix_ready, saveMetrics = TRUE)
ann_vaccines_pca_matrix_ready <- ann_vaccines_pca_matrix_ready[, !nearZeroVarCols$nzv]
pca_res <- prcomp(ann_vaccines_pca_matrix_ready, scale. = T)

########Correlation plot
corr_matrix = cor(ann_vaccines_pca_matrix_ready) 
var <- get_pca_var(pca_res)

### Contribuição dos genes principais para cada PC
# Comp1
var_ordenado_top20_dim1 <- var$cos2 %>%
  as.data.frame() %>%
  arrange(desc(.[, 1])) %>%   # Ordenar pela primeira coluna em ordem decrescente
  slice_head(n = 20) %>%      # Selecionar as primeiras 50 linhas
  select(1:1) %>%                  # Selecionar as primeiras 5 colunas
  as.matrix()

corplot_dim1 = {corrplot(var_ordenado_top20_dim1, 
         is.corr = T, tl.col = 'black', 
         tl.cex = 0.5, 
         addCoef.col = 'white',
         number.cex = 0.4,
         cl.pos = 'n', 
         col = COL1('Blues'),
         col.lim = c(min(var_ordenado_top20_dim1), max(var_ordenado_top20_dim1)))  ;
        # Call the recordPlot() function to record the plot
        recordPlot()
       }

#Comp2
var_ordenado_top20_dim2 <- var$cos2 %>%
  as.data.frame() %>%
  arrange(desc(.[, 2])) %>%   # Ordenar pela primeira coluna em ordem decrescente
  slice_head(n = 20) %>%      # Selecionar as primeiras 50 linhas
  select(2) %>%                  # Selecionar as primeiras 5 colunas
  as.matrix()

corplot_dim2 = {corrplot(var_ordenado_top20_dim2, 
         is.corr = T, 
         tl.col = 'black', 
         tl.cex = 0.5, 
         addCoef.col = 'white',
         number.cex = 0.4,
         cl.pos = 'n', 
         col = COL2('PiYG'),
         col.lim = c(min(var_ordenado_top20_dim2), max(var_ordenado_top20_dim2))) ;
        # Call the recordPlot() function to record the plot
        recordPlot()
       }

dim1_dim2_corrplot = plot_grid(corplot_dim1, corplot_dim2, 
          rel_widths = c(1, 0.5, 1), 
          align = "hv",
          labels = c("Dim1", "Dim2"), 
          nrow = 1)

ggsave(dim1_dim2_corrplot, file = "dim1_dim2_corrplot.png")

#Plot
corrplot = ggcorrplot(corr_matrix, hc.order = TRUE) + 
  theme(axis.text.x = element_text(angle = 90, size = 5), 
        axis.text.y = element_text(size = 5))
#Salvar
ggsave(corrplot, file = paste0(filename, "_corrplot.png"), 
       width = 20, #Grande 20, pequeno 10
       height= 20) #Grande 20, pequeno 10
print(corrplot)

#########Scree plot
data.pca = princomp(corr_matrix) #PCA
summary(data.pca) #Retornar PCs

#########Scree plot
scree_plot = fviz_eig(data.pca, 
                      addlabels = TRUE,
                      ylim = c(0, 70)) +
  geom_col(color = "#00AFBB", fill = "#00AFBB") +
  theme_classic()



#Salvar
ggsave(scree_plot, file = paste0(filename, "_screeplot.png"), width = 10, height = 3) 
print(scree_plot)

```


```{r}
# Graph of the variables
options(ggrepel.max.overlaps = Inf)

circle_contrib= fviz_pca_var(pca_res, col.var = "cos2",
                              gradient.cols = c("black", "#4CC9F0"),
                              select.var= list(cos2 = 20), 
                              repel = T, 
                              labelsize = 3,
                              col.circle = NA) +
  xlab("") + 
  ylab("") +
  theme_minimal() +
theme(panel.grid = element_blank(),  # Remover linhas de grade
        axis.text = element_blank(),   # Remover rótulos de texto dos eixos
        axis.ticks = element_blank()) 

ggsave(circle_contrib, file = "circle_contrib.png", width = 5, height = 5)
```

CORES
```{r}
condition_col = c(
                                "BBIBP (V3, D07)" = "gray50",
                                "BBIBP (V3, D14)" = "gray50",
                                "BBIBP (V3, D28)" = "gray50",
                                "BNT (V1, D6)" = "#56cfe1",
                                "BNT (V2, D1)" = "#56cfe1",
                                "BNT (V3, D1)" = "#56cfe1",
                                "BNT-I (D1)"= "#BF3100",
                                "BNT-I (D10, mild)"= "#BF3100",
                                "BNT-I (D10, severe)"= "#BF3100",
                                "BNT-I (D2)"= "#BF3100",
                                "BNT-I (D26, mild)"= "#BF3100",
                                "BNT-I (D26, severe)"= "#BF3100",
                                "BNT-I (D3)"= "#BF3100",
                                "BNT-I (D4)"= "#BF3100",
                                "BNT-I (D51, severe)"= "#BF3100",
                                "BNT-I-BNT (D51, mild)"= "#F5BB00",
                                "BNT-I-BNT (D51, severe)"= "#F5BB00",
                                "BNT-MO (V1, D6)"= "#D7B0EE",
                                "BNT-MO (V3, D1)"= "#D7B0EE",
                                "ChAd (V1, D3)"= "#5e60ce",
                                "ChAd (V1, D6)"= "#5e60ce",
                                "ChAd (V1, D7)"= "#5e60ce",
                                "ChAd (V2, D1)"= "#5e60ce",
                                "ChAd (V2, D3)"= "#5e60ce",
                                "ChAd (V2, D7)"= "#5e60ce",
                                "ChAd-BNT (V2, D0)"= "#7400b8",
                                "ChAd-BNT (V2, D3)"= "#7400b8",
                                "ChAd-BNT (V2, D7)"= "#7400b8",
                                "ChAd-BNT (V3, D1)"= "#7400b8",
                                "I (D1)"= "#ff4d6d",
                                "I (D10, moderate)"= "#ff4d6d",
                                "I (D10, severe)"= "#ff4d6d",
                                "I (D26, moderate)"= "#ff4d6d",
                                "I (D26, severe)"= "#ff4d6d",
                                "I (D51, moderate)"= "#ff4d6d",
                                "I (D51, severe)"= "#ff4d6d",
                                "I-BNT-I (D2)"= "#BF3100",
                                "I-BNT-I (D5)"= "#BF3100",
                                "I-I (D0)"= "#ff4d6d",
                                "I-I (D1)"= "#ff4d6d",
                                "I-I (D2)"= "#ff4d6d",
                                "I-I (D3)"= "#ff4d6d",
                                "I-I (D5)"= "#ff4d6d",
                                "ZF2001 (V3, D07)"= "#b5179e",
                                "ZF2001 (V3, D14)"= "#b5179e",
                                "ZF2001 (V3, D28)" = "#b5179e"
                              )

############### KNN classification
#Use the screeplot generated % of explained variance for each dimension
scree_plot #Dim 1 = 68.2%, Dim 2 = 15.9%
#Determinar o número de clusters para KNN
pca_scores <- data.frame(pca_res$x[, 1:2])
fviz_nbclust(pca_scores,  
                     FUNcluster = kmeans,
                     method = "wss")

set.seed(666)                             # Set seed for randomization
cluster_model <- kmeans(pca_res$x[, 1:2], centers = 3)  # Ajuste o número de clusters conforme necessário
ann_vaccines_pca_matrix$cluster <- as.factor(cluster_model$cluster)


# Condition -------
pca_plot_knn_condition_lab = autoplot(pca_res, 
        data = ann_vaccines_pca_matrix, 
        colour = 'condition') + 
  stat_ellipse(aes(color = cluster, fill = cluster), 
               geom = "polygon", 
               alpha = 0.1, 
               linetype = 1,
               size = 0.3,
               type = "t") +
  geom_text_repel(data = ann_vaccines_pca_matrix,
                  aes(label = "condition"),
                  box.padding = 0.3,
                  size = 2) +
  labs(title=paste0(filename, "_bycondition")) + 
  xlab("PC1 (68.2%)") + 
  ylab("PC2 (15.9%)") +
  scale_color_manual(values = c("1" = "#5e60ce", 
                                "2" = "#f72585", 
                                "3" = "#56cfe1")) +  # Ellipse line colors
  scale_fill_manual(values = c("1" = "#5e60ce", 
                               "2" = "#f72585", 
                               "3" = "#56cfe1")) +  # Cluster fill colors
  theme_minimal() +
  guides(col="none") +
  theme(panel.grid = element_blank())

ggsave(pca_plot_knn_condition_lab, file = paste0(filename, "_KNN_Clustered_labels.png"), width = 7, height = 5)

```


#Heatmap

## Genes annotated
```{r}
####### INPUT
PC1 = var$cos2 %>%
  as.data.frame() %>%
  arrange(desc(Dim.1)) %>%
  slice_head(n = 20) %>%
  rownames_to_column("genes") %>% 
  distinct() %>% 
  select(genes, Dim.1)

PC2 = var$cos2 %>%
  as.data.frame() %>%
  arrange(desc(Dim.2)) %>%
  slice_head(n = 20) %>%
  rownames_to_column("genes") %>% 
  distinct() %>% 
  select(genes, Dim.2)

data_2 =  PC2 %>% 
  inner_join(data_genes, by = "genes")

filename_2 = paste0("Immune_GO_genes_PCA_PC2", "_COVID")

######## Matrix
matrix = data_2 %>% 
  select(genes, condition, log2fold_change) %>%
  pivot_wider(names_from = "condition", 
              values_from = "log2fold_change", 
              values_fn = mean) %>% 
  replace(is.na(.), 0) %>%
  arrange(genes) %>% 
  column_to_rownames(var="genes") %>% 
  as.matrix()

######## Annotations
ann_vaccines_covid = data_2 %>% 
  select(condition) %>% 
  distinct() %>% 
  inner_join(ann_vaccines, by = "condition") %>% 
  select(condition, disease_vac, type, day) %>% 
  distinct()

#Columns
ann_cols_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  inner_join(ann_vaccines_covid, by = "condition") %>% 
  distinct() %>% 
  arrange(condition) %>% 
  column_to_rownames("condition")

matrix_data = matrix %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  inner_join(ann_cols_heatmap %>% rownames_to_column("condition"), by = "condition") %>% 
  select(!c(disease_vac:day)) %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>%
  as.matrix()

#Rows
ann_rows = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  inner_join(ImmuneGO_Annotated_Genes, by = "genes") %>% 
  filter(go_term == "Manual") %>%
  select(genes, process) %>%
  distinct() %>%
  group_by(genes) %>%
  arrange(genes, factor(process, levels = c("INNATE IMMUNE SYSTEM", "ADAPTIVE IMMUNE SYSTEM", "OTHER", "ANTIMICROBIAL IMMUNE RESPONSE")), .by_group = TRUE) %>% 
  mutate(i_process = row_number()) %>% 
  pivot_wider(., names_from = "i_process", values_from = "process") %>% 
  column_to_rownames("genes") %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column("index") %>% 
  arrange(desc(index)) %>% 
  column_to_rownames("index") %>% 
  t() %>% 
  as.data.frame() %>% 
  replace(is.na(.), ".")



#Verificar dimensões do dataset
dim(matrix_data)
dim(ann_rows)
dim(ann_cols_heatmap)

```

Colors

```{r}
################## Colors

#VAX SIG DB
ann_vaxsig_colors = list(
  type = c("VLP" = "#D7B0EE",
           "LA" =  "#5e60ce",
           "CONJ" = "#015BA0", 
           'IN'= "#76c893", #1st Gen  vaccines
           'VV' = "#5e60ce", #3rd Gen vaccines
           'RNA' = "#56cfe1",
           'SU' = "#b5e48c",
           'I'= "#f72585",
           "H" = "grey95"),
  target_pathogen_disease = c('MENINGOCOCCUS'	= "#16E0BD",
                             'PNEUMOCOCCUS'	= "#44C199",
                             'TUBERCULOSIS'	= "#99e2b4",
                             'F TULARENSIS'	= "#90e0ef",
                             'LEISHMANIA'	= "#118ab2",
                             'MALARIA' = "#3f37c9",
                             'EBOV'	= "#d00000",
                             "SARS" = "#ef233c",
                             'HBV'	= "#e85d04",
                             'HBV, HAV'	= "#f48c06",
                             'HIV'	= "#a4133c",
                             'HPV'	= "#f27059",
                             'INFLUENZA'	= "#ffa69e",
                             'MEASLES'	= "#c65b7c",
                             'MMR'	= "#f9b5ac",
                             'SMALLPOX'	= "#ff8c42",
                             'VEEV'	= "#e01e37",
                             'VZV'	= "#ff9b85",
                             'YF'	= "#f38375"),
  covid_other = c("COVID" = "#56cfe1",
                  "OTHER" = "#343a40"),
  microbe_type = c("VIRUS" = "#5e60ce",
                   'BACTERIUM' = "#72efdd",
                   'PARASITE' = "#b5179e"),
  
  week = c("0" = "#ECF8FA",
           "1" = "#caf0f8",
           "2" = "#6CD5EA",
           "3" = "#0087BF",
           "4" = "#015BA0", 
           "6" = "#03045e",
           "7" = "#03045e",
           "8" = "#03045e"),
  month = c("1" = "#caf0f8",
            "0" = "#6CD5EA",
           "2" = "#015BA0"),
  vaccine = c("BBIBP" = "#76c893",
  "ZF2001" = "#b5e48c",
  "BNT" = "#56cfe1",
  "MO" = "#72ddf7",
  "ChAd" = "#5e60ce",
  "I" = "grey95",
  "H" = "grey95"),
  dose = c(
            "0" = "grey95",
            "1" = "#56cfe1",
            "2" = "#5978d4",
            "3" = "#b5179e"),
  day = c(
          "0" = "white",
          "1" = "#caf0f8",
          "2" = "#ade8f4",
          "3" = "#90e0ef",
          "4" = "#6CD5EA",
          "5" = "#48cae4",
          "6" = "#00b4d8",
          "7" = "#0096c7",
          "10" = "#0087BF",
          "11" = "#0087BF",
          "14" = "#0077b6",
          "26" = "#015BA0",
          "28" = "#023e8a",
          "51" = "#03045e"),
  type = c('IN'= "#343a40", #1st Gen  vaccines
           'SU' = "#00a896",
           'VV' = "#72efdd", #3rd Gen vaccines
           'RNA' = "#56cfe1",
           'SU' = "#b5179e",
           'I'= "#da1e37",
           "H" = "grey95"), 
  infection = c("0" = "#64dfdf",
                "1" = "#f72585",
                "2" = "#a4161a"),
  variant = c("None" = "grey95",
              "Beta" = "#72efdd",
              "Omicron" = "#5e60ce"),
  severity = c("H" = "grey95",
               "S" = "#b5179e",
               "MO" = "#5e60ce",
               "MI" = "#80ffdb",
               "NA" = "grey95"),
  sex = c("Male" = "#56cfe1",
          "Female" = "#b5179e",
          "M/F" = "#5e60ce"),
  disease_vac = c("I" = "#5e60ce",
                  "V" = "#64dfdf")
  )


col_process = list(
  "1" = c("ADAPTIVE IMMUNE SYSTEM" = "#6f2dbd",
        "B CELLS" = "#7b2cbf",
        "CELLULAR ADAPTIVE IMMUNE SYSTEM" = "#e0aaff",
        "HUMORAL ADAPTIVE IMMUNE SYSTEM" = "#9d4edd",
        "IMMUNOGLOBULIN MEDIATED IMMUNE RESPONSE"= "#5a189a",
        "T CELLS" = "#c77dff",
        "COMPLEMENT IMMUNE SYSTEM" = "#ffadc7",
        "ANTIVIRAL AND INTERFERON" = "#88d4ab",
        "ARPP" = "#14746f",
        "DENDRITIC CELLS" = "#036666",
        "EOSINOPHIL" = "#67b99a",
        "INFLAMMATION" = "#99e2b4",
        "INNATE IMMUNE SYSTEM" = "#06d6a0",
        "MAST CELL" = "#56ab91",
        "MONOCYTES" = "#358f80",
        "NEUTROPHIL" = "#78c6a3",
        "NK CELL" = "#469d89",
        "MACROPHAGES" = "#14746f",
        "OTHER" = "#343a40",
        "."="white"),
  "2" = c("ADAPTIVE IMMUNE SYSTEM" = "#6f2dbd",
        "B CELLS" = "#7b2cbf",
        "CELLULAR ADAPTIVE IMMUNE SYSTEM" = "#e0aaff",
        "HUMORAL ADAPTIVE IMMUNE SYSTEM" = "#9d4edd",
        "IMMUNOGLOBULIN MEDIATED IMMUNE RESPONSE"= "#5a189a",
        "T CELLS" = "#c77dff",
        "COMPLEMENT IMMUNE SYSTEM" = "#ffadc7",
        "ANTIVIRAL AND INTERFERON" = "#88d4ab",
        "ARPP" = "#14746f",
        "DENDRITIC CELLS" = "#036666",
        "EOSINOPHIL" = "#67b99a",
        "INFLAMMATION" = "#99e2b4",
        "INNATE IMMUNE SYSTEM" = "#06d6a0",
        "MAST CELL" = "#56ab91",
        "MONOCYTES" = "#358f80",
        "NEUTROPHIL" = "#78c6a3",
        "NK CELL" = "#469d89",
        "MACROPHAGES" = "#14746f",
        "OTHER" = "#343a40",
        "."="white"),
  "3" = c("ADAPTIVE IMMUNE SYSTEM" = "#6f2dbd",
        "B CELLS" = "#7b2cbf",
        "CELLULAR ADAPTIVE IMMUNE SYSTEM" = "#e0aaff",
        "HUMORAL ADAPTIVE IMMUNE SYSTEM" = "#9d4edd",
        "IMMUNOGLOBULIN MEDIATED IMMUNE RESPONSE"= "#5a189a",
        "T CELLS" = "#c77dff",
        "COMPLEMENT IMMUNE SYSTEM" = "#ffadc7",
        "ANTIVIRAL AND INTERFERON" = "#88d4ab",
        "ARPP"= "#14746f",
        "DENDRITIC CELLS" = "#036666",
        "EOSINOPHIL" = "#67b99a",
        "INFLAMMATION" = "#99e2b4",
        "INNATE IMMUNE SYSTEM" = "#06d6a0",
        "MAST CELL" = "#56ab91",
        "MONOCYTES" = "#358f80",
        "NEUTROPHIL" = "#78c6a3",
        "NK CELL" = "#469d89",
        "MACROPHAGES" = "#14746f",
        "OTHER" = "#343a40",
        "."="white"),
  "4" = c("ADAPTIVE IMMUNE SYSTEM" = "#6f2dbd",
        "B CELLS" = "#7b2cbf",
        "CELLULAR ADAPTIVE IMMUNE SYSTEM" = "#e0aaff",
        "HUMORAL ADAPTIVE IMMUNE SYSTEM" = "#9d4edd",
        "IMMUNOGLOBULIN MEDIATED IMMUNE RESPONSE"= "#5a189a",
        "T CELLS" = "#c77dff",
        "COMPLEMENT IMMUNE SYSTEM" = "#ffadc7",
        "ANTIVIRAL AND INTERFERON" = "#88d4ab",
        "ARPP" ="#14746f",
        "DENDRITIC CELLS" = "#036666",
        "EOSINOPHIL" = "#67b99a",
        "INFLAMMATION" = "#99e2b4",
        "INNATE IMMUNE SYSTEM" = "#06d6a0",
        "MAST CELL" = "#56ab91",
        "MONOCYTES" = "#358f80",
        "NEUTROPHIL" = "#78c6a3",
        "NK CELL" = "#469d89",
        "MACROPHAGES" = "#14746f",
        "OTHER" = "#343a40",
        "."="white"),
  "5" = c("ADAPTIVE IMMUNE SYSTEM" = "#6f2dbd",
        "B CELLS" = "#7b2cbf",
        "CELLULAR ADAPTIVE IMMUNE SYSTEM" = "#e0aaff",
        "HUMORAL ADAPTIVE IMMUNE SYSTEM" = "#9d4edd",
        "IMMUNOGLOBULIN MEDIATED IMMUNE RESPONSE"= "#5a189a",
        "T CELLS" = "#c77dff",
        "COMPLEMENT IMMUNE SYSTEM" = "#ffadc7",
        "ANTIVIRAL AND INTERFERON" = "#88d4ab",
        "ARPP" = "#14746f",
        "DENDRITIC CELLS" = "#036666",
        "EOSINOPHIL" = "#67b99a",
        "INFLAMMATION" = "#99e2b4",
        "INNATE IMMUNE SYSTEM" = "#06d6a0",
        "MAST CELL" = "#56ab91",
        "MONOCYTES" = "#358f80",
        "NEUTROPHIL" = "#78c6a3",
        "NK CELL" = "#469d89",
        "MACROPHAGES" = "#14746f",
        "OTHER" = "#343a40",
        "."="white"),
  "6" = c("ADAPTIVE IMMUNE SYSTEM" = "#6f2dbd",
        "B CELLS" = "#7b2cbf",
        "CELLULAR ADAPTIVE IMMUNE SYSTEM" = "#e0aaff",
        "HUMORAL ADAPTIVE IMMUNE SYSTEM" = "#9d4edd",
        "IMMUNOGLOBULIN MEDIATED IMMUNE RESPONSE"= "#5a189a",
        "T CELLS" = "#c77dff",
        "COMPLEMENT IMMUNE SYSTEM" = "#ffadc7",
        "ANTIVIRAL AND INTERFERON" = "#88d4ab",
        "ARPP" = "#14746f",
        "DENDRITIC CELLS" = "#036666",
        "EOSINOPHIL" = "#67b99a",
        "INFLAMMATION" = "#99e2b4",
        "INNATE IMMUNE SYSTEM" = "#06d6a0",
        "MAST CELL" = "#56ab91",
        "MONOCYTES" = "#358f80",
        "NEUTROPHIL" = "#78c6a3",
        "NK CELL" = "#469d89",
        "MACROPHAGES" = "#14746f",
        "OTHER" = "#343a40",
        "."="white"),
  "7" = c("ADAPTIVE IMMUNE SYSTEM" = "#6f2dbd",
        "B CELLS" = "#7b2cbf",
        "CELLULAR ADAPTIVE IMMUNE SYSTEM" = "#e0aaff",
        "HUMORAL ADAPTIVE IMMUNE SYSTEM" = "#9d4edd",
        "IMMUNOGLOBULIN MEDIATED IMMUNE RESPONSE"= "#5a189a",
        "T CELLS" = "#c77dff",
        "COMPLEMENT IMMUNE SYSTEM" = "#ffadc7",
        "ANTIVIRAL AND INTERFERON" = "#88d4ab",
        "ARPP" = "#14746f",
        "DENDRITIC CELLS" = "#036666",
        "EOSINOPHIL" = "#67b99a",
        "INFLAMMATION" = "#99e2b4",
        "INNATE IMMUNE SYSTEM" = "#06d6a0",
        "MAST CELL" = "#56ab91",
        "MONOCYTES" = "#358f80",
        "NEUTROPHIL" = "#78c6a3",
        "NK CELL" = "#469d89",
        "MACROPHAGES" = "#14746f",
        "OTHER" = "#343a40",
        "."="white"),
  "8" = c("ADAPTIVE IMMUNE SYSTEM" = "#6f2dbd",
        "B CELLS" = "#7b2cbf",
        "CELLULAR ADAPTIVE IMMUNE SYSTEM" = "#e0aaff",
        "HUMORAL ADAPTIVE IMMUNE SYSTEM" = "#9d4edd",
        "IMMUNOGLOBULIN MEDIATED IMMUNE RESPONSE"= "#5a189a",
        "T CELLS" = "#c77dff",
        "COMPLEMENT IMMUNE SYSTEM" = "#ffadc7",
        "ANTIVIRAL AND INTERFERON" = "#88d4ab",
        "ARPP" = "#14746f",
        "DENDRITIC CELLS" = "#036666",
        "EOSINOPHIL" = "#67b99a",
        "INFLAMMATION" = "#99e2b4",
        "INNATE IMMUNE SYSTEM" = "#06d6a0",
        "MAST CELL" = "#56ab91",
        "MONOCYTES" = "#358f80",
        "NEUTROPHIL" = "#78c6a3",
        "NK CELL" = "#469d89",
        "MACROPHAGES" = "#14746f",
        "OTHER" = "#343a40",
        "."="white"),
  "9" = c("ADAPTIVE IMMUNE SYSTEM" = "#6f2dbd",
        "B CELLS" = "#7b2cbf",
        "CELLULAR ADAPTIVE IMMUNE SYSTEM" = "#e0aaff",
        "HUMORAL ADAPTIVE IMMUNE SYSTEM" = "#9d4edd",
        "IMMUNOGLOBULIN MEDIATED IMMUNE RESPONSE"= "#5a189a",
        "T CELLS" = "#c77dff",
        "COMPLEMENT IMMUNE SYSTEM" = "#ffadc7",
        "ANTIVIRAL AND INTERFERON" = "#88d4ab",
        "ARPP" = "#14746f",
        "DENDRITIC CELLS" = "#036666",
        "EOSINOPHIL" = "#67b99a",
        "INFLAMMATION" = "#99e2b4",
        "INNATE IMMUNE SYSTEM" = "#06d6a0",
        "MAST CELL" = "#56ab91",
        "MONOCYTES" = "#358f80",
        "NEUTROPHIL" = "#78c6a3",
        "NK CELL" = "#469d89",
        "MACROPHAGES" = "#14746f",
        "OTHER" = "#343a40",
        "."="white"),
  "10" = c("ADAPTIVE IMMUNE SYSTEM" = "#6f2dbd",
        "B CELLS" = "#7b2cbf",
        "CELLULAR ADAPTIVE IMMUNE SYSTEM" = "#e0aaff",
        "HUMORAL ADAPTIVE IMMUNE SYSTEM" = "#9d4edd",
        "IMMUNOGLOBULIN MEDIATED IMMUNE RESPONSE"= "#5a189a",
        "T CELLS" = "#c77dff",
        "COMPLEMENT IMMUNE SYSTEM" = "#ffadc7",
        "ANTIVIRAL AND INTERFERON" = "#88d4ab",
        "ARPP" = "#14746f",
        "DENDRITIC CELLS" = "#036666",
        "EOSINOPHIL" = "#67b99a",
        "INFLAMMATION" = "#99e2b4",
        "INNATE IMMUNE SYSTEM" = "#06d6a0",
        "MAST CELL" = "#56ab91",
        "MONOCYTES" = "#358f80",
        "NEUTROPHIL" = "#78c6a3",
        "NK CELL" = "#469d89",
        "MACROPHAGES" = "#14746f",
        "OTHER" = "#343a40",
        "."="white"))
  
```


```{r}
################# Plotar
#Heatmap annotation

ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "right")

row_ha = HeatmapAnnotation(df = ann_rows,
                       col = col_process,
                       which = c("row"),
                       show_annotation_name = F,
                       show_legend = F)

# Values colors
col_fun <- colorRamp2(c(-2, 0, 2), c("#9bc1bc", "white", "#ed6a5a"))

file = filename_2
mat = matrix_data
width_image = 30
height_image = 20
width = unit(10, "cm")
height = unit(10, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)
rect_gp = gpar(col = "gray80", lwd = 0.5)

###### CLUSTERIZED ALL VS ALL

fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = fileimageheatmap_grouped, 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        col = col_fun, #color
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "white",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(2, "cm"),
                        row_split = 2,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(8, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height 
)

draw(heatmap_plot, 
     annotation_legend_side = "left", 
     heatmap_legend_side = "left")
dev.off()

```


### STATS


```{r}
stats_1 = covid_other_immunego_genes %>% 
  inner_join(ann_vaccines_covid_other, by = "condition") %>% 
  group_by(genes, covid_other) %>% 
  summarise(n_conditions = n()) %>% 
  filter(all(c("COVID", "OTHER") %in% covid_other)) %>% 
  arrange(desc(n_conditions), genes) %>% 
  ungroup()


ggplot_stats1 = ggplot(stats_1) +
  aes(x = reorder(genes, n_conditions), fill = covid_other, weight = n_conditions) +
  geom_bar() +
  theme_minimal() +
  scale_fill_manual(
    values = c(COVID = "#56cfe1",
    OTHER = "#343a40")
  ) +
  theme_minimal() +
  labs(fill = "Covid or non-covid") +
  xlab("Genes") + 
  ylab("Number of shared conditions") +
  theme(legend.position = "right",
        axis.text.x = element_text(angle = 45, vjust = 1.5, hjust=1, size = 8),
        axis.text.y = element_text(size = 7, angle = 0),
        panel.grid.minor.y = element_blank(),
        legend.text = element_text(size=12),
        legend.title = element_text(size = 12, face = "bold")) +
  # geom_text(aes(label = n_conditions, y = n_conditions), 
  #           position = position_dodge(width = 0.9), 
  #           vjust = 0.2, 
  #           hjust = -0.2, 
  #           size = 1,
  #           angle = 90) +
  ggtitle("Genes shared") +
  coord_flip()

ggsave(ggplot_stats1, file = "Covid_Vax_genes_shared_column.png", width = 10, height = 20)




stats_2 = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  inner_join(ImmuneGO_Annotated_Genes, by = "genes") %>%
  filter(go_term == "Manual",
         !(process %in% c("ADAPTIVE IMMUNE SYSTEM",
                          "INNATE IMMUNE SYSTEM"))) %>%
  select(genes, process, immune_system) %>%
  distinct() %>%
  group_by(genes, immune_system) %>% 
  summarise(n_processes = n()) %>% 
  arrange(desc(n_processes)) %>% 
  ungroup() %>% 
  filter(n_processes >1)
  
ggplot_stats2 = ggplot(stats_2) +
  aes(x = reorder(genes, n_processes), fill = immune_system, weight = n_processes) +
  geom_bar() +
  theme_minimal() +
  scale_fill_manual(
    values = c(Adaptive = "#6f2dbd",
    Innate = "#06d6a0",
    Complement = "#ffadc7")
  ) +
  theme_minimal() +
  labs(fill = "Immune system") +
  xlab("Genes") + 
  ylab("Number of shared conditions") +
  theme(legend.position = "right",
        axis.text.x = element_text(angle = 45, vjust = 1.5, hjust=1, size = 8),
        axis.text.y = element_text(size = 7, angle = 0),
        panel.grid.minor.y = element_blank(),
        strip.text.x.top = element_text(size = 10, face = "bold"),
        legend.text = element_text(size=12),
        legend.title = element_text(size = 12, face = "bold")) +
  # geom_text(aes(label = n_conditions, y = n_conditions), 
  #           position = position_dodge(width = 0.9), 
  #           vjust = 0.2, 
  #           hjust = -0.2, 
  #           size = 1,
  #           angle = 90) +
  ggtitle("Genes shared") +
  coord_flip() +
  facet_wrap(~immune_system, scales = "free_y")

ggsave(ggplot_stats2, file = "ImmuneGO_genes_shared_major_process.png", width = 6, height = 20)

```







